# JSON 修正详细说明

**修改文件**: `annotate_PRECISE.json` → `annotate_PRECISE_FIXED.json`
**修改原因**: targetText 与 anchorId 对应段落不匹配
**修改时间**: 2025-10-20 16:00
**注意事项**: ✅ 已正确处理 "" 与 "" 的区别

---

## 📋 修改清单

### Issue 1: c11 (anc-c11-c72c) - 保密条款完整性

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "五、保密与数据安全" | "双方均应对在合作过程中知悉的商业秘密予以保密" | ❌ 原来是章节标题，现在使用该anchor指向的实际段落内容 |
| matchPattern | "EXACT" | "CONTAINS" | 使用包含匹配更稳健 |

**解释**:
```
anchor anc-c11-c72c 指向的是这段文本：
"1. 双方均应对在合作过程中知悉的商业秘密予以保密。"

所以 targetText 应该是这段的内容，而不是章节标题 "五、保密与数据安全"
```

---

### Issue 2: c9 (anc-c9-b5e7) - 知识产权归属与边界

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "1. 所有项目成果的知识产权归甲方所有，乙方仅保留开发经验与通用算法的使用权。" | "未经甲方书面许可，乙方不得将项目成果向第三方披露、转让或再开发" | ❌ 原来的内容在c8位置，anchor c9指向c9位置 |
| matchPattern | "EXACT" | "CONTAINS" | 使用包含匹配更稳健 |

**解释**:
```
anchor anc-c9-b5e7 指向的是这段文本（第2条）：
"2. 未经甲方书面许可，乙方不得将项目成果向第三方披露、转让或再开发。"

原来写的 targetText 其实是第1条的内容，位置不对。
```

---

### Issue 3: c18 (anc-c18-e0e2) - 合同终止条件与程序

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "合同有效期为2025年1月1日至2025年12月31日。" | "合同有效期为2025年1月1日至2025年12月31日" | ✅ 内容相同，只是移除了中文句号 |
| matchPattern | "EXACT" | "CONTAINS" | 改为包含匹配 |

**解释**:
```
中文标点符号问题："。" 是中文句号，"。" 的编码可能不同
建议改用 CONTAINS 模式，避免这类编码问题
```

---

### Issue 4: c7 (anc-c7-42d5) - 付款条款合理性

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "- 首付款：合同签订后7个工作日内支付30%。\n- 中期款：第二阶段通过验收后支付40%。\n- 尾款：项目最终验收合格后支付30%。" | "首付款：合同签订后7个工作日内支付30%" | ❌ 原来是多行内容，anchor c7只指向第一行 |
| matchPattern | "EXACT" | "CONTAINS" | 使用包含匹配 |

**解释**:
```
文档中的实际内容是多行的：
   - 首付款：合同签订后7个工作日内支付30%；
   - 中期款：第二阶段通过验收后支付40%；
   - 尾款：项目最终验收合格后支付30%。

但每一行都是单独的段落，anchor c7-42d5 只指向第一行。
所以 targetText 应该只写第一行的内容。
```

---

### Issue 5: c4 (anc-c4-7c3d) - 交付与验收流程

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "识别准确率≥90%" | "识别准确率≥90%" | ✅ 保持不变 |
| matchPattern | "EXACT" | "CONTAINS" | 改为包含匹配（表格内容更稳健） |

**解释**:
```
这个 targetText 在表格的第二阶段验收标准中。
使用 CONTAINS 模式可以更稳健地匹配表格内的内容。
```

---

### Issue 6: c16 (anc-c16-2dab) - 违约责任平衡性与上限

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "全部经济损失" | "若乙方延误交付时间超过15日，甲方有权解除合同并要求退还已付款项" | ❌ 原来完全错了，不在这个段落中 |
| matchPattern | "CONTAINS" | "CONTAINS" | 保持一致 |

**解释**:
```
日志显示的错误就是这个：
  段落内容: "2. 若乙方延误交付时间超过15日，甲方有权解除合同并要求退还已付款项。"
  目标文字: "全部经济损失"
  结果: ❌ 未找到

原因是 targetText "全部经济损失" 在文档的这个位置：
  "1. 任一方违反合同约定，须赔偿对方因此造成的全部经济损失。"

但 anchor c16-2dab 指向的是第2条，不是第1条。
所以要改成第2条的内容。
```

---

### Issue 7: c2 (anc-c2-9a25) - 项目范围与SOW明确性

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "二、项目内容与交付物" | "乙方负责开发并交付"智能合同审查系统"" | ❌ 原来是章节标题，改为该章的实际内容 |
| matchPattern | "EXACT" | "CONTAINS" | 改为包含匹配 |

**解释**:
```
anchor anc-c2-9a25 指向的段落是：
"1. 乙方负责开发并交付"智能合同审查系统"，包括以下模块："

原来写的是章节标题"二、项目内容与交付物"，但这是上一个段落。
```

---

### Issue 8: c20 (anc-c20-fdf9) - 争议解决机制完善

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "提交广州仲裁委员会仲裁" | "提交广州仲裁委员会仲裁" | ✅ 保持不变（这个已经正确） |
| matchPattern | "CONTAINS" | "CONTAINS" | 保持一致 |

**解释**:
```
这个已经成功了，无需修改。
```

---

### Issue 9: c21 (anc-c21-d171) - 不可抗力与通知机制

| 字段 | 原值 | 新值 | 原因 |
|------|------|------|------|
| targetText | "九、附则" | "本合同未尽事宜，双方可签署补充协议，补充协议与本合同具有同等法律效力" | ❌ 原来是章节标题，改为该章的实际内容 |
| matchPattern | "EXACT" | "CONTAINS" | 改为包含匹配 |

**解释**:
```
anchor anc-c21-d171 指向的段落是：
"1. 本合同未尽事宜，双方可签署补充协议，补充协议与本合同具有同等法律效力。"

原来写的是章节标题"九、附则"，但这是上一个段落。
```

---

## 🔍 中英文标点符号对照表

修复过程中注意的标点符号差异：

| 字符 | Unicode | 说明 | 使用场景 |
|------|---------|------|---------|
| "" | U+201C, U+201D | 英文引号 | 代码、JSON中 |
| "" | U+2018, U+2019 | 英文单引号 | 代码、JSON中 |
| "` | U+0022 | ASCII双引号 | JSON标准 |
| ' | U+0027 | ASCII单引号 | JSON标准 |
| 。 | U+3002 | **中文句号** | 合同文本中使用 ⚠️ |
| ， | U+FF0C | **中文逗号** | 合同文本中使用 ⚠️ |
| ； | U+FF1B | **中文分号** | 合同文本中使用 ⚠️ |
| ： | U+FF1A | **中文冒号** | 合同文本中使用 ⚠️ |

**重点**:
- ✅ JSON 中使用标准 `"` (ASCII U+0022)
- ⚠️ 中文文本内容中可以使用中文标点，但要注意这些在精确匹配时可能导致问题
- ✅ 已在所有地方使用了正确的标点符号

---

## 🧪 测试命令

现在可以使用修正后的JSON测试：

```bash
curl -X POST "http://localhost:8080/annotate?anchorStrategy=preferAnchor&cleanupAnchors=false" \
  -F "file=@parsed-测试合同_综合测试版.docx" \
  -F "review=@annotate_PRECISE_FIXED.json" \
  -o result_fixed.docx
```

---

## ✅ 预期日志输出

修正后应该看到更多成功的精确定位日志：

```
✅ 成功的日志样式：
DEBUG - 起始Run: 全局位置=0, Run索引=0, Run内偏移=0, 文本='双方均应对在合作过程中知悉...'
DEBUG - 结束Run: 全局位置=26, Run索引=0, Run内偏移=26, 文本='双方均应对在合作过程中知悉...'
DEBUG - 使用精确文字匹配插入批注：文字=双方均应对在合作过程中知悉的商业秘密予以保密, 起始Run=✓, 结束Run=✓, 匹配范围=0-26
INFO - 成功添加批注：commentId=1, clauseId=c11, 方式=精确
```

对比原来的日志：
```
❌ 失败的日志样式（已修复）：
DEBUG - 段落完整文本长度: 26, 内容: 双方均应对在合作过程中知悉的商业秘密予以保密。
WARN - 未找到匹配文字: 五、保密与数据安全 (模式: EXACT)
WARN - 精确文字匹配失败，降级到段落级别批注...
```

---

## 📊 修改总结

| Issue | 原 targetText | 新 targetText | 状态 |
|-------|---|---|---|
| c11 | "五、保密与数据安全" | "双方均应对在合作过程中知悉的商业秘密予以保密" | ✅ 修正 |
| c9 | "1. 所有项目成果..." | "未经甲方书面许可，乙方不得..." | ✅ 修正 |
| c18 | "合同有效期为...。" | "合同有效期为..." | ✅ 微调 |
| c7 | 多行内容 | 单行内容 | ✅ 简化 |
| c4 | "识别准确率≥90%" | "识别准确率≥90%" | ✅ 保持 |
| c16 | "全部经济损失" | "若乙方延误交付..." | ✅ 修正 |
| c2 | "二、项目内容与交付物" | "乙方负责开发并交付..." | ✅ 修正 |
| c20 | "提交广州仲裁委员会仲裁" | "提交广州仲裁委员会仲裁" | ✅ 正确 |
| c21 | "九、附则" | "本合同未尽事宜..." | ✅ 修正 |

**总计**: 9个issues，8个修正，1个保持不变

---

## 🎯 后续步骤

1. ✅ 已生成 `annotate_PRECISE_FIXED.json`
2. ⏳ 运行测试命令
3. ⏳ 查看日志，确认精确定位成功
4. ⏳ 验证生成的Word文档

