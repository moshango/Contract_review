# å‘é‡å¬å›æ›¿ä»£å…³é”®è¯åŒ¹é…æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

**ç›®æ ‡**ï¼šä½¿ç”¨è¯­ä¹‰å‘é‡å¬å›æŠ€æœ¯æ›¿ä»£å½“å‰çš„å…³é”®è¯ä¸¥æ ¼åŒ¹é…ï¼Œæå‡è§„åˆ™åŒ¹é…çš„å‡†ç¡®æ€§å’Œå¬å›ç‡ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šå°†è§„åˆ™å’ŒåˆåŒæ¡æ¬¾è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºï¼Œé€šè¿‡è®¡ç®—å‘é‡ç›¸ä¼¼åº¦è¿›è¡Œè¯­ä¹‰åŒ¹é…ï¼Œè€Œéç®€å•çš„å…³é”®è¯åŒ¹é…ã€‚

---

## ğŸ¯ æ–¹æ¡ˆå¯¹æ¯”

### å½“å‰æ–¹æ¡ˆï¼ˆå…³é”®è¯åŒ¹é…ï¼‰

```java
// å½“å‰å®ç°
if (clauseText.contains("è¿çº¦") || clauseText.contains("èµ”å¿")) {
    // åŒ¹é…è§„åˆ™
}
```

**é—®é¢˜**ï¼š
- âŒ æ— æ³•è¯†åˆ«åŒä¹‰è¯ï¼ˆå¦‚"è¿çº¦"vs"ä¸å±¥è¡Œä¹‰åŠ¡"ï¼‰
- âŒ æ— æ³•ç†è§£è¯­ä¹‰ï¼ˆå¦‚"è§£é™¤åˆåŒ"ä¸"ç»ˆæ­¢åè®®"ï¼‰
- âŒ å…³é”®è¯è¦†ç›–ä¸å…¨å¯¼è‡´æ¼æ£€
- âŒ å¤šä¸ªå…³é”®è¯ç»„åˆé€»è¾‘å¤æ‚

### å‘é‡å¬å›æ–¹æ¡ˆ

```java
// å‘é‡å¬å›
float similarity = cosineSimilarity(clauseVector, ruleVector);
if (similarity > threshold) {
    // åŒ¹é…è§„åˆ™
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… è¯­ä¹‰ç†è§£ï¼šç†è§£"è¿çº¦"="ä¸å±¥è¡Œä¹‰åŠ¡"
- âœ… è‡ªåŠ¨æ³›åŒ–ï¼šæ— éœ€æšä¸¾æ‰€æœ‰åŒä¹‰è¯
- âœ… æ¨¡ç³ŠåŒ¹é…ï¼šç›¸ä¼¼åº¦å¯è°ƒ
- âœ… å¤šè¯­è¨€æ”¯æŒï¼šä¸­è‹±æ–‡ç»Ÿä¸€å¤„ç†

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæœ¬åœ°è½»é‡çº§æ–¹æ¡ˆï¼ˆæ¨èç”¨äºå¿«é€ŸéªŒè¯ï¼‰

**æŠ€æœ¯æ ˆ**ï¼š
- **å‘é‡åŒ–æ¨¡å‹**ï¼šBGEä¸­æ–‡å‘é‡æ¨¡å‹ï¼ˆæœ¬åœ°éƒ¨ç½²ï¼‰
- **å‘é‡æ•°æ®åº“**ï¼šFaissï¼ˆçº¯Java/JNIï¼‰æˆ–å†…å­˜å­˜å‚¨
- **æ¨ç†å¼•æ“**ï¼šONNX Runtime Java

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åˆåŒå®¡æŸ¥ç³»ç»Ÿ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è§„åˆ™å‘é‡åŒ–ï¼ˆç¦»çº¿ï¼‰                            â”‚
â”‚     â”œâ”€ åŠ è½½rules.xlsx                           â”‚
â”‚     â”œâ”€ è§„åˆ™æ–‡æœ¬ â†’ BGEå‘é‡æ¨¡å‹ â†’ 768ç»´å‘é‡        â”‚
â”‚     â””â”€ ä¿å­˜åˆ°rules_vectors.bin                  â”‚
â”‚                                                  â”‚
â”‚  2. æ¡æ¬¾å‘é‡åŒ–ï¼ˆåœ¨çº¿ï¼‰                            â”‚
â”‚     â”œâ”€ åˆåŒè§£æ â†’ æ¡æ¬¾åˆ—è¡¨                       â”‚
â”‚     â”œâ”€ æ¡æ¬¾æ–‡æœ¬ â†’ BGEå‘é‡æ¨¡å‹ â†’ 768ç»´å‘é‡        â”‚
â”‚     â””â”€ ä¸´æ—¶å­˜å‚¨åœ¨å†…å­˜                            â”‚
â”‚                                                  â”‚
â”‚  3. å‘é‡å¬å›                                     â”‚
â”‚     â”œâ”€ è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦                            â”‚
â”‚     â”œâ”€ Top-Kç­›é€‰ï¼ˆK=5ï¼‰                          â”‚
â”‚     â””â”€ é˜ˆå€¼è¿‡æ»¤ï¼ˆ>0.7ï¼‰                          â”‚
â”‚                                                  â”‚
â”‚  4. ç»“æœèåˆ                                     â”‚
â”‚     â”œâ”€ å‘é‡ç›¸ä¼¼åº¦ Ã— 0.7                          â”‚
â”‚     â”œâ”€ å…³é”®è¯åŒ¹é… Ã— 0.3                          â”‚
â”‚     â””â”€ ç»¼åˆæ’åº                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€å¤–éƒ¨ä¾èµ–
- âœ… å“åº”é€Ÿåº¦å¿«ï¼ˆ<50msï¼‰
- âœ… éƒ¨ç½²ç®€å•
- âœ… æ•°æ®éšç§å®‰å…¨

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ¨¡å‹è¾ƒå¤§ï¼ˆ~400MBï¼‰
- âš ï¸ é¦–æ¬¡åŠ è½½æ…¢ï¼ˆ~3ç§’ï¼‰

---

### æ–¹æ¡ˆBï¼šäº‘æœåŠ¡æ–¹æ¡ˆï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

**æŠ€æœ¯æ ˆ**ï¼š
- **å‘é‡åŒ–æœåŠ¡**ï¼šé˜¿é‡Œäº‘DashScope Embedding API
- **å‘é‡æ•°æ®åº“**ï¼šMilvus / Elasticsearch
- **ç¼“å­˜**ï¼šRedis

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åˆåŒå®¡æŸ¥ç³»ç»Ÿ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è§„åˆ™å‘é‡åŒ–ï¼ˆç¦»çº¿ï¼‰                            â”‚
â”‚     â”œâ”€ è§„åˆ™æ–‡æœ¬ â†’ DashScope API                 â”‚
â”‚     â”œâ”€ æ‰¹é‡è·å–å‘é‡                              â”‚
â”‚     â””â”€ å­˜å‚¨åˆ°Milvuså‘é‡åº“                        â”‚
â”‚                                                  â”‚
â”‚  2. æ¡æ¬¾å‘é‡åŒ–ï¼ˆåœ¨çº¿ï¼‰                            â”‚
â”‚     â”œâ”€ æ¡æ¬¾æ–‡æœ¬ â†’ DashScope API                 â”‚
â”‚     â”œâ”€ è·å–å‘é‡ï¼ˆå¸¦ç¼“å­˜ï¼‰                         â”‚
â”‚     â””â”€ Redisç¼“å­˜å‘é‡                             â”‚
â”‚                                                  â”‚
â”‚  3. å‘é‡å¬å›                                     â”‚
â”‚     â”œâ”€ Milvusç›¸ä¼¼åº¦æœç´¢                          â”‚
â”‚     â”œâ”€ Top-Kç­›é€‰                                 â”‚
â”‚     â””â”€ é˜ˆå€¼è¿‡æ»¤                                  â”‚
â”‚                                                  â”‚
â”‚  4. ç»“æœè¿”å›                                     â”‚
â”‚     â””â”€ åŒ¹é…çš„è§„åˆ™åˆ—è¡¨                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ¨¡å‹è´¨é‡é«˜
- âœ… æ— éœ€æœ¬åœ°éƒ¨ç½²æ¨¡å‹
- âœ… æ‰©å±•æ€§å¥½
- âœ… ç»´æŠ¤æˆæœ¬ä½

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦å¤–ç½‘è®¿é—®
- âš ï¸ APIè°ƒç”¨æˆæœ¬
- âš ï¸ å“åº”å»¶è¿Ÿï¼ˆ~200msï¼‰

---

### æ–¹æ¡ˆCï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€æ¨èï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šæœ¬åœ°æ¨¡å‹ + äº‘ç«¯å¢å¼º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ··åˆå‘é‡å¬å›                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è§„åˆ™å‘é‡åŒ–                                   â”‚
â”‚     â”œâ”€ ç¦»çº¿ï¼šDashScope APIç”Ÿæˆé«˜è´¨é‡å‘é‡         â”‚
â”‚     â””â”€ åœ¨çº¿ï¼šæœ¬åœ°è½»é‡æ¨¡å‹å¤‡ç”¨                    â”‚
â”‚                                                  â”‚
â”‚  2. æ¡æ¬¾å‘é‡åŒ–                                   â”‚
â”‚     â”œâ”€ ä¼˜å…ˆï¼šæœ¬åœ°ONNXæ¨¡å‹ï¼ˆå¿«é€Ÿï¼‰                â”‚
â”‚     â”œâ”€ é™çº§ï¼šAPIè°ƒç”¨ï¼ˆç½‘ç»œæ•…éšœæ—¶ï¼‰               â”‚
â”‚     â””â”€ ç¼“å­˜ï¼šRediså­˜å‚¨å¸¸è§æ¡æ¬¾å‘é‡               â”‚
â”‚                                                  â”‚
â”‚  3. å‘é‡æ£€ç´¢                                     â”‚
â”‚     â”œâ”€ å°è§„æ¨¡ï¼ˆ<1000è§„åˆ™ï¼‰ï¼šå†…å­˜è®¡ç®—             â”‚
â”‚     â””â”€ å¤§è§„æ¨¡ï¼šMilvuså‘é‡åº“                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» å…·ä½“å®ç°æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆA - æ¨èå¿«é€Ÿå®ç°ï¼‰

### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ Mavenä¾èµ–

```xml
<!-- pom.xml -->
<dependencies>
    <!-- ONNX Runtime for Java (è¿è¡Œå‘é‡æ¨¡å‹) -->
    <dependency>
        <groupId>com.microsoft.onnxruntime</groupId>
        <artifactId>onnxruntime</artifactId>
        <version>1.16.3</version>
    </dependency>
    
    <!-- DJL (Deep Java Library) - å¯é€‰ï¼Œæä¾›æ›´å‹å¥½çš„API -->
    <dependency>
        <groupId>ai.djl</groupId>
        <artifactId>api</artifactId>
        <version>0.25.0</version>
    </dependency>
    <dependency>
        <groupId>ai.djl.huggingface</groupId>
        <artifactId>tokenizers</artifactId>
        <version>0.25.0</version>
    </dependency>
    
    <!-- ND4J (å‘é‡è¿ç®—åº“) -->
    <dependency>
        <groupId>org.nd4j</groupId>
        <artifactId>nd4j-native-platform</artifactId>
        <version>1.0.0-M2.1</version>
    </dependency>
</dependencies>
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå‘é‡åŒ–æœåŠ¡

**VectorEmbeddingService.java**ï¼š
```java
package com.example.Contract_review.service;

import ai.onnxruntime.*;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.*;

/**
 * å‘é‡åµŒå…¥æœåŠ¡
 * 
 * ä½¿ç”¨BGEä¸­æ–‡å‘é‡æ¨¡å‹å°†æ–‡æœ¬è½¬æ¢ä¸º768ç»´å‘é‡
 */
@Slf4j
@Service
public class VectorEmbeddingService {
    
    private OrtEnvironment env;
    private OrtSession session;
    private SimpleTokenizer tokenizer;
    
    // BGEæ¨¡å‹é…ç½®
    private static final int MAX_LENGTH = 512;
    private static final int VECTOR_DIM = 768;
    
    @PostConstruct
    public void init() {
        try {
            log.info("=== åˆå§‹åŒ–å‘é‡æ¨¡å‹ ===");
            
            // 1. åŠ è½½ONNXç¯å¢ƒ
            env = OrtEnvironment.getEnvironment();
            
            // 2. åŠ è½½æ¨¡å‹æ–‡ä»¶
            Path modelPath = Paths.get("models/bge-base-zh-v1.5.onnx");
            OrtSession.SessionOptions options = new OrtSession.SessionOptions();
            session = env.createSession(modelPath.toString(), options);
            
            // 3. åˆå§‹åŒ–åˆ†è¯å™¨
            tokenizer = new SimpleTokenizer();
            
            log.info("âœ“ å‘é‡æ¨¡å‹åŠ è½½æˆåŠŸï¼šç»´åº¦={}", VECTOR_DIM);
        } catch (Exception e) {
            log.error("âœ— å‘é‡æ¨¡å‹åŠ è½½å¤±è´¥", e);
        }
    }
    
    /**
     * æ–‡æœ¬è½¬å‘é‡
     * 
     * @param text è¾“å…¥æ–‡æœ¬
     * @return 768ç»´å‘é‡
     */
    public float[] textToVector(String text) {
        if (text == null || text.isEmpty()) {
            return new float[VECTOR_DIM];
        }
        
        try {
            // 1. åˆ†è¯
            List<Long> inputIds = tokenizer.tokenize(text, MAX_LENGTH);
            
            // 2. æ„é€ ONNXè¾“å…¥
            long[] shape = {1, inputIds.size()};
            long[] inputArray = inputIds.stream().mapToLong(Long::longValue).toArray();
            OnnxTensor inputTensor = OnnxTensor.createTensor(env, inputArray, shape);
            
            // 3. æ¨¡å‹æ¨ç†
            Map<String, OnnxTensor> inputs = new HashMap<>();
            inputs.put("input_ids", inputTensor);
            
            OrtSession.Result result = session.run(inputs);
            
            // 4. æå–å‘é‡ï¼ˆå–[CLS] tokençš„è¾“å‡ºï¼‰
            float[][] output = (float[][]) result.get(0).getValue();
            float[] vector = output[0];
            
            // 5. L2å½’ä¸€åŒ–
            return normalizeVector(vector);
            
        } catch (Exception e) {
            log.error("æ–‡æœ¬å‘é‡åŒ–å¤±è´¥ï¼š{}", text.substring(0, Math.min(50, text.length())), e);
            return new float[VECTOR_DIM];
        }
    }
    
    /**
     * L2å½’ä¸€åŒ–
     */
    private float[] normalizeVector(float[] vector) {
        float norm = 0;
        for (float v : vector) {
            norm += v * v;
        }
        norm = (float) Math.sqrt(norm);
        
        if (norm > 0) {
            for (int i = 0; i < vector.length; i++) {
                vector[i] /= norm;
            }
        }
        return vector;
    }
    
    /**
     * è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
     */
    public float cosineSimilarity(float[] vec1, float[] vec2) {
        if (vec1.length != vec2.length) {
            throw new IllegalArgumentException("å‘é‡ç»´åº¦ä¸åŒ¹é…");
        }
        
        float dotProduct = 0;
        for (int i = 0; i < vec1.length; i++) {
            dotProduct += vec1[i] * vec2[i];
        }
        
        // å·²ç»L2å½’ä¸€åŒ–ï¼Œç‚¹ç§¯å³ä¸ºä½™å¼¦ç›¸ä¼¼åº¦
        return dotProduct;
    }
    
    /**
     * æ‰¹é‡æ–‡æœ¬è½¬å‘é‡
     */
    public Map<String, float[]> batchTextToVector(List<String> texts) {
        Map<String, float[]> vectors = new HashMap<>();
        for (String text : texts) {
            vectors.put(text, textToVector(text));
        }
        return vectors;
    }
    
    @PreDestroy
    public void cleanup() {
        try {
            if (session != null) {
                session.close();
            }
            if (env != null) {
                env.close();
            }
            log.info("å‘é‡æ¨¡å‹èµ„æºå·²é‡Šæ”¾");
        } catch (Exception e) {
            log.error("é‡Šæ”¾æ¨¡å‹èµ„æºå¤±è´¥", e);
        }
    }
    
    /**
     * ç®€å•åˆ†è¯å™¨ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨Transformersåˆ†è¯å™¨ï¼‰
     */
    static class SimpleTokenizer {
        private static final int CLS_TOKEN_ID = 101;
        private static final int SEP_TOKEN_ID = 102;
        
        public List<Long> tokenize(String text, int maxLength) {
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”ä½¿ç”¨HuggingFace Tokenizer
            List<Long> tokens = new ArrayList<>();
            tokens.add((long) CLS_TOKEN_ID);
            
            // ç®€å•å­—ç¬¦çº§åˆ†è¯
            for (char c : text.toCharArray()) {
                if (tokens.size() >= maxLength - 1) break;
                tokens.add((long) (c % 21128)); // ç®€åŒ–å¤„ç†
            }
            
            tokens.add((long) SEP_TOKEN_ID);
            return tokens;
        }
    }
}
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºå‘é‡è§„åˆ™å­˜å‚¨æœåŠ¡

**VectorRuleStorageService.java**ï¼š
```java
package com.example.Contract_review.service;

import com.example.Contract_review.model.ReviewRule;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;
import java.io.*;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

/**
 * å‘é‡è§„åˆ™å­˜å‚¨æœåŠ¡
 * 
 * ç®¡ç†è§„åˆ™çš„å‘é‡è¡¨ç¤ºï¼Œæ”¯æŒç¦»çº¿å‘é‡åŒ–å’ŒæŒä¹…åŒ–
 */
@Slf4j
@Service
public class VectorRuleStorageService {
    
    @Autowired
    private VectorEmbeddingService embeddingService;
    
    @Autowired
    private ReviewRulesService reviewRulesService;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    // è§„åˆ™å‘é‡ç¼“å­˜ï¼šruleId -> vector
    private Map<String, float[]> ruleVectors = new ConcurrentHashMap<>();
    
    // è§„åˆ™å…ƒæ•°æ®ç¼“å­˜ï¼šruleId -> rule
    private Map<String, ReviewRule> ruleMetadata = new ConcurrentHashMap<>();
    
    private static final String VECTOR_CACHE_PATH = "cache/rule_vectors.json";
    
    @PostConstruct
    public void init() {
        try {
            log.info("=== åˆå§‹åŒ–è§„åˆ™å‘é‡åº“ ===");
            
            // 1. å°è¯•åŠ è½½ç¼“å­˜
            if (loadVectorsFromCache()) {
                log.info("âœ“ ä»ç¼“å­˜åŠ è½½ {} ä¸ªè§„åˆ™å‘é‡", ruleVectors.size());
                return;
            }
            
            // 2. ç¦»çº¿å‘é‡åŒ–æ‰€æœ‰è§„åˆ™
            vectorizeAllRules();
            
            // 3. ä¿å­˜åˆ°ç¼“å­˜
            saveVectorsToCache();
            
        } catch (Exception e) {
            log.error("åˆå§‹åŒ–è§„åˆ™å‘é‡åº“å¤±è´¥", e);
        }
    }
    
    /**
     * ç¦»çº¿å‘é‡åŒ–æ‰€æœ‰è§„åˆ™
     */
    public void vectorizeAllRules() {
        log.info("å¼€å§‹ç¦»çº¿å‘é‡åŒ–è§„åˆ™...");
        long startTime = System.currentTimeMillis();
        
        List<ReviewRule> rules = reviewRulesService.loadRules();
        int successCount = 0;
        
        for (ReviewRule rule : rules) {
            try {
                // æ„é€ è§„åˆ™æ–‡æœ¬ï¼ˆç»„åˆå¤šä¸ªå­—æ®µï¼‰
                String ruleText = buildRuleText(rule);
                
                // å‘é‡åŒ–
                float[] vector = embeddingService.textToVector(ruleText);
                
                // å­˜å‚¨
                ruleVectors.put(rule.getId(), vector);
                ruleMetadata.put(rule.getId(), rule);
                
                successCount++;
                
                if (successCount % 10 == 0) {
                    log.debug("å·²å‘é‡åŒ– {} ä¸ªè§„åˆ™", successCount);
                }
            } catch (Exception e) {
                log.error("è§„åˆ™å‘é‡åŒ–å¤±è´¥ï¼š{}", rule.getId(), e);
            }
        }
        
        long duration = System.currentTimeMillis() - startTime;
        log.info("âœ“ è§„åˆ™å‘é‡åŒ–å®Œæˆï¼šæˆåŠŸ {}/{} ä¸ªï¼Œè€—æ—¶ {}ms",
                successCount, rules.size(), duration);
    }
    
    /**
     * æ„é€ è§„åˆ™æ–‡æœ¬ï¼ˆç”¨äºå‘é‡åŒ–ï¼‰
     */
    private String buildRuleText(ReviewRule rule) {
        StringBuilder text = new StringBuilder();
        
        // 1. æ ‡é¢˜
        if (rule.getTitle() != null) {
            text.append(rule.getTitle()).append(" ");
        }
        
        // 2. æ£€æŸ¥è¦ç‚¹
        if (rule.getChecklist() != null) {
            text.append(rule.getChecklist()).append(" ");
        }
        
        // 3. å…³é”®è¯ï¼ˆä½œä¸ºè¡¥å……ï¼‰
        if (rule.getKeywords() != null) {
            text.append(rule.getKeywords()).append(" ");
        }
        
        // 4. é£é™©ç­‰çº§æ ‡ç­¾
        text.append("é£é™©ç­‰çº§:").append(rule.getRisk());
        
        return text.toString().trim();
    }
    
    /**
     * å‘é‡å¬å›ï¼šæŸ¥æ‰¾æœ€ç›¸ä¼¼çš„è§„åˆ™
     * 
     * @param clauseText æ¡æ¬¾æ–‡æœ¬
     * @param topK è¿”å›Top-Kä¸ªæœ€ç›¸ä¼¼çš„è§„åˆ™
     * @param threshold ç›¸ä¼¼åº¦é˜ˆå€¼
     * @return åŒ¹é…çš„è§„åˆ™åˆ—è¡¨ï¼ˆæŒ‰ç›¸ä¼¼åº¦é™åºï¼‰
     */
    public List<RuleMatchResult> vectorRecall(String clauseText, int topK, float threshold) {
        // 1. æ¡æ¬¾å‘é‡åŒ–
        float[] clauseVector = embeddingService.textToVector(clauseText);
        
        // 2. è®¡ç®—æ‰€æœ‰è§„åˆ™çš„ç›¸ä¼¼åº¦
        List<RuleMatchResult> results = new ArrayList<>();
        
        for (Map.Entry<String, float[]> entry : ruleVectors.entrySet()) {
            String ruleId = entry.getKey();
            float[] ruleVector = entry.getValue();
            
            // è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
            float similarity = embeddingService.cosineSimilarity(clauseVector, ruleVector);
            
            // è¿‡æ»¤ä½äºé˜ˆå€¼çš„
            if (similarity >= threshold) {
                ReviewRule rule = ruleMetadata.get(ruleId);
                RuleMatchResult result = new RuleMatchResult();
                result.setRule(rule);
                result.setSimilarity(similarity);
                results.add(result);
            }
        }
        
        // 3. æŒ‰ç›¸ä¼¼åº¦é™åºæ’åº
        results.sort((a, b) -> Float.compare(b.getSimilarity(), a.getSimilarity()));
        
        // 4. è¿”å›Top-K
        return results.subList(0, Math.min(topK, results.size()));
    }
    
    /**
     * ä»ç¼“å­˜åŠ è½½å‘é‡
     */
    private boolean loadVectorsFromCache() {
        try {
            Path cachePath = Paths.get(VECTOR_CACHE_PATH);
            if (!Files.exists(cachePath)) {
                return false;
            }
            
            String json = Files.readString(cachePath);
            VectorCache cache = objectMapper.readValue(json, VectorCache.class);
            
            ruleVectors = cache.getVectors();
            
            // é‡æ–°åŠ è½½è§„åˆ™å…ƒæ•°æ®
            List<ReviewRule> rules = reviewRulesService.loadRules();
            for (ReviewRule rule : rules) {
                ruleMetadata.put(rule.getId(), rule);
            }
            
            return true;
        } catch (Exception e) {
            log.warn("åŠ è½½å‘é‡ç¼“å­˜å¤±è´¥ï¼š{}", e.getMessage());
            return false;
        }
    }
    
    /**
     * ä¿å­˜å‘é‡åˆ°ç¼“å­˜
     */
    private void saveVectorsToCache() {
        try {
            Path cachePath = Paths.get(VECTOR_CACHE_PATH);
            Files.createDirectories(cachePath.getParent());
            
            VectorCache cache = new VectorCache();
            cache.setVectors(ruleVectors);
            cache.setTimestamp(System.currentTimeMillis());
            
            String json = objectMapper.writeValueAsString(cache);
            Files.writeString(cachePath, json);
            
            log.info("âœ“ å‘é‡ç¼“å­˜å·²ä¿å­˜ï¼š{}", cachePath);
        } catch (Exception e) {
            log.error("ä¿å­˜å‘é‡ç¼“å­˜å¤±è´¥", e);
        }
    }
    
    /**
     * å‘é‡ç¼“å­˜æ•°æ®ç»“æ„
     */
    @Data
    static class VectorCache {
        private Map<String, float[]> vectors;
        private long timestamp;
    }
    
    /**
     * è§„åˆ™åŒ¹é…ç»“æœ
     */
    @Data
    public static class RuleMatchResult {
        private ReviewRule rule;
        private float similarity;  // ç›¸ä¼¼åº¦åˆ†æ•°
    }
}
```

### ç¬¬å››æ­¥ï¼šä¿®æ”¹è§„åˆ™åŒ¹é…æœåŠ¡

**QwenRuleReviewService.javaï¼ˆå¢å¼ºç‰ˆï¼‰**ï¼š
```java
/**
 * å‘é‡å¬å› + å…³é”®è¯åŒ¹é…æ··åˆæ–¹æ¡ˆ
 */
public List<RuleMatchResult> matchRulesWithVector(ParseResult parseResult, String stance) {
    log.info("=== æ··åˆè§„åˆ™åŒ¹é…ï¼ˆå‘é‡+å…³é”®è¯ï¼‰ ===");
    
    List<RuleMatchResult> allMatches = new ArrayList<>();
    
    for (Clause clause : parseResult.getClauses()) {
        // 1. å‘é‡å¬å›ï¼ˆå 70%æƒé‡ï¼‰
        List<VectorRuleStorageService.RuleMatchResult> vectorMatches = 
            vectorRuleStorage.vectorRecall(clause.getFullText(), 5, 0.7f);
        
        for (VectorRuleStorageService.RuleMatchResult match : vectorMatches) {
            RuleMatchResult result = new RuleMatchResult();
            result.setClauseId(clause.getId());
            result.setAnchorId(clause.getAnchorId());
            result.setClauseText(clause.getFullText());
            result.setMatchedRule(match.getRule());
            result.setScore(match.getSimilarity() * 0.7f);  // å‘é‡ç›¸ä¼¼åº¦ Ã— 0.7
            result.setMatchType("VECTOR");
            allMatches.add(result);
        }
        
        // 2. å…³é”®è¯åŒ¹é…ï¼ˆå 30%æƒé‡ï¼‰
        List<ReviewRule> keywordMatches = reviewRulesService.matchRulesForClause(
            clause.getFullText(), parseResult.getContractType());
        
        for (ReviewRule rule : keywordMatches) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å‘é‡å¬å›
            boolean alreadyMatched = allMatches.stream()
                .anyMatch(m -> m.getMatchedRule().getId().equals(rule.getId()) 
                            && m.getClauseId().equals(clause.getId()));
            
            if (alreadyMatched) {
                // æå‡å·²åŒ¹é…è§„åˆ™çš„åˆ†æ•°
                allMatches.stream()
                    .filter(m -> m.getMatchedRule().getId().equals(rule.getId()))
                    .forEach(m -> m.setScore(m.getScore() + 0.3f));  // +å…³é”®è¯æƒé‡
            } else {
                // æ–°å¢å…³é”®è¯åŒ¹é…çš„è§„åˆ™
                RuleMatchResult result = new RuleMatchResult();
                result.setClauseId(clause.getId());
                result.setMatchedRule(rule);
                result.setScore(0.3f);  // ä»…å…³é”®è¯åŒ¹é…
                result.setMatchType("KEYWORD");
                allMatches.add(result);
            }
        }
    }
    
    // 3. æŒ‰åˆ†æ•°é™åºæ’åºï¼Œè¿‡æ»¤ä½åˆ†åŒ¹é…
    allMatches.sort((a, b) -> Float.compare(b.getScore(), a.getScore()));
    
    return allMatches.stream()
        .filter(m -> m.getScore() >= 0.5f)  // æ€»åˆ†é˜ˆå€¼
        .collect(Collectors.toList());
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”é¢„ä¼°

### åŒ¹é…å‡†ç¡®ç‡

| åœºæ™¯ | å…³é”®è¯åŒ¹é… | å‘é‡å¬å› | æå‡ |
|-----|-----------|---------|------|
| **åŒä¹‰è¯è¯†åˆ«** | 30% | 85% | **+55%** |
| **è¯­ä¹‰ç†è§£** | 40% | 90% | **+50%** |
| **é•¿æ–‡æœ¬åŒ¹é…** | 60% | 88% | **+28%** |
| **ç»¼åˆå‡†ç¡®ç‡** | 50% | 87% | **+37%** |

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å…³é”®è¯åŒ¹é… | å‘é‡å¬å›ï¼ˆæ–¹æ¡ˆAï¼‰ | å‘é‡å¬å›ï¼ˆæ–¹æ¡ˆBï¼‰ |
|-----|-----------|-----------------|-----------------|
| **åˆå§‹åŒ–æ—¶é—´** | <1s | ~3sï¼ˆæ¨¡å‹åŠ è½½ï¼‰ | <1s |
| **å•æ¡æ¬¾åŒ¹é…** | ~5ms | ~15ms | ~50ms |
| **100æ¡æ¬¾åˆåŒ** | ~500ms | ~1.5s | ~5s |
| **å†…å­˜å ç”¨** | ~50MB | ~500MB | ~100MB |
| **å¬å›ç‡** | 60% | 90% | 90% |
| **å‡†ç¡®ç‡** | 70% | 85% | 88% |

---

## ğŸš€ å®æ–½æ­¥éª¤ï¼ˆåˆ†é˜¶æ®µï¼‰

### é˜¶æ®µ1ï¼šéªŒè¯å¯è¡Œæ€§ï¼ˆ1å‘¨ï¼‰

**ç›®æ ‡**ï¼šå¿«é€ŸéªŒè¯å‘é‡å¬å›æ•ˆæœ

**æ­¥éª¤**ï¼š
1. âœ… é€‰æ‹©5-10æ¡å…¸å‹è§„åˆ™
2. âœ… æ‰‹åŠ¨å‡†å¤‡æµ‹è¯•é›†ï¼ˆ20ä¸ªæ¡æ¬¾ï¼‰
3. âœ… ä½¿ç”¨DashScope APIè¿›è¡Œå‘é‡åŒ–æµ‹è¯•
4. âœ… å¯¹æ¯”å…³é”®è¯åŒ¹é…vså‘é‡å¬å›æ•ˆæœ
5. âœ… è¯„ä¼°æ˜¯å¦å€¼å¾—ç»§ç»­æŠ•å…¥

**äº¤ä»˜ç‰©**ï¼š
- æµ‹è¯•æŠ¥å‘Š.md
- å‡†ç¡®ç‡å¯¹æ¯”æ•°æ®

---

### é˜¶æ®µ2ï¼šåŸå‹å¼€å‘ï¼ˆ2å‘¨ï¼‰

**ç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„å‘é‡å¬å›åŠŸèƒ½

**æ­¥éª¤**ï¼š
1. âœ… æ·»åŠ Mavenä¾èµ–
2. âœ… å®ç°VectorEmbeddingService
3. âœ… å®ç°VectorRuleStorageService
4. âœ… ä¿®æ”¹QwenRuleReviewService
5. âœ… å•å…ƒæµ‹è¯•
6. âœ… é›†æˆæµ‹è¯•

**äº¤ä»˜ç‰©**ï¼š
- å®Œæ•´ä»£ç 
- å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡>80%ï¼‰
- APIæ–‡æ¡£

---

### é˜¶æ®µ3ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰

**ç›®æ ‡**ï¼šä¼˜åŒ–æ€§èƒ½ï¼Œæ»¡è¶³ç”Ÿäº§è¦æ±‚

**æ­¥éª¤**ï¼š
1. âœ… å‘é‡ç¼“å­˜ä¼˜åŒ–
2. âœ… æ‰¹é‡æ¨ç†ä¼˜åŒ–
3. âœ… å†…å­˜å ç”¨ä¼˜åŒ–
4. âœ… å¹¶å‘å¤„ç†ä¼˜åŒ–
5. âœ… æ€§èƒ½æµ‹è¯•

**ç›®æ ‡æŒ‡æ ‡**ï¼š
- 100æ¡æ¬¾åˆåŒåŒ¹é… < 2ç§’
- å†…å­˜å ç”¨ < 600MB
- å¬å›ç‡ > 85%
- å‡†ç¡®ç‡ > 80%

---

### é˜¶æ®µ4ï¼šç”Ÿäº§éƒ¨ç½²ï¼ˆ1å‘¨ï¼‰

**ç›®æ ‡**ï¼šå¹³æ»‘ä¸Šçº¿ï¼Œå…¼å®¹æ—§ç‰ˆæœ¬

**æ­¥éª¤**ï¼š
1. âœ… é…ç½®å¼€å…³ï¼ˆæ”¯æŒå…³é”®è¯/å‘é‡/æ··åˆæ¨¡å¼ï¼‰
2. âœ… ç°åº¦å‘å¸ƒ
3. âœ… ç›‘æ§å‘Šè­¦
4. âœ… A/Bæµ‹è¯•
5. âœ… æ–‡æ¡£æ›´æ–°

**é…ç½®ç¤ºä¾‹**ï¼š
```properties
# application.properties
# è§„åˆ™åŒ¹é…æ¨¡å¼ï¼šKEYWORD|VECTOR|HYBRID
review.match-mode=HYBRID

# å‘é‡å¬å›å‚æ•°
review.vector.topk=5
review.vector.threshold=0.7
review.vector.weight=0.7

# å…³é”®è¯åŒ¹é…æƒé‡
review.keyword.weight=0.3
```

---

## ğŸ’¡ å¿«é€Ÿå¼€å§‹ï¼ˆæœ€å°å¯è¡Œæ–¹æ¡ˆï¼‰

å¦‚æœæ‚¨æƒ³å¿«é€ŸéªŒè¯ï¼Œæˆ‘å»ºè®®å…ˆç”¨**DashScope Embedding API**æµ‹è¯•ï¼š

```java
/**
 * ä½¿ç”¨DashScope APIçš„ç®€åŒ–ç‰ˆæœ¬ï¼ˆæ— éœ€æœ¬åœ°æ¨¡å‹ï¼‰
 */
@Service
public class DashScopeVectorService {
    
    @Value("${qwen.api-key}")
    private String apiKey;
    
    public float[] textToVector(String text) {
        // è°ƒç”¨DashScope Embedding API
        String url = "https://dashscope.aliyuncs.com/api/v1/services/embeddings/text-embedding/text-embedding";
        
        HttpRequest request = HttpRequest.newBuilder()
            .uri(URI.create(url))
            .header("Authorization", "Bearer " + apiKey)
            .header("Content-Type", "application/json")
            .POST(HttpRequest.BodyPublishers.ofString(buildRequestBody(text)))
            .build();
        
        HttpResponse<String> response = HttpClient.newHttpClient()
            .send(request, HttpResponse.BodyHandlers.ofString());
        
        // è§£æå‘é‡
        return parseVector(response.body());
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€ä¸‹è½½æ¨¡å‹
- âœ… ä»£ç é‡å°‘ï¼ˆ<100è¡Œï¼‰
- âœ… å¿«é€ŸéªŒè¯æ•ˆæœ

---

## ğŸ“‹ æ€»ç»“å¯¹æ¯”

| æ–¹æ¡ˆ | å¼€å‘éš¾åº¦ | å“åº”é€Ÿåº¦ | å‡†ç¡®ç‡ | æˆæœ¬ | æ¨èåœºæ™¯ |
|-----|---------|---------|--------|------|---------|
| **æ–¹æ¡ˆAï¼šæœ¬åœ°ONNX** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | ä½ | æ•°æ®æ•æ„Ÿã€é«˜å¹¶å‘ |
| **æ–¹æ¡ˆBï¼šäº‘æœåŠ¡** | â­â­ | â­â­â­ | â­â­â­â­â­ | ä¸­ | å¿«é€Ÿä¸Šçº¿ |
| **æ–¹æ¡ˆCï¼šæ··åˆæ–¹æ¡ˆ** | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | ä¸­ | ç”Ÿäº§ç¯å¢ƒ |

---

## ğŸ¯ æˆ‘çš„å»ºè®®

**ç¬¬ä¸€æ­¥**ï¼ˆæœ¬å‘¨ï¼‰ï¼šä½¿ç”¨**DashScope API**å¿«é€ŸéªŒè¯æ•ˆæœ
**ç¬¬äºŒæ­¥**ï¼ˆä¸‹å‘¨ï¼‰ï¼šå¦‚æœæ•ˆæœå¥½ï¼Œå®ç°**æ–¹æ¡ˆCæ··åˆæ–¹æ¡ˆ**
**ç¬¬ä¸‰æ­¥**ï¼ˆä¸‹æœˆï¼‰ï¼šæ ¹æ®ä½¿ç”¨æƒ…å†µå†³å®šæ˜¯å¦æ›¿æ¢ä¸ºæœ¬åœ°æ¨¡å‹

éœ€è¦æˆ‘å¸®æ‚¨å®ç°å“ªä¸ªæ–¹æ¡ˆçš„è¯¦ç»†ä»£ç ï¼Ÿ

