# 快速诊断测试指南

## 已完成的修改

1. ✅ 修复了 OPCPackage 未关闭的问题
2. ✅ 改进了 Run 分割时的索引计算
3. ✅ **添加了全面的维测日志用于诊断**

## 下一步：运行测试并收集日志

### 1. 启动应用
确保你的Spring Boot应用已启动在 `localhost:8080`

### 2. 上传长文档并执行一键审查
- 打开应用
- 上传一个50-100页的长合同文档
- 选择"一键审查"功能
- 等待审查完成

### 3. 观察日志输出

在控制台中寻找以下关键日志段落（都以 `【维测】` 开头）：

#### 段落 1：document.xml 批注标记验证
```
【维测】document.xml保存后诊断：commentRangeStart数量=X, commentRangeEnd数量=X, commentReference数量=X
【维测】commentRangeStart IDs: [...]
【维测】commentRangeEnd IDs: [...]
【维测】commentReference IDs: [...]
```

**预期**：三种标记的数量应该相同，都等于审查问题数量

#### 段落 2：comments.xml 内容验证
```
【维测】保存comments.xml前诊断：根元素=comments, 批注数量=X, 已添加批注ID=[...]
【维测】批注ID=1, 内容预览(总长度=YYY): <w:comment...
【维测】批注ID=2, 内容预览(总长度=YYY): <w:comment...
...
```

**预期**：批注数量应该等于审查问题数量，且应该有实际内容

#### 段落 3：comments.xml 保存验证
```
【维测】comments.xml保存后验证：文件是否存在于OPCPackage中
【维测】comments.xml在OPCPackage中，大小: XXXX 字节
```

**预期**：应该显示成功且文件大小 > 500字节

#### 段落 4：关系文件验证
```
【维测】已添加comments关系到document.xml.rels
【维测】document.xml.rels中总关系数: X
【维测】关系: Id=rComments, Target=comments.xml
```

**预期**：应该看到 rComments 关系

#### 段落 5：最终保存验证
```
【维测】OPCPackage保存后诊断：
【维测】✓ comments.xml在OPCPackage中，大小: XXXX 字节
【维测】comments.xml内容预览(前200字符): <?xml...
【维测】✓ document.xml在OPCPackage中，大小: XXXX 字节
【维测】OPCPackage已关闭
```

**预期**：所有项都显示✓，没有ERROR

### 4. 报告结果

请将以下内容保存并告诉我：

1. **document.xml 验证结果**
   - 三种标记数量是否一致？
   - 数量是否等于审查问题数？

2. **comments.xml 验证结果**
   - 批注数量是否正确？
   - 文件大小是否合理？

3. **最终验证结果**
   - 是否都显示✓？
   - 是否显示"OPCPackage已关闭"？

4. **任何ERROR日志**
   - 复制完整的ERROR行

## 可能的结果

### 情况 A：所有验证都✓
**说明**：一切正常，但文档中还是没有批注
**可能原因**：Word 格式问题或批注内容格式不符合 Word 标准
**下一步**：需要检查生成的 comments.xml 的具体XML结构

### 情况 B：comments.xml 数量为 0
**说明**：内存中根本没有批注数据
**可能原因**：批注未被正确添加到内存对象
**下一步**：检查 `addCommentToIssue()` 是否被调用

### 情况 C：关系文件缺少 rComments
**说明**：关系文件未被正确更新
**可能原因**：`updateDocumentRels()` 执行失败
**下一步**：检查是否有异常堆栈

### 情况 D：显示 ERROR: comments.xml 不在 OPCPackage 中
**说明**：comments.xml 未被正确写入到OPCPackage
**可能原因**：save() 操作问题或OPCPackage实现问题
**下一步**：需要改进 saveCommentsXml() 方法

## 性能提示

- 诊断日志的 INFO 级别都会被打印
- DEBUG 级别需要配置日志级别为 DEBUG 才能看到
- 长文档处理可能需要 1-2 分钟，请耐心等待

准备好了吗？现在开始测试，然后告诉我看到了哪种情况的日志！
