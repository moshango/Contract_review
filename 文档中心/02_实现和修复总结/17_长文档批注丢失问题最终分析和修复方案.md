# ğŸ¯ é•¿æ–‡æ¡£æ‰¹æ³¨ä¸¢å¤±é—®é¢˜ - æœ€ç»ˆåˆ†æå’Œä¿®å¤æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜å¯¹æ¯”åˆ†æç»“æœ

### å…³é”®å‘ç°

é€šè¿‡å¯¹æ¯”ä¸¤ä¸ªDOCXæ–‡ä»¶ï¼ˆçŸ­æ–‡æ¡£ vs é•¿æ–‡æ¡£ï¼‰ï¼Œå‘ç°**æœ€å…³é”®çš„åŒºåˆ«**ï¼š

| æ–‡ä»¶ | çŸ­æ–‡æ¡£ï¼ˆæ­£å¸¸ï¼‰ | é•¿æ–‡æ¡£ï¼ˆå¼‚å¸¸ï¼‰ | ç»“è®º |
|------|---------------|---------------|------|
| `word/_rels/document.xml.rels` | âœ… å­˜åœ¨ (1598 å­—èŠ‚) | âŒ **ç¼ºå¤±** | **è¿™æ˜¯æ ¹æœ¬åŸå› ï¼** |
| `word/comments.xml` | âœ… å­˜åœ¨ (3258 å­—èŠ‚) | âœ… å­˜åœ¨ (4232 å­—èŠ‚) | æ‰¹æ³¨å†…å®¹æ­£å¸¸ |
| `word/document.xml` | âœ… å­˜åœ¨ (22113 å­—èŠ‚) | âœ… å­˜åœ¨ (30958 å­—èŠ‚) | æ–‡æ¡£å†…å®¹æ­£å¸¸ |
| `word/commentsExtended.xml` | âœ… å­˜åœ¨ (1392 å­—èŠ‚) | âŒ ç¼ºå¤± | æ¬¡è¦é—®é¢˜ |
| `word/people.xml` | âœ… å­˜åœ¨ (1521 å­—èŠ‚) | âŒ ç¼ºå¤± | æ¬¡è¦é—®é¢˜ |

### é—®é¢˜æ ¹å› 

**é•¿æ–‡æ¡£ç”Ÿæˆçš„DOCXæ–‡ä»¶ä¸­å®Œå…¨ç¼ºå°‘ `word/_rels/document.xml.rels` æ–‡ä»¶ï¼**

è¿™ä¸ªæ–‡ä»¶æ˜¯ Word æ–‡æ¡£ä¸­**æœ€å…³é”®çš„å…³ç³»é…ç½®æ–‡ä»¶**ï¼Œå®ƒå‘Šè¯‰ Wordï¼š
- comments.xml æ–‡ä»¶åœ¨å“ªé‡Œ
- styles.xmlã€settings.xml ç­‰æ–‡ä»¶åœ¨å“ªé‡Œ
- å„ä¸ªç»„ä»¶ä¹‹é—´çš„å…³è”å…³ç³»

**æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼ŒWord æ ¹æœ¬æ— æ³•æ‰¾åˆ°æ‰¹æ³¨å†…å®¹ï¼**

## ğŸ” ä»£ç é—®é¢˜å®šä½

### é—®é¢˜ä»£ç ï¼š`updateDocumentRels()` æ–¹æ³•

åœ¨ `WordXmlCommentProcessor.java` çš„ç¬¬ 1270-1341 è¡Œï¼š

```java
private void updateDocumentRels(OPCPackage opcPackage) throws Exception {
    PackagePartName relsPartName = PackagingURIHelper.createPartName("/word/_rels/document.xml.rels");

    try {
        PackagePart relsPart = opcPackage.getPart(relsPartName);
        
        // è¯»å–ç°æœ‰å…³ç³»
        SAXReader reader = new SAXReader();
        Document relsDoc = reader.read(relsPart.getInputStream());
        
        // ... æ›´æ–°å…³ç³» ...
        
    } catch (Exception e) {
        logger.warn("æ›´æ–°document.xml.relså¤±è´¥ï¼š{}", e.getMessage());
        
        // å°è¯•æ¢å¤æˆ–é‡æ–°åˆ›å»º
        try {
            recoverOrCreateDocumentRels(opcPackage);
        } catch (Exception recoveryEx) {
            logger.error("æ¢å¤å¤±è´¥ï¼Œæœ€åå°è¯•åˆ›å»ºåŸºæœ¬å…³ç³»æ–‡ä»¶", recoveryEx);
            createBasicDocumentRels(opcPackage);
        }
    }
}
```

### é—®é¢˜åˆ†æ

**å…³é”®é—®é¢˜**ï¼šå½“ `opcPackage.getPart(relsPartName)` å¤±è´¥æ—¶ï¼ˆå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡è¯»å–æ—¶æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œå¼‚å¸¸è¢«æ•è·ï¼Œç„¶åè°ƒç”¨ `recoverOrCreateDocumentRels()` æˆ– `createBasicDocumentRels()`ã€‚

**ä½†æ˜¯ï¼** è¿™ä¸¤ä¸ªæ¢å¤æ–¹æ³•åˆ›å»ºçš„ rels æ–‡ä»¶å¯èƒ½ï¼š
1. æ²¡æœ‰è¢«æ­£ç¡®ä¿å­˜åˆ° OPCPackage ä¸­
2. æˆ–è€…è¢«åç»­çš„ `opcPackage.save()` æ“ä½œè¦†ç›–
3. æˆ–è€…å› ä¸ºé•¿æ–‡æ¡£çš„ç‰¹æ®Šæƒ…å†µï¼Œä¿å­˜æ—¶å‡ºç°ç«æ€æ¡ä»¶

### ä¸ºä»€ä¹ˆé•¿æ–‡æ¡£ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

1. **é•¿æ–‡æ¡£çš„ OPCPackage æ“ä½œæ›´å¤æ‚**ï¼šé•¿æ–‡æ¡£æœ‰æ›´å¤šçš„ Partï¼Œåœ¨å¤„ç† document.xml æ—¶å¯èƒ½è§¦å‘æŸäº›å†…éƒ¨æ“ä½œï¼Œå½±å“äº† rels çš„ä¿å­˜
2. **OPCPackage çš„å†™ç¼“å†²åŒºé—®é¢˜**ï¼šé•¿æ–‡æ¡£æ¶‰åŠå¤§é‡çš„ XML å†™å…¥æ“ä½œï¼Œå¯èƒ½å¯¼è‡´æŸäº› Part çš„æ›´æ”¹åœ¨ flush å‰è¢«è¦†ç›–
3. **ç¼ºå°‘ OPCPackage.close()**ï¼šä¹‹å‰æˆ‘ä»¬è™½ç„¶åŠ äº† close()ï¼Œä½†å¯èƒ½åœ¨å¼‚å¸¸å¤„ç†è·¯å¾„ä¸­æ²¡æœ‰æ‰§è¡Œåˆ°

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šåœ¨ `updateDocumentRels()` ä¸­æ·»åŠ åˆ›å»ºæ£€æŸ¥ï¼ˆæ¨èï¼‰

åœ¨ try å—å¼€å§‹å‰ï¼Œå…ˆæ£€æŸ¥ rels æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å…ˆåˆ›å»ºï¼š

```java
private void updateDocumentRels(OPCPackage opcPackage) throws Exception {
    PackagePartName relsPartName = PackagingURIHelper.createPartName("/word/_rels/document.xml.rels");

    // ã€å…³é”®ä¿®å¤ã€‘å…ˆæ£€æŸ¥å¹¶ç¡®ä¿ rels æ–‡ä»¶å­˜åœ¨
    PackagePart relsPart;
    try {
        relsPart = opcPackage.getPart(relsPartName);
    } catch (Exception e) {
        // å¦‚æœä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ rels æ–‡ä»¶
        logger.info("document.xml.relsä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºåŸºæœ¬æ–‡ä»¶");
        createBasicDocumentRels(opcPackage);
        relsPart = opcPackage.getPart(relsPartName);
    }

    // è¯»å–ç°æœ‰å…³ç³»
    SAXReader reader = new SAXReader();
    Document relsDoc = reader.read(relsPart.getInputStream());
    
    // æ£€æŸ¥å¹¶æ·»åŠ  comments å…³ç³»
    Element relationships = relsDoc.getRootElement();
    boolean hasCommentsRel = false;
    
    for (Element rel : relationships.elements()) {
        String target = rel.attributeValue("Target");
        if ("comments.xml".equals(target)) {
            hasCommentsRel = true;
            break;
        }
    }
    
    if (!hasCommentsRel) {
        Element newRel = relationships.addElement("Relationship");
        newRel.addAttribute("Id", "rComments");
        newRel.addAttribute("Type",
            "http://schemas.openxmlformats.org/officeDocument/2006/relationships/comments");
        newRel.addAttribute("Target", "comments.xml");
        
        // ä¿å­˜æ›´æ–°åçš„å…³ç³»æ–‡ä»¶
        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
        XMLWriter writer = new XMLWriter(outputStream, createOutputFormat());
        writer.write(relsDoc);
        writer.close();
        
        try (var partStream = relsPart.getOutputStream()) {
            partStream.write(outputStream.toByteArray());
            partStream.flush();
        }
        
        logger.info("ã€ç»´æµ‹ã€‘å·²æ·»åŠ commentså…³ç³»åˆ°document.xml.rels");
    }
    
    // ã€ç»´æµ‹ã€‘éªŒè¯å…³ç³»
    logger.info("ã€ç»´æµ‹ã€‘document.xml.relséªŒè¯å®Œæˆ");
}
```

### æ–¹æ¡ˆ 2ï¼šæ”¹è¿› `createBasicDocumentRels()` æ–¹æ³•

ç¡®ä¿åˆ›å»ºçš„åŸºæœ¬ rels æ–‡ä»¶åŒ…å«**æ‰€æœ‰å¿…éœ€çš„å…³ç³»**ï¼Œè€Œä¸ä»…ä»…æ˜¯ commentsï¼š

```java
private void createBasicDocumentRels(OPCPackage opcPackage) throws Exception {
    PackagePartName relsPartName = PackagingURIHelper.createPartName("/word/_rels/document.xml.rels");

    // åˆ›å»ºåŸºæœ¬çš„å…³ç³»XML
    Document relsDoc = DocumentHelper.createDocument();
    Element relationships = relsDoc.addElement("Relationships");
    relationships.addNamespace("", "http://schemas.openxmlformats.org/package/2006/relationships");

    // ã€å…³é”®ä¿®å¤ã€‘æ·»åŠ æ‰€æœ‰å¿…éœ€çš„åŸºæœ¬å…³ç³»
    // 1. styles å…³ç³»
    Element stylesRel = relationships.addElement("Relationship");
    stylesRel.addAttribute("Id", "rId1");
    stylesRel.addAttribute("Type", "http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles");
    stylesRel.addAttribute("Target", "styles.xml");
    
    // 2. settings å…³ç³»
    Element settingsRel = relationships.addElement("Relationship");
    settingsRel.addAttribute("Id", "rId2");
    settingsRel.addAttribute("Type", "http://schemas.openxmlformats.org/officeDocument/2006/relationships/settings");
    settingsRel.addAttribute("Target", "settings.xml");
    
    // 3. numbering å…³ç³»
    Element numberingRel = relationships.addElement("Relationship");
    numberingRel.addAttribute("Id", "rId3");
    numberingRel.addAttribute("Type", "http://schemas.openxmlformats.org/officeDocument/2006/relationships/numbering");
    numberingRel.addAttribute("Target", "numbering.xml");
    
    // 4. comments å…³ç³»
    Element commentsRel = relationships.addElement("Relationship");
    commentsRel.addAttribute("Id", "rComments");
    commentsRel.addAttribute("Type", "http://schemas.openxmlformats.org/officeDocument/2006/relationships/comments");
    commentsRel.addAttribute("Target", "comments.xml");

    // åˆ›å»ºæˆ–è¦†ç›– Part
    PackagePart relsPart;
    try {
        relsPart = opcPackage.getPart(relsPartName);
    } catch (Exception e) {
        relsPart = opcPackage.createPart(relsPartName, 
            "application/vnd.openxmlformats-package.relationships+xml");
    }

    // ä¿å­˜
    ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
    XMLWriter writer = new XMLWriter(outputStream, createOutputFormat());
    writer.write(relsDoc);
    writer.close();

    try (var partStream = relsPart.getOutputStream()) {
        partStream.write(outputStream.toByteArray());
        partStream.flush();
    }

    logger.info("ã€ç»´æµ‹ã€‘åˆ›å»ºåŸºæœ¬document.xml.relså®Œæˆï¼ŒåŒ…å«{}ä¸ªå…³ç³»", 
                relationships.elements().size());
}
```

### æ–¹æ¡ˆ 3ï¼šåœ¨ OPCPackage ä¿å­˜åéªŒè¯

åœ¨ `annotateContractWithXml()` æ–¹æ³•çš„æœ€åï¼Œæ·»åŠ éªŒè¯é€»è¾‘ï¼š

```java
// ä¿å­˜ OPCPackage
opcPackage.save(outputStream);
logger.debug("OPCPackageä¿å­˜æˆåŠŸï¼Œå¤§å°: {} å­—èŠ‚", outputStream.size());

// ã€å…³é”®ä¿®å¤ã€‘ä¿å­˜åéªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
PackagePartName relsPartName = PackagingURIHelper.createPartName("/word/_rels/document.xml.rels");
try {
    PackagePart relsPart = opcPackage.getPart(relsPartName);
    if (relsPart == null) {
        logger.error("âŒ ERROR: OPCPackageä¿å­˜åï¼Œdocument.xml.relsä¸ºnull!");
        // ç«‹å³ä¿®å¤
        createBasicDocumentRels(opcPackage);
        // é‡æ–°ä¿å­˜
        outputStream.reset();
        opcPackage.save(outputStream);
    } else {
        logger.info("âœ“ éªŒè¯é€šè¿‡ï¼šdocument.xml.relså­˜åœ¨äºOPCPackageä¸­");
    }
} catch (Exception e) {
    logger.error("âŒ ERROR: éªŒè¯document.xml.relsæ—¶å¼‚å¸¸: {}", e.getMessage());
}
```

## ğŸ“ æ¨èçš„ä¿®å¤æ­¥éª¤

1. **é¦–å…ˆå®æ–½æ–¹æ¡ˆ 1**ï¼šåœ¨ `updateDocumentRels()` æ–¹æ³•å¼€å§‹æ—¶å°±æ£€æŸ¥å’Œåˆ›å»º rels æ–‡ä»¶
2. **ç„¶åå®æ–½æ–¹æ¡ˆ 2**ï¼šç¡®ä¿ `createBasicDocumentRels()` åŒ…å«æ‰€æœ‰å¿…éœ€çš„å…³ç³»
3. **æœ€åæ·»åŠ æ–¹æ¡ˆ 3**ï¼šåœ¨ä¿å­˜åéªŒè¯ï¼Œä½œä¸ºæœ€åçš„ä¿é™©

è¿™æ ·å¯ä»¥ç¡®ä¿æ— è®ºå‡ºç°ä»»ä½•é—®é¢˜ï¼Œ`word/_rels/document.xml.rels` æ–‡ä»¶éƒ½ä¸ä¼šä¸¢å¤±ã€‚

## ğŸ§ª æµ‹è¯•éªŒè¯

ä¿®å¤åï¼Œåº”è¯¥ï¼š
1. é‡æ–°è¿è¡Œé•¿æ–‡æ¡£å®¡æŸ¥
2. æ£€æŸ¥ç”Ÿæˆçš„ DOCX æ–‡ä»¶æ˜¯å¦åŒ…å« `word/_rels/document.xml.rels`
3. åœ¨ Word ä¸­æ‰“å¼€ï¼ŒéªŒè¯æ‰¹æ³¨æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
4. å¯¹æ¯”ä¿®å¤å‰åçš„æ–‡ä»¶åˆ—è¡¨ï¼Œç¡®ä¿ä¸å†ç¼ºå°‘å…³é”®æ–‡ä»¶

---

**é—®é¢˜æ ¹æºæ€»ç»“**ï¼šé•¿æ–‡æ¡£ç”Ÿæˆçš„DOCXç¼ºå°‘ `word/_rels/document.xml.rels` æ–‡ä»¶ï¼Œå¯¼è‡´ Word æ— æ³•æ‰¾åˆ°æ‰¹æ³¨å†…å®¹ã€‚è¿™æ˜¯ç”±äºå¼‚å¸¸å¤„ç†é€»è¾‘ä¸å®Œå–„ï¼Œå¯¼è‡´æ¢å¤åˆ›å»ºçš„ rels æ–‡ä»¶æ²¡æœ‰è¢«æ­£ç¡®ä¿å­˜åˆ°æœ€ç»ˆçš„ DOCX ä¸­ã€‚

