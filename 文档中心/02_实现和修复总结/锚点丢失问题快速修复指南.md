# æ‰¹æ³¨æ’å…¥é”šç‚¹ä¸¢å¤± - å¿«é€Ÿä¿®å¤æŒ‡å—

**é—®é¢˜ç—‡çŠ¶**ï¼š
```
æ‰¹æ³¨æ’å…¥æ—¶æ‰¾ä¸åˆ°é”šç‚¹ä¹¦ç­¾ï¼Œæ—¥å¿—æ˜¾ç¤ºï¼š
æœªæ‰¾åˆ°anchorIdå¯¹åº”çš„ä¹¦ç­¾ï¼šanchorId=anc-c20-2cf51100
æ–‡æ¡£ä¸­æ€»ä¹¦ç­¾æ•°=1ï¼ˆåªæœ‰_GoBackï¼‰
```

---

## ğŸ¯ æ ¹æœ¬åŸå› 

`QwenRuleReviewController.one-click-review()` çš„ç¬¬ 348-349 è¡Œä¸­ï¼Œè™½ç„¶å‡†å¤‡äº†å¸¦é”šç‚¹çš„æ–‡æ¡£ï¼Œä½†éœ€è¦éªŒè¯ MultipartFile åŒ…è£…å™¨æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨ã€‚

---

## âœ… å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

### æ­¥éª¤1ï¼šä¿®æ”¹ QwenRuleReviewController.one-click-review()

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬ 314-350 è¡Œ

```java
// æ­¥éª¤4ï¼šè°ƒç”¨Qwenè¿›è¡Œå®¡æŸ¥
log.info("æ­¥éª¤3/6: æ­£åœ¨è°ƒç”¨Qwenè¿›è¡Œå®¡æŸ¥...");
String reviewResult = qwenRuleReviewService.reviewContractWithQwen(prompt);
List<ReviewIssue> issues = qwenRuleReviewService.parseReviewResults(reviewResult);
log.info("âœ“ Qwenå®¡æŸ¥å®Œæˆï¼Œæ£€å‡º {} ä¸ªé—®é¢˜", issues.size());

// ã€æ–°å¢ã€‘éªŒè¯ anchorId
int validAnchorCount = 0;
for (ReviewIssue issue : issues) {
    if (issue.getAnchorId() != null && !issue.getAnchorId().isEmpty()) {
        validAnchorCount++;
    } else {
        log.warn("âš ï¸ Issueç¼ºå°‘anchorId: clauseId={}", issue.getClauseId());
    }
}
log.info("âœ“ å…¶ä¸­ {} ä¸ªé—®é¢˜æœ‰æœ‰æ•ˆçš„anchorId", validAnchorCount);

// æ­¥éª¤5ï¼šå°†å®¡æŸ¥ç»“æœæ’å…¥æ–‡æ¡£
// ã€æ”¹è¿›ã€‘ç›´æ¥ä¼ é€’å­—èŠ‚æ•°ç»„å’Œ issues åˆ—è¡¨ï¼Œè€Œä¸æ˜¯åŒ…è£…å™¨å’Œ JSON å­—ç¬¦ä¸²
log.info("æ­¥éª¤4/6: æ­£åœ¨å°†å®¡æŸ¥ç»“æœæ’å…¥æ–‡æ¡£...");

byte[] annotatedDocBytes = xmlContractAnnotateService.annotateContractWithXml(
    documentWithAnchorBytes,   // â† ã€æ”¹ã€‘ç›´æ¥ä¼ é€’å­—èŠ‚æ•°ç»„
    issues,                    // â† ã€æ”¹ã€‘ç›´æ¥ä¼ é€’ issues åˆ—è¡¨
    "preferAnchor",
    false
);
log.info("âœ“ æ–‡æ¡£æ‰¹æ³¨å®Œæˆï¼Œå¤§å°: {} KB", annotatedDocBytes.length / 1024);
```

**å…³é”®æ”¹åŠ¨**ï¼š
- âŒ åˆ é™¤ç¬¬ 323-346 è¡Œçš„ MultipartFile åŒ…è£…å™¨åˆ›å»ºä»£ç 
- âœ… ç›´æ¥ä¼ é€’ `documentWithAnchorBytes` å’Œ `issues` åˆ—è¡¨

### æ­¥éª¤2ï¼šä¿®æ”¹ XmlContractAnnotateService.annotateContractWithXml()

**åŸæ–¹æ³•ç­¾å**ï¼š
```java
public byte[] annotateContractWithXml(MultipartFile file, String reviewJson,
                                     String anchorStrategy, boolean cleanupAnchors)
```

**æ–°æ–¹æ³•ç­¾å**ï¼š
```java
public byte[] annotateContractWithXml(byte[] documentBytes, List<ReviewIssue> issues,
                                     String anchorStrategy, boolean cleanupAnchors) throws IOException {

    logger.info("å¼€å§‹XMLæ–¹å¼æ‰¹æ³¨å¤„ç†: issuesæ•°é‡={}, anchorStrategy={}",
               issues.size(), anchorStrategy);

    try {
        // ã€å…³é”®è¯Šæ–­ã€‘æ£€æŸ¥ anchorId
        for (int i = 0; i < issues.size(); i++) {
            ReviewIssue issue = issues.get(i);
            logger.info("[Issue {}] clauseId={}, anchorId={}, severity={}",
                       i + 1,
                       issue.getClauseId(),
                       issue.getAnchorId() != null ? "âœ“ " + issue.getAnchorId() : "âœ— NULL",
                       issue.getSeverity());
        }

        // ç›´æ¥è°ƒç”¨æ‰¹æ³¨å¤„ç†å™¨
        byte[] annotatedBytes = xmlCommentProcessor.addCommentsToDocx(
            documentBytes, issues, anchorStrategy, cleanupAnchors);

        logger.info("XMLæ‰¹æ³¨å¤„ç†å®Œæˆï¼Œè¾“å‡ºæ–‡æ¡£å¤§å°: {} å­—èŠ‚", annotatedBytes.length);
        return annotatedBytes;

    } catch (Exception e) {
        logger.error("XMLæ‰¹æ³¨å¤„ç†å¤±è´¥", e);
        throw new IOException("XMLæ‰¹æ³¨å¤„ç†å¤±è´¥: " + e.getMessage(), e);
    }
}
```

**å…³é”®æ”¹åŠ¨**ï¼š
- âœ… æ”¹ä¸ºç›´æ¥æ¥æ”¶ `byte[]` å’Œ `List<ReviewIssue>`
- âœ… åˆ é™¤ JSON ååºåˆ—åŒ–é€»è¾‘
- âœ… æ·»åŠ  anchorId éªŒè¯æ—¥å¿—

### æ­¥éª¤3ï¼šå¤„ç†å…¶ä»–è°ƒç”¨ä½ç½®

æ£€æŸ¥å…¶ä»–è°ƒç”¨ `xmlContractAnnotateService.annotateContractWithXml()` çš„åœ°æ–¹ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæ›´æ–°å®ƒä»¬çš„è°ƒç”¨æ–¹å¼ã€‚

ä½¿ç”¨ IDE æœç´¢åŠŸèƒ½ï¼š`Ctrl+Shift+F` æœç´¢ `annotateContractWithXml`

---

## ğŸ” ä¿®å¤å‰éªŒè¯

å¦‚æœä¸æƒ³ç«‹å³ä¿®æ”¹ä»£ç ï¼Œå¯ä»¥å…ˆéªŒè¯é—®é¢˜ï¼š

åœ¨ QwenRuleReviewController çš„ 284-304 è¡Œï¼ˆè·å–å¸¦é”šç‚¹æ–‡æ¡£åï¼‰æ·»åŠ è¯Šæ–­ä»£ç ï¼š

```java
// ã€è¯Šæ–­ã€‘éªŒè¯æ–‡æ¡£æ˜¯å¦åŒ…å«é”šç‚¹
if (documentWithAnchorBytes != null && documentWithAnchorBytes.length > 0) {
    try (InputStream docxStream = new ByteArrayInputStream(documentWithAnchorBytes);
         OPCPackage opcPackage = OPCPackage.open(docxStream)) {

        PackagePartName documentPartName = PackagingURIHelper.createPartName("/word/document.xml");
        PackagePart documentPart = opcPackage.getPart(documentPartName);

        SAXReader reader = new SAXReader();
        Document doc = reader.read(documentPart.getInputStream());

        Element root = doc.getRootElement();
        List<Element> bookmarks = root.selectNodes("//w:bookmarkStart[@w:name]",
            "w", "http://schemas.openxmlformats.org/wordprocessingml/2006/main");

        int anchorCount = 0;
        for (Element bookmark : bookmarks) {
            String name = bookmark.attributeValue("name");
            if (name != null && name.startsWith("anc-")) {
                anchorCount++;
            }
        }

        log.info("ã€è¯Šæ–­ã€‘documentWithAnchorBytes ä¸­çš„é”šç‚¹æ•°: {}", anchorCount);
    } catch (Exception e) {
        log.warn("ã€è¯Šæ–­ã€‘é”šç‚¹éªŒè¯å¤±è´¥: {}", e.getMessage());
    }
}
```

å¦‚æœè¾“å‡ºæ˜¾ç¤ºé”šç‚¹æ•°ä¸º 0ï¼Œè¯´æ˜æ–‡æ¡£æœ¬èº«å°±æ²¡æœ‰é”šç‚¹ï¼Œé—®é¢˜åœ¨è§£æé˜¶æ®µã€‚

---

## ğŸ“ ä¿®å¤æ£€æŸ¥æ¸…å•

- [ ] ä¿®æ”¹ QwenRuleReviewController ç¬¬ 314-350 è¡Œ
- [ ] åˆ é™¤ MultipartFile åŒ…è£…å™¨ä»£ç ï¼ˆç¬¬ 323-346 è¡Œï¼‰
- [ ] ä¿®æ”¹ XmlContractAnnotateService.annotateContractWithXml() æ–¹æ³•ç­¾å
- [ ] æ›´æ–°æ–¹æ³•å†…éƒ¨é€»è¾‘ï¼šåˆ é™¤ JSON å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨ issues
- [ ] æœç´¢å…¶ä»–è°ƒç”¨ä½ç½®å¹¶æ›´æ–°
- [ ] é‡æ–°ç¼–è¯‘å¹¶æµ‹è¯•
- [ ] æŸ¥çœ‹æ—¥å¿—ä¸­çš„ anchorId è¯Šæ–­è¾“å‡º

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

ä¿®å¤å‰æ—¥å¿—ï¼š
```
æœªæ‰¾åˆ°anchorIdå¯¹åº”çš„ä¹¦ç­¾ï¼šanchorId=anc-c20-2cf51100
æ— æ³•é€šè¿‡æ–‡æœ¬åŒ¹é…æ‰¾åˆ°æ®µè½ï¼šclauseId=c20
```

ä¿®å¤åæ—¥å¿—ï¼ˆé¢„æœŸï¼‰ï¼š
```
ã€è¯Šæ–­ã€‘å…¶ä¸­ 5 ä¸ªé—®é¢˜æœ‰æœ‰æ•ˆçš„anchorId
âœ“ é€šè¿‡é”šç‚¹æ‰¾åˆ°ç›®æ ‡æ®µè½ï¼šanchorId=anc-c20-2cf51100, æ®µè½ç´¢å¼•=20
âœ“ ç²¾ç¡®æ‰¹æ³¨æ’å…¥å®Œæˆï¼šcommentId=1, å‰ç¼€=0, åŒ¹é…èŒƒå›´=0-50, åç¼€=10
âœ“ æ–‡æ¡£æ‰¹æ³¨å®Œæˆï¼Œå¤§å°: 500 KB
```

---

## ç›¸å…³æ–‡ä»¶

- ä¸»è¦ä¿®æ”¹ï¼š`QwenRuleReviewController.java`
- ä¸»è¦ä¿®æ”¹ï¼š`XmlContractAnnotateService.java`
- æŸ¥çœ‹ï¼š`ReviewIssue.java` - ç¡®è®¤ anchorId å­—æ®µå­˜åœ¨
- å‚è€ƒï¼š`WordXmlCommentProcessor.java` - æ‰¹æ³¨æ‰§è¡Œé€»è¾‘ï¼ˆå·²éªŒè¯æ­£ç¡®ï¼‰

---

**é¢„è®¡ä¿®å¤æ—¶é—´**ï¼š15-30 åˆ†é’Ÿ

**é£é™©çº§åˆ«**ï¼šä½ï¼ˆæ”¹è¿›å†…éƒ¨å·¥ä½œæµï¼Œä¸å½±å“å¤–éƒ¨æ¥å£ï¼‰

**æµ‹è¯•èŒƒå›´**ï¼šä¸€é”®å®¡æŸ¥æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯•
