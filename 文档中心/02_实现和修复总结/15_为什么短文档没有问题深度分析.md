# 为什么短文档没有这个问题？深度分析

## 用户的观察

- ✅ 短文档：批注可以显示
- ❌ 长文档：批注丢失
- 两者都使用相同的一键审查流程

## 我的初步假设错了

我之前认为问题是 `xml:space="preserve"` 属性缺失，但这个属性在**所有批注**中都缺失。那为什么短文档没事呢？

## 最有可能的原因

### 假设 1：不同的批注添加路径

可能短文档和长文档使用了**不同的代码路径**来添加批注：

- **短文档**：可能使用了 `insertCommentRangeInDocument()` (段落级批注)
- **长文档**：可能主要使用了 `insertPreciseCommentRangeInSingleRun()` (精确文字匹配)

如果是这样，可能有一个代码路径正确，另一个代码路径有问题。

### 假设 2：锚点清理问题

虽然 `cleanupAnchors=false`（不清理锚点），但可能存在其他地方的数据丢失：

- 短文档可能没有触发某个条件导致批注被清理
- 长文档可能因为文档大小或内容复杂性而触发了某个条件

### 假设 3：XML写入顺序问题

可能存在竞态条件或写入顺序问题：

- 短文档：因为数据量小，所有内容都被正确写入
- 长文档：因为数据量大，某些部分被覆盖或未被写入

### 假设 4：comments.xml 被覆盖

最有可能的情况是：**comments.xml 被新创建的空文件覆盖了**！

在 `loadOrCreateCommentsXml()` 方法中，如果每次都创建新文件而不是追加，长文档的情况下可能会发生问题。

## 需要验证的问题

1. **短文档的诊断日志**是什么样的？
   - `commentRangeStart数量` 是多少？
   - 是否也是 7 个？

2. **短文档和长文档使用的是同一个一键审查流程吗？**
   - 还是使用了不同的 API 端点？

3. **短文档中的批注内容是否也有 `xml:space="preserve"` 属性？**
   - 如果有，那说明有其他代码路径正确处理了这个属性
   - 如果没有，那说明我的 xml:space 假设不是关键问题

## 最紧迫的调查

能否：

1. **运行短文档测试**，查看它的诊断日志
2. **对比两个 DOCX 文件**的 comments.xml 结构
3. **检查是否使用了不同的 API 端点**

这样才能真正理解为什么短文档没问题。

## 可能的附加问题

我现在意识到可能还有**第二个问题**我没有修复：

在 `comments.xml` 首次创建时，可能需要添加**基本的段落格式**，而不仅仅是文本。Word 要求批注必须包含有效的段落格式。

让我检查一下 `addCommentToCommentsXml()` 是否为批注段落 (`<w:p>`) 添加了必要的属性...
