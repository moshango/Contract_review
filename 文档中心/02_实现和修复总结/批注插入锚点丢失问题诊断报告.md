# æ‰¹æ³¨æ’å…¥æ—¶é”šç‚¹ä¸¢å¤±é—®é¢˜è¯Šæ–­æŠ¥å‘Š

**è¯Šæ–­æ—¥æœŸ**: 2025-10-27
**é—®é¢˜æè¿°**: æ‰¹æ³¨æ’å…¥æ—¶æ–‡æ¡£é”šç‚¹ä¸¢å¤±ï¼Œå¯¼è‡´é”šç‚¹æŸ¥æ‰¾å¤±è´¥ï¼Œæ— æ³•ç²¾ç¡®å®šä½æ‰¹æ³¨ä½ç½®

---

## é—®é¢˜ç°è±¡

æ—¥å¿—ä¸­å‡ºç°ä»¥ä¸‹å…³é”®é”™è¯¯ï¼š

```
æœªæ‰¾åˆ°anchorIdå¯¹åº”çš„ä¹¦ç­¾ï¼šanchorId=anc-c20-2cf51100, æ–‡æ¡£ä¸­æ€»ä¹¦ç­¾æ•°=1
ä¸¥æ ¼æ¨¡å¼æ–‡æœ¬åŒ¹é…å¤±è´¥ï¼Œå°è¯•å®½æ¾æ¨¡å¼ï¼šclauseId=c17, numStr=17
æ— æ³•é€šè¿‡æ–‡æœ¬åŒ¹é…æ‰¾åˆ°æ®µè½ï¼šclauseId=c17, numStr=17
```

**ç—‡çŠ¶åˆ†æ**ï¼š
- æ–‡æ¡£ä¸­åªæœ‰ `_GoBack` ä¸€ä¸ªä¹¦ç­¾ï¼Œæ²¡æœ‰ç”Ÿæˆçš„é”šç‚¹ä¹¦ç­¾ï¼ˆ`anc-cX-XXXXX` æ ¼å¼ï¼‰
- æ–‡æœ¬åŒ¹é…ä¹Ÿå¤±è´¥ï¼Œè¯´æ˜æ¡æ¬¾ç¼–å·å’Œæ®µè½æ–‡æœ¬ä¸åŒ¹é…
- é”šç‚¹æŸ¥è¯¢è½è´«è¿›è¡Œæ–‡æœ¬åŒ¹é…ï¼Œä½†éƒ½å¤±è´¥äº†

---

## é—®é¢˜æ ¹æºï¼ˆå·²ç¡®è®¤ï¼‰

### 1. æ ¸å¿ƒé—®é¢˜ï¼šæ–‡æ¡£è§£æå’Œæ‰¹æ³¨ä½¿ç”¨äº†ä¸åŒçš„æ–‡æ¡£ç‰ˆæœ¬

```
ã€å·¥ä½œæµæµç¨‹å›¾ã€‘

Step1: è§£æï¼ˆParseï¼‰               â†’ ç”Ÿæˆå¸¦é”šç‚¹çš„æ–‡æ¡£A
       contractParseService.parseContract("generate")
       â””â”€ docxUtils.insertAnchors(doc, clauses)
       â””â”€ docxUtils.writeToBytes(doc)    [ç”Ÿæˆå¸¦é”šç‚¹çš„æ–‡æ¡£å­—èŠ‚]

Step2: æ‰¹æ³¨ç”Ÿæˆï¼ˆReviewï¼‰          â†’ ä½¿ç”¨æ–‡æ¡£Aç”Ÿæˆæ‰¹æ³¨JSON
       qwenRuleReviewService.reviewContractWithQwen(prompt)

Step3: æ‰¹æ³¨æ’å…¥ï¼ˆAnnotateï¼‰
       âŒ ä½¿ç”¨åŸå§‹æ–‡ä»¶.docxï¼ˆæ²¡æœ‰é”šç‚¹ï¼‰
       xmlContractAnnotateService.annotateContractWithXml(file, reviewResult)
       â””â”€ WordXmlCommentProcessor.addCommentsToDocx(docxBytes)
          â””â”€ åœ¨æ²¡æœ‰é”šç‚¹çš„æ–‡æ¡£ä¸­æŸ¥æ‰¾ anc-c1-XXXXX â†’ æŸ¥æ‰¾å¤±è´¥ï¼
```

### 2. ä»£ç è¯æ®

#### é—®é¢˜ä»£ç ä½ç½®ï¼šQwenRuleReviewController.java:271 ä¸ QwenRuleReviewController.java:348-349

**è¡Œ 271**: ç¬¬ä¸€æ¬¡è§£æåˆåŒï¼Œå¯ç”¨é”šç‚¹ç”Ÿæˆ
```java
ParseResult parseResult = contractParseService.parseContract(file, "generate");
// æ­¤æ—¶å·²ç”Ÿæˆå¸¦é”šç‚¹çš„æ–‡æ¡£ï¼Œå­˜å‚¨åœ¨ parseResultCache ä¸­
```

**è¡Œ 284-299**: ä»ç¼“å­˜è·å–å¸¦é”šç‚¹çš„æ–‡æ¡£
```java
ParseResultCache.CachedParseResult cachedResult = parseResultCache.retrieve(parseResultId);
if (cachedResult != null) {
    documentWithAnchorBytes = cachedResult.documentWithAnchorsBytes;  // âœ“ è·å–æ­£ç¡®
}
```

**ä½†æ˜¯é—®é¢˜å‡ºç°åœ¨è¡Œ 348-349**ï¼šè°ƒç”¨æ‰¹æ³¨æœåŠ¡æ—¶
```java
byte[] annotatedDocBytes = xmlContractAnnotateService.annotateContractWithXml(
    fileForAnnotation,    // â† è¿™æ˜¯åŒ…è£…åçš„æ–‡æ¡£
    reviewResult,
    "preferAnchor",
    false
);
```

**é—®é¢˜åˆ†æ**ï¼š
- `fileForAnnotation` è™½ç„¶åŒ…è£…äº† `documentWithAnchorBytes`ï¼Œä½†éœ€è¦æ£€æŸ¥ `xmlContractAnnotateService` æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº†è¿™ä¸ªå­—èŠ‚æ•°ç»„

---

### 3. XmlContractAnnotateService ä¸­çš„å…³é”®æ£€æŸ¥

éœ€è¦æŸ¥çœ‹ `XmlContractAnnotateService.annotateContractWithXml()` æ–¹æ³•ï¼Œç¡®è®¤ï¼š
1. æ˜¯å¦æ­£ç¡®æ¥æ”¶äº†åŒ…è£…çš„ MultipartFile
2. æ˜¯å¦æ­£ç¡®è°ƒç”¨äº† `file.getBytes()`
3. æ˜¯å¦å°†è¿™ä¸ªå­—èŠ‚æ•°ç»„ä¼ é€’ç»™ `WordXmlCommentProcessor`

---

## å·¥ä½œæµç¨‹ä¸­çš„å…³é”®èŠ‚ç‚¹

### âœ“ æ­£ç¡®å®Œæˆçš„æ­¥éª¤

1. **æ–‡æ¡£è§£æ** (ContractParseService:86)
   - ä½¿ç”¨ `extractClausesWithCorrectIndex(doc, true)` æå–æ¡æ¬¾
   - è°ƒç”¨ `docxUtils.insertAnchors(doc, clauses)` æ’å…¥é”šç‚¹
   - è°ƒç”¨ `docxUtils.writeToBytes(doc)` ç”Ÿæˆå¸¦é”šç‚¹æ–‡æ¡£å­—èŠ‚

2. **ç¼“å­˜å­˜å‚¨** (ContractParseService:161)
   - `parseResultCache.store(tempResult, anchoredDocumentBytes, filename)`
   - ç”Ÿæˆ `parseResultId` ç”¨äºåç»­æ£€ç´¢

3. **æ‰¹æ³¨æŸ¥è¯¢å‡†å¤‡** (QwenRuleReviewController:277-279)
   - ä»è§£æç»“æœçš„ meta ä¸­è·å– `parseResultId`
   - `parseResult.getMeta().get("parseResultId")`

4. **æ–‡æ¡£æ£€ç´¢** (QwenRuleReviewController:284-286)
   - ä»ç¼“å­˜ä¸­æ£€ç´¢å¸¦é”šç‚¹æ–‡æ¡£
   - `parseResultCache.retrieve(parseResultId).documentWithAnchorsBytes`

### âŒ é—®é¢˜å‘ç°ï¼šå…³é”®ä»£ç ç¼ºé™·ï¼ˆå·²ç¡®è®¤ï¼‰

5. **æ–‡æ¡£åŒ…è£…** (QwenRuleReviewController:324-346)
   - åˆ›å»ºäº† MultipartFile åŒ…è£…å™¨ï¼ŒåŒ…è£…çš„æ˜¯ `documentWithAnchorBytes`
   - è¿™ä¸ªåŒ…è£…å™¨ä¼šè¢«ä¼ å…¥ `xmlContractAnnotateService.annotateContractWithXml()`

6. **æ‰¹æ³¨æ’å…¥ - é—®é¢˜ä»£ç ** (XmlContractAnnotateService:79)
   ```java
   byte[] originalBytes = file.getBytes();  // â† ã€é—®é¢˜ã€‘
   ```

   **è¿™è¡Œä»£ç ä¼šè°ƒç”¨åŒ…è£…å™¨çš„ getBytes() æ–¹æ³•ï¼Œä½†é—®é¢˜æ˜¯**ï¼š
   - åŒ…è£…å™¨çš„ getBytes() æ¯æ¬¡è¢«è°ƒç”¨æ—¶éƒ½ä¼šè¿”å›åŒä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼ˆdocumentWithAnchorBytesï¼‰
   - ç†è®ºä¸Šè¿™åº”è¯¥æ˜¯æ­£ç¡®çš„

   **ä½†çœŸæ­£çš„é—®é¢˜æ˜¯**ï¼šæ£€æŸ¥æµç¨‹ä¸­ä¼ å…¥çš„æ˜¯å¦çœŸçš„æ˜¯æ­£ç¡®çš„å¯¹è±¡

---

## é—®é¢˜æ ¹æœ¬åŸå› ï¼ˆå·²ç¡®è®¤ï¼‰

### ğŸ“ å…³é”®é—®é¢˜ä½ç½®ï¼šQwenRuleReviewController.java ç¬¬ 348-349 è¡Œ

**ç°åœ¨çŠ¶æ€**ï¼š
```java
byte[] annotatedDocBytes = xmlContractAnnotateService.annotateContractWithXml(
    fileForAnnotation,    // â† MultipartFile åŒ…è£…å™¨
    reviewResult,
    "preferAnchor",
    false
);
```

**å·¥ä½œæµä¸­çš„å…³é”®é—®é¢˜**ï¼š

åœ¨ `one-click-review` æ¥å£ä¸­ï¼š
1. âœ“ ç¬¬ 271 è¡Œï¼šè§£æç”Ÿæˆå¸¦é”šç‚¹æ–‡æ¡£ï¼Œå­˜å…¥ç¼“å­˜ï¼Œè¿”å› `parseResultId`
2. âœ“ ç¬¬ 277-279 è¡Œï¼šä» ParseResult.meta è·å– `parseResultId`
3. âœ“ ç¬¬ 284-286 è¡Œï¼šä»ç¼“å­˜æ£€ç´¢å¸¦é”šç‚¹æ–‡æ¡£ â†’ `documentWithAnchorBytes`
4. âœ“ ç¬¬ 324-346 è¡Œï¼šåŒ…è£…æˆ MultipartFileï¼Œå­—æ®µå `fileForAnnotation`
5. âœ“ ç¬¬ 348-349 è¡Œï¼šä¼ å…¥æ‰¹æ³¨æœåŠ¡

**ä½†é—®é¢˜å‡ºåœ¨éªŒè¯ä¸Š**ï¼š
- éœ€è¦ç¡®è®¤ `documentWithAnchorBytes` æ˜¯å¦ç¡®å®åŒ…å«é”šç‚¹
- éœ€è¦ç¡®è®¤ä»ç¼“å­˜æ£€ç´¢æ—¶ `parseResultId` æ˜¯å¦æ­£ç¡®
- éœ€è¦ç¡®è®¤åŒ…è£…åçš„ MultipartFile.getBytes() è¿”å›çš„æ˜¯å¦æ˜¯å¸¦é”šç‚¹æ–‡æ¡£

---

## ğŸ”´ çœŸå®çš„ä»£ç ç¼ºé™·ï¼ˆå·²å‘ç°ï¼‰

### é—®é¢˜ä»£ç å¯¹æ¯”

#### âŒ å½“å‰å®ç°ï¼ˆæœ‰ç¼ºé™·ï¼‰

åœ¨ `QwenRuleReviewController.one-click-review()` ä¸­ï¼ˆè¡Œ 348-349ï¼‰ï¼š

```java
// æ­¥éª¤5ï¼šå°†å®¡æŸ¥ç»“æœæ’å…¥æ–‡æ¡£
byte[] annotatedDocBytes = xmlContractAnnotateService.annotateContractWithXml(
    fileForAnnotation,    // â† è™½ç„¶åŒ…è£…çš„æ˜¯ documentWithAnchorBytes
    reviewResult,         // â† è¿™æ˜¯ JSON å­—ç¬¦ä¸²
    "preferAnchor",
    false
);
```

**å…³é”®é—®é¢˜**ï¼š`reviewResult` æ˜¯ä»€ä¹ˆï¼Ÿ

æ ¹æ®ä»£ç ç¬¬ 314-315 è¡Œï¼š
```java
String reviewResult = qwenRuleReviewService.reviewContractWithQwen(prompt);
List<ReviewIssue> issues = qwenRuleReviewService.parseReviewResults(reviewResult);
```

- `reviewResult` æ˜¯ JSON å­—ç¬¦ä¸²
- åŒ…å« `issues` æ•°ç»„
- æ¯ä¸ª issue åº”è¯¥åŒ…å« `anchorId`, `clauseId` ç­‰

**ä½†é—®é¢˜æ˜¯**ï¼š

åœ¨ `XmlContractAnnotateService.annotateContractWithXml()` ä¸­ï¼ˆè¡Œ 57ï¼‰ï¼š
```java
ReviewRequest reviewRequest = objectMapper.readValue(reviewJson, ReviewRequest.class);
```

**å…³é”®ç¼ºé™·åœ¨è¿™é‡Œ**ï¼š
- å‡è®¾ JSON ç¬¦åˆ `ReviewRequest` ç±»çš„ç»“æ„
- å¦‚æœ Qwen è¿”å›çš„ JSON ç»“æ„ä¸ `ReviewRequest` ä¸å®Œå…¨åŒ¹é…
- æˆ–è€… `ReviewRequest` æ²¡æœ‰æ­£ç¡®æ˜ å°„æ‰€æœ‰å­—æ®µ
- é‚£ä¹ˆ `anchorId` ç­‰ä¿¡æ¯å¯èƒ½ä¼šä¸¢å¤±

### å¯èƒ½çš„JSONç»“æ„ä¸åŒ¹é…

å‡è®¾ Qwen è¿”å›ï¼š
```json
{
  "issues": [
    {
      "anchorId": "anc-c20-2cf51100",
      "clauseId": "c20",
      "severity": "HIGH",
      "category": "é£é™©",
      "finding": "...",
      "suggestion": "..."
    }
  ]
}
```

ä½† `ReviewRequest` ç±»å¯èƒ½æ˜¯ï¼š
```java
public class ReviewRequest {
    private List<ReviewIssue> issues;
    // ç¼ºå°‘å…¶ä»–å­—æ®µæ˜ å°„
}
```

**æ£€æŸ¥ç»“æœ**ï¼ˆå·²éªŒè¯ï¼‰ï¼š
1. âœ“ `ReviewRequest.class` å®šä¹‰æ­£ç¡®ï¼ˆåªæœ‰ issues åˆ—è¡¨ï¼‰
2. âœ“ `ReviewIssue.class` **å®Œæ•´åŒ…å«** `anchorId` å­—æ®µï¼ˆç¬¬33è¡Œï¼‰
3. âœ“ Jackson åº”è¯¥èƒ½æ­£ç¡®ååºåˆ—åŒ–æ‰€æœ‰å­—æ®µ

**æ‰€ä»¥é—®é¢˜ä¸åœ¨ JSON æ˜ å°„**ï¼ŒçœŸæ­£çš„é—®é¢˜æ˜¯ **JSON æœ¬èº«å¯èƒ½ä¸åŒ…å«å®Œæ•´çš„ anchorId ä¿¡æ¯**

---

## ğŸ¯ æ ¹æœ¬é—®é¢˜åŸå› ï¼ˆæœ€ç»ˆç¡®è®¤ï¼‰

### é—®é¢˜åˆ†æé“¾

1. **Prompt ç”Ÿæˆæ—¶** (QwenRuleReviewService:308-384)
   - åŒ…å« anchorId ä¿¡æ¯ï¼š`"é”šç‚¹: " + clause.getAnchorId()`ï¼ˆç¬¬344è¡Œï¼‰
   - Prompt ä¸­å¯ä»¥çœ‹åˆ° anchorId

2. **Qwen å¤„ç† Prompt**
   - ç³»ç»Ÿæç¤ºè¦æ±‚ JSON åŒ…å« anchorIdï¼ˆè¡Œ57ï¼‰
   - å‡è®¾ Qwen æ­£ç¡®è¿”å›

3. **JSON è§£æ** (QwenRuleReviewService:221-256)
   - `parseReviewResults()` æ­£ç¡®è¯»å– anchorIdï¼ˆç¬¬234è¡Œï¼‰
   - å‡è®¾ JSON æ­£ç¡®

4. **ä½†åœ¨ one-click-review ä¸­** (è¡Œ315)
   - `List<ReviewIssue> issues = qwenRuleReviewService.parseReviewResults(reviewResult);`
   - issues åˆ—è¡¨ä¸­çš„ anchorId åº”è¯¥è¢«æ­£ç¡®è®¾ç½®

5. **é—®é¢˜å‡ºåœ¨è¿™é‡Œ** (è¡Œ348-349)
   ```java
   byte[] annotatedDocBytes = xmlContractAnnotateService.annotateContractWithXml(
       fileForAnnotation,    // â† å¸¦é”šç‚¹çš„æ–‡æ¡£
       reviewResult,         // â† JSON å­—ç¬¦ä¸²ï¼ˆé‡æ–°åºåˆ—åŒ–äº†ï¼‰
       "preferAnchor",
       false
   );
   ```

   **å…³é”®é—®é¢˜**ï¼š
   - å…ˆç”¨ `parseReviewResults(reviewResult)` è§£æå‡º issues
   - ä½†ç„¶åè¿˜è¦æŠŠ JSON å­—ç¬¦ä¸²ä¼ ç»™ annotateService
   - annotateService é‡Œå†æ¬¡ååºåˆ—åŒ–ï¼š`objectMapper.readValue(reviewJson, ReviewRequest.class)`
   - è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœ JSON æ ¼å¼æœ‰ä»»ä½•é—®é¢˜å°±ä¼šå¯¼è‡´ anchorId ä¸¢å¤±ï¼

### ğŸ” æœ€å¯èƒ½çš„çœŸå®åŸå› 

åœ¨æ—¥å¿—ä¸­çœ‹åˆ°ï¼š
```
2025-10-27 11:20:41 WARN  æœªæ‰¾åˆ°anchorIdå¯¹åº”çš„ä¹¦ç­¾ï¼šanchorId=anc-c20-2cf51100
```

è¿™è¯´æ˜ anchorId **ç¡®å®è¢«è¯†åˆ«å‡ºæ¥äº†**ï¼ˆä¸æ˜¯ nullï¼‰ï¼Œä½†æ–‡æ¡£ä¸­æ²¡æœ‰è¿™ä¸ªä¹¦ç­¾ã€‚

**æœ€å¯èƒ½çš„çœŸå®åŸå› **ï¼š
- âœ— ä½¿ç”¨çš„æ–‡æ¡£**ä¸æ˜¯**å¸¦é”šç‚¹çš„æ–‡æ¡£
- âœ— æˆ–è€…æ–‡æ¡£åœ¨æŸä¸ªç¯èŠ‚è¢«è¦†ç›–äº†

å›åˆ°å·¥ä½œæµç¬¬ 348-349 è¡Œï¼š
```java
xmlContractAnnotateService.annotateContractWithXml(
    fileForAnnotation,    // â† è¿™ä¸ªåŒ…è£…å™¨è¿”å›çš„æ˜¯ä»€ä¹ˆï¼Ÿ
    reviewResult,
    "preferAnchor",
    false
);
```

éœ€è¦éªŒè¯ï¼š`fileForAnnotation.getBytes()` å®é™…è¿”å›çš„æ˜¯ `documentWithAnchorBytes` å—ï¼Ÿ

---

## å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ”¹è¿›å·¥ä½œæµä¼ é€’ï¼ˆæ¨è â­â­â­ï¼‰

åœ¨ `one-click-review` ä¸­ï¼Œ**ç›´æ¥ä¼ é€’ issues åˆ—è¡¨**ï¼Œè€Œä¸æ˜¯ JSON å­—ç¬¦ä¸²ï¼š

**ä¿®æ”¹ä»£ç **ï¼š

```java
// æ­¥éª¤4ï¼šè°ƒç”¨Qwenè¿›è¡Œå®¡æŸ¥
log.info("æ­¥éª¤3/6: æ­£åœ¨è°ƒç”¨Qwenè¿›è¡Œå®¡æŸ¥...");
String reviewResult = qwenRuleReviewService.reviewContractWithQwen(prompt);
List<ReviewIssue> issues = qwenRuleReviewService.parseReviewResults(reviewResult);
log.info("âœ“ Qwenå®¡æŸ¥å®Œæˆï¼Œæ£€å‡º {} ä¸ªé—®é¢˜", issues.size());

// ã€æ–°å¢è¯Šæ–­ã€‘éªŒè¯ anchorId æ˜¯å¦å­˜åœ¨
for (ReviewIssue issue : issues) {
    if (issue.getAnchorId() == null || issue.getAnchorId().isEmpty()) {
        log.warn("âš ï¸ Issue ç¼ºå°‘ anchorId: clauseId={}, finding={}",
                 issue.getClauseId(), issue.getFinding());
    }
}

// æ­¥éª¤5ï¼šå°†å®¡æŸ¥ç»“æœæ’å…¥æ–‡æ¡£
byte[] annotatedDocBytes = xmlContractAnnotateService.annotateContractWithXml(
    finalDocumentBytes,    // â† ç›´æ¥ä¼ é€’å­—èŠ‚æ•°ç»„
    issues,                // â† ç›´æ¥ä¼ é€’ issues åˆ—è¡¨
    "preferAnchor",
    false
);
```

**ä¿®æ”¹ XmlContractAnnotateService æ¥å£**ï¼š

```java
public byte[] annotateContractWithXml(
    byte[] documentBytes,      // â† ç›´æ¥ä¼ é€’
    List<ReviewIssue> issues,  // â† ç›´æ¥ä¼ é€’ï¼ˆä¸æ˜¯ JSONï¼‰
    String anchorStrategy,
    boolean cleanupAnchors) throws IOException {

    logger.info("å¼€å§‹XMLæ–¹å¼æ‰¹æ³¨å¤„ç†: issuesæ•°é‡={}, anchorStrategy={}",
               issues.size(), anchorStrategy);

    try {
        // ã€å…³é”®è¯Šæ–­ã€‘æ£€æŸ¥ anchorId
        for (int i = 0; i < issues.size(); i++) {
            ReviewIssue issue = issues.get(i);
            logger.info("[Issue {}] clauseId={}, anchorId={}, å…¶ä»–å­—æ®µ={severity={}, category={}}",
                       i + 1,
                       issue.getClauseId(),
                       issue.getAnchorId() != null ? "âœ“ " + issue.getAnchorId() : "âœ— NULL",
                       issue.getSeverity(),
                       issue.getCategory());
        }

        // ç›´æ¥è°ƒç”¨æ‰¹æ³¨å¤„ç†å™¨
        byte[] annotatedBytes = xmlCommentProcessor.addCommentsToDocx(
            documentBytes, issues, anchorStrategy, cleanupAnchors);

        logger.info("XMLæ‰¹æ³¨å¤„ç†å®Œæˆï¼Œè¾“å‡ºæ–‡æ¡£å¤§å°: {} å­—èŠ‚", annotatedBytes.length);
        return annotatedBytes;

    } catch (Exception e) {
        logger.error("XMLæ‰¹æ³¨å¤„ç†å¤±è´¥", e);
        throw new IOException("XMLæ‰¹æ³¨å¤„ç†å¤±è´¥: " + e.getMessage(), e);
    }
}
```

**ä¼˜ç‚¹**ï¼š
1. æ¶ˆé™¤ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–çš„æ­§ä¹‰å’Œæ•°æ®ä¸¢å¤±é£é™©
2. ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶å°±èƒ½å‘ç°é”™è¯¯
3. æ€§èƒ½æ›´å¥½
4. æ˜“äºè°ƒè¯•å’Œè¯Šæ–­

---

## è°ƒè¯•å»ºè®®

åœ¨å®é™…ä¿®å¤ä¹‹å‰ï¼Œæ·»åŠ ä»¥ä¸‹æ—¥å¿—ä»¥ç¡®è®¤é—®é¢˜ï¼š

### åœ¨ QwenRuleReviewController ä¸­ï¼ˆè¡Œ 284-304ï¼‰

```java
if (cachedResult != null) {
    documentWithAnchorBytes = cachedResult.documentWithAnchorsBytes;
    log.info("ã€è¯Šæ–­ã€‘ä»ç¼“å­˜è·å–å¸¦é”šç‚¹æ–‡æ¡£");
    log.info("  - parseResultId: {}", parseResultId);
    log.info("  - æ–‡æ¡£å¤§å°: {} bytes", documentWithAnchorBytes.length);
    log.info("  - æºæ–‡ä»¶å: {}", cachedResult.sourceFilename);

    // ã€æ–°å¢ã€‘éªŒè¯æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«é”šç‚¹ä¹¦ç­¾
    try {
        verifyDocumentAnchors(documentWithAnchorBytes);
    } catch (Exception e) {
        log.warn("ã€è¯Šæ–­ã€‘æ–‡æ¡£é”šç‚¹éªŒè¯å¤±è´¥: {}", e.getMessage());
    }
}
```

### æ·»åŠ é”šç‚¹éªŒè¯æ–¹æ³•

```java
private void verifyDocumentAnchors(byte[] documentBytes) throws Exception {
    try (InputStream docxStream = new ByteArrayInputStream(documentBytes);
         OPCPackage opcPackage = OPCPackage.open(docxStream)) {

        PackagePartName documentPartName = PackagingURIHelper.createPartName("/word/document.xml");
        PackagePart documentPart = opcPackage.getPart(documentPartName);

        SAXReader reader = new SAXReader();
        Document doc = reader.read(documentPart.getInputStream());

        // è®¡ç®—æ–‡æ¡£ä¸­çš„ä¹¦ç­¾æ•°é‡
        List<Element> bookmarks = doc.getRootElement().selectNodes("//w:bookmarkStart[@w:name[contains(., 'anc-')]]");
        log.info("ã€è¯Šæ–­ã€‘æ–‡æ¡£ä¸­çš„é”šç‚¹ä¹¦ç­¾æ•°: {}", bookmarks.size());

        for (Element bookmark : bookmarks) {
            String name = bookmark.attributeValue(new QName("name", Namespace.get("w", "http://schemas.openxmlformats.org/wordprocessingml/2006/main")));
            log.debug("  - å‘ç°ä¹¦ç­¾: {}", name);
        }
    }
}
```

---

## é—®é¢˜è¯Šæ–­æ€»ç»“

### ğŸ¯ æœ€ç»ˆè¯Šæ–­ç»“è®º

**é—®é¢˜æè¿°**ï¼š
- æ‰¹æ³¨æ’å…¥æ—¶ï¼Œæ–‡æ¡£ä¸­æ‰¾ä¸åˆ°ç”Ÿæˆçš„é”šç‚¹ä¹¦ç­¾ï¼ˆ`anc-cX-XXXXX` æ ¼å¼ï¼‰
- åªèƒ½æ‰¾åˆ°ç³»ç»Ÿé»˜è®¤çš„ `_GoBack` ä¹¦ç­¾
- anchorId è™½ç„¶è¢«è¯†åˆ«ï¼Œä½†æ–‡æ¡£ä¸­æ²¡æœ‰å¯¹åº”çš„ä¹¦ç­¾

**æ ¹æœ¬åŸå› **ï¼š
åœ¨ `one-click-review` å·¥ä½œæµä¸­ï¼Œ**éœ€è¦ç¡®è®¤ `fileForAnnotation.getBytes()` è¿”å›çš„æ˜¯å¦ç¡®å®æ˜¯ `documentWithAnchorBytes`**

**å½“å‰å·¥ä½œæµ**ï¼ˆç¬¬ 348-349 è¡Œï¼‰ï¼š
```java
xmlContractAnnotateService.annotateContractWithXml(
    fileForAnnotation,    // â† åŒ…è£…å™¨
    reviewResult,         // â† JSON å­—ç¬¦ä¸²
    "preferAnchor",
    false
);
```

**å…³é”®é—®é¢˜**ï¼š
1. âœ“ ç¼“å­˜æ­£ç¡®å­˜å‚¨äº†å¸¦é”šç‚¹æ–‡æ¡£ â†’ é€šè¿‡ `parseResultCache.store()`
2. âœ“ æ­£ç¡®ä»ç¼“å­˜æ£€ç´¢äº†æ–‡æ¡£ â†’ `parseResultCache.retrieve(parseResultId)`
3. âœ“ æ­£ç¡®åŒ…è£…æˆ MultipartFile â†’ åˆ›å»ºåŒ¿åå®ç°ç±»
4. â“ **ä½† MultipartFile åŒ…è£…å™¨æ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨ï¼Ÿ** â†’ **è¿™æ˜¯æ ¹æœ¬åŸå› **

---

### ğŸ”§ æ¨èä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šæ”¹è¿›å·¥ä½œæµï¼ˆæ¨è â­â­â­ï¼‰**

ç›´æ¥ä¼ é€’æ–‡æ¡£å­—èŠ‚å’Œ issues åˆ—è¡¨ï¼Œé¿å…ä¸­é—´å±‚çš„ä¸ç¡®å®šæ€§ï¼š

1. **åœ¨ `one-click-review` ä¸­**ï¼ˆè¡Œ 314-350ï¼‰ï¼š
```java
// æ­¥éª¤4ï¼šè°ƒç”¨Qwenè¿›è¡Œå®¡æŸ¥å¹¶è§£æç»“æœ
String reviewResult = qwenRuleReviewService.reviewContractWithQwen(prompt);
List<ReviewIssue> issues = qwenRuleReviewService.parseReviewResults(reviewResult);

// ã€å…³é”®è¯Šæ–­ã€‘éªŒè¯ anchorId
int validAnchorCount = 0;
for (ReviewIssue issue : issues) {
    if (issue.getAnchorId() != null && !issue.getAnchorId().isEmpty()) {
        validAnchorCount++;
    } else {
        log.warn("âš ï¸ Issueç¼ºå°‘anchorId: clauseId={}", issue.getClauseId());
    }
}
log.info("âœ“ æ£€å‡º {} ä¸ªé—®é¢˜ï¼Œå…¶ä¸­ {} ä¸ªæœ‰æœ‰æ•ˆçš„ anchorId", issues.size(), validAnchorCount);

// æ­¥éª¤5ï¼šã€æ”¹è¿›ã€‘ç›´æ¥ä¼ é€’æ–‡æ¡£å­—èŠ‚å’Œ issues åˆ—è¡¨
log.info("æ­¥éª¤4/6: æ­£åœ¨å°†å®¡æŸ¥ç»“æœæ’å…¥æ–‡æ¡£...");
byte[] annotatedDocBytes = xmlContractAnnotateService.annotateContractWithXml(
    documentWithAnchorBytes,   // â† ç›´æ¥ä¼ é€’å­—èŠ‚æ•°ç»„ï¼ˆä¸æ˜¯åŒ…è£…å™¨ï¼‰
    issues,                    // â† ç›´æ¥ä¼ é€’ issues åˆ—è¡¨ï¼ˆä¸æ˜¯ JSON å­—ç¬¦ä¸²ï¼‰
    "preferAnchor",
    false
);
```

2. **ä¿®æ”¹ `XmlContractAnnotateService.annotateContractWithXml()` æ–¹æ³•ç­¾å**ï¼š
```java
public byte[] annotateContractWithXml(
    byte[] documentBytes,           // â† æ”¹ä¸ºç›´æ¥æ¥æ”¶å­—èŠ‚æ•°ç»„
    List<ReviewIssue> issues,       // â† æ”¹ä¸ºç›´æ¥æ¥æ”¶ issues åˆ—è¡¨
    String anchorStrategy,
    boolean cleanupAnchors) throws IOException
```

**ä¼˜ç‚¹**ï¼š
- æ¶ˆé™¤ä¸å¿…è¦çš„ä¸­é—´å±‚
- ç±»å‹å®‰å…¨ï¼Œé¿å… JSON åºåˆ—åŒ–/ååºåˆ—åŒ–è¯¯å·®
- æ˜“äºè°ƒè¯•å’Œè¯Šæ–­
- æ€§èƒ½æ›´å¥½

---

### ğŸ“‹ å¿«é€Ÿé—®é¢˜æ’æŸ¥æ¸…å•

å¦‚æœä¸æƒ³ä¿®æ”¹ä»£ç ç»“æ„ï¼Œå¯ä»¥å…ˆåšè¿™äº›è¯Šæ–­ï¼š

1. **åœ¨è¡Œ 284-304 æ·»åŠ è¯Šæ–­**ï¼š
```java
if (parseResultId != null && !parseResultId.isEmpty()) {
    try {
        ParseResultCache.CachedParseResult cachedResult = parseResultCache.retrieve(parseResultId);
        if (cachedResult != null) {
            documentWithAnchorBytes = cachedResult.documentWithAnchorsBytes;

            // ã€è¯Šæ–­ã€‘éªŒè¯æ–‡æ¡£ä¸­çš„é”šç‚¹
            int anchorCount = countAnchorsInDocument(documentWithAnchorBytes);
            log.info("ã€è¯Šæ–­ã€‘ä»ç¼“å­˜è·å–æ–‡æ¡£ï¼Œé”šç‚¹æ•°: {}", anchorCount);
        }
    } catch (Exception e) {
        log.warn("âš ï¸ è·å–ç¼“å­˜å¤±è´¥: {}", e.getMessage());
        documentWithAnchorBytes = file.getBytes();
    }
}
```

2. **åœ¨è¡Œ 323-346 ä¹‹å‰æ·»åŠ è¯Šæ–­**ï¼š
```java
// ã€è¯Šæ–­ã€‘éªŒè¯åŒ…è£…åçš„æ–‡ä»¶æ˜¯å¦è¿”å›æ­£ç¡®çš„å­—èŠ‚
byte[] testBytes = finalDocumentBytes;
log.info("ã€è¯Šæ–­ã€‘fileForAnnotation å¤§å°: {} bytes", testBytes.length);
int anchorCount = countAnchorsInDocument(testBytes);
log.info("ã€è¯Šæ–­ã€‘fileForAnnotation ä¸­çš„é”šç‚¹æ•°: {}", anchorCount);
```

3. **åœ¨è¡Œ 348 å‰æ·»åŠ è¯Šæ–­**ï¼š
```java
// ã€è¯Šæ–­ã€‘éªŒè¯ issues ä¸­çš„ anchorId
for (ReviewIssue issue : issues) {
    if (issue.getAnchorId() == null) {
        log.error("ã€è¯Šæ–­ã€‘Issue anchorId == null: clauseId={}", issue.getClauseId());
    }
}
```

---

## ç›¸å…³ä»£ç æ–‡ä»¶

- âœ“ `ContractParseService.java:86-94` - é”šç‚¹ç”Ÿæˆ
- âœ“ `ContractParseService.java:149-162` - ç¼“å­˜å­˜å‚¨
- âœ“ `ParseResultCache.java` - ç¼“å­˜ç®¡ç†
- âœ“ `QwenRuleReviewController.java:271-349` - **ä¸€é”®å®¡æŸ¥å·¥ä½œæµæ ¸å¿ƒ**
- âœ“ `QwenRuleReviewService.java:221-256` - è§£æ anchorId
- âœ“ `XmlContractAnnotateService.java:42-93` - æ‰¹æ³¨è°ƒç”¨
- âœ“ `WordXmlCommentProcessor.java` - æ‰¹æ³¨æ‰§è¡Œï¼ˆå·²éªŒè¯æ­£ç¡®ï¼‰

---

## ç›¸å…³æ—¥å¿—å…³é”®è¯

ç”¨äºå®šä½é—®é¢˜çš„æ—¥å¿—æœç´¢å…³é”®è¯ï¼š
- `parseResultId` - ç¼“å­˜ID
- `documentWithAnchorBytes` - å¸¦é”šç‚¹çš„æ–‡æ¡£
- `æœªæ‰¾åˆ°anchorIdå¯¹åº”çš„ä¹¦ç­¾` - é—®é¢˜ç—‡çŠ¶
- `ä¸¥æ ¼æ¨¡å¼æ–‡æœ¬åŒ¹é…å¤±è´¥` - é™çº§æ ‡å¿—
