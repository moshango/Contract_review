# 下载错误文件问题分析

## 问题确认

对比结果显示：
- **本地保存的文档**：`测试合同_C档_长文本版_一键审查_A_20251031_103358.docx` ✅ 包含7个批注
- **MinIO下载的文档**：`测试合同_C档_长文本版.docx` ❌ 缺少批注文件（原始文档）

## 问题根源

用户下载的是**原始上传的文件**，而不是**审查后的带批注文件**。

### 可能的原因

1. **下载了错误的URL**
   - 前端可能提供了两个下载链接：
     - `originalUrl`：原始文档（不带批注）
     - `minioUrl`：审查后的文档（带批注）
   - 用户可能点击了 `originalUrl` 而不是 `minioUrl`

2. **前端显示问题**
   - 前端可能默认显示原始文档的下载链接
   - 或者两个链接的标签/描述不清楚

3. **MinIO中存储了多个版本**
   - 原始文档：`contracts/.../测试合同_C档_长文本版.docx`
   - 审查后文档：`reports/.../_____C_______一键审查_A_20251031_103358_7b475346.docx`
   - 用户可能下载了错误的版本

## 代码检查

### 原始文档上传逻辑

```java
// 步骤1：保存原始文件到MinIO
String originalUrl = null;
try {
    if (minioFileService.isEnabled()) {
        String originalObjName = minioFileService.generateObjectName(filename, "contracts");
        originalUrl = minioFileService.uploadBytes(
            file.getBytes(),
            originalObjName,
            file.getContentType()
        );
        log.info("✓ 原始文件已保存到MinIO: {}", originalUrl);
    }
} catch (Exception ex) {
    log.warn("原始文件上传MinIO失败: {}", ex.getMessage());
}
```

### 审查后文档上传逻辑

```java
// 步骤7：保存带批注的文档到MinIO
String minioUrl = null;
try {
    if (minioFileService.isEnabled()) {
        String minioObjectName = minioFileService.generateReportObjectName(
            filename, "一键审查", stance);
        minioUrl = minioFileService.uploadBytes(
            annotatedDocBytes,  // ← 带批注的文档
            minioObjectName,
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        );
    }
}
```

## 解决方案

### 方案1：前端只显示审查后的文档链接

确保前端默认显示或只显示 `minioUrl`（审查后的文档），而不是 `originalUrl`。

### 方案2：明确区分两个链接

如果前端需要显示两个链接，应该明确标注：
- "下载原始文档" → `originalUrl`
- "下载审查结果（带批注）" → `minioUrl`

### 方案3：检查前端代码

检查前端 `List.vue` 中的下载逻辑：

```vue
<el-button @click="downloadFile(row.minioUrl)">下载审查结果</el-button>
<!-- 或 -->
<el-button @click="downloadFile(row.originalUrl)">下载原始文档</el-button>
```

## 验证步骤

### 1. 检查前端返回的数据

查看前端收到的响应数据：
```json
{
  "success": true,
  "minioUrl": "http://localhost:9000/contract-review/reports/_____C_______一键审查_A_20251031_103358_7b475346.docx",
  "originalUrl": "http://localhost:9000/contract-review/contracts/.../测试合同_C档_长文本版.docx"
}
```

### 2. 检查前端下载逻辑

检查前端代码中：
- 哪个URL被用于下载？
- 用户界面如何显示的？

### 3. 直接从MinIO下载正确的文件

使用正确的objectName直接下载：
```
reports/_____C_______一键审查_A_20251031_103358_7b475346.docx
```

然后对比下载的文件和本地保存的文件，应该完全一致。

## 立即修复建议

### 修复1：确保前端使用正确的URL

在前端代码中，确保下载审查结果时使用 `minioUrl`：

```javascript
// 正确的做法
const downloadUrl = row.minioUrl || row.originalUrl;
// 如果可能，优先使用minioUrl

// 或者明确提示
if (row.minioUrl) {
    // 下载审查结果（带批注）
    downloadFile(row.minioUrl, "审查结果_" + row.name);
} else if (row.originalUrl) {
    // 下载原始文档（不带批注）
    downloadFile(row.originalUrl, "原始文档_" + row.name);
}
```

### 修复2：在响应中明确标注

后端可以在响应中添加说明：

```java
response.put("minioUrl", minioUrl);
response.put("minioUrlDescription", "审查结果文档（带批注）");
response.put("originalUrl", originalUrl);
response.put("originalUrlDescription", "原始文档（不带批注）");
```

---

**问题状态**：确认 - 用户下载了原始文档而不是审查后的文档  
**修复优先级**：高 - 需要确保前端正确显示和使用审查后的文档链接  
**下一步**：检查前端代码，确保下载使用的是 `minioUrl`


