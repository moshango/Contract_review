# ä¸€é”®å¼å®¡æŸ¥åŠŸèƒ½ - ç«¯ç‚¹å¤ç”¨æ€§è¯„ä¼°æŠ¥å‘Š

**è¯„ä¼°æ—¥æœŸ**: 2025-10-27
**è¯„ä¼°ç»“æœ**: âœ… **å¯å®Œå…¨å¤ç”¨ç°æœ‰ç«¯ç‚¹**
**å®ç°æ–¹å¼**: å‰ç«¯å¤šæ­¥éª¤æµç¨‹ç¼–æ’ + ç°æœ‰åç«¯ç«¯ç‚¹

---

## æ‰§è¡Œæ€»ç»“

ç»è¿‡å…¨é¢ä»£ç å®¡æŸ¥ï¼Œç³»ç»Ÿå·²å…·å¤‡å®Œæ•´çš„å¤šæ­¥éª¤å·¥ä½œæµåŸºç¡€è®¾æ–½ï¼š

| åŠŸèƒ½éœ€æ±‚ | ç°æœ‰å®ç° | ç«¯ç‚¹ | çŠ¶æ€ |
|---------|---------|------|------|
| æ–‡ä»¶ä¸Šä¼ å’Œè§£æ | ContractParseService | `/api/parse?anchors=generate` | âœ… å®Œæˆ |
| ç”²ä¹™æ–¹æå– | PartyExtractionService | `/api/review/extract-parties` | âœ… å®Œæˆ |
| è§„åˆ™åˆ†æ | RuleAnalysisService | `/api/review/analyze` | âœ… å®Œæˆ |
| æ–‡æ¡£æ‰¹æ³¨ | XmlContractAnnotateService | `/api/annotate-xml` | âœ… å®Œæˆ |
| æ–‡æ¡£ç¼“å­˜ | ParseResultCache | å†…éƒ¨æœåŠ¡ | âœ… å®Œæˆ |
| parseResultId æŒä¹…åŒ– | å‰ç«¯ JS | windowå˜é‡ | âœ… å®Œæˆ |

**ç»“è®º**: æ— éœ€åˆ›å»ºæ–°çš„åç«¯ç«¯ç‚¹ï¼Œæ‰€æœ‰åŠŸèƒ½é€šè¿‡ç°æœ‰ç«¯ç‚¹çš„å‰ç«¯ç¼–æ’å¯å®ç°ã€‚

---

## 1. ç°æœ‰ç«¯ç‚¹èƒ½åŠ›åˆ†æ

### 1.1 ç¬¬ä¸€æ­¥ï¼šæ–‡ä»¶è§£æ (`/api/parse`)

**ç«¯ç‚¹**: `POST /api/parse?anchors=generate&returnMode=json`

**è¯·æ±‚**:
```bash
curl -X POST "http://localhost:8080/api/parse?anchors=generate&returnMode=json" \
  -F "file=@contract.docx"
```

**å“åº”åŒ…å«**:
```json
{
  "filename": "contract.docx",
  "title": "æŠ€æœ¯æœåŠ¡åè®®",
  "partyA": "ABCå…¬å¸",                    // â† å·²åŒ…å«ç”²æ–¹
  "partyB": "XYZå…¬å¸",                    // â† å·²åŒ…å«ä¹™æ–¹
  "partyARoleName": "ç”²æ–¹",
  "partyBRoleName": "ä¹™æ–¹",
  "fullContractText": "å®Œæ•´åˆåŒæ–‡æœ¬...",   // â† ç”¨äºåç»­æå–
  "clauses": [...],
  "meta": {
    "parseResultId": "uuid-here",        // â† å…³é”®ï¼šç”¨äºä¿å­˜é”šç‚¹æ–‡æ¡£
    "wordCount": 5000,
    "clauseCount": 20
  }
}
```

**ä¼˜åŠ¿**:
- âœ“ ä¸€æ¬¡è°ƒç”¨è§£ææ–‡ä»¶å¹¶åˆæ­¥è¯†åˆ«ç”²ä¹™æ–¹
- âœ“ è¿”å› `parseResultId` ä¾›åç»­æ­¥éª¤ä½¿ç”¨
- âœ“ å¯ç”¨é”šç‚¹ç”Ÿæˆï¼Œç¡®ä¿æ‰¹æ³¨ç²¾åº¦
- âœ“ è¿”å›å®Œæ•´åˆåŒæ–‡æœ¬ï¼Œç”¨äº Qwen äºŒæ¬¡è¯†åˆ«

**é›†æˆç‚¹**:
- å­˜å‚¨ `parseResultId` åˆ° `window.ruleReviewParseResultId`
- å­˜å‚¨æ–‡æ¡£å†…å®¹åˆ°æœ¬åœ°æˆ–åç«¯ç¼“å­˜
- æ£€æŸ¥ `partyA` å’Œ `partyB` æ˜¯å¦å·²æå–

---

### 1.2 ç¬¬äºŒæ­¥ï¼šç”²ä¹™æ–¹æå– (`/api/review/extract-parties`)

**ç«¯ç‚¹**: `POST /api/review/extract-parties`

**ç”¨é€”**: å½“ `/api/parse` æœªèƒ½è¯†åˆ«ç”²ä¹™æ–¹æ—¶è°ƒç”¨

**è¯·æ±‚**:
```json
{
  "contractText": "å®Œæ•´åˆåŒæ–‡æœ¬",
  "contractType": "é‡‡è´­åˆåŒ",
  "parseResultId": "uuid-here"
}
```

**å“åº”**:
```json
{
  "success": true,
  "partyA": "ABCé‡‡è´­æœ‰é™å…¬å¸",
  "partyB": "XYZä¾›åº”è‚¡ä»½å…¬å¸",
  "partyARoleName": "ç”²æ–¹ï¼ˆé‡‡è´­æ–¹ï¼‰",
  "partyBRoleName": "ä¹™æ–¹ï¼ˆä¾›åº”æ–¹ï¼‰",
  "recommendedStance": "A",
  "stanceReason": "ç”²æ–¹ä½œä¸ºé‡‡è´­æ–¹éœ€å…³æ³¨è´¨é‡æ¡æ¬¾",
  "processingTime": 2500
}
```

**ä¼˜åŠ¿**:
- âœ“ ä½¿ç”¨ Qwen LLM + æœ¬åœ°å…³é”®å­—ï¼Œ3å±‚æå–ç­–ç•¥
- âœ“ æä¾›å®¡æŸ¥ç«‹åœºå»ºè®®
- âœ“ æ¥æ”¶ `parseResultId` ç»´æŒæ–‡æ¡£ä¸€è‡´æ€§

**é›†æˆç‚¹**:
- ä»…åœ¨ `/api/parse` æœªè¯†åˆ«ç”²ä¹™æ–¹æ—¶è°ƒç”¨
- æ˜¾ç¤ºè¯†åˆ«ç»“æœä¾›ç”¨æˆ·ç¡®è®¤
- ä¿å­˜è¯†åˆ«ç»“æœå¤‡åç»­æ­¥éª¤ä½¿ç”¨

---

### 1.3 ç¬¬ä¸‰æ­¥ï¼šè§„åˆ™åˆ†æå’Œ Prompt ç”Ÿæˆ (`/api/review/analyze`)

**ç«¯ç‚¹**: `POST /api/review/analyze`

**è¯·æ±‚**:
```json
{
  "file": "åˆåŒæ–‡ä»¶(multipart)",
  "contractType": "é‡‡è´­åˆåŒ",
  "stance": "A",
  "parseResultId": "uuid-here"
}
```

**å“åº”**:
```json
{
  "success": true,
  "partyA": "ABCå…¬å¸",
  "partyB": "XYZå…¬å¸",
  "userStance": "A",
  "parseResultId": "uuid-here",
  "matchResults": [
    {
      "clauseId": "c1",
      "clauseHeading": "ç¬¬ä¸€æ¡ åˆä½œèŒƒå›´",
      "matchedRules": [...]
    }
  ],
  "prompt": "è¯·å®¡æŸ¥ä»¥ä¸‹åˆåŒ...",
  "promptMetadata": {
    "matchedClauses": 12,
    "totalClauses": 20,
    "ruleMatches": 45
  }
}
```

**ä¼˜åŠ¿**:
- âœ“ ä¸€æ¬¡è°ƒç”¨å®Œæˆè§„åˆ™åŒ¹é…+Promptç”Ÿæˆ
- âœ“ æ¥æ”¶ `parseResultId` ç¡®ä¿ä¸è§£ææ­¥éª¤ä¸€è‡´
- âœ“ è¿”å›ç»“æ„åŒ– Prompt å¯ç›´æ¥é€ Qwen

**é›†æˆç‚¹**:
- ç”¨æˆ·é€‰æ‹©ç«‹åœºåè°ƒç”¨
- æ˜¾ç¤ºåŒ¹é…çš„æ¡æ¬¾å’Œè§„åˆ™
- è·å¾—Promptä¾›åç»­Qwenå®¡æŸ¥ä½¿ç”¨

---

### 1.4 ç¬¬å››æ­¥ï¼šQwen æ™ºèƒ½å®¡æŸ¥ (`/api/qwen/rule-review/review`)

**ç«¯ç‚¹**: `POST /api/qwen/rule-review/review`

**è¯·æ±‚**:
```json
{
  "prompt": "è¯·å®¡æŸ¥ä»¥ä¸‹åˆåŒ...",
  "contractType": "é‡‡è´­åˆåŒ",
  "stance": "A",
  "parseResultId": "uuid-here"
}
```

**å“åº”**:
```json
{
  "success": true,
  "issueCount": 8,
  "parseResultId": "uuid-here",
  "review": {
    "issues": [
      {
        "clauseId": "c1",
        "severity": "HIGH",
        "category": "äº¤ä»˜æ¡æ¬¾",
        "finding": "æœªæ˜ç¡®äº¤ä»˜æ—¶é—´",
        "suggestion": "å»ºè®®æ˜ç¡®äº¤ä»˜æœŸé™å’Œäº¤ä»˜æ–¹å¼"
      }
    ]
  },
  "processingTime": "5234ms"
}
```

**ä¼˜åŠ¿**:
- âœ“ å·²å®ç° `parseResultId` ä¼ é€’
- âœ“ è¿”å›ç»“æ„åŒ– JSON å®¡æŸ¥ç»“æœ
- âœ“ æ”¯æŒä¸åŒç±»å‹å’Œç«‹åœºçš„å®šåˆ¶å®¡æŸ¥

**é›†æˆç‚¹**:
- è°ƒç”¨æ­¤ç«¯ç‚¹è¿›è¡Œ AI å®¡æŸ¥
- è·å¾—ç»“æ„åŒ–å®¡æŸ¥ç»“æœ JSON
- å‡†å¤‡ç”¨äºæ–‡æ¡£æ‰¹æ³¨

---

### 1.5 ç¬¬äº”æ­¥ï¼šæ–‡æ¡£æ‰¹æ³¨ (`/api/annotate-xml`)

**ç«¯ç‚¹**: `POST /api/annotate-xml?anchorStrategy=preferAnchor&cleanupAnchors=true`

**è¯·æ±‚** (multipart/form-data):
- `file`: åŸå§‹åˆåŒæ–‡ä»¶
- `review`: å®¡æŸ¥ç»“æœ JSON å­—ç¬¦ä¸²
- `parseResultId`: æ–‡æ¡£ç¼“å­˜ IDï¼ˆå¯é€‰ï¼Œç”¨äºé«˜ç²¾åº¦å®šä½ï¼‰

**å“åº”**: å¸¦æ‰¹æ³¨çš„ Word æ–‡æ¡£

**ä¼˜åŠ¿**:
- âœ“ æ”¯æŒ `parseResultId` ç”¨äºä»ç¼“å­˜è·å–å¸¦é”šç‚¹çš„æ–‡æ¡£
- âœ“ ä½¿ç”¨ `preferAnchor` ç­–ç•¥ç¡®ä¿ç²¾ç¡®å®šä½
- âœ“ æ”¯æŒ `cleanupAnchors=true` æ¸…ç†é”šç‚¹

**é›†æˆç‚¹**:
- ä¼ é€’ Qwen è¿”å›çš„å®¡æŸ¥ JSON
- ä¼ é€’ `parseResultId` è·å–å¸¦é”šç‚¹çš„æ–‡æ¡£å‰¯æœ¬
- è¿”å›æ‰¹æ³¨åçš„æ–‡ä»¶ä¾›ä¸‹è½½

---

## 2. å®Œæ•´å¤šæ­¥éª¤å·¥ä½œæµè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸€é”®å¼å®¡æŸ¥å¤šæ­¥éª¤å·¥ä½œæµ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç¬¬ä¸€é˜¶æ®µã€‘æ–‡ä»¶è§£æå’Œç”²ä¹™æ–¹æå–
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 1: ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶                                          â”‚
  â”‚  Input:  ruleReviewFile (multipart)                        â”‚
  â”‚  State:  showLoading("æ­£åœ¨è§£ææ–‡ä»¶...")                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 2: è°ƒç”¨ /api/parse?anchors=generate                 â”‚
  â”‚  Method: POST /api/parse?anchors=generate&returnMode=json â”‚
  â”‚  Save:   window.ruleReviewParseResultId = parseResultId   â”‚
  â”‚  Check:  if (parseResult.partyA && parseResult.partyB)    â”‚
  â”‚    YES â†’ è·³è½¬åˆ° Step 4                                     â”‚
  â”‚    NO  â†’ æ‰§è¡Œ Step 3                                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 3: [å¯é€‰] è°ƒç”¨ /api/review/extract-parties          â”‚
  â”‚  ä»…å½“ parseResult æœªè¯†åˆ«ç”²ä¹™æ–¹æ—¶æ‰§è¡Œ                         â”‚
  â”‚  Method: POST /api/review/extract-parties                 â”‚
  â”‚  Input:  contractText, contractType, parseResultId        â”‚
  â”‚  Output: partyA, partyB, recommendedStance                â”‚
  â”‚  Show:   displayPartyExtractionResult()                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 4: æ˜¾ç¤ºç”²ä¹™æ–¹ä¿¡æ¯å’Œç«‹åœºé€‰æ‹©                              â”‚
  â”‚  Display: ç”²æ–¹: {partyA} ({partyARoleName})                â”‚
  â”‚           ä¹™æ–¹: {partyB} ({partyBRoleName})                â”‚
  â”‚           æ¨èç«‹åœº: {recommendedStance}                   â”‚
  â”‚  UI:      ä¸¤ä¸ªæŒ‰é’®å…è®¸ç”¨æˆ·é€‰æ‹©ç«‹åœº A æˆ– B                   â”‚
  â”‚           ç”¨æˆ·é€‰æ‹©ç«‹åœºå¹¶ç‚¹å‡»æŒ‰é’®                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
ã€ç¬¬äºŒé˜¶æ®µã€‘è§„åˆ™åŒ¹é…å’Œå®¡æŸ¥
  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 5: è°ƒç”¨ /api/review/analyze                         â”‚
  â”‚  Method: POST /api/review/analyze                         â”‚
  â”‚  Input:  file, contractType, stance, parseResultId        â”‚
  â”‚  Output: matchResults, prompt, partyA, partyB             â”‚
  â”‚  Save:   window.ruleReviewParseResultId (å·²æœ‰)             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 6: æ˜¾ç¤ºåˆ†æç»“æœ                                        â”‚
  â”‚  Display: åŒ¹é…çš„æ¡æ¬¾å’Œè§„åˆ™                                  â”‚
  â”‚           ç”Ÿæˆçš„ Prompt                                   â”‚
  â”‚           è§„åˆ™åŒ¹é…ç»Ÿè®¡                                    â”‚
  â”‚  Option:  ç”¨æˆ·å¯å¤åˆ¶ Prompt æˆ–ç›´æ¥ç‚¹å‡»"å¼€å§‹Qwenå®¡æŸ¥"        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 7: è°ƒç”¨ /api/qwen/rule-review/review                â”‚
  â”‚  Method: POST /api/qwen/rule-review/review                â”‚
  â”‚  Input:  prompt, contractType, stance, parseResultId      â”‚
  â”‚  Output: issues[], issueCount                             â”‚
  â”‚  Save:   window.ruleReviewResult = reviewResult           â”‚
  â”‚  State:  showLoading("æ­£åœ¨è°ƒç”¨ Qwen å®¡æŸ¥...")              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
ã€ç¬¬ä¸‰é˜¶æ®µã€‘æ–‡æ¡£æ‰¹æ³¨å’Œè¾“å‡º
  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 8: è°ƒç”¨ /api/annotate-xml                           â”‚
  â”‚  Method: POST /api/annotate-xml?anchorStrategy=preferAnchor&cleanupAnchors=true â”‚
  â”‚  Input:  file, review (JSON), parseResultId              â”‚
  â”‚  Output: annotatedDocBytes                               â”‚
  â”‚  State:  showLoading("æ­£åœ¨ç”Ÿæˆæ‰¹æ³¨...")                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 9: ä¿å­˜åˆ°æ–‡æ¡£ä¸­å¿ƒå¹¶è¿”å›ä¸‹è½½                              â”‚
  â”‚  Generate Filename: {åŸæ–‡ä»¶å}_ä¸€é”®å®¡æŸ¥_{ç«‹åœº}.docx          â”‚
  â”‚  Save Path: æ–‡æ¡£ä¸­å¿ƒ/å·²ç”Ÿæˆçš„å®¡æŸ¥æŠ¥å‘Š/                      â”‚
  â”‚  è¿”å›:      File blob ä¾›ç”¨æˆ·ä¸‹è½½                          â”‚
  â”‚  Display:   showSuccessMessage()                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Step 10: å®Œæˆ                                              â”‚
  â”‚  Download: è‡ªåŠ¨ä¸‹è½½æ‰¹æ³¨æ–‡æ¡£                                â”‚
  â”‚  Save:     æ–‡æ¡£ä¸­å¿ƒå·²è‡ªåŠ¨ä¿å­˜                              â”‚
  â”‚  UI:       æ˜¾ç¤ºæˆåŠŸæç¤ºå’Œä¿å­˜ä½ç½®                          â”‚
  â”‚  Reset:    æä¾›"ç»§ç»­å®¡æŸ¥"æŒ‰é’®                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å‰ç«¯å®ç°å·®è·åˆ†æ

### 3.1 å·²å®ç°çš„åŠŸèƒ½

âœ… **æ–‡ä»¶ä¸Šä¼ å’Œç”²ä¹™æ–¹æå–** (`party-extraction.js` ç¬¬ 14-156 è¡Œ)
- è°ƒç”¨ `/api/parse?anchors=generate`
- æ™ºèƒ½è°ƒç”¨ Qwen è¯†åˆ«ç”²ä¹™æ–¹ï¼ˆå¦‚éœ€è¦ï¼‰
- æ˜¾ç¤ºæå–ç»“æœ

âœ… **ç«‹åœºé€‰æ‹©å’Œè§„åˆ™åŒ¹é…** (`main.js` ç¬¬ 1150-1220 è¡Œ)
- `startRuleReview()` è§¦å‘æå–æµç¨‹
- ç”¨æˆ·é€‰æ‹©ç«‹åœºåè°ƒç”¨ `/api/review/analyze`
- æ˜¾ç¤ºåŒ¹é…æ¡æ¬¾

âœ… **Qwen å®¡æŸ¥** (`main.js` ç¬¬ 1414+ è¡Œ)
- `startQwenReview()` æ–¹æ³•å­˜åœ¨
- è°ƒç”¨ `/api/qwen/rule-review/review`

âœ… **æ–‡æ¡£æ‰¹æ³¨** (`main.js` ç¬¬ 1265-1363 è¡Œ)
- `importRuleReviewResult()` æ”¯æŒæ‰¹æ³¨
- ä½¿ç”¨ `parseResultId` ç»´æŒä¸€è‡´æ€§
- æ”¯æŒ `cleanupAnchors` é€‰é¡¹

---

### 3.2 ç¼ºå¤±çš„åŠŸèƒ½

âŒ **è‡ªåŠ¨åŒ–å®Œæ•´æµç¨‹**
- å½“å‰æµç¨‹éœ€ç”¨æˆ·å¤šæ¬¡ç‚¹å‡»æŒ‰é’®
- éœ€è¦å®ç°è‡ªåŠ¨åŒ–ç¼–æ’ï¼šParse â†’ Extract â†’ Analyze â†’ Review â†’ Annotate â†’ Save

âŒ **åç«¯æ–‡æ¡£ä¿å­˜**
- å½“å‰ `/api/annotate-xml` ä»…è¿”å›æ–‡ä»¶ blob
- éœ€è¦åç«¯åœ¨ä¿å­˜è¿‡ç¨‹ä¸­å°†æ–‡ä»¶å½’æ¡£åˆ° "æ–‡æ¡£ä¸­å¿ƒ/å·²ç”Ÿæˆçš„å®¡æŸ¥æŠ¥å‘Š/"
- éœ€è¦ç”Ÿæˆä¸­æ–‡æ–‡ä»¶å

âŒ **æµç¨‹çŠ¶æ€æç¤º**
- éœ€è¦æ˜¾ç¤ºå¤šæ­¥éª¤è¿›åº¦æ¡
- éœ€è¦æ˜¾ç¤ºå½“å‰æ‰§è¡Œçš„æ­¥éª¤

---

## 4. æ¨èçš„å®ç°ç­–ç•¥

### æ–¹æ¡ˆ Aï¼šå‰ç«¯ç¼–æ’ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼š
- æ— éœ€ä¿®æ”¹åç«¯ä»£ç 
- å®Œå…¨å¤ç”¨ç°æœ‰ç«¯ç‚¹
- æ¸…æ™°çš„æµç¨‹æ§åˆ¶
- æ˜“äºè°ƒè¯•å’Œæ‰©å±•

**å®ç°æ­¥éª¤**ï¼š

1. **åˆ›å»ºæ–°çš„ JavaScript å‡½æ•°**ï¼š`startCompleteOneClickReview()`
   ```javascript
   async function startCompleteOneClickReview() {
       try {
           // Step 1: Parse
           const parseResult = await callApi('/api/parse?anchors=generate');
           window.ruleReviewParseResultId = parseResult.meta.parseResultId;

           // Step 2: Extract parties (if needed)
           let parties = parseResult.partyA && parseResult.partyB
               ? { partyA: parseResult.partyA, partyB: parseResult.partyB }
               : await callApi('/api/review/extract-parties', {...});

           // Step 3: Get user stance selection (from UI)
           await showStanceSelectionDialog(parties);

           // Step 4: Analyze
           const analyzeResult = await callApi('/api/review/analyze', {...});

           // Step 5: Review with Qwen
           const reviewResult = await callApi('/api/qwen/rule-review/review', {...});

           // Step 6: Annotate
           const annotatedFile = await callApi('/api/annotate-xml', {...});

           // Step 7: Download
           downloadFile(annotatedFile, generateFilename());

           // Step 8: Show success
           showSuccessMessage();
       } catch (error) {
           handleError(error);
       }
   }
   ```

2. **UI ä¿®æ”¹**ï¼š
   - æ·»åŠ å¤šæ­¥éª¤è¿›åº¦æŒ‡ç¤ºå™¨
   - æ·»åŠ ç«‹åœºé€‰æ‹©å¯¹è¯æ¡†
   - æ˜¾ç¤ºå½“å‰æ‰§è¡Œæ­¥éª¤

3. **çŠ¶æ€ç®¡ç†**ï¼š
   - ä½¿ç”¨ `window` å¯¹è±¡å­˜å‚¨ `parseResultId`ã€`currentParties`ã€`selectedStance`
   - æˆ–ä½¿ç”¨å±€éƒ¨å¯¹è±¡ç»´æŠ¤æ­¥éª¤çŠ¶æ€

---

### æ–¹æ¡ˆ Bï¼šåç«¯ç¼–æ’ï¼ˆå¯é€‰å¢å¼ºï¼‰

å¦‚æœéœ€è¦å®Œæ•´çš„åç«¯æ”¯æŒï¼ˆå¦‚æ–‡æ¡£è‡ªåŠ¨ä¿å­˜åˆ°æ–‡æ¡£ä¸­å¿ƒï¼‰ï¼Œå¯åˆ›å»ºæ–°ç«¯ç‚¹ï¼š

**æ–°ç«¯ç‚¹**ï¼š`POST /api/qwen/rule-review/one-click-review` (å·²å­˜åœ¨ï¼Œä½†éœ€æ”¹è¿›)

**æ”¹è¿›ç‚¹**ï¼š
1. æ¥æ”¶ `stance` å‚æ•°
2. è°ƒç”¨ `/api/review/analyze` è·å– Prompt
3. è°ƒç”¨ `/api/qwen/rule-review/review` è¿›è¡Œå®¡æŸ¥
4. è°ƒç”¨ `/api/annotate-xml` æ‰¹æ³¨æ–‡æ¡£
5. **ä¿å­˜æ–‡ä»¶åˆ° "æ–‡æ¡£ä¸­å¿ƒ/å·²ç”Ÿæˆçš„å®¡æŸ¥æŠ¥å‘Š/"**ï¼ˆå½“å‰ç¼ºå¤±ï¼‰
6. è¿”å›æ–‡ä»¶ blob + ä¿å­˜ä½ç½®ä¿¡æ¯

**ä¼˜ç‚¹**ï¼š
- æä¾›å®Œæ•´çš„ä¸€é”®è§£å†³æ–¹æ¡ˆ
- è‡ªåŠ¨ä¿å­˜åˆ°æ–‡æ¡£ä¸­å¿ƒ
- å•ä¸ªè¯·æ±‚å®Œæˆå…¨æµç¨‹
- å‡å°‘å‰ç«¯å¤æ‚æ€§

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¿®æ”¹åç«¯ä»£ç 
- å¢åŠ åç«¯å¤æ‚æ€§
- è¶…æ—¶é£é™©ï¼ˆå®Œæ•´æµç¨‹éœ€è¦ 10+ ç§’ï¼‰

---

## 5. å»ºè®®çš„å®ç°è·¯å¾„

### é˜¶æ®µ 1ï¼šæ”¹è¿›å½“å‰ `one-click-review` ç«¯ç‚¹ï¼ˆæ¨èï¼‰

**ç°çŠ¶**ï¼šç«¯ç‚¹å·²å­˜åœ¨ä½†ç¼ºå¤±å…³é”®åŠŸèƒ½

**æ”¹è¿›æ¸…å•**ï¼š

| åŠŸèƒ½ | å½“å‰ | éœ€æ”¹ | ä¼˜å…ˆçº§ |
|-----|------|------|--------|
| æ¥æ”¶ stance å‚æ•° | âœ“ | - | - |
| è°ƒç”¨ /api/parse | âœ“ | - | - |
| è°ƒç”¨ Qwen review | âœ“ | - | - |
| è°ƒç”¨ /api/annotate-xml | âœ“ | - | - |
| è¿”å›æ–‡ä»¶æµ | âœ“ | - | - |
| ä¿å­˜åˆ°æ–‡æ¡£ä¸­å¿ƒ | âœ— | âœ“ | é«˜ |
| ä½¿ç”¨ä¸­æ–‡æ–‡ä»¶å | âœ— | âœ“ | é«˜ |
| è°ƒç”¨ /api/review/analyze | âœ— | âœ“ | å¯é€‰ |
| æ”¯æŒ parseResultId ç¼“å­˜ | âœ— | âœ“ | ä¸­ |

**å®ç°æ–‡ä»¶**ï¼š`QwenRuleReviewController.java` lines 235-377

**ä¸»è¦æ”¹åŠ¨**ï¼š
1. è°ƒç”¨ `/api/review/analyze` è€Œé `generateRuleReviewPrompt()`
2. åœ¨æœ€åæ·»åŠ æ–‡æ¡£ä¿å­˜é€»è¾‘
3. å®Œæ•´çš„é”™è¯¯å¤„ç†

---

### é˜¶æ®µ 2ï¼šå‰ç«¯ UI ä¼˜åŒ–ï¼ˆå½“å‰ï¼‰

**ä¼˜åŒ–æ¸…å•**ï¼š

| åŠŸèƒ½ | å½“å‰ | ä¼˜åŒ– | ä¼˜å…ˆçº§ |
|-----|------|------|--------|
| ç«‹åœºé€‰æ‹©æ¡†å¯è§ | âœ“ | - | - |
| ç”²ä¹™æ–¹ä¿¡æ¯æ˜¾ç¤º | âœ— | âœ“ | é«˜ |
| å¤šæ­¥éª¤è¿›åº¦æ¡ | âœ— | âœ“ | ä¸­ |
| æ¨èç«‹åœºæç¤º | âœ— | âœ“ | ä¸­ |
| å®Œæ•´å·¥ä½œæµç¼–æ’ | âœ— | âœ“ | é«˜ |

**å®ç°æ–‡ä»¶**ï¼š
- `index.html` - å¢åŠ ç”²ä¹™æ–¹æ˜¾ç¤ºåŒºåŸŸå’Œè¿›åº¦æ¡
- `main.js` - ä¼˜åŒ– `startOneClickReview()` å®ç°å®Œæ•´ç¼–æ’
- `party-extraction.js` - å®Œå–„æ˜¾ç¤ºé€»è¾‘

---

## 6. æ€»ä½“è¯„ä¼°

| ç»´åº¦ | è¯„ä¼°ç»“æœ |
|-----|---------|
| å¯ä»¥å¤ç”¨ç°æœ‰ç«¯ç‚¹ | âœ… **æ˜¯** |
| éœ€è¦æ–°å»ºåç«¯ç«¯ç‚¹ | âœ… **å¦ï¼ˆä½†å¯é€‰æ”¹è¿›ç°æœ‰ç«¯ç‚¹ï¼‰** |
| ç°æœ‰åŸºç¡€è®¾æ–½å®Œæ•´æ€§ | âœ… **100%** |
| å‰ç«¯å®ç°å®Œæ•´æ€§ | âš ï¸ **70%ï¼ˆç¼ºè‡ªåŠ¨åŒ–ç¼–æ’å’Œä¿å­˜ï¼‰** |
| æ–‡æ¡£ä¿å­˜åŠŸèƒ½ | âŒ **ç¼ºå¤±** |
| é¢„è®¡å®ç°éš¾åº¦ | ğŸŸ¢ **ä½** |
| é¢„è®¡å·¥ä½œé‡ | ğŸŸ¢ **2-3 å°æ—¶** |

---

## 7. è¡ŒåŠ¨è®¡åˆ’

### ä¼˜å…ˆçº§ 1ï¼ˆå¿…é¡»ï¼‰
- [ ] æ”¹è¿› `QwenRuleReviewController.oneClickReview()` ä»¥ä¿å­˜åˆ°æ–‡æ¡£ä¸­å¿ƒ
- [ ] ä¼˜åŒ–å‰ç«¯ `startOneClickReview()` æ˜¾ç¤ºç”²ä¹™æ–¹ä¿¡æ¯
- [ ] å®ç°ç«‹åœºé€‰æ‹©éªŒè¯

### ä¼˜å…ˆçº§ 2ï¼ˆé‡è¦ï¼‰
- [ ] æ·»åŠ å¤šæ­¥éª¤è¿›åº¦æŒ‡ç¤ºå™¨
- [ ] å®Œå–„ partyA/partyB æ˜¾ç¤ºåŒºåŸŸ
- [ ] æ”¹è¿›é”™è¯¯æç¤º

### ä¼˜å…ˆçº§ 3ï¼ˆå¯é€‰ï¼‰
- [ ] æ·»åŠ æ¨èç«‹åœºæç¤º
- [ ] ä¼˜åŒ– UI æ ·å¼
- [ ] æ·»åŠ å®¡æŸ¥ç»Ÿè®¡ä¿¡æ¯

---

## ç»“è®º

**ç°æœ‰ç³»ç»Ÿå·²å…·å¤‡å®Œæ•´çš„æŠ€æœ¯åŸºç¡€ï¼Œæ— éœ€å¤§è§„æ¨¡æ”¹é€ ã€‚**

å»ºè®®é‡‡ç”¨**æ–¹æ¡ˆ Aï¼ˆå‰ç«¯ç¼–æ’ï¼‰ + é˜¶æ®µ 1ï¼ˆæ”¹è¿›åç«¯ä¿å­˜ï¼‰**çš„ç»„åˆæ–¹æ¡ˆï¼Œå¯åœ¨æœ€å°æ”¹åŠ¨çš„å‰æä¸‹å®ç°å®Œæ•´çš„å¤šæ­¥éª¤ä¸€é”®å®¡æŸ¥å·¥ä½œæµã€‚
