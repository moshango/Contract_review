# 审查立场参数丢失问题 - 根本原因诊断

**完成时间**: 2025-10-27 15:35
**问题等级**: 🔴 严重 - 影响规则审查和批注结果
**诊断状态**: ✅ 完成

---

## ❌ 问题现象

用户报告：**选择审查立场后失效，立场参数丢失**

症状：
- ✅ 用户能看到立场选择界面（甲方/乙方）
- ✅ 用户点击立场按钮后有反应
- ❌ 但后续的规则审查、一键审查、批注结果中立场参数缺失
- ❌ 审查结果中应该按照选定的立场过滤规则，但没有

---

## 🔍 根本原因分析

### 问题1️⃣：前端参数名不统一

**位置1**: `main.js` 第1325行 - `performRuleReviewAnalysis()`
```javascript
formData.append('stance', stance);  // ❌ 发送的是 'stance'
```

**位置2**: `party-extraction.js` 第220行 - `selectRuleReviewStance()`
```javascript
formData.append('party', stance);   // ✅ 发送的是 'party'
```

**问题**：两个地方发送的参数名不同！

**后端期望**（`ApiReviewController.java` 第80行）：
```java
@RequestParam(value = "party", required = false) String party
```

**结果**：
- ✅ `party-extraction.js` 中的立场被正确识别
- ❌ `main.js` 中的立场被忽略（参数名错误）

---

### 问题2️⃣：立场参数在导入批注时完全丢失

**位置**: `main.js` 第1558行 - `importRuleReviewResult()`

```javascript
async function importRuleReviewResult() {
    // ... 代码中完全没有获取立场参数！
    const chatgptResponse = document.getElementById('rule-review-response').value.trim();
    // 之后直接构建 URL，不包含任何立场信息
    let url = `/chatgpt/import-result?cleanupAnchors=${cleanupAnchors}`;
    // ❌ 没有 party 或 stance 参数
}
```

**影响**：
- 导入批注时无法按照用户选择的立场进行处理
- 如果后端需要立场信息来调整批注方式，会失效

---

### 问题3️⃣：一键审查中立场传递正确，但后端可能没有处理

**位置**: `main.js` 第1402行 - `performOneClickReview()`
```javascript
formData.append('stance', stance);  // ❌ 发送的是 'stance'，不是 'party'
```

**后端期望**：`party` 参数
**实际收到**：`stance` 参数

**结果**：后端无法识别立场

---

### 问题4️⃣：立场信息没有保存到全局变量

**缺失**：没有像 `window.ruleReviewParseResultId` 这样的全局变量保存立场

**后果**：
- 立场信息无法在整个工作流中持久化
- 用户选择的立场在不同操作间丢失

---

## 📊 问题影响对比

| 场景 | 立场参数名 | 发送方式 | 后端识别 | 影响 |
|------|-----------|--------|--------|------|
| `performRuleReviewAnalysis()` | `stance` ❌ | FormData | ❌ 不识别 | 规则过滤失效 |
| `selectRuleReviewStance()` | `party` ✅ | FormData | ✅ 识别 | 正常 |
| `performOneClickReview()` | `stance` ❌ | FormData | ❌ 不识别 | 结果不按立场区分 |
| `importRuleReviewResult()` | 无 ❌ | 不发送 | ❌ 丢失 | 无法用立场调整批注 |

---

## 🔗 工作流追踪

### 规则审查工作流

```
1. extractRuleReviewParties() [party-extraction.js]
   ↓
2. displayPartyExtractionResult() 显示立场选择
   ↓
3. 用户点击立场按钮 (A方/B方)
   ↓
4. selectRuleReviewStance(stance) [party-extraction.js]  ✅ 发送 'party' 参数
   ↓
5. 后端 /api/review/analyze 识别立场 ✅
   ↓
6. displayRuleReviewResults() 显示分析结果
   ↓
7. 用户输入ChatGPT审查结果
   ↓
8. importRuleReviewResult() [main.js]  ❌ 不发送立场参数
   ↓
9. 后端 /chatgpt/import-result 无法获取立场 ❌
   ↓
10. 批注时丧失立场上下文
```

### 一键审查工作流

```
1. extractRuleReviewParties() [party-extraction.js]  ✅
   ↓
2. displayPartyExtractionResult() 显示立场选择  ✅
   ↓
3. 用户点击立场按钮
   ↓
4. performOneClickReview() [main.js]  ❌ 发送 'stance' 参数（应该是 'party'）
   ↓
5. 后端 /api/qwen/rule-review/one-click-review 无法识别立场 ❌
   ↓
6. Qwen审查结果不考虑立场
```

---

## 📋 问题清单

| # | 问题 | 位置 | 严重性 | 解决方案 |
|---|------|------|--------|---------|
| 1 | `performRuleReviewAnalysis()` 中参数名错误 | main.js:1325 | 🔴 高 | 改为 'party' |
| 2 | `performOneClickReview()` 中参数名错误 | main.js:1402 | 🔴 高 | 改为 'party' |
| 3 | `importRuleReviewResult()` 没有发送立场 | main.js:1558 | 🔴 高 | 添加立场参数 |
| 4 | 立场没有保存到全局变量 | 全局 | 🟡 中 | 添加 `window.ruleReviewStance` |
| 5 | ChatGPT导入时也应该使用立场 | main.js 某处 | 🟡 中 | 检查ChatGPT流程 |

---

## ✅ 解决方案

### 修复1：修改 `performRuleReviewAnalysis()` 中的参数名

**文件**: `main.js` 第1325行

```javascript
// 修改前 ❌
formData.append('stance', stance);

// 修改后 ✅
formData.append('party', stance);
```

同时添加全局变量保存：
```javascript
// 添加代码
window.ruleReviewStance = stance;
console.log('✅ 【关键】已保存审查立场:', window.ruleReviewStance);
```

### 修复2：修改 `performOneClickReview()` 中的参数名

**文件**: `main.js` 第1402行

```javascript
// 修改前 ❌
formData.append('stance', stance);

// 修改后 ✅
formData.append('party', stance);
```

同时添加全局变量保存：
```javascript
// 添加代码
window.ruleReviewStance = stance;
console.log('✅ 【关键】已保存审查立场:', window.ruleReviewStance);
```

### 修复3：在 `importRuleReviewResult()` 中传递立场

**文件**: `main.js` 第1595-1620行

```javascript
// 修改前 ❌
const cleanupAnchors = document.getElementById('rule-review-cleanup-anchors').checked;
let url = `/chatgpt/import-result?cleanupAnchors=${cleanupAnchors}`;

// 修改后 ✅
const cleanupAnchors = document.getElementById('rule-review-cleanup-anchors').checked;

// 【关键修复】获取保存的立场
const stance = window.ruleReviewStance;

let url = `/chatgpt/import-result?cleanupAnchors=${cleanupAnchors}`;

// 添加立场参数
if (stance) {
    url += `&party=${encodeURIComponent(stance)}`;
    console.log('✅ 【关键】将传递立场参数:', stance);
    showToast('✅ 使用立场信息进行批注...', 'info');
} else {
    console.warn('⚠️ 立场信息不存在，批注可能不精确');
    showToast('⚠️ 警告：立场信息丢失，批注可能不考虑立场因素', 'warning');
}
```

---

## 📊 修改统计

| 项目 | 详情 |
|------|------|
| 修改文件 | 1个 (main.js) |
| 修改位置 | 3处 (1325, 1402, 1595-1620) |
| 修改行数 | ~12行 |
| 新增代码 | 立场保存 + 日志 + 条件检查 |
| 向后兼容 | ✅ 是 (没有删除代码) |

---

## 🎯 验证点

修复后应验证以下内容：

```
1. 规则审查流程
   ✓ 选择文件
   ✓ 选择合同类型
   ✓ 显示甲乙方信息
   ✓ 点击立场按钮（选择甲方或乙方）
   ✓ Console 中验证日志: "✅ 【关键】已保存审查立场"
   ✓ 开始规则审查
   ✓ 在规则匹配结果中，应该看到根据立场过滤的规则
   ✓ 输入ChatGPT审查结果
   ✓ 导入批注结果
   ✓ 验证日志: "✅ 【关键】将传递立场参数"
   ✓ 下载文档

2. 一键审查流程
   ✓ 选择文件
   ✓ 显示甲乙方信息
   ✓ 点击立场按钮
   ✓ Console 中验证日志: "✅ 【关键】已保存审查立场"
   ✓ 点击"开始一键审查"
   ✓ 下载文档
   ✓ 验证文档中的批注和建议与立场相符

3. ChatGPT流程 (如果存在)
   ✓ 验证立场参数也被正确处理
```

---

## 🔍 深层问题

这个问题反映出的设计缺陷：

1. **参数命名不一致**
   - 有的地方用 `stance`，有的用 `party`
   - 后端期望 `party`，但前端有时发送 `stance`

2. **状态管理散落**
   - 立场信息没有统一的全局变量保存
   - 无法在不同的工作流步骤间传递

3. **工作流缺乏状态上下文**
   - 每个步骤独立工作
   - 立场等关键信息在步骤间丢失

这些都与之前诊断的**架构设计问题**是同一类问题，验证了统一工作流的必要性。

---

## 💡 长期建议

这个问题的完全解决，需要在架构统一中进行（见《合同审查系统统一工作流架构设计方案.md》）：

1. **统一参数命名** - 所有地方都用 `party` 或统一用某个名称
2. **统一状态管理** - 用 `ReviewContext` 保存所有状态
3. **明确的工作流** - 定义清晰的状态传递路径

---

## 🚀 快速修复预期

修复后：
- ✅ 立场参数正确传递到后端
- ✅ 规则审查根据立场过滤规则
- ✅ 批注时考虑立场因素
- ✅ 一键审查根据立场生成不同的结果

