# ğŸ” æ‰¹æ³¨ä¸¢å¤±é—®é¢˜çš„æ ¹æœ¬åŸå› å‘ç°

## å…³é”®å‘ç°

ä»ä½ æä¾›çš„æ—¥å¿—ä¸­ï¼Œæˆ‘å‘ç°äº†**çœŸæ­£çš„é—®é¢˜æ‰€åœ¨**ï¼

### è¯Šæ–­æ—¥å¿—åˆ†æ

**æ—¥å¿—æ˜¾ç¤º**ï¼š
```
ã€ç»´æµ‹ã€‘document.xmlä¿å­˜åè¯Šæ–­ï¼šcommentRangeStartæ•°é‡=0, commentRangeEndæ•°é‡=0, commentReferenceæ•°é‡=0
```

**ä½†åŒæ—¶**ï¼š
```
ã€ç»´æµ‹ã€‘ä¿å­˜comments.xmlå‰è¯Šæ–­ï¼šæ ¹å…ƒç´ =comments, æ‰¹æ³¨æ•°é‡=7, å·²æ·»åŠ æ‰¹æ³¨ID=[1, 2, 3, 4, 5, 6, 7]
ã€ç»´æµ‹ã€‘å…³ç³»: Id=rComments, Target=comments.xml
```

## é—®é¢˜æ‰€åœ¨

### æˆ‘ä¹‹å‰çš„è¯Šæ–­ä»£ç æœ‰ç¼ºé™·ï¼

åœ¨ä¿®å¤å‰çš„è¯Šæ–­ä»£ç ä¸­ï¼š
```java
List<Element> allCommentRangeStarts = body.elements(QName.get("commentRangeStart", W_NS));
```

**é—®é¢˜**ï¼š`body.elements()` **åªæŸ¥è¯¢ body çš„ç›´æ¥å­å…ƒç´ **ï¼

ä½†æ˜¯åœ¨ Word XML ä¸­ï¼Œæ‰¹æ³¨æ ‡è®°çš„ç»“æ„æ˜¯ï¼š
```xml
<w:body>
  <w:p>              <!-- æ®µè½ (bodyçš„ç›´æ¥å­å…ƒç´ )-->
    <w:commentRangeStart id="0"/>   <!-- è¢«åŸ‹åœ¨æ®µè½å†… -->
    <w:r>...</w:r>
    <w:commentRangeEnd id="0"/>     <!-- è¢«åŸ‹åœ¨æ®µè½å†… -->
    <w:r>
      <w:commentReference id="0"/>  <!-- è¢«åŸ‹åœ¨æ®µè½å†… -->
    </w:r>
  </w:p>
</w:body>
```

æ‰€ä»¥ `body.elements()` **æ‰¾ä¸åˆ°è¢«åµŒå¥—åœ¨æ®µè½å†…çš„æ‰¹æ³¨æ ‡è®°**ï¼

## ä¿®å¤æ–¹æ¡ˆ

å·²ä¿®æ”¹è¯Šæ–­ä»£ç ï¼Œä½¿ç”¨**é€’å½’æŸ¥æ‰¾**ï¼š

```java
// ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨é€’å½’æŸ¥æ‰¾æ‰€æœ‰æ®µè½ä¸­çš„æ‰¹æ³¨æ ‡è®°ï¼Œè€Œä¸æ˜¯åªæŸ¥ç›´æ¥å­å…ƒç´ 
List<Element> allCommentRangeStarts = findAllElementsRecursive(body, QName.get("commentRangeStart", W_NS));
List<Element> allCommentRangeEnds = findAllElementsRecursive(body, QName.get("commentRangeEnd", W_NS));
List<Element> allCommentRefs = findAllElementsRecursive(body, QName.get("commentReference", W_NS));
```

æ–°å¢çš„ `findAllElementsRecursive()` æ–¹æ³•ä¼šï¼š
1. éå† body ä¸­çš„**æ‰€æœ‰å­å…ƒç´ **ï¼ˆåŒ…æ‹¬æ®µè½ï¼‰
2. **é€’å½’æŸ¥æ‰¾**æ¯ä¸ªå­å…ƒç´ å†…éƒ¨çš„æ‰€æœ‰åä»£å…ƒç´ 
3. æ­£ç¡®æ‰¾åˆ°åµŒå¥—åœ¨æ®µè½ã€è¡¨æ ¼ç­‰å®¹å™¨å†…çš„æ‰¹æ³¨æ ‡è®°

## çœŸæ­£çš„é—®é¢˜å¯èƒ½æ˜¯

ç°åœ¨æ­£ç¡®çš„è¯Šæ–­ä»£ç ä¼šå¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°çœŸå®æƒ…å†µï¼š

### æƒ…å†µ Aï¼šç°åœ¨èƒ½æ‰¾åˆ°æ‰€æœ‰æ‰¹æ³¨æ ‡è®°äº† âœ“
**è¯´æ˜**ï¼šæ‰¹æ³¨æ ‡è®°ç¡®å®è¢«æ­£ç¡®æ’å…¥äº†ï¼é—®é¢˜å¯èƒ½å‡ºåœ¨å…¶ä»–åœ°æ–¹
**ä¸‹ä¸€æ­¥**ï¼šæ£€æŸ¥ Word æ˜¯å¦æ”¯æŒè¿™ç§æ‰¹æ³¨æ ¼å¼

### æƒ…å†µ Bï¼šä»ç„¶æ‰¾ä¸åˆ°æ‰¹æ³¨æ ‡è®°
**è¯´æ˜**ï¼šæ‰¹æ³¨æ ‡è®°æ²¡æœ‰è¢«æ’å…¥åˆ° document.xml ä¸­
**å¯èƒ½åŸå› **ï¼š
- `insertCommentRangeInDocument()` æˆ– `insertPreciseCommentRange()` æ²¡æœ‰çœŸæ­£æ‰§è¡Œ
- æˆ–è€…æ®µè½æŸ¥æ‰¾è¿‡ç¨‹æœ‰é—®é¢˜ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°ç›®æ ‡æ®µè½

## ä¸‹ä¸€æ­¥ï¼šé‡æ–°æµ‹è¯•

1. **é‡æ–°å¯åŠ¨åº”ç”¨**ï¼ˆåŠ è½½æ–°ç¼–è¯‘çš„ä»£ç ï¼‰
2. **é‡æ–°ä¸Šä¼ é•¿æ–‡æ¡£**å¹¶æ‰§è¡Œä¸€é”®å®¡æŸ¥
3. **æŸ¥çœ‹æ–°çš„è¯Šæ–­æ—¥å¿—**ï¼š
   ```
   ã€ç»´æµ‹ã€‘document.xmlä¿å­˜åè¯Šæ–­ï¼šcommentRangeStartæ•°é‡=X
   ```

4. **æŠ¥å‘Šç»“æœ**ï¼š
   - å¦‚æœ `commentRangeStartæ•°é‡ > 0`ï¼Œè¯´æ˜æ‰¹æ³¨æ ‡è®°çœŸçš„è¢«æ’å…¥äº†
   - å¦‚æœä»ç„¶æ˜¯ 0ï¼Œé‚£å°±éœ€è¦æ£€æŸ¥æ’å…¥é€»è¾‘

## ä¿®å¤çš„ä»£ç 

å·²æ·»åŠ ä¸¤ä¸ªæ–°æ–¹æ³•åˆ° `WordXmlCommentProcessor.java`ï¼š

```java
/**
 * é€’å½’æŸ¥æ‰¾æ‰€æœ‰æŒ‡å®šåç§°çš„å…ƒç´ ï¼ˆåŒ…æ‹¬åµŒå¥—åœ¨å…¶ä»–å…ƒç´ ä¸­çš„ï¼‰
 */
private List<Element> findAllElementsRecursive(Element element, QName targetQName) {
    List<Element> results = new ArrayList<>();
    collectElementsRecursive(element, targetQName, results);
    return results;
}

/**
 * é€’å½’æ”¶é›†æŒ‡å®šå…ƒç´ çš„è¾…åŠ©æ–¹æ³•
 */
private void collectElementsRecursive(Element element, QName targetQName, List<Element> results) {
    // å¦‚æœå½“å‰å…ƒç´ åŒ¹é…ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
    if (targetQName.equals(element.getQName())) {
        results.add(element);
    }

    // é€’å½’æŸ¥æ‰¾å­å…ƒç´ 
    for (Element child : element.elements()) {
        collectElementsRecursive(child, targetQName, results);
    }
}
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥å‡†ç¡®è·å¾—çœŸå®æƒ…å†µäº†ï¼
