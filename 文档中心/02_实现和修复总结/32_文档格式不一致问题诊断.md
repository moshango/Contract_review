# 文档格式不一致问题诊断

## 问题描述

用户报告：**文档内容不一致，格式被改了导致看不到批注**

- 本地保存的文档：正常显示批注 ✅
- MinIO中的文档（通过OnlyOffice访问）：格式被改，看不到批注 ❌

## 诊断方案

### 已添加的诊断功能

在 `QwenRuleReviewController` 中添加了MD5校验：

1. **上传前计算MD5**
   ```
   【诊断】上传前文档MD5: {hash}
   ```

2. **下载后计算MD5**
   ```
   【诊断】下载后文档MD5: {hash}
   【诊断】MD5匹配: true/false
   ```

3. **如果MD5不匹配**
   ```
   【诊断】⚠️ 文档内容不一致！上传前后MD5不匹配
   【诊断】上传前: {hash1}, 下载后: {hash2}
   ```

### 诊断流程

```
本地文档生成 (annotatedDocBytes)
  ↓
计算MD5 (md5Before)
  ↓
上传到MinIO
  ↓
从MinIO下载
  ↓
计算MD5 (md5After)
  ↓
对比MD5 → 判断内容是否一致
```

## 可能的原因分析

### 1. MinIO上传/下载过程中文档被修改

**检查方法**：
- 查看日志中的MD5值
- 如果MD5不匹配 → 说明MinIO存储有问题

**可能原因**：
- MinIO存储时的编码问题
- 文件流传输时的数据损坏
- MinIO版本或配置问题

### 2. 文档通过代理URL访问时被修改

**检查方法**：
- 直接下载MinIO文件并打开（不使用代理）
- 对比直接下载和通过代理下载的文档

**可能原因**：
- `FilePreviewController.proxyDocumentByQuery` 在返回文档时可能修改了内容
- HTTP响应头或内容类型设置问题
- 字节流传输时的编码问题

### 3. OnlyOffice渲染时的格式问题

**检查方法**：
- 直接下载MinIO文件到本地
- 在Word中打开本地文件和MinIO下载的文件
- 对比批注显示情况

**可能原因**：
- OnlyOffice对文档格式的处理方式不同
- 批注XML结构虽然完整，但OnlyOffice无法正确解析
- 文档中的某些格式信息被OnlyOffice忽略

### 4. 文档生成时的格式问题

**检查方法**：
- 检查本地保存的文档是否正常
- 检查批注XML结构是否完整

**可能原因**：
- 批注生成时格式不正确
- XML结构虽然完整但不符合OnlyOffice的要求

## 下一步诊断步骤

### 步骤1：重新生成文档并查看MD5日志

1. **重启应用**（使用新编译的代码）

2. **重新生成审查报告**
   - 上传长文档
   - 执行一键审查

3. **查看日志中的MD5信息**
   ```
   【诊断】上传前文档MD5: ...
   【诊断】下载后文档MD5: ...
   【诊断】MD5匹配: true/false
   ```

### 步骤2：根据MD5结果判断

#### 情况A：MD5匹配（内容一致）

**结论**：文档内容没有被修改，问题可能在于：
- OnlyOffice渲染问题
- 文档格式虽然完整但OnlyOffice无法正确解析
- 需要检查OnlyOffice配置或文档格式

**下一步**：
1. 直接下载MinIO文件到本地
2. 在Word中打开并检查批注
3. 对比本地保存的文档和MinIO下载的文档

#### 情况B：MD5不匹配（内容不一致）

**结论**：文档在上传/下载过程中被修改了

**下一步**：
1. 检查 `MinioFileService.uploadBytes()` 方法
2. 检查 `MinioFileService.downloadFile()` 方法
3. 检查 `FilePreviewController.proxyDocumentByQuery()` 方法
4. 确认MinIO配置是否正确

### 步骤3：手动验证

1. **直接下载MinIO文件**
   ```bash
   # 使用MinIO客户端或API直接下载文件
   # 不要在文档编辑器（OnlyOffice）中打开
   ```

2. **在Word中打开并对比**
   - 打开本地保存的文档
   - 打开MinIO下载的文档
   - 检查批注是否都显示

3. **检查文档ZIP结构**
   - 使用7-Zip或其他工具解压DOCX文件
   - 检查 `word/comments.xml` 是否存在
   - 检查 `word/_rels/document.xml.rels` 是否存在

## 修复建议

### 如果MD5匹配但格式仍然有问题

可能需要在文档生成时确保格式兼容性：
1. 检查 `WordXmlCommentProcessor` 生成的XML格式
2. 确保批注格式符合OnlyOffice的要求
3. 可能需要调整批注XML结构

### 如果MD5不匹配

需要修复文档传输过程：
1. 确保上传时使用二进制模式
2. 确保下载时不被修改
3. 检查代理URL的响应设置

## 相关文件

- `QwenRuleReviewController.java`：添加了MD5诊断代码
- `MinioFileService.java`：上传和下载逻辑
- `FilePreviewController.java`：代理URL逻辑
- `WordXmlCommentProcessor.java`：批注生成逻辑

---

**诊断代码已添加**：✅  
**待执行**：重新生成文档并查看MD5日志  
**下一步**：根据MD5结果判断问题根源


