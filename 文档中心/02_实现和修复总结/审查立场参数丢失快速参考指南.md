# 审查立场丢失问题 - 快速参考指南

**更新时间**: 2025-10-27
**状态**: ✅ 已修复
**编译**: ✅ BUILD SUCCESS

---

## 🎯 一句话总结

**前端发送错误的参数名('stance'而不是'party')，导致后端无法识别立场；同时立场信息没有保存到全局变量，导致在批注导入时完全丢失。**

---

## ❌ 问题现象

```
✅ 用户能看到立场选择（甲方/乙方）
✅ 用户能点击立场按钮
❌ 但后续的规则审查、批注、一键审查中立场参数丢失
❌ 最终的审查结果不体现所选立场
```

---

## 🔧 快速修复

### 修改1：参数名纠正

**文件**: `main.js`

```javascript
// 位置1：performRuleReviewAnalysis() 第1325行
formData.append('party', stance);  // 改为 'party'，不是 'stance'

// 位置2：performOneClickReview() 第1406行
formData.append('party', stance);  // 改为 'party'，不是 'stance'
```

### 修改2：状态保存

**文件**: `main.js`

```javascript
// 位置1：performRuleReviewAnalysis() 第1333-1335行
window.ruleReviewStance = stance;
console.log('✅ 已保存审查立场:', window.ruleReviewStance);

// 位置2：performOneClickReview() 第1413-1415行
window.ruleReviewStance = stance;
console.log('✅ 已保存审查立场:', window.ruleReviewStance);
```

### 修改3：参数传递

**文件**: `main.js`

```javascript
// 位置：importRuleReviewResult() 第1605-1647行
const stance = window.ruleReviewStance;  // 读取保存的立场

if (stance) {
    url += `&party=${encodeURIComponent(stance)}`;  // 传递给后端
}
```

---

## ✅ 修复效果

| 功能 | 修复前 | 修复后 |
|------|--------|--------|
| 参数名 | 'stance' ❌ | 'party' ✅ |
| 后端识别 | 无法识别 ❌ | 正确识别 ✅ |
| 立场保存 | 不保存 ❌ | 保存到全局变量 ✅ |
| 批注导入 | 丢失立场 ❌ | 传递立场 ✅ |
| 规则过滤 | 不过滤 ❌ | 按立场过滤 ✅ |
| 批注内容 | 不体现立场 ❌ | 体现立场 ✅ |

---

## 🧪 快速验证

### Console日志验证

在F12 Console中查看是否出现以下日志：

```javascript
// 规则审查时
✅ 【关键】performRuleReviewAnalysis 已保存审查立场: A方
// 或
✅ 【关键】performRuleReviewAnalysis 已保存审查立场: B方

// 一键审查时
✅ 【关键】performOneClickReview 已保存审查立场: A方
// 或
✅ 【关键】performOneClickReview 已保存审查立场: B方

// 批注导入时
✅ 【关键】将传递立场参数: A方
// 或
✅ 【关键】将传递立场参数: B方
```

### 功能验证

**规则审查**:
1. 选择文件 → 上传
2. 显示甲乙方信息
3. 点击"甲方"或"乙方"
4. 查看Console日志（见上）
5. 点击"开始规则审查"
6. ✅ 规则应该按立场过滤

**一键审查**:
1. 选择文件 → 上传
2. 显示甲乙方信息
3. 点击"甲方"或"乙方"
4. 查看Console日志（见上）
5. 点击"开始一键审查"
6. ✅ 结果应该体现立场

**批注导入**:
1. 完成上述步骤后...
2. 输入ChatGPT审查结果
3. 点击"导入批注结果"
4. 查看Console日志（见上）
5. ✅ 批注应该考虑立场

---

## 📊 代码变更汇总

```
文件: main.js

第1325行:
  - 'stance' → 'party'

第1333-1335行:
  + window.ruleReviewStance = stance;
  + console.log(...);

第1406行:
  - 'stance' → 'party'

第1413-1415行:
  + window.ruleReviewStance = stance;
  + console.log(...);

第1605-1647行:
  + const stance = window.ruleReviewStance;
  + if (stance) url += `&party=...`;
  + 详细日志和提示

总计: ~18行修改
```

---

## 📋 文档导航

| 需求 | 文档 | 说明 |
|------|------|------|
| 快速了解 | 本文档 | 一页纸的快速参考 |
| 问题诊断 | 根本原因诊断.md | 详细的4个问题分析 |
| 修复方案 | 快速修复总结.md | 修复要点和验证清单 |
| 详细说明 | 详细修复指南.md | 完整的修改说明和测试步骤 |
| 完成总结 | 工作完成总结.md | 整体工作回顾 |

---

## ⚡ 需要帮助？

### 如果修复后仍有问题

1. **检查编译**: 运行 `mvn compile` 确保 BUILD SUCCESS
2. **查看日志**: 打开F12 Console查看是否有日志输出
3. **检查参数**: 打开Network标签，查看请求的URL参数
4. **对比文档**: 查看《详细修复指南.md》中的具体代码

### 常见问题

**Q: 为什么还是没有看到日志?**
A: 检查是否清空了浏览器缓存（Ctrl+Shift+Delete）

**Q: 参数是否真的被发送了?**
A: 打开F12 Network标签，查看请求的URL是否包含 `&party=...`

**Q: 后端是否能正确处理?**
A: 需要检查后端的 `/api/review/analyze` 端点是否正确处理了 `party` 参数

---

## ✅ 检查清单

- [x] 代码修改完成
- [x] 编译成功 (BUILD SUCCESS)
- [x] 生成了诊断文档
- [x] 生成了修复文档
- [ ] 功能测试（需手动验证）
- [ ] 部署到测试环境

---

**现在可以测试和部署修复！** 🚀

