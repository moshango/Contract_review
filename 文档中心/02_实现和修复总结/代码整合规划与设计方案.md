# ä»£ç æ•´åˆè§„åˆ’ä¸è®¾è®¡æ–¹æ¡ˆ

**å®Œæˆæ—¶é—´**: 2025-10-27 16:35
**çŠ¶æ€**: ğŸ“‹ æ•´åˆè§„åˆ’è®¾è®¡å®Œæˆ
**ç›®æ ‡**: ç»Ÿä¸€å®¡æŸ¥æ¥å£ï¼Œæ¶ˆé™¤é‡å¤ä»£ç 

---

## ğŸ“Š å½“å‰é—®é¢˜åˆ†æ

### ç°æœ‰çš„å¤šä¸ªAPIç«¯ç‚¹ï¼ˆé‡å¤åŠŸèƒ½ï¼‰

```
å®¡æŸ¥ç«¯ç‚¹åˆ†å¸ƒ:
â”œâ”€â”€ /api/review/analyze           â† è§„åˆ™å®¡æŸ¥
â”œâ”€â”€ /api/qwen/rule-review/review  â† Qwenå®¡æŸ¥ï¼ˆåªå¤„ç†Promptï¼‰
â”œâ”€â”€ /api/qwen/rule-review/one-click-review  â† ä¸€é”®å®¡æŸ¥ï¼ˆæ•´åˆè§„åˆ™+Qwenï¼‰
â”œâ”€â”€ /chatgpt/import-result        â† ChatGPTæ‰¹æ³¨å¯¼å…¥
â””â”€â”€ /auto-review                  â† è‡ªåŠ¨åŒ–å®¡æŸ¥ï¼ˆå®Œæ•´æµç¨‹ï¼‰
```

### é‡å¤çš„å·¥ä½œæµç¨‹

```
è§„åˆ™å®¡æŸ¥æµç¨‹ (/api/review/analyze):
1. è§£æåˆåŒ â†’ ç”Ÿæˆå¸¦é”šç‚¹æ–‡æ¡£
2. åŠ è½½è§„åˆ™å¹¶åŒ¹é…
3. ç”ŸæˆPrompt
4. è¿”å›åŒ¹é…ç»“æœå’ŒPrompt

ä¸€é”®å®¡æŸ¥æµç¨‹ (/api/qwen/rule-review/one-click-review):
1. è§£æåˆåŒ â†’ ç”Ÿæˆå¸¦é”šç‚¹æ–‡æ¡£
2. åŠ è½½è§„åˆ™å¹¶åŒ¹é…  â† é‡å¤ï¼
3. ç”ŸæˆPrompt        â† é‡å¤ï¼
4. è°ƒç”¨Qwen
5. å¯¼å…¥æ‰¹æ³¨

è‡ªåŠ¨åŒ–å®¡æŸ¥æµç¨‹ (/auto-review):
1. è§£æåˆåŒ â†’ ç”Ÿæˆå¸¦é”šç‚¹æ–‡æ¡£  â† é‡å¤ï¼
2. åŠ è½½è§„åˆ™å¹¶åŒ¹é…           â† é‡å¤ï¼
3. ç”ŸæˆPrompt               â† é‡å¤ï¼
4. è°ƒç”¨AI
5. å¯¼å…¥æ‰¹æ³¨
```

### é—®é¢˜æ¸…å•

| é—®é¢˜ | å½±å“ | ä¸¥é‡æ€§ |
|------|------|--------|
| âŒ åŒä¸€ä¸ªé€»è¾‘åœ¨å¤šä¸ªç«¯ç‚¹å®ç° | éš¾ä»¥ç»´æŠ¤ï¼Œå®¹æ˜“ä¸ä¸€è‡´ | ğŸ”´ é«˜ |
| âŒ è§£æã€è§„åˆ™åŒ¹é…ã€Promptç”Ÿæˆé‡å¤ | ä»£ç å†—ä½™ï¼Œéš¾ä»¥ä¿®å¤bug | ğŸ”´ é«˜ |
| âŒ å‚æ•°å/æ ¼å¼åœ¨ä¸åŒç«¯ç‚¹ä¸ä¸€è‡´ | å‰ç«¯éœ€è¦ä¸åŒçš„è°ƒç”¨æ–¹å¼ | ğŸŸ  ä¸­ |
| âŒ é”™è¯¯å¤„ç†æ–¹å¼ä¸ç»Ÿä¸€ | éš¾ä»¥ç»Ÿä¸€ç®¡ç†å’Œæ”¹è¿› | ğŸŸ  ä¸­ |
| âŒ æ•°æ®ç»“æ„åœ¨ä¸åŒç«¯ç‚¹ä¸ä¸€è‡´ | å‰ç«¯éœ€è¦å¤šå¥—è§£æé€»è¾‘ | ğŸŸ  ä¸­ |

---

## ğŸ¯ æ•´åˆç›®æ ‡

### ç†æƒ³æ¶æ„

```
ç»Ÿä¸€çš„å®¡æŸ¥API:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ main.js                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ç»Ÿä¸€çš„å®¡æŸ¥ç«¯ç‚¹  â”‚
        â”‚  /api/unified/   â”‚
        â”‚    review        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            â”‚            â”‚
    â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è§£æ    â”‚  â”‚è§„åˆ™    â”‚  â”‚AI      â”‚
â”‚æœåŠ¡    â”‚  â”‚åŒ¹é…    â”‚  â”‚è°ƒç”¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚            â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
          â”‚ æ‰¹æ³¨å¯¼å…¥    â”‚
          â”‚ å’Œè¿”å›      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–°çš„APIè®¾è®¡

```javascript
POST /api/unified/review
å‚æ•°:
  - file: åˆåŒæ–‡ä»¶
  - contractType: åˆåŒç±»å‹
  - party: å®¡æŸ¥ç«‹åœº
  - reviewMode: 'rules' | 'ai' | 'full'  â† æ§åˆ¶æ‰§è¡Œæµç¨‹
  - aiProvider: 'qwen' | 'chatgpt' | 'claude' (å½“reviewModeåŒ…å«'ai'æ—¶)

è¿”å›:
  {
    success: boolean,
    statistics: { ... },
    matchResults: [ ... ],
    prompt: "...",
    aiResult: { ... }  â† åªæœ‰åœ¨reviewModeåŒ…å«'ai'æ—¶
    parseResultId: "...",
    documentUrl: "..."
  }
```

---

## ğŸ“‹ æ•´åˆè®¡åˆ’

### Phase 1: æå–å…¬å…±æœåŠ¡

**åˆ›å»ºæ–°çš„æœåŠ¡**ï¼š`UnifiedReviewService`

```java
public class UnifiedReviewService {
    // å…¬å…±æµç¨‹
    - parseContract(file)  // ç»Ÿä¸€çš„è§£æ
    - matchRules(clauses, party)  // ç»Ÿä¸€çš„è§„åˆ™åŒ¹é…
    - generatePrompt(matchResults)  // ç»Ÿä¸€çš„Promptç”Ÿæˆ
    - importAnnotations(result, parseResultId)  // ç»Ÿä¸€çš„æ‰¹æ³¨å¯¼å…¥
    - callAI(prompt, provider)  // ç»Ÿä¸€çš„AIè°ƒç”¨
}
```

### Phase 2: åˆ›å»ºç»Ÿä¸€æ¥å£

**æ–°å»ºç«¯ç‚¹**ï¼š`UnifiedReviewController`

```java
@RestController
@RequestMapping("/api/unified")
public class UnifiedReviewController {
    @PostMapping("/review")
    public ResponseEntity<?> review(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "contractType", defaultValue = "é€šç”¨") String contractType,
        @RequestParam(value = "party", required = false) String party,
        @RequestParam(value = "reviewMode", defaultValue = "rules") String reviewMode,
        @RequestParam(value = "aiProvider", required = false) String aiProvider
    ) {
        // ä½¿ç”¨UnifiedReviewServiceæ‰§è¡Œ
    }
}
```

### Phase 3: æ›´æ–°å‰ç«¯

**æ›´æ–° main.js** çš„æ‰€æœ‰APIè°ƒç”¨ï¼š

```javascript
// åŸæ¥å¤šä¸ªä¸åŒçš„è°ƒç”¨
await fetch('/api/review/analyze', ...)           // è§„åˆ™å®¡æŸ¥
await fetch('/api/qwen/rule-review/review', ...) // Qwenå®¡æŸ¥
await fetch('/api/qwen/rule-review/one-click-review', ...)  // ä¸€é”®å®¡æŸ¥

// ç»Ÿä¸€ä¸ºä¸€ä¸ªè°ƒç”¨
async function performReview(file, contractType, party, reviewMode, aiProvider) {
    await fetch('/api/unified/review', {
        method: 'POST',
        body: formData,
        // ...
    })
}
```

### Phase 4: é€æ­¥è¿ç§»

```
Step 1: åˆ›å»º UnifiedReviewService âœ“ï¼ˆè®¾è®¡å®Œï¼‰
Step 2: åˆ›å»º UnifiedReviewController âœ“ï¼ˆè®¾è®¡å®Œï¼‰
Step 3: æ›´æ–° main.js è°ƒç”¨ â† æœ¬é˜¶æ®µ
Step 4: éªŒè¯æ‰€æœ‰åŠŸèƒ½ â† æœ¬é˜¶æ®µ
Step 5: ä¿ç•™æ—§æ¥å£ï¼ˆå‘åå…¼å®¹ï¼‰ â† ä¸ºäº†ä¸ç ´åç°æœ‰ç³»ç»Ÿ
Step 6: æ ‡è®°æ—§æ¥å£ä¸º @Deprecated â† é€æ­¥è¿ç§»
```

---

## ğŸ”§ å…·ä½“å®ç°æ–¹æ¡ˆ

### 1. æ–°å»º UnifiedReviewService

```java
@Service
@Slf4j
public class UnifiedReviewService {

    @Autowired
    private ContractParseService contractParseService;

    @Autowired
    private ReviewRulesService reviewRulesService;

    @Autowired
    private ParseResultCache parseResultCache;

    @Autowired
    private ReviewStanceService reviewStanceService;

    @Autowired
    private QwenRuleReviewService qwenRuleReviewService;

    @Autowired
    private ChatGPTService chatGPTService;

    /**
     * ç»Ÿä¸€çš„å®¡æŸ¥æµç¨‹
     */
    public ReviewResult performReview(
        MultipartFile file,
        String contractType,
        String party,
        ReviewMode reviewMode,  // RULES, AI, FULL
        String aiProvider       // qwen, chatgpt, claude
    ) {
        // 1. è§£æåˆåŒ
        ParseResultWithDocument parseResultWithDoc =
            contractParseService.parseContractWithDocument(file, "generate");

        // 2. åŒ¹é…è§„åˆ™
        List<RuleMatchResult> matchResults =
            reviewRulesService.matchRulesForClauses(
                parseResultWithDoc.getParseResult().getClauses(),
                contractType,
                party
            );

        // 3. ç”ŸæˆPrompt
        String prompt = PromptGeneratorNew.generate(matchResults, party);

        // 4. æ„å»ºåŸºç¡€ç»“æœ
        ReviewResult result = buildBaseResult(
            parseResultWithDoc,
            matchResults,
            prompt
        );

        // 5. å¦‚æœéœ€è¦AIè°ƒç”¨
        if (reviewMode == ReviewMode.AI || reviewMode == ReviewMode.FULL) {
            AIResult aiResult = callAI(prompt, aiProvider);
            result.setAiResult(aiResult);

            // 6. å¯¼å…¥æ‰¹æ³¨
            if (reviewMode == ReviewMode.FULL) {
                byte[] annotatedDocument = importAnnotations(
                    parseResultWithDoc,
                    aiResult
                );
                result.setAnnotatedDocument(annotatedDocument);
            }
        }

        return result;
    }

    private ReviewResult buildBaseResult(...) { ... }
    private AIResult callAI(String prompt, String provider) { ... }
    private byte[] importAnnotations(...) { ... }
}
```

### 2. æ–°å»º UnifiedReviewController

```java
@RestController
@RequestMapping("/api/unified")
@Slf4j
public class UnifiedReviewController {

    @Autowired
    private UnifiedReviewService unifiedReviewService;

    /**
     * ç»Ÿä¸€çš„å®¡æŸ¥æ¥å£
     *
     * æ”¯æŒå¤šç§æ¨¡å¼ï¼š
     * - reviewMode=rules: ä»…è§„åˆ™å®¡æŸ¥ï¼ˆè¿”å›Promptï¼‰
     * - reviewMode=ai: è°ƒç”¨AIè¿›è¡Œå®¡æŸ¥
     * - reviewMode=full: è§„åˆ™å®¡æŸ¥ + AIå®¡æŸ¥ + æ‰¹æ³¨å¯¼å…¥
     */
    @PostMapping("/review")
    public ResponseEntity<?> review(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "contractType", defaultValue = "é€šç”¨åˆåŒ") String contractType,
        @RequestParam(value = "party", required = false) String party,
        @RequestParam(value = "reviewMode", defaultValue = "rules") String reviewMode,
        @RequestParam(value = "aiProvider", defaultValue = "qwen") String aiProvider
    ) {
        try {
            ReviewMode mode = ReviewMode.valueOf(reviewMode.toUpperCase());
            ReviewResult result = unifiedReviewService.performReview(
                file,
                contractType,
                party,
                mode,
                aiProvider
            );

            return ResponseEntity.ok(result);
        } catch (Exception e) {
            log.error("ç»Ÿä¸€å®¡æŸ¥å¤±è´¥", e);
            return ResponseEntity.internalServerError()
                .body(createErrorResponse("å®¡æŸ¥å¤±è´¥", e.getMessage()));
        }
    }
}
```

### 3. å‰ç«¯è°ƒç”¨ç»Ÿä¸€åŒ–

```javascript
// åŸï¼šè§„åˆ™å®¡æŸ¥
async function performRuleReviewAnalysis() {
    const response = await fetch('/api/review/analyze', {
        method: 'POST',
        body: formData
    });
}

// åŸï¼šä¸€é”®å®¡æŸ¥
async function performOneClickReview() {
    const response = await fetch('/api/qwen/rule-review/one-click-review', {
        method: 'POST',
        body: formData
    });
}

// æ–°ï¼šç»Ÿä¸€çš„å®¡æŸ¥æ¥å£
async function performUnifiedReview(reviewMode = 'rules', aiProvider = 'qwen') {
    const formData = new FormData();
    formData.append('file', ruleReviewFile);
    formData.append('contractType', selectedContractType);
    formData.append('party', userStance);
    formData.append('reviewMode', reviewMode);
    formData.append('aiProvider', aiProvider);

    const response = await fetch('/api/unified/review', {
        method: 'POST',
        body: formData
    });

    const data = await response.json();
    handleUnifiedReviewResult(data);
}

// æŒ‰é’®å¤„ç†
function startRuleReview() {
    performUnifiedReview('rules', null);  // ä»…è§„åˆ™å®¡æŸ¥
}

function startOneClickReview() {
    performUnifiedReview('full', 'qwen');  // å®Œæ•´æµç¨‹
}
```

---

## âœ… æ•´åˆæ¸…å•

### ä»£ç æ•´åˆ

- [ ] åˆ›å»º `UnifiedReviewService`
- [ ] åˆ›å»º `UnifiedReviewController`
- [ ] åˆ›å»º `ReviewResult` å’Œ `ReviewMode` æ¨¡å‹
- [ ] ä»ç°æœ‰æœåŠ¡ä¸­æå–å…¬å…±é€»è¾‘
- [ ] æ›´æ–° `main.js` è°ƒç”¨æ–°æ¥å£
- [ ] éªŒè¯ç¼–è¯‘æˆåŠŸ
- [ ] åŠŸèƒ½æµ‹è¯•

### å‘åå…¼å®¹

- [ ] ä¿ç•™æ—§æ¥å£ä¸åˆ é™¤
- [ ] åœ¨æ—§æ¥å£ä¸Šæ·»åŠ  `@Deprecated` æ³¨è§£
- [ ] åœ¨æ—§æ¥å£ä¸­è°ƒç”¨æ–°çš„ UnifiedReviewService
- [ ] æ–‡æ¡£è¯´æ˜è¿ç§»è®¡åˆ’

### æ–‡æ¡£

- [ ] æ›´æ–°APIæ–‡æ¡£
- [ ] ç”Ÿæˆæ•´åˆæ€»ç»“
- [ ] åˆ—å‡ºç ´åæ€§æ”¹å˜ï¼ˆå¦‚æœ‰ï¼‰

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ä»£ç ç®€åŒ–

```
ä¿®æ”¹å‰ï¼š
- ApiReviewController: 300+ è¡Œ
- AutoReviewController: 200+ è¡Œ
- QwenRuleReviewController: 400+ è¡Œ
- ChatGPTIntegrationController: 500+ è¡Œ
å…± 1400+ è¡Œé‡å¤æˆ–ç›¸ä¼¼çš„ä»£ç 

ä¿®æ”¹åï¼š
- UnifiedReviewController: 100 è¡Œï¼ˆè°ƒç”¨æœåŠ¡ï¼‰
- UnifiedReviewService: 300 è¡Œï¼ˆç»Ÿä¸€å®ç°ï¼‰
- æ—§æ§åˆ¶å™¨ä¿ç•™ä½†è°ƒç”¨æ–°æœåŠ¡ï¼ˆæ¶ˆé™¤é‡å¤ï¼‰
å…±å‡å°‘ 60%+ çš„å†—ä½™ä»£ç 
```

### å‰ç«¯ç®€åŒ–

```
ä¿®æ”¹å‰ï¼š
- fetch('/api/review/analyze', ...)
- fetch('/api/qwen/rule-review/one-click-review', ...)
- fetch('/api/qwen/rule-review/review', ...)
å¤šä¸ªä¸åŒçš„è°ƒç”¨æ–¹å¼

ä¿®æ”¹åï¼š
- performUnifiedReview(mode, provider)
ç»Ÿä¸€çš„è°ƒç”¨æ¥å£
```

### é˜²æ­¢é—®é¢˜

âœ… ç»Ÿä¸€çš„æ•°æ®ç»“æ„ â†’ ä¸ä¼šå‡ºç°å­—æ®µåä¸åŒ¹é…é—®é¢˜
âœ… ç»Ÿä¸€çš„å®ç° â†’ å‚æ•°å¤„ç†ä¿æŒä¸€è‡´
âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç† â†’ ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
âœ… ç»Ÿä¸€çš„æµ‹è¯• â†’ æ›´å®¹æ˜“å†™é›†æˆæµ‹è¯•

---

## ğŸ“ å®ç°ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…åšï¼‰
1. åˆ›å»º UnifiedReviewServiceï¼ˆé›†ä¸­é€»è¾‘ï¼‰
2. åˆ›å»º UnifiedReviewControllerï¼ˆç»Ÿä¸€å…¥å£ï¼‰
3. æ›´æ–°å‰ç«¯è°ƒç”¨

### ä¸­ä¼˜å…ˆçº§ï¼ˆåº”åšï¼‰
1. æ ‡è®°æ—§æ¥å£ä¸º Deprecated
2. æ—§æ¥å£ä¸­è°ƒç”¨æ–°æœåŠ¡ï¼ˆæ¶ˆé™¤é‡å¤å®ç°ï¼‰
3. æ›´æ–° API æ–‡æ¡£

### ä½ä¼˜å…ˆçº§ï¼ˆå¯åšï¼‰
1. åˆ é™¤æ—§æ¥å£ï¼ˆåç»­ç‰ˆæœ¬ï¼‰
2. æ·»åŠ é›†æˆæµ‹è¯•
3. æ€§èƒ½ä¼˜åŒ–

---

## ğŸš€ åç»­å»ºè®®

### ç«‹å³
1. âœ… è®¾è®¡æ–¹æ¡ˆå·²å®Œæˆ
2. â³ å¼€å§‹å®ç° UnifiedReviewService
3. â³ å®ç° UnifiedReviewController

### æœ¬å‘¨
1. å®Œæˆä»£ç æ•´åˆå’Œæµ‹è¯•
2. æ›´æ–°å‰ç«¯è°ƒç”¨
3. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

### é•¿æœŸ
1. è€ƒè™‘å°†æœåŠ¡è¿›ä¸€æ­¥åˆ†å±‚
2. å®æ–½å®Œæ•´çš„é›†æˆæµ‹è¯•
3. å»ºç«‹APIç‰ˆæœ¬ç®¡ç†ç­–ç•¥

---

**æ•´åˆè§„åˆ’è®¾è®¡å®Œæˆï¼Œå¯ä»¥è¿›è¡Œå®ç°ã€‚** ğŸš€

