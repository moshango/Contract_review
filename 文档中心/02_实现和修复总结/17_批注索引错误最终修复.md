# ğŸ¯ æ‰¹æ³¨ç´¢å¼•é”™è¯¯ - æœ€ç»ˆæ ¹æœ¬åŸå› ä¿®å¤

## å‘ç°çš„ç¬¬å…­ä¸ªé—®é¢˜

é€šè¿‡åˆ†æè¯Šæ–­æ—¥å¿—ä¸­çš„æ‰¹æ³¨IDé¡ºåºï¼Œ**æ‰¾åˆ°äº†æœ€åä¸€ä¸ªå…³é”®é—®é¢˜**ï¼š

```log
ã€ç»´æµ‹ã€‘commentRangeStart IDs: [1, 2, 3, 4, 6, 5, 7]  âŒ ä¸å¯¹ï¼
ã€ç»´æµ‹ã€‘å·²æ·»åŠ æ‰¹æ³¨ID=[1, 2, 3, 4, 5, 6, 7]          âœ“ æ­£ç¡®
```

**æ‰¹æ³¨æ ‡è®°çš„IDé¡ºåºæ··ä¹±**ï¼ˆ5å’Œ6è¢«äº¤æ¢ï¼‰ï¼Œå¯¼è‡´Wordæ— æ³•æ­£ç¡®åŒ¹é…æ‰¹æ³¨ã€‚

## æ ¹æœ¬åŸå› 

åœ¨ `insertPreciseCommentRangeInSingleRun()` æ–¹æ³•ä¸­çš„ç´¢å¼•è®¡ç®—æœ‰è¯¯ï¼š

### é”™è¯¯çš„é€»è¾‘

```java
// ç¬¬1027è¡Œï¼šæ’å…¥commentRangeStart
paragraph.elements().add(runIndex, commentRangeStart);
runIndex++;  // runIndexç°åœ¨æŒ‡å‘commentRangeStart

// ç¬¬1050è¡Œï¼šâŒ é”™è¯¯çš„è®¡ç®—
// runIndexæŒ‡å‘commentRangeStartï¼ˆä½ç½®0ï¼‰
// originalRunå®é™…åœ¨ä½ç½®1
// ä½†æˆ‘ä»¬æ’å…¥commentRangeEndåˆ° runIndex + 1 = ä½ç½®1
// è¿™ä¼šæŠŠcommentRangeEndæ’å…¥åˆ°originalRunä¹‹å‰ï¼Œè€Œä¸æ˜¯ä¹‹åï¼
paragraph.elements().add(runIndex + 1, commentRangeEnd);
```

### ç¤ºæ„å›¾

```
æ’å…¥commentRangeStartåï¼š
[commentRangeStart, originalRun]
runIndex = 0

é”™è¯¯çš„æ’å…¥commentRangeEndï¼š
paragraph.elements().add(0 + 1, commentRangeEnd)
->
[commentRangeStart, commentRangeEnd, originalRun]  âŒ é¡ºåºé”™äº†ï¼

æ­£ç¡®çš„åº”è¯¥æ˜¯ï¼š
[commentRangeStart, originalRun, commentRangeEnd]
```

## æœ€ç»ˆä¿®å¤

```java
// Step 4: åœ¨åŒ¹é…éƒ¨åˆ†åæ’å…¥commentRangeEnd
// ç°åœ¨ originalRun åœ¨ runIndex + 1 çš„ä½ç½®
Element commentRangeEnd = new org.dom4j.tree.DefaultElement(QName.get("commentRangeEnd", W_NS));
commentRangeEnd.addAttribute(QName.get("id", W_NS), String.valueOf(commentId));
// originalRunåœ¨æ®µè½ä¸­çš„ä½ç½®æ˜¯runIndex+1ï¼Œæ‰€ä»¥commentRangeEndåº”è¯¥åœ¨runIndex+2  âœ…
paragraph.elements().add(runIndex + 2, commentRangeEnd);
runIndex = runIndex + 2;  // æ›´æ–°runIndexæŒ‡å‘commentRangeEnd  âœ…
```

## ä¿®å¤åçš„ç»“æ„

```
æ’å…¥åçš„æ­£ç¡®ç»“æ„ï¼š
[commentRangeStart, originalRun, commentRangeEnd, commentRefRun]

å¯¹åº”Word XMLï¼š
<w:p>
  <w:commentRangeStart id="1"/>
  <w:r><w:t>åŒ¹é…æ–‡æœ¬</w:t></w:r>
  <w:commentRangeEnd id="1"/>
  <w:r><w:commentReference id="1"/></w:r>
</w:p>
```

## ä¿®å¤çš„æ‰€æœ‰é—®é¢˜æ€»ç»“

| # | é—®é¢˜ | æ ¹æœ¬åŸå›  | ä¿®å¤æ–¹æ¡ˆ | çŠ¶æ€ |
|----|------|--------|--------|------|
| 1 | OPCPackage æœªå…³é—­ | èµ„æºæ³„éœ² | æ·»åŠ finallyå— | âœ… |
| 2 | relsæ–‡ä»¶ä¸¢å¤± | å¼‚å¸¸å¤„ç†è¦†ç›–åŸæ–‡ä»¶ | æ·»åŠ æ¢å¤æœºåˆ¶ | âœ… |
| 3 | è¯Šæ–­ä»£ç ä¸å®Œæ•´ | åªæŸ¥ç›´æ¥å­å…ƒç´  | ä½¿ç”¨é€’å½’æŸ¥æ‰¾ | âœ… |
| 4 | æ‰¹æ³¨æ–‡æœ¬æ ¼å¼ | ç¼ºå°‘xml:space | æ·»åŠ preserveå±æ€§ | âœ… |
| **5** | **æ‰¹æ³¨æ ‡è®°é¡ºåºé”™è¯¯** | **ç´¢å¼•è®¡ç®—é”™è¯¯** | **ä¿®æ­£runIndex+2** | **âœ…** |

## ç¼–è¯‘çŠ¶æ€

âœ… é¡¹ç›®å·²æˆåŠŸç¼–è¯‘ï¼Œæ‰€æœ‰ä¿®å¤éƒ½å·²åº”ç”¨ã€‚

##  ç°åœ¨è¯·æµ‹è¯•

1. **é‡å¯åº”ç”¨**ï¼ˆåŠ è½½æ–°ç¼–è¯‘çš„ä»£ç ï¼‰
2. **ä¸Šä¼ é•¿æ–‡æ¡£**å¹¶æ‰§è¡Œä¸€é”®å®¡æŸ¥
3. **æ‰“å¼€ç”Ÿæˆçš„DOCX**
4. **Wordåº”è¯¥èƒ½æ˜¾ç¤ºæ‰€æœ‰æ‰¹æ³¨äº†ï¼** âœ…

è¿™åº”è¯¥æ˜¯æœ€åçš„é—®é¢˜äº†ï¼
