# 批注锚点修复 - 测试验证指南

**验证范围**: 一键审查工作流从文件上传到批注生成的全流程
**验证日期**: 2025-10-27
**预期结果**: 批注能准确定位，日志显示所有 anchorId 有效

---

## 测试前准备

### 1. 代码准备
```bash
# 确保已应用修复代码
- QwenRuleReviewController.java (已修改)
- XmlContractAnnotateService.java (已修改)

# 编译验证
mvn clean compile
# 应该编译成功，无错误
```

### 2. 环境准备
- ✅ 启动 Spring Boot 应用
- ✅ 确保 Qwen API 可用且配置正确
- ✅ 准备测试合同文件（.docx 格式）
- ✅ 启用 DEBUG 日志级别以查看详细诊断信息

---

## 测试场景

### 场景1：标准一键审查流程

#### 1.1 上传合同并执行审查

**步骤**:
1. 打开前端界面
2. 上传合同文件（建议 5-10 个条款的文档）
3. 选择审查立场（建议选择 "neutral"）
4. 点击"一键审查"按钮

**预期日志输出**（依次出现）:

```log
# 步骤1：解析合同
INFO  - 开始解析合同: filename=test.docx, anchorMode=generate
INFO  - ✓ 合同解析完成，识别 X 个条款

# 步骤2：生成 Prompt
INFO  - 步骤2/6: 正在生成审查Prompt...
INFO  - ✓ Prompt生成完成，长度: XXXX 字符

# 步骤3：调用 Qwen
INFO  - 步骤3/6: 正在调用Qwen进行审查...
INFO  - ✓ Qwen审查完成，检出 X 个问题

# 【关键诊断1】anchorId 验证
INFO  - ✓ 其中 X 个问题有有效的anchorId
# ⚠️ 如果出现以下警告，说明 Qwen 返回了缺少 anchorId 的问题
WARN  - ⚠️ Issue缺少anchorId: clauseId=cX, finding长度=XXX

# 步骤4：批注处理
INFO  - 步骤4/6: 正在将审查结果插入文档...
INFO  - 【改进版本】开始XML方式批注处理: issues数量=X, anchorStrategy=preferAnchor, cleanupAnchors=false
INFO  - ✓ 输入验证通过，文档大小: XXXXX 字节, 问题数: X

# 【关键诊断2】anchorId 有效性检查
DEBUG - [Issue 1] ✓ anchorId=anc-c1-XXXXXX, clauseId=c1, severity=HIGH
DEBUG - [Issue 2] ✓ anchorId=anc-c2-XXXXXX, clauseId=c2, severity=MEDIUM
...
INFO  - ✓ 问题诊断：有效anchorId数=X, 缺失anchorId数=0

# 如果缺失 anchorId，会出现类似的警告：
WARN  - [Issue N] ✗ anchorId为NULL，clauseId=cX, finding长度=XXX

# 批注插入执行
INFO  - ✓ 通过锚点找到目标段落：anchorId=anc-c1-XXXXXX, 段落索引=0
INFO  - ✓ 精确批注插入完成：commentId=1, 前缀=0, 匹配范围=0-50, 后缀=0
...
INFO  - ✓ XML批注处理完成，输出文档大小: XXXXX 字节

# 步骤5：保存文档
INFO  - 步骤5/6: 正在保存文档到文档中心...
INFO  - ✓ 创建文档中心目录: D:\...\文档中心\已生成的审查报告
INFO  - ✓ 文档已保存到: D:\...\合同_一键审查_neutral.docx

# 步骤6：返回结果
INFO  - 步骤6/6: 返回审查结果...
INFO  - ✓ 一键审查完成！总耗时: XXXX ms, 检出 X 个问题
INFO  - ✓ 输出文件: 合同_一键审查_neutral.docx
```

#### 1.2 验证日志关键指标

| 指标 | 预期值 | 含义 |
|-----|-------|------|
| `其中 X 个问题有有效的anchorId` | X > 0 | 至少有一个问题有 anchorId |
| `有效anchorId数=X` | X > 0 | 同上 |
| `缺失anchorId数=0` | 0 | **修复成功的标志** |
| `✓ 通过锚点找到目标段落` | 出现 1+ 次 | 锚点定位生效 |
| `✓ 精确批注插入完成` | 出现 X 次 | 批注成功插入 |
| `无错误日志` | - | 流程顺畅 |

#### 1.3 验证输出文件

**操作**:
1. 下载审查后的文档
2. 用 Word 打开
3. 查看右侧是否有批注气泡
4. 点击批注查看内容

**预期结果**:
- ✅ 文档右侧出现多个批注气泡
- ✅ 批注内容包含：风险等级 + 问题描述 + 建议
- ✅ 批注位置准确（在对应的条款旁）
- ✅ 所有检出的问题都有对应批注

---

### 场景2：异常情况验证

#### 2.1 缺失 anchorId 的情况

**触发方式**:
这种情况通常由 Qwen 返回的 JSON 不包含 anchorId 引起

**预期日志**:
```log
WARN  - ⚠️ Issue缺少anchorId: clauseId=c5, finding长度=150
WARN  - [Issue N] ✗ anchorId为NULL，clauseId=cX, finding长度=XXX
INFO  - ✓ 问题诊断：有效anchorId数=4, 缺失anchorId数=1
```

**验证**:
- 这是正常的降级处理（会使用文本匹配）
- 查看日志中 "无法通过文本匹配找到段落" 的条款
- 这表示 Qwen 返回的 JSON 可能需要优化

#### 2.2 文档不带锚点的情况

**触发方式**:
如果 parseContract() 的 anchorMode 不是 "generate"

**预期日志**:
```log
INFO  - 无法找到批注插入位置：clauseId=c1, anchorId=null
WARN  - 无法通过文本匹配找到段落：clauseId=c1, numStr=1
```

**验证**:
- 这表示使用的是没有锚点的文档
- 但由于有文本匹配降级，批注仍会插入
- 可能精度不如带锚点的情况

---

### 场景3：性能验证

#### 3.1 检查性能提升

**操作**:
```
1. 在日志中查找 "一键审查完成！总耗时"
2. 记录耗时时间
3. 与修复前的时间对比
```

**预期结果**:
- 应该略有性能提升（消除了包装和序列化）
- 提升幅度通常 2-5%

---

## 日志解读指南

### 🟢 正常日志表现

#### 完全成功（所有问题都有 anchorId）
```log
✓ 其中 5 个问题有有效的anchorId
✓ 问题诊断：有效anchorId数=5, 缺失anchorId数=0
✓ 通过锚点找到目标段落：anchorId=anc-c1-XXXXXX, 段落索引=0
✓ 精确批注插入完成：commentId=1
```
→ **修复成功，工作流正常**

#### 部分成功（有些问题缺 anchorId，但文本匹配救援）
```log
⚠️ Issue缺少anchorId: clauseId=c5
✓ 问题诊断：有效anchorId数=4, 缺失anchorId数=1
✓ 通过文本匹配找到目标段落：clauseId=c1, 模式=第1条
```
→ **修复有效，降级处理生效**

### 🟡 警告日志

#### anchorId 为 NULL
```log
⚠️ Issue缺少anchorId: clauseId=c17, finding长度=200
[Issue 5] ✗ anchorId为NULL，clauseId=c17
```
→ **Qwen 返回的 JSON 不包含 anchorId**
→ 不是修复的问题，是 Qwen 模型输出的问题

#### 无法定位段落（文本匹配失败）
```log
无法找到批注插入位置：clauseId=c17, anchorId=anc-c17-XXXXXX
严格模式文本匹配失败
无法通过文本匹配找到段落：clauseId=c17, numStr=17
```
→ **降级失败，该问题无法批注**
→ 通常是文档结构异常导致

### 🔴 错误日志

#### 文档字节为空
```log
java.io.IOException: 文档字节数组为空
```
→ **应该检查文件是否正确上传**

#### JSON 反序列化失败
```log
XML批注处理失败: com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException
```
→ **应该检查 Qwen 返回的 JSON 格式**

---

## 快速检查清单

### ✅ 修复验证清单

- [ ] 代码已编译，无编译错误
- [ ] 应用已启动，无启动错误
- [ ] 一键审查流程可以执行到底
- [ ] 日志中出现 "✓ 其中 X 个问题有有效的anchorId"
- [ ] 日志中出现 "✓ 问题诊断：有效anchorId数=X, 缺失anchorId数=0"
- [ ] 日志中无 "✗ anchorId为NULL" 或数量为 0
- [ ] 下载的文档中有批注气泡
- [ ] 批注内容完整（包含风险等级、问题描述、建议）
- [ ] 批注位置准确（在对应条款旁）

### ⚠️ 需要关注的日志

- 搜索 "⚠️" - 有多少个警告
- 搜索 "缺失anchorId数=" - 是否为 0
- 搜索 "无法找到批注插入位置" - 是否出现
- 搜索 "ERROR" - 是否有错误

---

## 问题排查

### 问题1：日志中缺失 anchorId 数 > 0

**可能原因**:
- Qwen 模型返回的 JSON 不包含 anchorId 字段

**排查步骤**:
1. 查看 Qwen 返回的原始 JSON（在日志中搜索 "Qwen原始返回"）
2. 确认 JSON 中是否包含 "anchorId" 字段
3. 如果不包含，需要调整 Qwen 的系统提示

**解决方案**:
- 修改 `QwenRuleReviewService.java` 中的系统提示
- 确保明确要求 anchorId 字段

### 问题2：批注位置不准确

**可能原因**:
- 文档结构异常
- 文本匹配失败

**排查步骤**:
1. 查看日志中 "通过文本匹配找到" 的条款
2. 这些条款的批注可能位置不准
3. 检查文档中该条款的格式是否特殊

**解决方案**:
- 调整文本匹配模式（参考 `WordXmlCommentProcessor.java` 中的 patterns）
- 或者使用 targetText 和 matchPattern 字段进行精确匹配

### 问题3：没有批注气泡出现

**可能原因**:
1. 所有问题都定位失败
2. Word 的批注功能被禁用
3. 文档格式不兼容

**排查步骤**:
1. 查看日志中 "成功添加 X 个批注"
2. 如果是 0，说明没有成功插入
3. 检查日志中 "无法找到批注插入位置" 的数量

**解决方案**:
- 检查文档是否为标准 .docx 格式
- 尝试用另一个 Word 文档重新审查

---

## 性能基准

### 参考数据

| 操作 | 耗时 | 说明 |
|-----|-----|------|
| 文件解析（5 条款） | 100-200ms | 包含锚点生成 |
| Qwen 审查 | 3000-5000ms | 取决于网络 |
| 批注插入 | 50-100ms | 5-10 个问题 |
| 文件保存 | 50-100ms | 写入磁盘 |
| **总耗时** | **3200-5400ms** | 一键审查完整流程 |

### 修复前后对比

| 操作 | 修复前 | 修复后 | 改进 |
|-----|-------|-------|-----|
| 批注插入 | 60-120ms | 50-100ms | ↓ 10-20% |
| 内存占用 | 较高 | 较低 | ↓ 5-10% |

---

## 测试完成标准

✅ **绿灯通过**：
- 日志中 "缺失anchorId数=0"
- 文档中有批注气泡
- 批注位置准确

⚠️ **黄灯注意**：
- 日志中 "缺失anchorId数>0"（Qwen 问题）
- 日志中有 "无法找到批注插入位置"（文档问题）

🔴 **红灯失败**：
- 没有批注气泡
- 程序错误
- 日志中有 ERROR

---

## 后续行动

### 修复验证通过后
1. ✅ 部署到生产环境
2. ✅ 通知用户进行验收测试
3. ✅ 监控日志，关注异常情况

### 修复验证未通过
1. 查看详细日志，定位问题
2. 根据问题排查指南解决
3. 重新测试

---

**测试指南完成**

如有问题，请参考上述排查指南或查看详细的诊断报告。
