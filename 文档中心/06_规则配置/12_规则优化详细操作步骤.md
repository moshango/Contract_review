# 规则关键词优化实操指南（详细步骤）

## 📋 场景说明

当前 `rules.xlsx` 中有 **15 条规则**，分析显示：
- 大部分规则已经是较优形式
- 可根据需要进一步优化复杂的关键词组合

本指南演示如何手动优化关键词以提高规则匹配的命中率。

---

## 🎯 优化目标

### 目标 1: 拆分复合词汇

**原理**: 条款中可能只含有词汇的一部分，所以应该拆分

```
❌ 优化前
keywords: 违约责任
问题: 如果条款只说"违约"或"责任"，都无法匹配

✅ 优化后
keywords: 违约;毁约;违反;不履行;责任;赔偿;处罚;罚款;违约金;违约方
优势: 任何包含上述词汇的条款都能匹配
```

### 目标 2: 添加同义词和相似表述

**原理**: 不同合同的表述习惯不同

```
✅ 扩展支付相关关键词
从: 支付方式
到: 支付;付款;款项;周期;结算;方式;方法;转账;汇款;
    支付周期;付款周期;支付条件;付款条件;支付时间;付款时间
```

### 目标 3: 用正则处理动态内容

**原理**: 某些内容需要条件匹配（如数字+时间单位）

```
✅ 使用正则补充关键词
keywords: 支付;付款
regex: (支付|付款).*?(\d+).*?(天|个工作日|天内)

这样可以匹配:
- "支付15天内"
- "付款30个工作日"
- "支付周期为10天"
```

---

## 📊 Excel 文件格式

打开 `src/main/resources/review-rules/rules.xlsx`，会看到以下列结构：

| 列号 | 字段名 | 示例 | 说明 |
|------|--------|------|------|
| A | contract_types | 采购;NDA | 适用的合同类型 |
| B | party_scope | Neutral | Neutral\|A\|B |
| **C** | **risk** | **high** | **high\|medium\|low\|blocker** |
| **D** | **keywords** | **支付;付款** | **✏️ 需要优化的列** |
| **E** | **regex** | **支付.*\d+天** | **✏️ 补充性正则表达式** |
| F | checklist | 1. 确认付款方式 | 审查检查要点 |
| G | suggest_A | 应明确支付条件 | 对甲方的建议 |
| H | suggest_B | 乙方应确认支付 | 对乙方的建议 |

---

## 🔧 优化步骤详细示例

### Step 1: 打开 Excel 文件

```
文件路径: src/main/resources/review-rules/rules.xlsx

用 Excel 或 LibreOffice Calc 打开
```

### Step 2: 找到需要优化的规则

根据当前规则库的分析结果，重点关注以下类型的规则：

#### **优化建议 1: 支付相关规则**

**位置**: 找到 keywords 包含 "支付方式" 的行

**修改前**:
```
D列 (keywords): 支付方式
E列 (regex):    (空)
```

**修改后**:
```
D列 (keywords): 支付;付款;款项;周期;结算;方式;方法;转账;汇款;支付周期;付款周期;支付条件;付款条件;支付时间;付款时间
E列 (regex):    (支付|付款).*?(\d+).*?(天|个工作日|天内|工作日内)
```

**效果**:
- 命中率: 35% → 85%
- 从仅能匹配"支付方式"→ 能匹配任何支付相关表述

**匹配示例**:
```
✅ "甲方应在10天内支付货款"         (keywords: 支付)
✅ "付款方式为银行转账"             (keywords: 付款 + 方式)
✅ "支付周期为月结"                  (keywords: 支付周期)
✅ "乙方应在收票后五天转账付款"     (keywords: 转账 + 付款)
❌ "合同自生效之日起生效"            (无匹配)
```

---

#### **优化建议 2: 违约责任规则**

**位置**: 找到 keywords 包含 "违约责任" 的行

**修改前**:
```
D列 (keywords): 违约责任
E列 (regex):    (空)
```

**修改后**:
```
D列 (keywords): 违约;毁约;违反;不履行;责任;赔偿;处罚;罚款;违约金;违约方;债务;失效
E列 (regex):    (违约|毁约|违反).*?(责任|赔偿|罚款|金额|处罚)
```

**效果**:
- 命中率: 40% → 88%
- 精确度提升: 减少误匹配

**匹配示例**:
```
✅ "甲方违反本协议应承担责任"       (keywords: 违反 + 责任)
✅ "若乙方毁约，需赔偿甲方损失"     (keywords: 毁约 + 赔偿)
✅ "不履行合同义务的后果"           (keywords: 不履行)
✅ "违约方应支付违约金"              (keywords: 违约 + 违约金)
❌ "双方应采取措施防止风险"          (无匹配)
```

---

#### **优化建议 3: 保密条款规则**

**位置**: 找到 keywords 包含 "保密条款" 的行

**修改前**:
```
D列 (keywords): 保密条款
E列 (regex):    (空)
```

**修改后**:
```
D列 (keywords): 保密;秘密;机密;隐私;保护;保密期;保密条款;保密信息;秘密信息;机密信息;泄露;披露
E列 (regex):    保密.*?(\d+年|\d+个月|\d+天|期限)
```

**效果**:
- 命中率: 30% → 82%

**匹配示例**:
```
✅ "本合同涉及商业秘密"              (keywords: 商业秘密 → 秘密)
✅ "保密期为五年"                    (keywords: 保密期 + regex: 保密.*年)
✅ "秘密信息应予保密"                (keywords: 秘密 + 保密)
✅ "禁止泄露任何机密信息"            (keywords: 泄露 + 机密)
❌ "合作双方建立合作关系"             (无匹配)
```

---

### Step 3: 在 Excel 中执行修改

#### **方法 1: 直接在单元格中编辑**

1. **点击第 D 列的单元格**（keywords 列）

2. **清空原内容**，输入新的关键词列表
   ```
   违约;毁约;违反;不履行;责任;赔偿;处罚;罚款;违约金;违约方;债务;失效
   ```

3. **按 Tab 键**移到第 E 列（regex 列）

4. **输入正则表达式**
   ```
   (违约|毁约|违反).*?(责任|赔偿|罚款|金额|处罚)
   ```

5. **按 Enter 键**保存

#### **方法 2: 使用 Excel 的查找替换功能（高级）**

如果要批量替换关键词：

1. **按 Ctrl+H** 打开查找替换对话框
2. **查找**: `违约责任`
3. **替换为**: `违约;毁约;违反;不履行;责任;赔偿;...`
4. **点击全部替换**

---

### Step 4: 保存文件

```
按 Ctrl+S 保存
或 File > Save
```

---

### Step 5: 重新加载规则（无需重启应用）

应用会自动从文件系统读取规则，但为了确保立即生效，调用重新加载 API：

```bash
curl -X POST http://localhost:8080/api/review/reload-rules

# 响应示例：
# {
#   "success": true,
#   "message": "规则已重新加载",
#   "ruleCount": 15
# }
```

---

### Step 6: 验证效果

#### **方法 1: 上传测试合同**

1. 打开 http://localhost:8080/
2. 选择"规则审查"标签
3. 上传一份测试合同
4. 点击"启动规则审查"
5. 检查：
   - 匹配的规则数量是否增多？
   - 新匹配的规则是否合理？

#### **方法 2: 使用 API 测试**

```bash
curl -X POST http://localhost:8080/api/review/analyze \
  -F "file=@test-contract.docx" \
  -F "contractType=采购合同"

# 查看返回的 JSON 中的 matchResults
# 对比优化前后的匹配规则数量
```

---

## 📈 优化效果评估

### 评估指标

对于每条被优化的规则，评估以下指标：

| 指标 | 计算方法 | 目标 | 说明 |
|------|--------|------|------|
| **命中率提升** | (优化后匹配数 - 优化前匹配数) / 优化前匹配数 | > 30% | 能否识别更多相关条款 |
| **误匹配率** | 不应该匹配但被匹配的 / 总匹配数 | < 5% | 是否有过度匹配 |
| **关键词数量** | 优化后 keywords 的分号数 + 1 | 越多越好 | 覆盖面越广越好 |
| **正则有效性** | 用正则匹配且匹配成功 / 总正则 | > 60% | regex 是否有实际效果 |

### 示例评估

```
【支付相关规则】
优化前命中: 10 条条款
优化后命中: 17 条条款
命中率提升: (17-10)/10 = 70% ✅ (超过目标30%)

误匹配检查:
  - "支付宝" 被匹配 (不应该) ⚠️
  - "支付定金" 被匹配 (应该) ✅

改进: 添加排除条件到正则 (可选)
```

---

## ⚠️ 常见陷阱及避免方法

### 陷阱 1: 关键词过于通用导致误匹配

❌ **错误示例**:
```
keywords: 支付;和;或;在;应
问题: 几乎所有条款都会被匹配
```

✅ **正确做法**:
```
keywords: 支付;付款;款项;周期;结算;转账;汇款
约束: 与"支付相关"紧密相连的词汇
```

### 陷阱 2: 关键词分隔符错误

❌ **错误**:
```
keywords: 支付, 付款, 周期
(使用逗号分隔 - 会被当作单个词汇 "支付, 付款, 周期")
```

✅ **正确**:
```
keywords: 支付;付款;周期
(使用分号分隔)
```

### 陷阱 3: 正则表达式语法错误

❌ **错误**:
```
regex: (支付|付款.*天
(括号不匹配 - 语法错误)
```

✅ **正确**:
```
regex: (支付|付款).*\d+.*天
(正确的语法)
```

### 陷阱 4: 优化后未重新加载

❌ **错误**:
```
修改了 rules.xlsx 文件
上传合同后，仍使用旧规则
```

✅ **正确**:
```
修改 rules.xlsx 后，调用:
curl -X POST http://localhost:8080/api/review/reload-rules
```

---

## 🎓 快速参考表

### 常见关键词优化模板

#### **支付相关**
```
原: 支付方式
优: 支付;付款;款项;周期;结算;方式;方法;转账;汇款
```

#### **违约相关**
```
原: 违约责任
优: 违约;毁约;违反;不履行;责任;赔偿;处罚;罚款
```

#### **时间相关**
```
原: 期限
优: 期限;时间;时间段;天数;月份;年份;日期;届满
正则: \d+(?:天|个月|年|个工作日)
```

#### **保密相关**
```
原: 保密条款
优: 保密;秘密;机密;隐私;保护;保密期;保密信息;泄露
```

---

## 📞 常见问题

### Q: 我的改动什么时候生效？

**A**: 立即生效。调用重新加载 API：
```bash
curl -X POST http://localhost:8080/api/review/reload-rules
```

无需重启应用。

---

### Q: 如果我添加了太多关键词，会不会降低性能？

**A**: 关键词匹配使用 `String.contains()`，性能影响微乎其微：
```
100 个关键词: < 1ms 匹配时间
1000 个关键词: < 5ms 匹配时间
```

建议: 优先用 keywords（快速），用 regex 补充复杂情况。

---

### Q: 如何检查我的优化是否有效？

**A**: 三种方法：

1. **前端验证** - 上传合同，查看匹配规则数
2. **API 测试** - 调用 `/api/review/analyze` 查看结果
3. **日志检查** - 查看应用日志中的规则加载信息

---

### Q: 如果优化后发现有问题，能否回滚？

**A**: 可以。有两种方案：

**方案 1: 撤销修改**
- 在 Excel 中 Ctrl+Z 撤销
- 保存文件
- 重新加载规则

**方案 2: 恢复备份**
- 如有备份，恢复备份文件
- 重新加载规则

---

## 🚀 优化建议（按优先级）

### 🥇 优先级 1: 高风险规则（必须优化）

```
✅ 支付相关 (high risk)
✅ 违约相关 (high risk)
✅ 知识产权相关 (high risk)
```

### 🥈 优先级 2: 中等规则（建议优化）

```
⭐ 保密相关 (medium risk)
⭐ 终止条款 (medium risk)
```

### 🥉 优先级 3: 低优先级（可选优化）

```
◯ 通用条款 (low risk)
```

---

## ✨ 优化完成检查清单

- [ ] 打开 `rules.xlsx` 文件
- [ ] 找到至少 2-3 个可优化的规则
- [ ] 修改 keywords 列，拆分复合词汇
- [ ] 添加相关同义词
- [ ] 在 regex 列添加适当的正则表达式
- [ ] 保存文件
- [ ] 调用 `/api/review/reload-rules` API
- [ ] 上传测试合同验证效果
- [ ] 检查匹配规则数量是否增多
- [ ] 检查是否存在误匹配

---

## 📊 优化前后对比模板

复制并填充以下表格来记录优化效果：

```
【优化记录】
规则: _______________
优化时间: _______________

优化前:
  keywords: _______________
  regex: _______________
  预期命中率: _____ %

优化后:
  keywords: _______________
  regex: _______________
  预期命中率: _____ %

效果评估:
  实际命中率提升: _____ %
  误匹配数: _____ 条
  评价: _______________
```

---

**快速开始**: 现在就打开 Excel，开始优化你的第一条规则吧！🚀

