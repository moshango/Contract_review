# 审查设置与立场配置

## 概述

审查设置模块允许用户选择自己的审查立场（甲方或乙方），系统在规则匹配时会根据用户的立场返回对应的建议。这使得不同身份的用户可以获得针对性的审查指导。

---

## 立场类型

| 立场 | 代码 | 说明 | 获得的建议 |
|------|------|------|----------|
| **甲方** | `A` | 代表合同甲方的利益 | `suggestA` - 对甲方有利的建议 |
| **乙方** | `B` | 代表合同乙方的利益 | `suggestB` - 对乙方有利的建议 |
| **中立** | `Neutral` / 无 | 不代表任何一方 | 只显示通用的中立规则 |

---

## API 接口

### 1. 设置审查立场

**端点**：`POST /api/review/settings`

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `party` | String | 否 | 审查立场，可选值：`A`（甲方）、`B`（乙方）、空或不提供（中立） |

**请求示例**：

```bash
# 设置为甲方立场
curl -X POST "http://localhost:8080/api/review/settings?party=A"

# 设置为乙方立场
curl -X POST "http://localhost:8080/api/review/settings?party=B"

# 重置为中立立场
curl -X POST "http://localhost:8080/api/review/settings"
```

**响应示例**：

```json
{
  "success": true,
  "currentStance": "A",
  "stanceDescription": "甲方",
  "timestamp": 1734027600000,
  "stanceInfo": {
    "A": "甲方立场 - 将收到对甲方有利的建议",
    "B": "乙方立场 - 将收到对乙方有利的建议",
    "Neutral": "中立立场 - 只显示通用的中立建议"
  },
  "nextStep": "下次调用 /api/review/analyze 时，系统将使用此立场进行规则匹配"
}
```

---

### 2. 获取当前审查设置

**端点**：`GET /api/review/settings`

**参数**：无

**请求示例**：

```bash
curl -X GET "http://localhost:8080/api/review/settings"
```

**响应示例**：

```json
{
  "success": true,
  "currentStance": "A",
  "stanceDescription": "甲方",
  "timestamp": 1734027600000,
  "availableOptions": {
    "A": "甲方立场",
    "B": "乙方立场",
    "Neutral": "中立立场"
  },
  "info": "可使用 POST /api/review/settings?party=A 或 party=B 来切换立场"
}
```

---

### 3. 合同分析（支持立场参数）

**端点**：`POST /api/review/analyze`

**参数**：

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `file` | File | 是 | 合同文件（.docx / .doc） |
| `contractType` | String | 否 | 合同类型（默认：通用合同） |
| `party` | String | 否 | 审查立场（`A` 甲方 / `B` 乙方 / 不指定则为中立） |

**请求示例**：

```bash
# 使用甲方立场分析合同
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@contract.docx" \
  -F "contractType=采购合同" \
  -F "party=A"

# 使用乙方立场分析合同
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@contract.docx" \
  -F "contractType=采购合同" \
  -F "party=B"

# 不指定立场（中立分析）
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@contract.docx" \
  -F "contractType=采购合同"
```

**响应示例**：

```json
{
  "success": true,
  "filename": "采购合同.docx",
  "contractType": "采购合同",
  "userStance": "A",
  "stanceDescription": "甲方",
  "timestamp": 1734027600000,
  "statistics": {
    "totalClauses": 10,
    "matchedClauses": 3,
    "totalRules": 45,
    "applicableRules": 30,
    "totalMatchedRules": 5,
    "highRiskClauses": 1
  },
  "guidance": { /* ... */ },
  "prompt": "...根据立场选择对应的建议...",
  "matchResults": [
    {
      "clauseId": "c1",
      "anchorId": "anc-c1-4f21",
      "heading": "第一条 采购范围",
      "riskLevel": "high",
      "matchedRuleCount": 2,
      "matchedRules": [ /* ... */ ]
    }
  ],
  "parseResultId": "parse_xxxxx",
  "processingTime": "1234ms"
}
```

---

## 工作流程

### 场景 1：甲方审查采购合同

```
1. 用户登录系统（代表甲方）
   ↓
2. 调用 POST /api/review/settings?party=A
   （设置立场为甲方）
   ↓
3. 调用 POST /api/review/analyze 上传合同
   ├─ 系统加载匹配的规则
   ├─ 根据甲方立场过滤规则
   │  （只显示对甲方有利的建议）
   └─ 返回针对甲方的 Prompt
   ↓
4. 用户复制 Prompt 到 ChatGPT
   ↓
5. ChatGPT 基于甲方立场返回审查结果
   ↓
6. 用户导入结果生成批注
```

### 场景 2：乙方审查采购合同

```
1. 用户切换身份（代表乙方）
   ↓
2. 调用 POST /api/review/settings?party=B
   （设置立场为乙方）
   ↓
3. 调用 POST /api/review/analyze 上传相同合同
   ├─ 系统加载匹配的规则
   ├─ 根据乙方立场过滤规则
   │  （只显示对乙方有利的建议）
   └─ 返回针对乙方的 Prompt
   ↓
4. 用户复制 Prompt 到 ChatGPT
   ↓
5. ChatGPT 基于乙方立场返回审查结果
   ↓
6. 用户导入结果生成批注
```

---

## 规则匹配过滤逻辑

系统在规则匹配时会应用以下逻辑：

```
对于每条规则：

1. 检查规则的 partyScope 字段
   ├─ 如果为 "Neutral" → 对所有立场适用
   ├─ 如果为 "A" → 仅当用户立场为甲方时适用
   └─ 如果为 "B" → 仅当用户立场为乙方时适用

2. 如果用户未设置立场（中立）
   └─ 只返回 partyScope 为 "Neutral" 的规则

3. 返回建议时：
   ├─ 如果用户是甲方 → 返回 suggestA
   └─ 如果用户是乙方 → 返回 suggestB
```

---

## Prompt 中的立场信息

在生成的 LLM Prompt 中，会包含用户的立场信息：

```
【合同审查信息】
- 用户立场: 甲方
- 审查角度: 对甲方有利的建议

【审查规则】
这些规则都是基于甲方立场筛选的，重点关注：
- 对甲方不利的条款
- 需要甲方特别注意的风险
- 对甲方有利的条款改进建议

...
```

---

## 规则配置建议

在 `rules.xlsx` 中配置规则时，建议：

| 字段 | 配置建议 |
|------|---------|
| `partyScope` | 明确指定 `A`（甲方）、`B`（乙方）或 `Neutral`（中立） |
| `suggestA` | 填写对甲方的具体建议 |
| `suggestB` | 填写对乙方的具体建议 |

**示例**：

| partyScope | suggestA | suggestB |
|-----------|----------|----------|
| Neutral | 应明确付款方式 | 应明确付款方式 |
| A | 建议要求预付款50% | 接受分期付款但要求首付至少30% |
| B | 乙方不应承担额外费用 | 应争取合理的付款期限 |

---

## 常见问题

### Q1: 如何在分析合同时应用立场？

可通过以下两种方式：

**方式 1：先设置立场，后分析**
```bash
# 设置立场
curl -X POST "http://localhost:8080/api/review/settings?party=A"

# 分析合同（使用之前设置的立场）
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@contract.docx"
```

**方式 2：直接在分析接口中指定立场**
```bash
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@contract.docx" \
  -F "party=A"
```

### Q2: 不设置立场会怎样？

系统会使用默认的中立立场，只显示 `partyScope` 为 `Neutral` 的规则。

### Q3: 立场设置是全局的还是会话级的？

当前实现使用线程本地存储，每个用户会话有自己的立场设置。

### Q4: 可以在同一次审查中混合不同立场吗？

不可以。每次分析合同时只能使用一种立场。如需对比不同立场下的结果，需要分别进行两次分析。

### Q5: 如何重置立场到中立？

```bash
# 不指定 party 参数即可重置为中立
curl -X POST "http://localhost:8080/api/review/settings"
```

---

## 集成建议

### 前端集成

```javascript
// 设置立场
async function setStance(party) {
  const response = await fetch(
    `/api/review/settings?party=${party}`,
    { method: 'POST' }
  );
  return await response.json();
}

// 获取当前立场
async function getStance() {
  const response = await fetch('/api/review/settings');
  return await response.json();
}

// 分析合同（带立场）
async function analyzeContract(file, contractType, party) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('contractType', contractType);
  formData.append('party', party);

  const response = await fetch(
    '/api/review/analyze',
    { method: 'POST', body: formData }
  );
  return await response.json();
}
```

### 用户界面建议

建议在前端显示一个立场选择器：

```
┌─ 审查立场选择 ─────────────────┐
│ ○ 甲方  ○ 乙方  ○ 中立        │
│                               │
│ 当前立场: 甲方                  │
│ [确认] [切换立场]               │
└───────────────────────────────┘
```

---

## 性能考虑

- **立场过滤开销**：最小化，仅在规则流过滤时进行判断
- **建议查询效率**：O(1) 查询，通过字段直接获取
- **线程安全**：使用 ThreadLocal 保证线程安全

---

## 后续改进方向

- [ ] 支持自定义立场（不仅限于甲/乙/中立）
- [ ] 立场历史记录和审计
- [ ] 用户个人化的立场配置
- [ ] 立场转换时的对比报告
- [ ] 多方协商场景支持（A、B、C 三方）

---

**更新时间**：2025-10-23
**版本**：1.0

