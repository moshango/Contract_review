# 规则审查关键词匹配逻辑详解

## 📋 概述

规则审查系统采用**两阶段匹配策略**：
1. **关键字粗召回**（Keyword Broad Recall）
2. **正则精筛**（Regex Fine-tuning）

## 🔍 匹配流程详解

### 阶段 1: 关键字匹配（优先级最高）

**代码位置**: `ReviewRule.java:180-200`

```java
// 优先检查关键字（广召回）
String[] keywordList = getKeywordList();
for (String keyword : keywordList) {
    String trimmedKeyword = keyword.trim();
    if (text.contains(trimmedKeyword)) {
        this.matchedKeywords.add(trimmedKeyword);
    }
}

// 如果关键字匹配了，直接返回true
if (!this.matchedKeywords.isEmpty()) {
    return true;
}
```

**特点**:
- ✅ 使用 `String.contains()` 进行**精确子串匹配**
- ✅ 支持多个关键字（用`;`分隔）
- ✅ **只要任意一个关键字命中，就判定为匹配**
- ✅ 不区分大小写处理（中文自动精确匹配）
- ✅ **关键字匹配成功后，正则表达式不再执行**

**关键词分割方式**:

```java
public String[] getKeywordList() {
    if (keywords == null || keywords.trim().isEmpty()) {
        return new String[0];
    }
    return keywords.split(";");  // 使用分号分隔
}
```

**示例**:

| 规则中的 keywords | 条款文本 | 结果 |
|-----------------|--------|------|
| `付款方式;支付周期;付款条件` | "乙方应在收到发票后10个工作日内支付货款" | ✅ 匹配 ("付款条件") |
| `违约责任` | "一方违反本协议，应承担违约责任" | ✅ 匹配 ("违约责任") |
| `知识产权;专利;著作权` | "本合同涉及的所有知识产权属于甲方" | ✅ 匹配 ("知识产权") |
| `保密期限` | "保密信息应保密五年" | ❌ 不匹配 |

---

### 阶段 2: targetClauses 匹配（向后兼容）

**代码位置**: `ReviewRule.java:202-211`

```java
// 检查 targetClauses（向后兼容）
if (targetClauses != null && !targetClauses.isEmpty()) {
    String lowerText = text.toLowerCase();
    for (String clause : targetClauses) {
        if (lowerText.contains(clause.toLowerCase())) {
            this.matchedKeywords.add(clause);
            return true;
        }
    }
}
```

**特点**:
- 用于向后兼容旧的 `ReviewStandard` 规则数据
- 不区分大小写
- 如果 `targetClauses` 中任意项命中，也直接返回true

---

### 阶段 3: 正则表达式匹配（最精细）

**代码位置**: `ReviewRule.java:213-228`

```java
// 如果有正则表达式，进行正则匹配
if (regex != null && !regex.trim().isEmpty()) {
    if (compiledPattern == null) {
        try {
            compiledPattern = Pattern.compile(regex);
        } catch (Exception e) {
            System.err.println("Failed to compile regex for rule " + id + ": " + regex);
            return false;
        }
    }
    if (compiledPattern.matcher(text).find()) {
        this.matchedKeywords.add("正则: " + regex);
        return true;
    }
}

return false;  // 最后都没匹配，返回false
```

**特点**:
- 只在关键字和 targetClauses 都不匹配时执行
- 支持完整的 Java 正则表达式语法
- 使用 `Pattern.find()` 而不是 `matches()`（不需要完全匹配整个文本）
- 异常处理：正则编译失败时记录日志但不中断

**常见正则表达式示例**:

| 正则表达式 | 说明 | 匹配例子 |
|-----------|------|--------|
| `支付.*\d+天` | "支付" + 任意字符 + 数字 + "天" | "支付后10天内" ✅ |
| `(违约\|毁约)` | "违约"或"毁约" | "存在违约行为" ✅ |
| `保密期.*(\d+年\|\d+个月)` | 保密期 + 时间 | "保密期为5年" ✅ |
| `\d{4}-\d{2}-\d{2}` | YYYY-MM-DD 格式日期 | "2024-12-31" ✅ |

---

## 📊 关键字 vs 正则的区别

### keywords（关键字）

**定义**: 规则Excel中的第 **4 列**

**使用场景**:
- 快速、精确的子串匹配
- 高频出现的重要词汇
- 需要广泛召回的情况

**性质**:
- 多个用`;`分隔
- 不支持通配符或正则
- 必须精确包含在条款中
- 性能高（简单字符串比对）

**示例**:
```
违约责任;违约条款;违约处理;责任承担
```

### regex（正则表达式）

**定义**: 规则Excel中的第 **5 列**

**使用场景**:
- 复杂的模式匹配
- 动态内容匹配（如数字、日期）
- 多种表述方式的统一匹配

**性质**:
- 支持完整的Java正则语法
- 仅在keyword和targetClauses都不匹配时使用
- 性能较低（复杂度取决于正则表达式）

**示例**:
```
支付.*(\d+|\w+).*天
(甲方|乙方).*违约
保密期限.*(\d+年|\d+个月)
```

---

## 🔄 完整匹配流程图

```
条款文本输入
    ↓
┌─────────────────────────────┐
│ 检查关键字 (keywords)        │
│ 任一关键字.contains() 匹配?  │
└─────────────────────────────┘
    ↓ 是                ↓ 否
   返回 TRUE           继续
    ↑                  ↓
   ┌─────────────────────────────┐
   │ 检查 targetClauses           │
   │ 任一 clause.contains() 匹配? │
   └─────────────────────────────┘
       ↓ 是                ↓ 否
      返回 TRUE           继续
       ↑                  ↓
      ┌─────────────────────────────┐
      │ 检查正则表达式 (regex)      │
      │ pattern.find() 匹配?       │
      └─────────────────────────────┘
          ↓ 是         ↓ 否
         返回 TRUE    返回 FALSE
```

---

## 💡 关键词优化建议

### 问题示例

用户提出的优化例子：`违约责任` → `违约`

**分析**:
- `违约责任` 是更具体的词汇
- `违约` 是更通用的词汇

### 优化策略

#### 1. **拆分复合词汇**

❌ 不够好:
```
违约责任;违约金;违约处理
```

✅ 更好:
```
违约;违约责任;违约金;违约处理
```

**原因**: 条款中可能只包含 "违约"，不包含整个词组

---

#### 2. **添加同义词和相似表述**

❌ 不够好:
```
支付方式
```

✅ 更好:
```
支付方式;付款方式;支付条件;付款条件;支付周期;付款周期
```

**原因**: 不同合同的表述习惯不同

---

#### 3. **识别核心概念**

❌ 过于冗长（可能出现召回不全）:
```
本合同中甲乙双方就技术合作事项;甲乙双方在技术合作上的协议;技术合作的具体内容
```

✅ 提炼核心词汇:
```
技术合作;合作范围;合作内容;技术交流
```

---

#### 4. **考虑使用正则处理复杂情况**

对于需要条件匹配的场景，应该用 `regex` 而不是扩展 `keywords`：

❌ 不够优雅:
```
keywords: 支付10天;支付15天;支付20天;支付30天
```

✅ 使用正则:
```
keywords: 支付
regex: 支付.*\d+.*天
```

---

## 🛠️ Excel规则文件格式

| 列号 | 字段名 | 示例值 | 说明 |
|------|--------|--------|------|
| 0 | contract_types | 采购;NDA;外包 | 适用的合同类型 (`;` 分隔) |
| 1 | party_scope | Neutral\|A\|B | 适用范围 |
| 2 | risk | high\|medium\|low\|blocker | 风险等级 |
| **3** | **keywords** | **支付;付款;款项** | **关键字匹配** (`;` 分隔) |
| **4** | **regex** | **支付.*\d+.*天** | **正则匹配** |
| 5 | checklist | 1. 确认支付方式\n2. 确认周期 | 审查清单 |
| 6 | suggest_A | 应明确支付条件 | 对甲方的建议 |
| 7 | suggest_B | 乙方应确认支付时间 | 对乙方的建议 |

---

## 📈 规则匹配的实际调用流程

### 1. 规则加载阶段

**文件**: `ReviewRulesService.java:50-83`

```java
public synchronized List<ReviewRule> loadRules() {
    // 从 rules.xlsx 加载规则
    cachedRules = loadRulesFromExcel(actualPath);
    logger.info("Successfully loaded {} rules", cachedRules.size());
}
```

### 2. 规则匹配阶段（规则审查时）

**文件**: `ReviewRulesService.java:301-310`

```java
public List<ReviewRule> matchRulesForClause(String clauseText, String contractType) {
    return cachedRules.stream()
        .filter(rule -> rule.applicableToContractType(contractType))  // 筛选合同类型
        .filter(rule -> rule.matches(clauseText))                     // 执行匹配
        .collect(Collectors.toList());
}
```

### 3. 规则的 matches() 方法（核心匹配逻辑）

**文件**: `ReviewRule.java:180-231`

```
1. 检查关键字 → 如果匹配，返回 TRUE
2. 检查 targetClauses → 如果匹配，返回 TRUE
3. 检查正则表达式 → 如果匹配，返回 TRUE
4. 都不匹配 → 返回 FALSE
```

---

## 🎯 优化关键词的实操步骤

### 步骤 1: 识别低效的规则

查找当前规则中命中率低的规则：

```bash
# 检查 rules.xlsx，找出：
# - keywords 过于具体（如"违约责任" 而不是 "违约"）
# - 缺少常用同义词
# - regex 空白而应该用来处理复杂情况的
```

### 步骤 2: 分析实际合同文本

```
审查过去的合同，统计：
1. 哪些关键字出现频率最高
2. 哪些关键字是复合词汇（可以拆分）
3. 同一个概念的不同表述方式
```

### 步骤 3: 编辑 rules.xlsx

打开 `src/main/resources/review-rules/rules.xlsx`：

```
示例：
原规则 keywords: "违约责任"
优化后 keywords: "违约;违约责任;违约金;毁约;责任承担"

或使用正则:
keywords: "违约"
regex: "(违约|毁约|违反).*责任
```

### 步骤 4: 动态重新加载规则

无需重启应用，调用重新加载接口：

```bash
curl -X POST http://localhost:8080/api/review/reload-rules
```

---

## 📊 性能考量

| 匹配方式 | 性能 | 推荐场景 |
|--------|------|--------|
| keywords | ⚡⚡⚡ 最快 | 简单子串匹配、高频词汇 |
| targetClauses | ⚡⚡ 快 | 向后兼容 |
| regex | ⚡ 较慢 | 复杂模式、动态内容 |

**建议**:
- 优先使用 `keywords`（性能好、维护简单）
- 用 `regex` 处理 `keywords` 无法表达的复杂情况
- 避免过度使用正则表达式

---

## 🔗 相关代码位置

| 模块 | 文件 | 主要方法 |
|------|------|--------|
| 规则加载 | `ReviewRulesService.java` | `loadRules()`, `loadRulesFromExcel()` |
| 规则匹配 | `ReviewRule.java` | `matches()`, `getKeywordList()` |
| 规则过滤 | `ReviewRulesService.java` | `matchRulesForClause()` |
| 规则控制器 | `QwenRuleReviewController.java` | `/api/review/analyze` |

---

## 📝 总结

1. **keywords（关键字）**:
   - 使用 `contains()` 进行精确子串匹配
   - 多个用 `;` 分隔
   - 优先级最高，建议首先优化

2. **regex（正则）**:
   - 仅在关键字和 targetClauses 都不匹配时执行
   - 支持复杂的模式匹配
   - 性能较差，用于补充关键字无法表达的情况

3. **优化建议**:
   - 拆分复合词汇（如 `违约责任` → `违约;违约责任`)
   - 添加同义词和相似表述
   - 用正则处理动态内容

---

**最后更新**: 2025-10-24
**文档版本**: 1.0
