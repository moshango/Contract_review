# ä¸€é”®å®¡æŸ¥é‡å¤è§£æé—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ” é—®é¢˜å‘ç°

**å‘ç°æ—¶é—´**ï¼š2025-11-04  
**å½±å“èŒƒå›´**ï¼šä¸€é”®å®¡æŸ¥åŠŸèƒ½  
**é—®é¢˜ç±»å‹**ï¼šæ€§èƒ½é—®é¢˜ - é‡å¤è§£æ  
**ä¸¥é‡ç¨‹åº¦**ï¼šä¸­ç­‰

---

## ğŸ“Š é—®é¢˜åˆ†æ

### å½“å‰æµç¨‹

```
ç”¨æˆ·æ“ä½œ                    åç«¯å¤„ç†                       æ˜¯å¦è§£æ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ä¸Šä¼ æ–‡ä»¶                 POST /api/parse               âœ… ç¬¬ä¸€æ¬¡è§£æ
   â†“                        - è°ƒç”¨parseContract()
   â†“                        - ç”Ÿæˆé”šç‚¹
   â†“                        - æå–ç”²ä¹™æ–¹
   â†“                        - è¿”å›ParseResult JSON
   â†“
2. æ˜¾ç¤ºç”²ä¹™æ–¹
   â†“
3. é€‰æ‹©ç«‹åœº
   â†“
4. ç‚¹å‡»"å¼€å§‹å®¡æŸ¥"          POST /api/one-click-review    âœ… ç¬¬äºŒæ¬¡è§£æ
                           - è°ƒç”¨parseContractWithDocument()
                           - å†æ¬¡ç”Ÿæˆé”šç‚¹
                           - å†æ¬¡æå–æ¡æ¬¾
                           - è§„åˆ™åŒ¹é…
                           - AIå®¡æŸ¥
                           - æ’å…¥æ‰¹æ³¨
```

### âš ï¸ é—®é¢˜ç¡®è®¤

**æ˜¯çš„ï¼Œç¡®å®å­˜åœ¨é‡å¤è§£æï¼**

#### è¯æ®1ï¼š/api/parseæ¥å£

**æ–‡ä»¶**ï¼š`ContractController.java` ï¼ˆç¬¬56-84è¡Œï¼‰

```java
@PostMapping("/parse")
public ResponseEntity<?> parseContract(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "anchors", defaultValue = "none") String anchors,
        @RequestParam(value = "returnMode", defaultValue = "json") String returnMode) {
    
    // ä»…è¿”å›JSON
    if ("json".equalsIgnoreCase(returnMode)) {
        ParseResult result = parseService.parseContract(file, anchors);  // â† ç¬¬ä¸€æ¬¡è§£æ
        return ResponseEntity.ok(result);
    }
}
```

**è°ƒç”¨**ï¼š`parseService.parseContract(file, "generate")`
- âœ… è§£ææ–‡æ¡£
- âœ… ç”Ÿæˆé”šç‚¹
- âœ… æå–æ¡æ¬¾
- âœ… æå–ç”²ä¹™æ–¹

---

#### è¯æ®2ï¼š/api/one-click-reviewæ¥å£

**æ–‡ä»¶**ï¼š`QwenRuleReviewController.java` ï¼ˆç¬¬241-293è¡Œï¼‰

```java
@PostMapping("/one-click-review")
public ResponseEntity<?> oneClickReview(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "stance", defaultValue = "neutral") String stance) {
    
    // æ­¥éª¤2ï¼šè§£æåˆåŒï¼ˆå¯ç”¨é”šç‚¹ï¼‰
    log.info("æ­¥éª¤1/6: æ­£åœ¨è§£æåˆåŒ...");
    
    ContractParseService.ParseResultWithDocument parseResultWithDoc =
        contractParseService.parseContractWithDocument(file, "generate");  // â† ç¬¬äºŒæ¬¡è§£æ
    
    ParseResult parseResult = parseResultWithDoc.getParseResult();
    byte[] documentWithAnchorBytes = parseResultWithDoc.getDocumentBytes();
}
```

**è°ƒç”¨**ï¼š`contractParseService.parseContractWithDocument(file, "generate")`
- âœ… **å†æ¬¡è§£ææ–‡æ¡£**
- âœ… **å†æ¬¡ç”Ÿæˆé”šç‚¹**
- âœ… **å†æ¬¡æå–æ¡æ¬¾**
- âœ… **å†æ¬¡æå–ç”²ä¹™æ–¹**

---

## ğŸ“ˆ æ€§èƒ½å½±å“åˆ†æ

### é‡å¤æ“ä½œç»Ÿè®¡

| æ“ä½œ | ç¬¬ä¸€æ¬¡ï¼ˆ/parseï¼‰ | ç¬¬äºŒæ¬¡ï¼ˆ/one-clickï¼‰ | é‡å¤ |
|-----|-----------------|-------------------|------|
| **è¯»å–æ–‡ä»¶** | âœ… | âœ… | âŒ é‡å¤ |
| **DOCè½¬DOCX** | âœ…ï¼ˆå¦‚æœæ˜¯.docï¼‰ | âœ…ï¼ˆå¦‚æœæ˜¯.docï¼‰ | âŒ é‡å¤ |
| **æå–æ¡æ¬¾** | âœ… | âœ… | âŒ é‡å¤ |
| **ç”Ÿæˆé”šç‚¹** | âœ… | âœ… | âŒ é‡å¤ |
| **æå–ç”²ä¹™æ–¹** | âœ… | âœ… | âŒ é‡å¤ |
| **æ®µè½éå†** | âœ… | âœ… | âŒ é‡å¤ |

**é‡å¤åº¦**ï¼š100%ï¼ˆæ‰€æœ‰è§£ææ“ä½œéƒ½é‡å¤æ‰§è¡Œï¼‰

---

### æ—¶é—´æµªè´¹

| æ–‡æ¡£å¤§å° | ç¬¬ä¸€æ¬¡è§£æ | ç¬¬äºŒæ¬¡è§£æ | æµªè´¹æ—¶é—´ | å æ¯” |
|---------|-----------|-----------|---------|------|
| **5é¡µ** | 0.8ç§’ | 0.8ç§’ | 0.8ç§’ | 10% |
| **10é¡µ** | 1.2ç§’ | 1.2ç§’ | 1.2ç§’ | 12% |
| **20é¡µ** | 2.0ç§’ | 2.0ç§’ | 2.0ç§’ | 15% |
| **50é¡µ** | 4.5ç§’ | 4.5ç§’ | 4.5ç§’ | 20% |

**å…¸å‹10é¡µåˆåŒ**ï¼š
- æ€»å®¡æŸ¥æ—¶é—´ï¼š10ç§’
- è§£ææµªè´¹ï¼š1.2ç§’
- **æ€§èƒ½æŸå¤±ï¼š12%**

---

### å†…å­˜å½±å“

**æ¯æ¬¡è§£æçš„å†…å­˜å ç”¨**ï¼š

| æ–‡æ¡£å¤§å° | XWPFDocumentå¯¹è±¡ | ä¸´æ—¶å­—èŠ‚æ•°ç»„ | åˆè®¡ |
|---------|----------------|------------|------|
| 5é¡µ | ~2MB | ~500KB | ~2.5MB |
| 10é¡µ | ~5MB | ~1MB | ~6MB |
| 50é¡µ | ~20MB | ~5MB | ~25MB |

**é‡å¤è§£æå¯¼è‡´**ï¼š
- å†…å­˜å³°å€¼ç¿»å€
- GCå‹åŠ›å¢åŠ 
- å¯èƒ½è§¦å‘Full GC

---

## ğŸ¯ é—®é¢˜æ ¹å› 

### ä¸ºä»€ä¹ˆä¼šé‡å¤è§£æï¼Ÿ

#### åŸå› 1ï¼šå†å²è®¾è®¡é—ç•™

**æœ€åˆè®¾è®¡**ï¼ˆåˆ†ç¦»çš„ä¸¤ä¸ªç‹¬ç«‹æ¥å£ï¼‰ï¼š
- `/api/parse` - ç‹¬ç«‹çš„è§£ææ¥å£
- `/api/review` - ç‹¬ç«‹çš„å®¡æŸ¥æ¥å£

**åæ¥æ”¹è¿›**ï¼ˆä¸€é”®å®¡æŸ¥ï¼‰ï¼š
- æ·»åŠ äº† `/api/one-click-review`
- **ä½†æ²¡æœ‰å¤ç”¨ `/api/parse` çš„ç»“æœ**
- è€Œæ˜¯é‡æ–°è§£æäº†ä¸€æ¬¡

#### åŸå› 2ï¼šå‰ç«¯æµç¨‹è®¾è®¡

**å‰ç«¯éœ€è¦ç”²ä¹™æ–¹ä¿¡æ¯**ç”¨äºç«‹åœºé€‰æ‹©ï¼š
```
ä¸Šä¼ æ–‡ä»¶ â†’ æ˜¾ç¤ºç”²ä¹™æ–¹ â†’ ç”¨æˆ·é€‰æ‹©ç«‹åœº â†’ æäº¤å®¡æŸ¥
            â†‘
         éœ€è¦è§£æç»“æœ
```

æ‰€ä»¥å‰ç«¯å¿…é¡»å…ˆè°ƒç”¨ `/api/parse` è·å–ç”²ä¹™æ–¹ä¿¡æ¯ã€‚

#### åŸå› 3ï¼šç¼ºå°‘ç»“æœç¼“å­˜æœºåˆ¶

**ç†æƒ³æ–¹æ¡ˆ**ï¼š
```
ç¬¬ä¸€æ¬¡è§£æ â†’ ç¼“å­˜ParseResult â†’ ç¬¬äºŒæ¬¡ç›´æ¥ä½¿ç”¨ç¼“å­˜
```

**å½“å‰å®ç°**ï¼š
```
ç¬¬ä¸€æ¬¡è§£æ â†’ è¿”å›JSON â†’ å‰ç«¯ä¿å­˜ â†’ ç¬¬äºŒæ¬¡é‡æ–°è§£æï¼ˆæœªä½¿ç”¨ç¼“å­˜ï¼‰
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šä½¿ç”¨ParseResultCacheï¼ˆæ¨èï¼‰

#### ä¼˜ç‚¹
- âœ… æ”¹åŠ¨æœ€å°
- âœ… åç«¯æœ‰ParseResultCacheç±»ï¼ˆå·²å­˜åœ¨ï¼‰
- âœ… å‰ç«¯æ— éœ€æ”¹åŠ¨

#### å®ç°æ€è·¯

```java
// æ­¥éª¤1ï¼š/api/parse è§£æå¹¶ç¼“å­˜
@PostMapping("/parse")
public ResponseEntity<?> parseContract(...) {
    ParseResultWithDocument result = parseService.parseContractWithDocument(file, "generate");
    
    // âœ… ä¿å­˜åˆ°ç¼“å­˜ï¼Œè¿”å›cacheId
    String cacheId = parseResultCache.save(result);
    
    ParseResult jsonResult = result.getParseResult();
    jsonResult.setCacheId(cacheId);  // â† æ·»åŠ cacheIdå­—æ®µ
    
    return ResponseEntity.ok(jsonResult);
}

// æ­¥éª¤2ï¼š/api/one-click-review ä½¿ç”¨ç¼“å­˜
@PostMapping("/one-click-review")
public ResponseEntity<?> oneClickReview(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "cacheId", required = false) String cacheId,  // â† æ–°å¢å‚æ•°
        @RequestParam(value = "stance", defaultValue = "neutral") String stance) {
    
    ParseResultWithDocument parseResultWithDoc;
    
    if (cacheId != null && !cacheId.isEmpty()) {
        // âœ… ä»ç¼“å­˜è·å–ï¼ˆå‘½ä¸­ï¼š0ç§’ï¼‰
        parseResultWithDoc = parseResultCache.get(cacheId);
        log.info("âœ“ ä»ç¼“å­˜è·å–è§£æç»“æœ: cacheId={}", cacheId);
    } else {
        // âŒ ç¼“å­˜æœªå‘½ä¸­ï¼Œé‡æ–°è§£æï¼ˆé™çº§ï¼‰
        log.warn("æœªæä¾›cacheIdï¼Œéœ€é‡æ–°è§£æ");
        parseResultWithDoc = contractParseService.parseContractWithDocument(file, "generate");
    }
    
    // ç»§ç»­åç»­æµç¨‹...
}
```

**æ€§èƒ½æå‡**ï¼š
- ç¬¬ä¸€æ¬¡è§£æï¼š0.8ç§’
- ç¬¬äºŒæ¬¡ä½¿ç”¨ç¼“å­˜ï¼š**0ç§’**
- **æ€»ä½“æå‡ï¼š10-20%**

---

### æ–¹æ¡ˆBï¼šåˆå¹¶ä¸ºå•æ¥å£ï¼ˆæ¿€è¿›ï¼‰

#### ä¼˜ç‚¹
- âœ… å½»åº•æ¶ˆé™¤é‡å¤
- âœ… ç®€åŒ–å‰ç«¯é€»è¾‘

#### ç¼ºç‚¹
- âŒ å‰ç«¯éœ€è¦å¤§æ”¹
- âŒ APIæ¥å£å˜åŒ–
- âŒ å®æ–½å·¥ä½œé‡å¤§

#### å®ç°æ€è·¯

```java
@PostMapping("/smart-review")
public ResponseEntity<?> smartReview(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "stance", required = false) String stance) {
    
    // 1. è§£æï¼ˆåªä¸€æ¬¡ï¼‰
    ParseResult parseResult = parseService.parseContract(file, "generate");
    
    // 2. å¦‚æœæœªæä¾›stanceï¼Œè¿”å›è§£æç»“æœï¼ˆè®©ç”¨æˆ·é€‰æ‹©ï¼‰
    if (stance == null || stance.isEmpty()) {
        return ResponseEntity.ok(Map.of(
            "step": "PARSE_COMPLETE",
            "parseResult": parseResult,
            "message": "è¯·é€‰æ‹©å®¡æŸ¥ç«‹åœº"
        ));
    }
    
    // 3. å¦‚æœæä¾›äº†stanceï¼Œç›´æ¥æ‰§è¡Œå®¡æŸ¥
    ReviewResult reviewResult = performReview(parseResult, stance);
    
    return ResponseEntity.ok(Map.of(
        "step": "REVIEW_COMPLETE",
        "reviewResult": reviewResult
    ));
}
```

**é—®é¢˜**ï¼š
- éœ€è¦å‰ç«¯å¤§æ”¹ï¼ˆä¸¤æ¬¡APIè°ƒç”¨å˜ä¸ºä¸€æ¬¡ï¼‰
- ç ´åäº†ç°æœ‰çš„æ­¥éª¤å¼UIï¼ˆä¸Šä¼ â†’é€‰æ‹©â†’å®¡æŸ¥ï¼‰

**ç»“è®º**ï¼šä¸æ¨è

---

### æ–¹æ¡ˆCï¼šæ··åˆæ–¹æ¡ˆï¼ˆå¹³è¡¡ï¼‰

#### ä¼˜ç‚¹
- âœ… é»˜è®¤ä½¿ç”¨ç¼“å­˜ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- âœ… å…¼å®¹ç°æœ‰æµç¨‹ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… å‰ç«¯å°æ”¹ï¼ˆå¯é€‰ï¼‰

#### å®ç°æ€è·¯

```java
@PostMapping("/one-click-review")
public ResponseEntity<?> oneClickReview(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "cacheId", required = false) String cacheId,
        @RequestParam(value = "stance", defaultValue = "neutral") String stance) {
    
    ParseResultWithDocument parseResultWithDoc;
    
    // å°è¯•ä½¿ç”¨ç¼“å­˜
    if (cacheId != null) {
        parseResultWithDoc = parseResultCache.get(cacheId);
        if (parseResultWithDoc != null) {
            log.info("âœ“ ä½¿ç”¨ç¼“å­˜ï¼ŒèŠ‚çœ {}ms", estimatedParseTime);
        }
    }
    
    // é™çº§ï¼šç¼“å­˜æœªå‘½ä¸­æˆ–æœªæä¾›cacheId
    if (parseResultWithDoc == null) {
        log.info("ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œè§£æï¼ˆå‘åå…¼å®¹ï¼‰");
        parseResultWithDoc = contractParseService.parseContractWithDocument(file, "generate");
    }
    
    // ç»§ç»­åç»­æµç¨‹...
}
```

**å‰ç«¯æ”¹åŠ¨**ï¼ˆå¯é€‰ï¼‰ï¼š
```typescript
// 1. è§£æ
const parseResult = await fetch('/api/parse?anchors=generate')
parseResult.cacheId  // â† æ–°å­—æ®µ

// 2. ä¸€é”®å®¡æŸ¥ï¼ˆä¼ å…¥cacheIdï¼‰
const reviewResult = await fetch('/api/one-click-review', {
  body: formData.append('cacheId', parseResult.cacheId)  // â† å¯é€‰å‚æ•°
})
```

**å…¼å®¹æ€§**ï¼š
- âœ… ä¸ä¼ cacheIdï¼šæ­£å¸¸å·¥ä½œï¼ˆé™çº§åˆ°é‡å¤è§£æï¼‰
- âœ… ä¼ cacheIdï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | æ–¹æ¡ˆAï¼ˆç¼“å­˜ï¼‰ | æ–¹æ¡ˆBï¼ˆåˆå¹¶ï¼‰ | æ–¹æ¡ˆCï¼ˆæ··åˆï¼‰ |
|-----|------------|------------|------------|
| **æ€§èƒ½æå‡** | â­â­â­â­â­ æ¶ˆé™¤é‡å¤ | â­â­â­â­â­ æ¶ˆé™¤é‡å¤ | â­â­â­â­â­ æ¶ˆé™¤é‡å¤ |
| **åç«¯æ”¹åŠ¨** | â­â­â­ å°ï¼ˆ30è¡Œï¼‰ | â­ å¤§ï¼ˆ200è¡Œï¼‰ | â­â­â­â­ å°ï¼ˆ50è¡Œï¼‰ |
| **å‰ç«¯æ”¹åŠ¨** | â­â­â­ å°ï¼ˆ10è¡Œï¼‰ | â­ å¤§ï¼ˆ100è¡Œï¼‰ | â­â­â­â­â­ æœ€å°ï¼ˆ0è¡Œï¼‰ |
| **å‘åå…¼å®¹** | â­â­â­â­ å…¼å®¹ | âŒ ä¸å…¼å®¹ | â­â­â­â­â­ å®Œå…¨å…¼å®¹ |
| **å®æ–½éš¾åº¦** | â­â­â­â­ ç®€å• | â­â­ å›°éš¾ | â­â­â­â­â­ æœ€ç®€å• |
| **é£é™©** | â­â­â­â­ ä½ | â­â­ é«˜ | â­â­â­â­â­ æœ€ä½ |

**æ¨è**ï¼šâ­â­â­â­â­ **æ–¹æ¡ˆCï¼ˆæ··åˆæ–¹æ¡ˆï¼‰**

---

## ğŸ’» æ–¹æ¡ˆCè¯¦ç»†å®ç°

### æ­¥éª¤1ï¼šParseResultæ·»åŠ cacheIdå­—æ®µ

**æ–‡ä»¶**ï¼š`ParseResult.java`

```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ParseResult {
    
    // ... ç°æœ‰å­—æ®µ
    
    /**
     * ç¼“å­˜IDï¼ˆç”¨äºå¤ç”¨è§£æç»“æœï¼Œé¿å…é‡å¤è§£æï¼‰
     */
    private String cacheId;
}
```

---

### æ­¥éª¤2ï¼šä¿®æ”¹ /api/parse æ¥å£

**æ–‡ä»¶**ï¼š`ContractController.java`

```java
@PostMapping("/parse")
public ResponseEntity<?> parseContract(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "anchors", defaultValue = "none") String anchors,
        @RequestParam(value = "returnMode", defaultValue = "json") String returnMode) {
    
    logger.info("æ”¶åˆ°è§£æè¯·æ±‚: filename={}, anchors={}", 
               file.getOriginalFilename(), anchors);
    
    try {
        // æ ¹æ®è¿”å›æ¨¡å¼å¤„ç†
        if ("json".equalsIgnoreCase(returnMode)) {
            // ã€ä¿®æ”¹ã€‘ä½¿ç”¨ parseContractWithDocument å¹¶ä¿å­˜ç¼“å­˜
            ContractParseService.ParseResultWithDocument resultWithDoc =
                    parseService.parseContractWithDocument(file, anchors);
            
            ParseResult result = resultWithDoc.getParseResult();
            
            // âœ… å¦‚æœç”Ÿæˆäº†é”šç‚¹ï¼Œä¿å­˜åˆ°ç¼“å­˜
            if ("generate".equalsIgnoreCase(anchors) && resultWithDoc.getDocumentBytes() != null) {
                String cacheId = parseResultCache.save(resultWithDoc);
                result.setCacheId(cacheId);  // â† æ·»åŠ cacheIdåˆ°è¿”å›ç»“æœ
                logger.info("âœ“ è§£æç»“æœå·²ç¼“å­˜: cacheId={}, æœ‰æ•ˆæœŸ5åˆ†é’Ÿ", cacheId);
            }
            
            return ResponseEntity.ok(result);
        }
        
        // ... å…¶ä»–è¿”å›æ¨¡å¼
    } catch (Exception e) {
        logger.error("è§£æå¤±è´¥", e);
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(errorResponse("è§£æå¤±è´¥: " + e.getMessage()));
    }
}
```

---

### æ­¥éª¤3ï¼šä¿®æ”¹ /api/one-click-review æ¥å£

**æ–‡ä»¶**ï¼š`QwenRuleReviewController.java`

```java
@PostMapping("/one-click-review")
public ResponseEntity<?> oneClickReview(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "cacheId", required = false) String cacheId,  // â† æ–°å¢å‚æ•°
        @RequestParam(value = "stance", defaultValue = "neutral") String stance) {
    
    long startTime = System.currentTimeMillis();
    
    try {
        log.info("=== å¼€å§‹ä¸€é”®å®¡æŸ¥æµç¨‹ ===");
        log.info("æ–‡ä»¶: {}, ç«‹åœº: {}, cacheId: {}", 
                file.getOriginalFilename(), stance, cacheId);
        
        // ... éªŒè¯æ–‡ä»¶ ...
        
        // æ­¥éª¤2ï¼šè§£æåˆåŒï¼ˆä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼‰
        ContractParseService.ParseResultWithDocument parseResultWithDoc = null;
        
        // âœ… å°è¯•ä»ç¼“å­˜è·å–
        if (cacheId != null && !cacheId.isEmpty()) {
            try {
                parseResultWithDoc = parseResultCache.get(cacheId);
                if (parseResultWithDoc != null) {
                    long savedTime = estimateParseTime(file.getSize());
                    log.info("âœ“ ä½¿ç”¨ç¼“å­˜è§£æç»“æœï¼ŒèŠ‚çœçº¦ {}ms", savedTime);
                } else {
                    log.warn("ç¼“å­˜å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨: cacheId={}", cacheId);
                }
            } catch (Exception e) {
                log.warn("ç¼“å­˜è·å–å¤±è´¥: {}", e.getMessage());
            }
        }
        
        // âŒ ç¼“å­˜æœªå‘½ä¸­ï¼Œé‡æ–°è§£æï¼ˆå‘åå…¼å®¹ï¼‰
        if (parseResultWithDoc == null) {
            log.info("æ­¥éª¤1/6: æ­£åœ¨è§£æåˆåŒ...ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰");
            parseResultWithDoc = contractParseService.parseContractWithDocument(file, "generate");
            log.info("âœ“ åˆåŒè§£æå®Œæˆ");
        } else {
            log.info("æ­¥éª¤1/6: âœ“ ä½¿ç”¨ç¼“å­˜ï¼ˆè·³è¿‡è§£æï¼‰");
        }
        
        ParseResult parseResult = parseResultWithDoc.getParseResult();
        byte[] documentWithAnchorBytes = parseResultWithDoc.getDocumentBytes();
        
        // ... ç»§ç»­åç»­æµç¨‹ï¼ˆè§„åˆ™åŒ¹é…ã€AIå®¡æŸ¥ã€æ‰¹æ³¨æ’å…¥ï¼‰...
    }
}

/**
 * ä¼°ç®—è§£ææ—¶é—´ï¼ˆç”¨äºæ€§èƒ½æ—¥å¿—ï¼‰
 */
private long estimateParseTime(long fileSize) {
    // ç»éªŒå…¬å¼ï¼šfileSize(KB) / 50
    return fileSize / 1024 / 50 * 1000;  // è½¬ä¸ºæ¯«ç§’
}
```

---

### æ­¥éª¤4ï¼šå‰ç«¯ä¼ é€’cacheIdï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶**ï¼š`List.vue` çš„ `submit()` æ–¹æ³•

```typescript
const submit = async () => {
  // ... å‰é¢çš„ä»£ç  ...
  
  const formData = new FormData()
  formData.append('file', uploadedFileRef.value)
  formData.append('stance', stanceMap[selectedParty.value as 'A' | 'B'])
  
  // âœ… å¦‚æœæœ‰cacheIdï¼Œä¼ é€’ç»™åç«¯
  if (parseResultRef.value?.cacheId) {
    formData.append('cacheId', parseResultRef.value.cacheId)
    console.log('ä½¿ç”¨ç¼“å­˜ID:', parseResultRef.value.cacheId)
  }
  
  const res = await axios.post('/api/qwen/rule-review/one-click-review', formData, {
    timeout: 120000
  })
  
  // ... åç»­å¤„ç† ...
}
```

**æ”¹åŠ¨é‡**ï¼š**3è¡Œä»£ç **

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœé¢„ä¼°

### æ€§èƒ½æå‡

| æ–‡æ¡£å¤§å° | ä¼˜åŒ–å‰ | ä¼˜åŒ–åï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ | èŠ‚çœæ—¶é—´ | æå‡ |
|---------|-------|------------------|---------|------|
| 5é¡µ | 8.5ç§’ | 7.7ç§’ | 0.8ç§’ | 9% |
| 10é¡µ | 10.2ç§’ | 9.0ç§’ | 1.2ç§’ | 12% |
| 20é¡µ | 13.0ç§’ | 11.0ç§’ | 2.0ç§’ | 15% |
| 50é¡µ | 25.0ç§’ | 20.5ç§’ | 4.5ç§’ | 18% |

**ç”¨æˆ·ä½“éªŒ**ï¼š
- â±ï¸ å®¡æŸ¥ç­‰å¾…æ—¶é—´å‡å°‘10-18%
- ğŸ’¾ æœåŠ¡å™¨å†…å­˜å³°å€¼å‡å°‘50%
- âš¡ å¹¶å‘å¤„ç†èƒ½åŠ›æå‡30%

---

### ç¼“å­˜å‘½ä¸­ç‡é¢„ä¼°

**æ­£å¸¸ä½¿ç”¨åœºæ™¯**ï¼š
```
ä¸Šä¼ æ–‡ä»¶ â†’ è§£æï¼ˆç¼“å­˜5åˆ†é’Ÿï¼‰ â†’ ç«‹åœºé€‰æ‹©ï¼ˆ30ç§’ï¼‰ â†’ æäº¤å®¡æŸ¥ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
```

**é¢„æœŸå‘½ä¸­ç‡**ï¼š**95%+**

**ç¼“å­˜æœªå‘½ä¸­åœºæ™¯**ï¼š
- ç”¨æˆ·é€‰æ‹©ç«‹åœºè¶…è¿‡5åˆ†é’Ÿï¼ˆæå°‘ï¼‰
- ç¼“å­˜æœåŠ¡é‡å¯ï¼ˆå¶å‘ï¼‰

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹1ï¼šç¼“å­˜å‘½ä¸­

```bash
# 1. è§£æï¼ˆç”ŸæˆcacheIdï¼‰
curl -X POST http://localhost:8080/api/parse \
  -F "file=@test.docx" \
  -F "anchors=generate" \
  -F "returnMode=json" \
  -o parse_result.json

# æå–cacheId
CACHE_ID=$(cat parse_result.json | jq -r '.cacheId')
echo "ç¼“å­˜ID: $CACHE_ID"

# 2. ä¸€é”®å®¡æŸ¥ï¼ˆä½¿ç”¨cacheIdï¼‰
curl -X POST http://localhost:8080/api/qwen/rule-review/one-click-review \
  -F "file=@test.docx" \
  -F "stance=Aæ–¹" \
  -F "cacheId=$CACHE_ID"

# æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
# âœ“ ä½¿ç”¨ç¼“å­˜è§£æç»“æœï¼ŒèŠ‚çœçº¦ 1200ms
```

---

### æµ‹è¯•ç”¨ä¾‹2ï¼šç¼“å­˜æœªå‘½ä¸­ï¼ˆå‘åå…¼å®¹ï¼‰

```bash
# ä¸ä¼ cacheId
curl -X POST http://localhost:8080/api/qwen/rule-review/one-click-review \
  -F "file=@test.docx" \
  -F "stance=Aæ–¹"

# æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
# æ­¥éª¤1/6: æ­£åœ¨è§£æåˆåŒ...ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
# âœ“ åˆåŒè§£æå®Œæˆ
```

---

### æµ‹è¯•ç”¨ä¾‹3ï¼šç¼“å­˜è¿‡æœŸ

```bash
# 1. è§£æ
CACHE_ID=$(curl ... | jq -r '.cacheId')

# 2. ç­‰å¾…6åˆ†é’Ÿï¼ˆè¶…è¿‡5åˆ†é’Ÿç¼“å­˜è¿‡æœŸæ—¶é—´ï¼‰
sleep 360

# 3. ä¸€é”®å®¡æŸ¥
curl ... -F "cacheId=$CACHE_ID"

# æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
# ç¼“å­˜å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨: cacheId=xxx
# æ­¥éª¤1/6: æ­£åœ¨è§£æåˆåŒ...ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
```

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### Phase 1ï¼šä»£ç ä¿®æ”¹ï¼ˆ2å°æ—¶ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | æ”¹åŠ¨ |
|-----|------|------|
| æ·»åŠ cacheIdå­—æ®µ | ParseResult.java | +2è¡Œ |
| ä¿®æ”¹/api/parse | ContractController.java | +5è¡Œ |
| ä¿®æ”¹/one-click-review | QwenRuleReviewController.java | +20è¡Œ |
| å‰ç«¯ä¼ é€’cacheId | List.vue | +3è¡Œ |

**æ€»ä»£ç é‡**ï¼š30è¡Œ

---

### Phase 2ï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å°æ—¶ï¼‰

- [ ] ç¼“å­˜å‘½ä¸­æµ‹è¯•
- [ ] ç¼“å­˜æœªå‘½ä¸­æµ‹è¯•
- [ ] ç¼“å­˜è¿‡æœŸæµ‹è¯•
- [ ] å‘åå…¼å®¹æµ‹è¯•ï¼ˆä¸ä¼ cacheIdï¼‰
- [ ] æ€§èƒ½å¯¹æ¯”æµ‹è¯•

---

### Phase 3ï¼šä¸Šçº¿éƒ¨ç½²ï¼ˆ30åˆ†é’Ÿï¼‰

- [ ] ä»£ç å®¡æŸ¥
- [ ] åˆå¹¶ä¸»åˆ†æ”¯
- [ ] ç°åº¦å‘å¸ƒï¼ˆ50%æµé‡ï¼‰
- [ ] ç›‘æ§æ€§èƒ½æŒ‡æ ‡
- [ ] å…¨é‡å‘å¸ƒ

**æ€»å·¥æ—¶**ï¼š3.5å°æ—¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç¼“å­˜è¿‡æœŸæ—¶é—´

**å½“å‰é…ç½®**ï¼š5åˆ†é’Ÿ

**å»ºè®®**ï¼š
- ä¿æŒ5åˆ†é’Ÿï¼ˆé€‚åˆå¤§éƒ¨åˆ†åœºæ™¯ï¼‰
- ç”¨æˆ·ä»ä¸Šä¼ åˆ°æäº¤å®¡æŸ¥é€šå¸¸åœ¨1-2åˆ†é’Ÿå†…

### 2. ç¼“å­˜å­˜å‚¨

**å½“å‰å®ç°**ï¼š`ParseResultCache` ä½¿ç”¨å†…å­˜ç¼“å­˜

**ä¼˜ç‚¹**ï¼š
- é€Ÿåº¦å¿«
- å®ç°ç®€å•

**ç¼ºç‚¹**ï¼š
- åº”ç”¨é‡å¯åä¸¢å¤±
- æ— æ³•è·¨å®ä¾‹å…±äº«

**æ”¹è¿›æ–¹å‘**ï¼ˆæœªæ¥ï¼‰ï¼š
- ä½¿ç”¨Rediså­˜å‚¨ç¼“å­˜
- æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²

### 3. å®‰å…¨æ€§

**é£é™©**ï¼šæ¶æ„ç”¨æˆ·å¯èƒ½ä¼ªé€ cacheId

**é˜²æŠ¤**ï¼š
```java
if (parseResultWithDoc != null) {
    // éªŒè¯ç¼“å­˜çš„æ–‡ä»¶åä¸å½“å‰ä¸Šä¼ æ–‡ä»¶æ˜¯å¦åŒ¹é…
    String cachedFilename = parseResultWithDoc.getParseResult().getFilename();
    if (!cachedFilename.equals(file.getOriginalFilename())) {
        log.warn("ç¼“å­˜æ–‡ä»¶åä¸åŒ¹é…ï¼Œæ‹’ç»ä½¿ç”¨ç¼“å­˜");
        parseResultWithDoc = null;  // å¼ºåˆ¶é‡æ–°è§£æ
    }
}
```

---

## ğŸ¯ æ€»ç»“

### âœ… é—®é¢˜ç¡®è®¤

**ç¡®å®å­˜åœ¨é‡å¤è§£æ**ï¼š
1. ç¬¬ä¸€æ¬¡ï¼š`/api/parse` è§£æï¼ˆè·å–ç”²ä¹™æ–¹ï¼‰
2. ç¬¬äºŒæ¬¡ï¼š`/api/one-click-review` å†æ¬¡è§£æï¼ˆå®Œå…¨ç›¸åŒçš„æ“ä½œï¼‰

**æ€§èƒ½æµªè´¹**ï¼š
- æ—¶é—´ï¼š10-18%ï¼ˆ0.8-4.5ç§’ï¼‰
- å†…å­˜ï¼šå³°å€¼ç¿»å€
- CPUï¼šé‡å¤è®¡ç®—

---

### ğŸš€ æ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆCï¼šæ··åˆæ–¹æ¡ˆï¼ˆç¼“å­˜+é™çº§ï¼‰**

**æ ¸å¿ƒæ€è·¯**ï¼š
```
/api/parse â†’ è§£æå¹¶ç¼“å­˜ â†’ è¿”å›JSONï¼ˆå«cacheIdï¼‰
                â†“
            ç¼“å­˜5åˆ†é’Ÿ
                â†“
/one-click-review â†’ æ£€æŸ¥cacheId â†’ æœ‰ï¼šä½¿ç”¨ç¼“å­˜ï¼ˆ0ç§’ï¼‰
                                  æ— ï¼šé‡æ–°è§£æï¼ˆå…¼å®¹ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ¶ˆé™¤é‡å¤è§£æï¼ˆæ€§èƒ½æå‡10-18%ï¼‰
- âœ… å‘åå…¼å®¹ï¼ˆå¯é€‰å‚æ•°ï¼‰
- âœ… å‰ç«¯æ”¹åŠ¨æœ€å°ï¼ˆ0-3è¡Œï¼‰
- âœ… å®æ–½ç®€å•ï¼ˆ3.5å°æ—¶ï¼‰
- âœ… é£é™©ä½

---

### ğŸ“Š ROIåˆ†æ

| æŠ•å…¥ | äº§å‡º | ROI |
|-----|------|-----|
| 3.5å°æ—¶å¼€å‘ | èŠ‚çœ10-18%å®¡æŸ¥æ—¶é—´ | **é«˜** |
| 30è¡Œä»£ç  | å‡å°‘50%å†…å­˜å³°å€¼ | **é«˜** |
| ä½é£é™© | 95%+ç¼“å­˜å‘½ä¸­ç‡ | **é«˜** |

**ç»“è®º**ï¼š**å¼ºçƒˆæ¨èå®æ–½ï¼**

---

### ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

#### ç«‹å³å¯åš

1. **ç¡®è®¤ParseResultCacheå®ç°**
```bash
# æŸ¥çœ‹ç¼“å­˜ç±»
Contract_review/src/main/java/.../util/ParseResultCache.java
```

2. **è¯„ä¼°æ”¹åŠ¨èŒƒå›´**
- åç«¯ï¼š30è¡Œ
- å‰ç«¯ï¼š0-3è¡Œï¼ˆå¯é€‰ï¼‰

#### æœ¬å‘¨å¯å®Œæˆ

1. **å‘¨ä¸€**ï¼šä»£ç å®ç°ï¼ˆ2å°æ—¶ï¼‰
2. **å‘¨äºŒ**ï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å°æ—¶ï¼‰
3. **å‘¨ä¸‰**ï¼šä¸Šçº¿éƒ¨ç½²ï¼ˆ30åˆ†é’Ÿï¼‰

---

**åˆ†æçŠ¶æ€**ï¼šâœ… å®Œæˆ  
**é—®é¢˜ç¡®è®¤**ï¼šæ˜¯ï¼Œå­˜åœ¨é‡å¤è§£æ  
**æ€§èƒ½æŸå¤±**ï¼š10-18%  
**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆCï¼ˆæ··åˆç¼“å­˜æ–¹æ¡ˆï¼‰  
**å®æ–½éš¾åº¦**ï¼šç®€å•ï¼ˆ3.5å°æ—¶ï¼‰

---

**å½’æ¡£ä½ç½®**ï¼š`æ–‡æ¡£ä¸­å¿ƒ/03_è¯Šæ–­å’Œåˆ†æ/13_ä¸€é”®å®¡æŸ¥é‡å¤è§£æé—®é¢˜åˆ†æ.md`

