# 🔧 快速故障排除指南

**针对**: 第 23 个条款（c23）无法定位

---

## 🎯 问题诊断

### 症状

```
WARN  ? 未找到anchorId对应的书签：anchorId=anc-c23-e043
INFO  锚点查找失败，回退到文本匹配
```

---

## ✅ 诊断步骤（按顺序执行）

### 第 1 步: 验证使用的文档

**问题**: 是否使用了 Parse 返回的带锚点文档？

**检查方法**:
```bash
# 打开最后用来调用 /import-result-xml 的文档
# 用 Word 打开该文件
# 菜单: Insert → Links → Bookmarks
# 查看是否有 anc-c1-*, anc-c2-*, ..., anc-c23-* 等书签

# 如果没有看到任何 anc-* 开头的书签，说明问题在这里！
```

**预期结果**:
- ✅ 看到 23 个书签（anc-c1 到 anc-c23）
- ❌ 只看到 _GoBack （Word 默认书签）

**如果只看到 _GoBack，问题找到了！** 👇

---

### 第 2 步: 检查 Parse 阶段是否正确

**问题**: Parse 时是否正确生成了锚点？

**检查方法**:
```bash
# 调用 /generate-prompt 时检查日志
curl -X POST "http://localhost:8080/chatgpt/generate-prompt" \
  -F "file=@contract.docx" \
  -F "anchors=generate" \
  2>&1 | grep -i "锚点\|anchor"

# 预期看到:
# ✓ 发现条款 [clauseId=c1]
# ✓ 发现条款 [clauseId=c2]
# ...
# ✓ 发现条款 [clauseId=c23]
# 生成锚点: anchorId=anc-c23-xxxx
```

**检查响应JSON**:
```bash
curl -X POST "http://localhost:8080/chatgpt/generate-prompt" \
  -F "file=@contract.docx" \
  -F "anchors=generate" \
  | jq '.parseResult.clauses[] | {id, anchorId}' | tail -5

# 预期看到 c23 有对应的 anchorId
```

**如果看不到 c23，问题可能在这里！** 👇

---

### 第 3 步: 检查文档下载和解码

**问题**: 是否正确下载和解码了带锚点的文档？

**方案 A - 使用 Base64 (从 /generate-prompt 返回)**:
```bash
# 1. 获取响应
curl -X POST "http://localhost:8080/chatgpt/generate-prompt" \
  -F "file=@contract.docx" \
  -F "anchors=generate" \
  > result.json

# 2. 检查是否有 documentWithAnchorsBase64
jq '.documentWithAnchorsBase64' result.json | wc -c
# 应该输出一个很大的数字（> 50000）

# 3. 解码并保存
jq -r '.documentWithAnchorsBase64' result.json | base64 -d > contract_with_anchors_decoded.docx

# 4. 验证文件大小
ls -lh contract_with_anchors_decoded.docx
# 应该与原文件大小相近
```

**方案 B - 使用新端点 (推荐)**:
```bash
# 直接下载带锚点的文档
curl -X POST "http://localhost:8080/chatgpt/get-document-with-anchors" \
  -F "file=@contract.docx" \
  -o contract_with_anchors_direct.docx

# 验证文件
ls -lh contract_with_anchors_direct.docx
# 应该是有效的 .docx 文件
```

**如果解码或下载失败，问题可能在这里！** 👇

---

## 🛠️ 常见问题和解决方案

### 问题 1: 文档中没有锚点书签

**症状**:
```
文档中只有 1 个书签（_GoBack）
没有看到 anc-c1, anc-c2, ..., anc-c23
```

**原因**:
- ❌ 使用的是原始文档，不是 Parse 返回的文档
- ❌ Parse 时没有设置 `anchors=generate` 参数
- ❌ Base64 解码出错

**解决方案**:
```bash
# 重新执行正确的工作流程

# Step 1: 使用新端点直接获取
curl -X POST "http://localhost:8080/chatgpt/get-document-with-anchors" \
  -F "file=@contract.docx" \
  -o contract_with_anchors.docx

# Step 2: 验证文档有锚点（Word 中打开查看书签）

# Step 3: 使用此文档进行批注
curl -X POST "http://localhost:8080/chatgpt/import-result-xml" \
  -F "file=@contract_with_anchors.docx" \
  -F "chatgptResponse=@review.json" \
  -o final_annotated.docx
```

---

### 问题 2: Parse 时没有找到 c23 条款

**症状**:
```
parseResult.clauses 中只有 22 个条款，没有 c23
```

**原因**:
- ❌ 原始合同中第 23 个条款无法被识别（不符合条款标题规则）
- ❌ 或文档被截断

**检查方法**:
```bash
# 查看返回的条款总数
curl -X POST "http://localhost:8080/chatgpt/generate-prompt" \
  -F "file=@contract.docx" \
  | jq '.clauseCount'

# 如果返回 22 而不是 23，那就是这个问题
```

**解决方案**:
- 检查原始合同中第 23 个条款的格式
- 查看是否符合条款标题规则（"第XXX条" 或数字开头等）
- 可能需要修改原始合同的格式

---

### 问题 3: Parse 返回了 c23，但没有锚点

**症状**:
```
parseResult.clauses[22].id = "c23"
parseResult.clauses[22].anchorId = null
```

**原因**:
- ❌ 没有使用 `anchors=generate` 参数

**解决方案**:
```bash
# 确保使用 anchors=generate
curl -X POST "http://localhost:8080/chatgpt/generate-prompt" \
  -F "file=@contract.docx" \
  -F "anchors=generate"  # ← 这行很关键！
```

---

## ✅ 完整的正确工作流程

### 推荐流程（最简单）

```bash
# 1️⃣ 获取带锚点的文档
curl -X POST "http://localhost:8080/chatgpt/get-document-with-anchors" \
  -F "file=@contract.docx" \
  -o contract_with_anchors.docx

# 2️⃣ 验证文档有锚点
# 用 Word 打开 contract_with_anchors.docx
# Insert → Links → Bookmarks
# 应该看到 anc-c1 到 anc-c23 等书签

# 3️⃣ 生成 Prompt（获取条款信息）
curl -X POST "http://localhost:8080/chatgpt/generate-prompt" \
  -F "file=@contract.docx" \
  -F "anchors=generate" \
  | jq '.chatgptPrompt' > prompt.txt

# 4️⃣ 在 ChatGPT 中审查（用户手动操作）

# 5️⃣ 导入审查结果（使用带锚点的文档）
curl -X POST "http://localhost:8080/chatgpt/import-result-xml" \
  -F "file=@contract_with_anchors.docx" \
  -F "chatgptResponse=@review.json" \
  -o final_annotated.docx

# 6️⃣ 完成！在 Word 中查看带批注的文档
```

---

## 🎯 快速检查清单

- [ ] 使用的文档是否是 Parse 返回的带锚点文档？
- [ ] 文档中是否有 23 个锚点书签（anc-c1 到 anc-c23）？
- [ ] Parse 时是否使用了 `anchors=generate` 参数？
- [ ] c23 条款在 parseResult 中是否存在？
- [ ] c23 的 anchorId 是否不为 null？

---

## 📊 症状到原因的映射

| 症状 | 原因 | 解决方案 |
|------|------|---------|
| 文档中没有任何锚点书签 | 使用了原始文档 | 使用 /get-document-with-anchors |
| parseResult 中没有 c23 | 合同格式问题或文档截断 | 检查原始合同中第 23 条 |
| c23 的 anchorId 为 null | 没有设置 anchors=generate | 添加 -F "anchors=generate" |
| 批注定位到错误位置 | targetText 与实际文本不匹配 | 从原文精确复制 targetText |

---

## 💡 快速诊断命令

**一键诊断**:
```bash
echo "=== 检查文档中的锚点 ===" && \
echo "进行中... (需要在 Word 中手动操作)" && \
echo "菜单: Insert → Links → Bookmarks" && \
echo "" && \
echo "=== 检查 ParseResult ===" && \
curl -s -X POST "http://localhost:8080/chatgpt/generate-prompt" \
  -F "file=@contract.docx" \
  -F "anchors=generate" \
  | jq '{
    clauseCount: .clauseCount,
    lastClause: .parseResult.clauses[-1],
    hasDocumentWithAnchors: (.documentWithAnchorsBase64 != null)
  }' && \
echo "" && \
echo "=== 下载文档并检查 ===" && \
curl -s -X POST "http://localhost:8080/chatgpt/get-document-with-anchors" \
  -F "file=@contract.docx" \
  -o test_doc.docx && \
ls -lh test_doc.docx
```

---

**建议**: 按照快速检查清单逐一排查，找到问题所在！
