# ⚡ 快速参考 - 锚点问题诊断和修复

**更新**: 2025-10-21
**状态**: ✅ 诊断工具已部署

---

## 🚀 5 分钟快速诊断

```bash
# 1. 编译 (2分钟)
cd D:\工作\合同审查系统开发\spring boot\Contract_review
mvn clean package -DskipTests

# 2. 启动 (1分钟)
java -jar target/Contract_review-0.0.1-SNAPSHOT.jar

# 3. 诊断 (1分钟)
curl -X POST "http://localhost:8080/chatgpt/generate-prompt" \
  -F "file=@test.docx" \
  -F "anchors=generate" > response.json

# 4. 查看结果 (1分钟)
# 在服务输出中查找这行:
# 【文档保存】即将保存文档: 总段落数=X, 总书签数=Y
```

**关键指标**:
- 如果 `Y > 0` → 问题可能已解决 ✅
- 如果 `Y = 0` → 需要修复方案 ❌

---

## 📊 诊断日志地图

```
【修复版本】条款提取完成: 共找到 X 个条款
    ↓
【锚点插入】开始插入锚点: 文档段落数=X, 条款数=Y
    ↓
【锚点插入】为条款添加书签: clauseId=c1, anchorId=anc-c1-xxxx, paraIndex=5
    ↓
【锚点插入】完成: 成功插入=Y个, 跳过=0  ← 检查这里
    ↓
【文档保存】即将保存文档: 总段落数=X, 总书签数=Z  ← ⚠️ 最关键
    ↓
【文档保存】文档已保存到字节数组: 文档大小=XXXX 字节
```

---

## 🔧 快速修复方案

### 方案 1: POI 升级 (最简单)
```bash
# 编辑 pom.xml，找到:
# <version>5.2.0</version>  (或其他版本)

# 改为:
# <version>5.3.0</version>

# 重新编译
mvn clean package -DskipTests
```

### 方案 2: 隐藏文本标记 (最可靠)
- 需要修改代码以使用隐藏文本代替书签
- 预计 30 分钟修复时间

### 方案 3: XML 直接操作 (最强大)
- 完全绕过 POI
- 预计 2 小时修复时间

---

## ❓ 常见问题

### Q1: 诊断后 `总书签数=0` 怎么办?
**A**: 这表示 POI 序列化有问题，尝试方案 1（升级 POI）

### Q2: 如何查看完整日志?
**A**:
- 终端重定向: `java -jar ... > app.log 2>&1`
- 或在 IDE 中运行查看 Console 输出

### Q3: 诊断中找不到 `【文档保存】` 日志怎么办?
**A**:
- 检查 `anchors=generate` 参数是否正确传递
- 查看是否有异常信息

### Q4: 升级 POI 后还是不行?
**A**:
- 使用方案 2 或方案 3
- 向我报告诊断结果，我会实施更复杂的修复

---

## 📋 诊断检查清单

- [ ] 编译成功（BUILD SUCCESS）
- [ ] 服务启动成功（看到 Tomcat 启动信息）
- [ ] 文件上传成功（response.json 有数据）
- [ ] 找到 `【修复版本】条款提取完成` 日志
- [ ] 找到 `【锚点插入】完成` 日志，记下成功/跳过数字
- [ ] **找到 `【文档保存】即将保存文档` 日志，记下 `总书签数` 值** ⚠️
- [ ] 根据 `总书签数` 决定是否需要修复

---

## 📞 需要帮助?

如果卡在某一步，请提供：
1. 正确的命令和参数
2. 收到的错误信息
3. 完整的相关日志

---

**这份文档的内容已整合到完整的诊断指南中！**

详见:
- `DIAGNOSTIC_EXECUTION_GUIDE.md` - 完整指南
- `DIAGNOSTIC_STEPS.md` - 详细步骤
- `POTENTIAL_SOLUTIONS.md` - 解决方案详解
