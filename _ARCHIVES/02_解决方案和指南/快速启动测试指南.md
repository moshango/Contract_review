# 🚀 快速启动和完整测试指南

**编译状态**: ✅ BUILD SUCCESS
**准备时间**: 2025-10-21
**目标**: 5 分钟内启动服务并完成完整工作流测试

---

## ⚡ 快速启动（3 步）

### 第 1 步: 启动服务（15 秒）

打开 PowerShell，执行：

```powershell
cd D:\工作\合同审查系统开发\spring boot\Contract_review
java -jar target/Contract_review-0.0.1-SNAPSHOT.jar
```

**等待看到这个消息**（通常 5-10 秒）：
```
Started Contract_review in X.XXX seconds
Tomcat started on port(s): 8080 (http)
```

**此窗口保持打开** - 这是日志观察窗口

### 第 2 步: 执行完整测试（2 分钟）

打开**新的 PowerShell 窗口**，执行：

```powershell
cd D:\工作\合同审查系统开发\spring boot\Contract_review
.\run_full_workflow_test.ps1
```

**脚本会自动**：
- ✅ 上传测试文件
- ✅ 获取 parseResultId
- ✅ 生成 5 个测试问题
- ✅ 导入审查结果
- ✅ 生成批注文档
- ✅ 验证输出文件

### 第 3 步: 检查结果（1 分钟）

脚本完成后，会在当前目录生成 `annotated_output.docx` 文件。

打开文件查看批注：

```powershell
Start-Process "annotated_output.docx"
```

---

## 🔍 验证检查清单

### Parse 阶段验证

在**第一个 PowerShell 窗口**（服务窗口）中查找：

```
✅ 应该看到这些日志：
INFO  为ChatGPT生成提示: filename=测试合同_综合测试版.docx, contractType=通用合同, anchors=generate
INFO  开始解析合同并生成带锚点文档: filename=测试合同_综合测试版.docx, anchorMode=generate
INFO  【工作流】开始插入锚点到文档中
INFO  【锚点插入】开始插入锚点: 文档段落数=60, 条款数=8
INFO  【锚点插入】完成: 成功插入=8个, 跳过=0
INFO  【文档保存】即将保存文档: 总段落数=60, 总书签数=8
INFO  【文档保存】文档已保存到字节数组: 文档大小=XXXXX 字节
```

**关键指标**:
- 📌 `【锚点插入】完成: 成功插入=8个` - 表示 8 个锚点被添加到文档
- 📌 `【文档保存】总书签数=8` - 表示所有 8 个锚点被成功序列化到文件

### Annotate 阶段验证

继续在服务窗口中查找：

```
✅ 应该看到这些日志：
INFO  导入ChatGPT审查结果（使用XML方式）: filename=..., strategy=preferAnchor
INFO  开始处理 XML 格式的合同批注: 问题数=5
INFO  开始查找目标段落：clauseId=c1, anchorId=anc-c1-304286e3
INFO  ✓ 通过锚点找到目标段落: clauseId=c1
INFO  ✓ 精确批注插入完成: commentId=...
```

**关键指标**:
- 📌 `✓ 通过锚点找到目标段落` - 表示锚点定位成功！
- 📌 问题数 = 5 - 表示所有 5 个测试问题都被处理

### Word 文档验证

打开 `annotated_output.docx` 后检查：

```
✅ 应该看到：
1. 5 个批注气泡（通常是红色标记）
2. 每个批注包含：
   - 问题分类（如"合同目的"、"付款条款"）
   - 严重程度（HIGH/MEDIUM）
   - 具体问题描述
   - 修改建议

✅ 批注应该定位在：
- 第 1 个批注：合同目的那一段（第一条）
- 第 2 个批注：前端展示界面描述
- 第 3 个批注：首付款条款
- 第 4 个批注：知识产权条款
- 第 5 个批注：违约责任条款
```

---

## 📊 完整工作流示意图

```
┌─────────────────────┐
│  启动服务           │
│  java -jar ...jar   │
└──────────┬──────────┘
           │ (15秒)
           ▼
┌─────────────────────┐
│  脚本自动执行       │
│  .\run_full_...ps1  │
└──────────┬──────────┘
           │
    ┌──────┴──────┬──────────┬──────────┐
    │             │          │          │
    ▼             ▼          ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│ Parse  │ │Generate│ │Annotate│ │ Verify │
│ 阶段   │ │Test    │ │ 阶段   │ │ 输出   │
└────────┘ └────────┘ └────────┘ └────────┘
   │          │          │          │
   │ 生成     │ 生成     │ 导入并  │ 检查
   │ 锚点和   │ 5 个    │ 生成    │ 批注
   │ parseId  │ 问题    │ 批注    │ 文档
   │          │         │ 文档    │
   └──────────┴─────────┴─────────┘
              │
              ▼
         ✅ 生成
         annotated_output.docx
```

---

## 🎯 预期输出

### 第二个 PowerShell 窗口（脚本执行）应该看到：

```
==========================================
开始完整工作流自测试
==========================================

✅ 测试文件存在
📁 文件: D:\工作\合同审查系统开发\spring boot\Contract_review\测试合同_综合测试版.docx

========== 步骤 1: Parse 阶段 ==========
调用 /generate-prompt 端点...

📋 Parse 响应:
{
  "success": true,
  "filename": "测试合同_综合测试版.docx",
  "clauseCount": 8,
  "contractType": "通用合同",
  "anchorsEnabled": true,
  "parseResultId": "xxx-xxx-xxx",
  ...
}

✅ Parse 成功
   - parseResultId: xxx-xxx-xxx
   - 条款数: 8

========== 步骤 2: 生成测试审查结果 ==========
✅ 测试审查结果生成完成
   - 问题数: 5
   - 高风险: 3
   - 中风险: 2

========== 步骤 3: Annotate 阶段 ==========
调用 /import-result-xml 端点...

✅ Annotate 成功
   - 输出文件: annotated_output.docx
   - 文件大小: XXX KB

========== 步骤 4: 验证结果 ==========
检查输出文件...

✅ 批注文档已生成
   文件位置: D:\...\annotated_output.docx

📋 工作流完成！

下一步建议:
1. 打开 annotated_output.docx 文件检查批注
2. 验证批注位置是否正确
3. 查看后台日志中的关键信息

==========================================
✅ 完整工作流自测试结束
==========================================
```

---

## 🐛 故障排查

### 如果 Parse 失败

```powershell
# 检查文件是否存在
Test-Path "D:\工作\合同审查系统开发\spring boot\Contract_review\测试合同_综合测试版.docx"

# 检查服务是否运行
Invoke-RestMethod "http://localhost:8080/chatgpt/status" -Method Get 2>/dev/null || "❌ 服务未运行"
```

### 如果 Annotate 失败

检查后台日志中是否有异常。常见原因：
1. parseResultId 过期（在 Parse 后 4 小时内应该有效）
2. 测试 JSON 格式错误
3. 网络连接问题

### 如果 Word 文档打不开

```powershell
# 检查文件大小（应该 > 50 KB）
(Get-Item "annotated_output.docx").Length

# 用 Word 尝试修复
# 打开 Word → 文件 → 打开 → annotated_output.docx → 点击"修复"
```

---

## 📝 关键文件说明

| 文件 | 用途 |
|------|------|
| `run_full_workflow_test.ps1` | 完整自动化测试脚本 |
| `SELF_TEST_GUIDE.md` | 详细的测试指南和手动步骤 |
| `DIAGNOSTIC_STEPS.md` | 诊断日志解读指南 |
| `ROOT_CAUSE_ANALYSIS.md` | 问题根源分析 |
| `POTENTIAL_SOLUTIONS.md` | 可能的修复方案 |

---

## ✅ 成功标准

完整工作流测试成功的标志：

```
✅ Parse 阶段：
   - 获得 parseResultId
   - 条款数 = 8
   - 日志显示 【锚点插入】完成: 成功插入=8个
   - 日志显示 【文档保存】总书签数=8

✅ Annotate 阶段：
   - 生成 annotated_output.docx 文件
   - 日志显示问题数 = 5
   - 日志显示 ✓ 通过锚点找到目标段落（至少一次）

✅ Word 文档：
   - 能正常打开
   - 包含 5 个批注气泡
   - 批注内容完整准确
   - 批注位置与问题相关

✅ 全流程：无异常错误
```

---

## 🎉 完成！

现在您已经有了一个完整的自测试环境。可以用这个脚本来：

1. **验证新修改是否正常工作**
2. **调试批注定位逻辑**
3. **测试不同的文件和审查规则**
4. **收集诊断日志**

**祝测试顺利！** 🚀

