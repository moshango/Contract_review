# 合同审查系统 - 恢复到8080端口指南

## 📋 当前状态

- ✅ **诊断代码已成功编译并部署**
- ✅ **端到端测试已验证完成**
- ⚠️ **应用当前运行在端口 9999**（由于MINGW64环境限制）
- 🔒 **zombie进程占用了8080和9999端口**

## 🔧 恢复步骤

### 方案1: 使用批处理脚本（推荐）

**在项目目录中双击运行：**
```
恢复到8080.bat
```

该脚本会自动：
1. 关闭所有Java进程
2. 验证并释放端口
3. 启动应用到8080

---

### 方案2: 手动恢复（如果脚本失败）

#### 步骤1: 关闭所有Java进程

打开 **命令提示符 (CMD)** 或 **PowerShell**，执行：

```cmd
taskkill /F /IM java.exe
```

#### 步骤2: 验证端口已释放

```cmd
netstat -ano | findstr "8080"
netstat -ano | findstr "9999"
```

如果显示空结果，说明端口已释放。

#### 步骤3: 启动应用到8080

在项目目录中执行：

```cmd
# 方案A: 使用编译好的app.jar（包含诊断代码）
java -jar target/app.jar

# 或方案B: 重新编译后启动
mvn clean package -DskipTests
java -jar target/Contract_review-0.0.1-SNAPSHOT.jar
```

#### 步骤4: 验证启动成功

打开新的 **命令提示符** 或 **PowerShell**，执行：

```cmd
# 验证端口
netstat -ano | findstr "8080"

# 或测试服务
curl http://localhost:8080/chatgpt/generate-prompt -H "GET"
```

---

## ✅ 验证应用就绪

### 测试Parse端点（步骤1）

```bash
curl -X POST http://localhost:8080/chatgpt/generate-prompt \
  -F "file=@测试合同_综合测试版.docx"
```

**预期响应：**
- HTTP 200
- 返回parseResultId和23个条款
- JSON格式正常

### 测试Annotate端点（步骤2）

使用从Parse返回的parseResultId：

```bash
curl -X POST "http://localhost:8080/chatgpt/import-result-xml?parseResultId=<从Parse获得的ID>" \
  --data-urlencode chatgptResponse@review.json \
  -o annotated.docx
```

**预期结果：**
- HTTP 200
- 返回35-40KB的DOCX文件
- 包含comments.xml和批注内容

---

## 🎯 确认工作流完成

成功启动后，您应该看到：

```
2025-10-21 17:41:16 [main] INFO  c.e.C.ContractReviewApplication - Started ContractReviewApplication in X.XXX seconds
```

以及可用的端点：
- `POST /chatgpt/generate-prompt` - 解析合同并生成锚点
- `POST /chatgpt/import-result-xml` - 批注文档

---

## 🔍 故障排除

### 问题1: "Address already in use"（端口被占用）

**解决方案：**
```cmd
# 查找占用8080的进程
netstat -ano | findstr "8080"

# 强制关闭该进程（替换<PID>为实际的进程ID）
taskkill /PID <PID> /F

# 再次启动应用
java -jar target/app.jar
```

### 问题2: "Cannot find JAR file"（找不到JAR）

**解决方案：**
```cmd
# 重新编译
mvn clean package -DskipTests

# 等待编译完成后启动
java -jar target/Contract_review-0.0.1-SNAPSHOT.jar
```

### 问题3: 应用启动失败

查看完整日志：
```cmd
# Windows
type logs\spring.log

# 或重新启动并查看控制台输出
java -jar target/app.jar
```

---

## 📊 关键成就总结

✅ **架构验证**
- Parse → Cache → Annotate 完整工作流已验证
- 锚点精确定位机制已确认可用
- 批注插入功能已成功测试

✅ **代码质量**
- 添加了完整的诊断日志
- 支持EXACT/CONTAINS/REGEX三种匹配模式
- 支持preferAnchor/anchorOnly/textFallback策略

✅ **生产就绪**
- 已生成包含诊断代码的可执行JAR
- 配置文件已恢复到标准端口8080
- 应用可立即部署使用

---

## 📞 需要帮助？

如果遇到其他问题，请：

1. 检查项目根目录的日志文件
2. 确认Java版本：`java -version`
3. 确认Maven版本：`mvn -version`
4. 查看完整构建日志：`mvn clean package -DskipTests -X`

