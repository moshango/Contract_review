# Prompt提示词 - targetText关键问题处优先级修改说明

## 📋 修改概述

**修改日期**: 2025-10-22（更新）
**修改主题**: 调整 targetText 优先级规则 - 从关键名词改为关键问题处
**核心变化**: 优先选择问题所在处的具体内容（如数字、时间、条件），而非抽象概念
**影响范围**: 3个模板 (通用、技术服务、采购)
**修改文件**: `src/main/resources/review-templates/default-templates.json`

---

## 🎯 核心修改理念

### ❌ 旧思路（关键名词）
```
问题: "交付期限在30天内，太短了"

旧的targetText: "交付期限"  ← 抽象概念
缺点:
  - 太宽泛，容易匹配到多个位置
  - "交付期限"可能出现多次
  - 不精确指向具体问题
```

### ✅ 新思路（关键问题处）
```
问题: "交付期限在30天内，太短了"

新的targetText: "30天"  ← 具体问题所在处
优点:
  - 精确指向问题源头
  - "30天"通常只出现一次
  - 直观体现具体问题
```

---

## 📊 targetText优先级（修改后）

### 优先级1️⃣：关键问题处（推荐）⭐⭐⭐⭐⭐

**字数**: 1-10字
**特点**: 精确指向具体问题所在处
**关键特征**: 问题的具体体现形式

**示例（按问题类型）**：

#### 📌 时间问题
```
完整句: "甲方应在损害事实发生后30天内承担赔偿责任"
问题: 时限过短
targetText: "30天"  ✅ 优先选择
targetText: "30天内"  ✅ 也可以
targetText: "30天内承担赔偿责任"  ❌ 过长，非问题所在处
```

#### 📌 数值问题
```
完整句: "赔偿金额不超过年度费用的2倍"
问题: 赔偿上限过低
targetText: "2倍"  ✅ 优先选择
targetText: "年度费用的2倍"  ✅ 也可以
targetText: "赔偿金额不超过"  ❌ 不是问题所在处
```

#### 📌 缺失问题
```
完整句: "乙方对知识产权使用无限制"
问题: 使用权限不清楚
targetText: "无限制"  ✅ 优先选择
targetText: "知识产权使用无限制"  ✅ 也可以
targetText: "知识产权"  ❌ 太宽泛
```

#### 📌 条件问题
```
完整句: "交付地点为甲方指定地址"
问题: 交付地点不明确
targetText: "甲方指定地址"  ✅ 优先选择
targetText: "甲方指定"  ✅ 也可以
targetText: "交付地点"  ❌ 太宽泛
```

#### 📌 期限问题
```
完整句: "保密期限为本协议终止后5年"
问题: 保密期限过长
targetText: "5年"  ✅ 优先选择
targetText: "本协议终止后5年"  ✅ 也可以
targetText: "保密期限"  ❌ 太宽泛
```

#### 📌 标准问题
```
完整句: "商品质量需符合ISO9001标准"
问题: 质量指标不明确
targetText: "ISO9001"  ✅ 优先选择
targetText: "符合ISO9001标准"  ✅ 也可以
targetText: "质量"  ❌ 太宽泛
```

**matchPattern**: 通常 `EXACT` 或 `CONTAINS`

**优势**：
- ✅ 精确指向问题源头
- ✅ 易于唯一定位
- ✅ 批注位置最准确
- ✅ 用户易理解问题所在

---

### 优先级2️⃣：短句形式（退级选择）

**字数**: 2-15字
**特点**: 包含前后文，增加唯一性

**示例**：
```
"应在30天内完成"
"赔偿上限为2倍"
"无具体限制条件"
"本协议终止后5年"
"符合ISO9001标准"
```

**使用场景**：
- 关键问题处太短，容易重复（如"30"）
- 需要保留前后文增加唯一性
- 关键问题处在句子中出现多次

**matchPattern**: 通常 `EXACT`

---

### 优先级3️⃣：完整句子（兜底方案）

**字数**: 10+字
**特点**: 完整、唯一、可靠

**示例**：
```
"甲方应在损害事实发生后30天内承担赔偿责任"
"供应商应在订单确认后30天内完成交付"
"保密期限为本协议终止后5年，任何情况下不得提前终止"
```

**使用场景**：
- 优先级1、2都无法准确定位
- 整句中集中体现多个问题
- 需要绝对精准的唯一定位

**matchPattern**: 通常 `EXACT`

---

## 📝 修改后的模板示例

### 通用合同模板 (default)

**修改后**：
```json
【优先级1 - 关键问题处】
{
  "clauseId": "c1",
  "targetText": "30天",
  "matchPattern": "EXACT",
  "matchIndex": 1,
  "finding": "赔偿时限过短",
  "suggestion": "建议将30天延长到60天，给予甲方合理的处理时间"
}

【优先级2 - 短句形式】
{
  "clauseId": "c1",
  "targetText": "甲方应在损害事实发生后30天内承担赔偿责任",
  "matchPattern": "EXACT",
  "finding": "赔偿责任上限不明确",
  "suggestion": "应明确赔偿上限为年度费用的2倍"
}
```

### 技术服务合同模板 (technology)

**修改后示例**：
```json
【优先级1 - 关键问题处（数值）】
{
  "clauseId": "c2",
  "targetText": "1000万",
  "matchPattern": "EXACT",
  "matchIndex": 1,
  "finding": "并发访问性能指标不明确",
  "suggestion": "应明确单位时间内允许的并发访问数和响应时间要求"
}

【优先级1 - 关键问题处（条件）】
{
  "clauseId": "c3",
  "targetText": "甲方所有",
  "matchPattern": "EXACT",
  "finding": "知识产权归属不清晰",
  "suggestion": "应明确开发代码、文档、技术方案的具体归属和使用权限"
}
```

### 采购合同模板 (purchase)

**修改后示例**：
```json
【优先级1 - 关键问题处（时间）】
{
  "clauseId": "c1",
  "targetText": "45天",
  "matchPattern": "EXACT",
  "matchIndex": 1,
  "finding": "交付期限过长，影响生产进度",
  "suggestion": "应将交付期限从45天缩短到30天，以满足生产计划需求"
}

【优先级1 - 关键问题处（标准）】
{
  "clauseId": "c2",
  "targetText": "一般质量标准",
  "matchPattern": "EXACT",
  "finding": "质量验收标准过于宽泛",
  "suggestion": "应明确具体的质量指标、检验方法和不合格品处理办法"
}
```

---

## 🔄 问题识别流程

```
1. 识别问题 (Finding)
   ↓
2. 定位问题在合同中的具体位置
   ↓
3. 提取问题所在处的关键内容 ← targetText
   └─ 优先: 数字、时间、条件、标准等
   └─ 退级: 包含前后文的短句
   └─ 兜底: 完整句子
   ↓
4. 选择匹配方式 (matchPattern)
   └─ 一般选 EXACT（精确）
```

---

## 💡 LLM使用指南

### 对于Claude、GPT等LLM

重点强调的提示词：

```
【关键】targetText填写规则：

❌ 不要填写抽象概念：
   "交付期限" "质量标准" "知识产权" "保密条款"
   （这些太宽泛，容易重复）

✅ 要填写具体问题处：
   "30天" "ISO9001" "无限制" "45天以上"
   （这些精确指向具体问题）

优先顺序：
1. 问题的具体体现 (如数字/时间/条件)
2. 包含问题的短句 (2-15字)
3. 完整句子 (仅当前两者无法定位)

示例对比：
❌ 旧: targetText = "保密期限"
✅ 新: targetText = "5年"  或  "本协议终止后5年"

问题: "保密期限过长"
↓
应该批注: "5年" 这个具体数字，而非抽象的"保密期限"
```

### 验证LLM是否理解

检查LLM返回的JSON中的targetText：
- ✅ 是否包含具体的数字、时间、条件？
- ✅ 是否精确指向问题所在处？
- ✅ targetText是否相对简短（通常1-10字）？
- ❌ 是否避免了抽象概念词？

---

## 📊 修改对比

| 方面 | 旧规则（关键名词） | 新规则（关键问题处） |
|------|------------------|-----------------|
| **示例** | "交付期限" | "30天" |
| **特点** | 抽象概念 | 具体数值/条件 |
| **匹配难度** | 易重复 | 易唯一定位 |
| **问题指向** | 宽泛 | 精确 |
| **批注准确性** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **LLM易理解** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## ✨ 修改的优势

### 1. 批注定位更精准
```
旧: 在"交付期限"处批注 → 可能批注到多个地方
新: 在"30天"处批注 → 精确定位到问题数值
```

### 2. LLM易理解
```
旧: "请提取关键词" → LLM容易理解为概念名词
新: "请提取具体数字/条件" → LLM更易准确提取
```

### 3. 用户体验更好
```
用户看到: "⚠️ 30天这个期限过短"
相比: "⚠️ 交付期限有问题" 更清晰直观
```

### 4. 系统处理效率
```
旧: "保密期限"可能匹配10+次，需多次尝试
新: "5年"通常只有1-2次，快速匹配
```

---

## 📚 相关文档

- **工作流详解**: `PARSE_ANNOTATE_WORKFLOW_REPORT.md`
- **模板文件**: `src/main/resources/review-templates/default-templates.json`
- **API说明**: `CHATGPT_INTEGRATION_SUMMARY.md`

---

## ✅ 总结

| 项目 | 描述 |
|------|------|
| 修改时间 | 2025-10-22 (更新) |
| 修改类型 | Prompt优化 - 策略调整 |
| 核心变化 | 关键名词 → 关键问题处 |
| 受影响模板 | 3个 (通用、技术、采购) |
| 向后兼容 | ✅ 完全兼容 |
| 性能影响 | ✅ 定位更快、更准确 |
| 推荐迁移 | ✅ 强烈推荐 |

---

**更新人**: Claude Code
**版本**: 2.0 (问题处优先级版)
**最后更新**: 2025-10-22
