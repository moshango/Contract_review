# ✅ 自测试环境已准备就绪！

**准备完成时间**: 2025-10-21
**编译状态**: ✅ BUILD SUCCESS
**测试脚本**: ✅ 已生成
**文件**: 测试合同_综合测试版.docx

---

## 🎯 现在可以执行完整工作流测试了！

我已经为您准备好了完整的自测试环境。以下是快速开始指南：

---

## 🚀 立即开始（3 步，5 分钟）

### 第 1 步: 启动服务

打开 PowerShell，执行：

```powershell
cd D:\工作\合同审查系统开发\spring boot\Contract_review
java -jar target/Contract_review-0.0.1-SNAPSHOT.jar
```

等待看到 `Tomcat started on port(s): 8080`

**此窗口保持打开**

### 第 2 步: 执行自动化测试

打开**新的 PowerShell 窗口**，执行：

```powershell
cd D:\工作\合同审查系统开发\spring boot\Contract_review
.\run_full_workflow_test.ps1
```

脚本会自动完成：
- ✅ Parse 阶段：上传文件，获取锚点
- ✅ 生成测试审查结果：5 个不同风险级别的问题
- ✅ Annotate 阶段：导入审查结果，生成批注文档
- ✅ 验证输出：检查文件是否成功生成

### 第 3 步: 检查批注文档

脚本完成后会生成 `annotated_output.docx`，打开查看批注：

```powershell
Start-Process "annotated_output.docx"
```

---

## 📊 测试过程中应该看到的关键日志

### 在服务窗口（第 1 步的 PowerShell）中查找：

**Parse 阶段日志**：
```
INFO  为ChatGPT生成提示: filename=测试合同_综合测试版.docx, contractType=通用合同, anchors=generate
INFO  【工作流】开始插入锚点到文档中
INFO  【锚点插入】开始插入锚点: 文档段落数=60, 条款数=8
INFO  【锚点插入】完成: 成功插入=8个, 跳过=0
INFO  【文档保存】即将保存文档: 总段落数=60, 总书签数=8  ⭐ 关键指标
```

**Annotate 阶段日志**：
```
INFO  开始处理 XML 格式的合同批注: 问题数=5
INFO  开始查找目标段落：clauseId=c1, anchorId=anc-c1-304286e3
INFO  ✓ 通过锚点找到目标段落: clauseId=c1  ⭐ 锚点定位成功！
INFO  ✓ 精确批注插入完成: commentId=X
```

---

## 🔍 关键诊断指标

| 指标 | 预期值 | 含义 |
|------|--------|------|
| 【锚点插入】完成: 成功插入=X | 8 | 所有 8 个条款的锚点都被添加 |
| 【文档保存】总书签数=X | 8 | 所有 8 个锚点都被序列化 |
| 通过锚点找到目标段落 | 出现多次 | 锚点定位成功 ✅ |
| 问题数=X | 5 | 所有 5 个测试问题都被处理 |
| 批注气泡数 | 5 | Word 文档中有 5 个批注 |

---

## 📋 测试审查结果说明

脚本中包含的 5 个测试问题：

| # | clauseId | 风险级别 | 类别 | 问题 |
|---|----------|---------|------|------|
| 1 | c1 | HIGH | 合同目的 | 需要更明确的合作范围定义 |
| 2 | c3 | MEDIUM | 交付物定义 | 前端展示界面缺少具体的技术规格 |
| 3 | c5 | HIGH | 付款条款 | 首付款比例偏低，风险较大 |
| 4 | c10 | MEDIUM | 知识产权 | 知识产权所有权分配不够平衡 |
| 5 | c15 | HIGH | 违约责任 | 违约责任条款过于宽泛 |

这些问题涵盖了：
- ✅ 不同的 clauseId（c1, c3, c5, c10, c15）
- ✅ 不同的风险级别（HIGH, MEDIUM）
- ✅ 不同的匹配模式（EXACT, CONTAINS）
- ✅ 不同的内容长度

用于全面测试批注定位功能

---

## 📁 生成的文件

测试完成后，当前目录会生成：

```
annotated_output.docx  - 生成的带批注文档
```

同时有多个诊断和指南文档可用：

```
run_full_workflow_test.ps1       - 完整自动化测试脚本
QUICK_START_TEST.md              - 快速启动指南
SELF_TEST_GUIDE.md               - 详细自测试指南
ROOT_CAUSE_ANALYSIS.md           - 问题根源分析
DIAGNOSTIC_STEPS.md              - 诊断步骤指南
```

---

## ✅ 成功标准

测试完成后，如果看到以下结果说明**全流程成功**：

```
✅ 脚本执行完成，显示"完整工作流自测试结束"
✅ 生成了 annotated_output.docx 文件
✅ 服务日志显示 【文档保存】总书签数=8
✅ 服务日志显示至少一次 "✓ 通过锚点找到目标段落"
✅ Word 文件能正常打开
✅ Word 文件中包含 5 个批注气泡
✅ 批注位置和内容正确
```

---

## 🎯 测试完成后

测试完成后，请提供：

1. **是否看到 `【文档保存】总书签数=8`？**
   - 如果是 8 → 锚点序列化成功 ✅
   - 如果是 0 → 需要调查 POI 序列化问题 ❌

2. **是否看到 `✓ 通过锚点找到目标段落`？**
   - 如果多次出现 → 锚点定位成功 ✅
   - 如果没看到 → 系统回退到文本匹配 ⚠️

3. **Word 文档的批注情况**
   - 批注数量（预期 5 个）
   - 批注位置是否准确
   - 批注内容是否完整

4. **关键日志片段**（复制粘贴相关部分）

---

## 🔧 故障排查快速菜单

### Parse 失败？
```powershell
# 检查文件存在
Test-Path "D:\工作\合同审查系统开发\spring boot\Contract_review\测试合同_综合测试版.docx"

# 检查服务运行
curl http://localhost:8080/chatgpt/status
```

### Annotate 失败？
- 检查服务日志中的异常信息
- 验证 JSON 格式是否正确
- 检查 parseResultId 是否有效

### Word 文档打不开？
- 检查文件大小（应该 > 50 KB）
- 尝试用 Word 的修复功能

---

## 📚 详细指南

如需了解更多细节，请参考：

- **QUICK_START_TEST.md** - 快速启动和验证指南（推荐首先阅读）
- **SELF_TEST_GUIDE.md** - 详细的手动步骤和调试方法
- **DIAGNOSTIC_STEPS.md** - 如何理解诊断日志
- **ROOT_CAUSE_ANALYSIS.md** - 问题根源分析和修复

---

## 🎉 准备就绪！

所有准备工作已完成，现在可以立即开始自测试了！

**祝测试顺利！**  🚀

---

**下一步**: 执行上面的 3 个步骤，然后将测试结果反馈给我！

