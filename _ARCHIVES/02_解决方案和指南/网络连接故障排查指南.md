# AI合同审查系统 - 网络连接故障排查指南

## 概述

本指南帮助您解决调用 Claude 或 OpenAI API 时遇到的网络连接问题，特别是 `HttpURLConnection timeout` 错误。

---

## 🔍 问题诊断

### 1. 确认错误类型

当您看到以下错误信息时，表明存在网络连接问题：

- `HttpURLConnection.plainConnect timeout`
- `Connection refused`
- `Connect timeout`
- `Read timeout`
- `网络连接失败，无法访问AI服务`

---

## ✅ 解决方案

### ⚠️ 方案 0: 检查并清除系统代理环境变量（最常见问题）

**问题：** 如果您使用了 Clash、V2Ray 等代理软件，系统可能设置了代理环境变量，但代理端口不可用，导致连接超时。

#### 0.1 检查系统代理

在 Git Bash 或 PowerShell 中运行：

```bash
# Git Bash
set | grep -i proxy

# PowerShell
Get-ChildItem Env:*proxy*
```

如果看到类似输出：
```
HTTP_PROXY=http://127.0.0.1:33210
HTTPS_PROXY=http://127.0.0.1:33210
ALL_PROXY=socks5://127.0.0.1:33211
```

这些代理可能正在干扰应用的网络连接。

#### 0.2 解决方法

**方法 A：使用提供的启动脚本（推荐）**

已为您创建了清除代理的启动脚本：

**Windows：**
```bash
start-without-proxy.bat
```

**Linux/Mac：**
```bash
chmod +x start-without-proxy.sh
./start-without-proxy.sh
```

这些脚本会在启动应用前清除所有代理环境变量。

**方法 B：手动清除代理并启动**

```bash
# Windows CMD
set HTTP_PROXY=
set HTTPS_PROXY=
set ALL_PROXY=
mvn spring-boot:run

# Git Bash / Linux / Mac
unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy
mvn spring-boot:run
```

**方法 C：代码已自动处理**

最新版本的代码已经添加了 `Proxy.NO_PROXY` 设置，会自动忽略系统代理（除非您在 `application.properties` 中明确启用代理）。

---

### 方案 1: 检查网络连接

#### 1.1 测试基本网络连通性

```bash
# 测试能否访问 Anthropic API (Claude)
curl -v https://api.anthropic.com/v1/messages

# 测试能否访问 OpenAI API
curl -v https://api.openai.com/v1/chat/completions
```

**预期结果：**
- 如果返回 `401 Unauthorized` 或类似认证错误，说明网络连通正常，只是缺少API密钥
- 如果返回 `Connection refused` 或 `timeout`，说明网络无法访问

#### 1.2 检查防火墙设置

确保您的防火墙允许访问以下域名：
- `api.anthropic.com` (Claude)
- `api.openai.com` (OpenAI)

---

### 方案 2: 配置代理服务器

如果您的网络环境需要通过代理访问外网，请按以下步骤配置：

#### 2.1 编辑配置文件

打开 `src/main/resources/application.properties`，找到代理配置部分：

```properties
# Proxy Configuration (optional)
# 取消注释并配置您的代理信息
ai.service.proxy.enabled=true
ai.service.proxy.host=your-proxy-host
ai.service.proxy.port=8080
ai.service.proxy.type=HTTP
```

#### 2.2 配置示例

**HTTP 代理示例：**
```properties
ai.service.proxy.enabled=true
ai.service.proxy.host=proxy.company.com
ai.service.proxy.port=8080
ai.service.proxy.type=HTTP
```

**SOCKS 代理示例：**
```properties
ai.service.proxy.enabled=true
ai.service.proxy.host=127.0.0.1
ai.service.proxy.port=1080
ai.service.proxy.type=SOCKS
```

#### 2.3 重启应用

修改配置后，需要重启应用：

```bash
mvn spring-boot:run
```

---

### 方案 3: 验证 API 密钥

#### 3.1 检查 API 密钥配置

打开 `application.properties`，确认已正确配置 API 密钥：

```properties
# 确认使用哪个提供商
ai.service.provider=openai

# OpenAI 配置
ai.service.openai.api-key=your-actual-api-key
ai.service.openai.api-endpoint=https://api.openai.com/v1/chat/completions

# Claude 配置
ai.service.claude.api-key=your-actual-api-key
ai.service.claude.api-endpoint=https://api.anthropic.com/v1/messages
```

#### 3.2 独立测试 API 密钥

**测试 OpenAI API：**

```bash
curl https://api.openai.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "model": "gpt-4",
    "messages": [{"role": "user", "content": "Hello"}],
    "max_tokens": 10
  }'
```

**测试 Claude API：**

```bash
curl https://api.anthropic.com/v1/messages \
  -H "content-type: application/json" \
  -H "x-api-key: YOUR_API_KEY" \
  -H "anthropic-version: 2023-06-01" \
  -d '{
    "model": "claude-3-5-sonnet-20241022",
    "max_tokens": 10,
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

**成功响应示例：**
- 如果 API 密钥有效，会返回带有 `content` 字段的 JSON 响应
- 如果 API 密钥无效，会返回 `401 Unauthorized` 错误

---

### 方案 4: 调整超时设置

如果您的网络速度较慢，可以增加超时时间：

编辑 `application.properties`：

```properties
# 增加超时时间（当前已设置为较长时间）
ai.service.timeout=120
ai.service.max-retries=5
```

或者直接修改 `WebClientConfig.java`：

```java
factory.setConnectTimeout(120000);  // 120秒连接超时
factory.setReadTimeout(240000);     // 240秒读取超时
```

---

### 方案 5: 使用备用 API 端点

某些地区可能无法访问官方 API，可以尝试使用第三方转发服务或备用端点：

```properties
# 使用备用端点（仅示例，需要您自己找到可用的）
ai.service.openai.api-endpoint=https://your-proxy-domain.com/v1/chat/completions
```

---

## 🔧 系统已实现的容错机制

系统已内置以下容错措施：

### 1. 自动重试机制

- **默认重试次数：** 3 次
- **重试策略：** 指数退避（2秒、4秒、8秒）
- **配置位置：** `application.properties` → `ai.service.max-retries`

### 2. 增强的错误提示

系统会根据不同的错误类型提供友好的错误信息：

| HTTP 状态码 | 错误信息 |
|------------|---------|
| 401 | API密钥无效或已过期，请检查配置 |
| 403 | API访问被拒绝，请检查API密钥权限 |
| 429 | API调用频率超限，请稍后重试 |
| 500 | AI服务内部错误，请稍后重试 |
| 503 | AI服务暂时不可用，请稍后重试 |
| 网络错误 | 网络连接失败，无法访问AI服务。请检查网络配置 |

### 3. 详细日志记录

所有 API 调用都会记录详细日志，便于排查问题：

```
调用OpenAI API - 尝试 1/3
OpenAI API调用失败 (尝试 1/3): Connection timeout
等待2秒后重试...
```

---

## 📋 完整检查清单

在联系技术支持前，请依次检查以下项目：

- [ ] 1. 网络连接正常，可以访问外网
- [ ] 2. 防火墙允许访问 `api.anthropic.com` 和 `api.openai.com`
- [ ] 3. API 密钥已正确配置且未过期
- [ ] 4. 使用 curl 测试 API 密钥有效
- [ ] 5. 如需代理，已正确配置代理信息
- [ ] 6. 检查应用日志 (`logs/` 目录) 查看详细错误
- [ ] 7. 尝试切换不同的 AI 提供商（Claude ↔ OpenAI）
- [ ] 8. 重启应用后重新测试

---

## 🚀 快速测试流程

### 步骤 1: 启动应用

```bash
cd "D:\工作\合同审查系统开发\spring boot\Contract_review"
mvn spring-boot:run
```

### 步骤 2: 检查 AI 服务状态

访问：`http://localhost:8080`，打开"自动化审查"选项卡，查看 AI 服务状态指示器。

### 步骤 3: 上传测试文件

选择一个简单的 `.docx` 合同文件（建议 < 10 页），选择合同类型，点击"开始自动审查"。

### 步骤 4: 观察错误信息

- 如果出现网络错误，查看具体错误提示
- 根据错误类型选择对应的解决方案
- 检查浏览器控制台和后端日志

---

## 📞 获取帮助

如果以上方案都无法解决问题，请提供以下信息：

1. **错误日志：** 完整的错误堆栈信息
2. **网络环境：** 是否使用代理、防火墙设置
3. **测试结果：** curl 测试 API 的返回结果
4. **配置信息：** `application.properties` 的相关配置（隐藏 API 密钥）
5. **系统版本：** Java 版本、操作系统版本

---

## 📝 附录：常见错误代码

### Java 网络异常

| 异常类型 | 原因 | 解决方案 |
|---------|------|---------|
| `ConnectException: Connection refused` | 目标服务器拒绝连接 | 检查 API 端点 URL 是否正确 |
| `ConnectException: Connection timed out` | 连接超时 | 检查网络连接、配置代理 |
| `SocketTimeoutException: Read timed out` | 读取超时 | 增加读取超时时间 |
| `UnknownHostException` | 无法解析域名 | 检查 DNS 设置、网络连接 |
| `SSLHandshakeException` | SSL 握手失败 | 检查系统证书、更新 JDK |

### HTTP 状态码

| 状态码 | 含义 | 处理方式 |
|-------|------|---------|
| 200 | 成功 | 正常处理响应 |
| 400 | 请求格式错误 | 检查请求参数 |
| 401 | 未授权 | 检查 API 密钥 |
| 403 | 禁止访问 | 检查 API 权限 |
| 429 | 请求过多 | 等待后重试 |
| 500 | 服务器错误 | 稍后重试 |
| 503 | 服务不可用 | 稍后重试 |

---

**最后更新：** 2025-10-13
**版本：** 1.0
