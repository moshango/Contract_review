# 🧪 8080 ChatGPT 批注功能完整自测试指南

**创建时间**: 2025-10-21
**目标**: 完整打通批注功能工作流并生成测试结果
**测试文件**: 测试合同_综合测试版.docx

---

## 📋 准备工作

### 1. 启动服务

在一个终端中启动服务（需要保持运行）：

```bash
cd D:\工作\合同审查系统开发\spring boot\Contract_review
mvn clean package -DskipTests
java -jar target/Contract_review-0.0.1-SNAPSHOT.jar
```

**等待看到这个输出**：
```
Started Contract_review in X.XXX seconds
Tomcat started on port(s): 8080 (http)
```

### 2. 验证文件

```bash
# Windows PowerShell
Test-Path "D:\工作\合同审查系统开发\spring boot\Contract_review\测试合同_综合测试版.docx"
# 应该返回 True
```

---

## 🚀 执行完整工作流测试

### 方法 A: 使用 PowerShell 脚本（推荐用于 Windows）

在**新的 PowerShell 终端**中执行：

```powershell
cd D:\工作\合同审查系统开发\spring boot\Contract_review
.\run_full_workflow_test.ps1
```

**脚本会自动执行**：
1. ✅ Parse 阶段：上传文件，获取 parseResultId 和条款信息
2. ✅ 生成测试审查结果：5 个包含不同风险级别的问题
3. ✅ Annotate 阶段：导入审查结果，生成批注文档
4. ✅ 验证输出：检查输出文件是否生成成功

### 方法 B: 手动执行（用于调试）

如果需要逐步执行以便观察中间结果，请按以下步骤：

---

## 📊 工作流详解与手动执行

### 步骤 1: Parse 阶段 - 生成 Prompt

```powershell
$testFile = "D:\工作\合同审查系统开发\spring boot\Contract_review\测试合同_综合测试版.docx"
$response = Invoke-RestMethod -Uri "http://localhost:8080/chatgpt/generate-prompt" `
    -Method Post `
    -Form @{
        file = Get-Item $testFile
        contractType = "通用合同"
        anchors = "generate"
    }

# 查看完整响应
$response | ConvertTo-Json -Depth 10

# 提取 parseResultId
$parseId = $response.parseResultId
Write-Host "ParseResultId: $parseId"

# 提取条款数
$clauseCount = $response.clauseCount
Write-Host "条款数: $clauseCount"
```

**预期结果**：
- ✅ 获得 `parseResultId`（类似 UUID 格式）
- ✅ 获得 `clauseCount`（应该是 > 0 的数字）
- ✅ 响应中包含 `anchorsEnabled: true`

### 步骤 2: 生成测试审查结果 JSON

创建一个包含测试审查问题的 JSON 对象：

```powershell
$reviewJson = @{
    issues = @(
        @{
            clauseId = "c1"
            anchorId = "anc-c1-304286e3"
            severity = "HIGH"
            category = "合同目的"
            finding = "需要更明确的合作范围定义"
            suggestion = "建议在合同目的中明确列出所有合作项目的具体范围和目标"
            targetText = "本合同旨在明确双方在软件开发、技术交付、知识产权、数据安全、保密义务及后期维护等方面的权利与义务，以确保项目顺利进行。"
            matchPattern = "EXACT"
        },
        @{
            clauseId = "c3"
            anchorId = "anc-c3-ea3ec6c4"
            severity = "MEDIUM"
            category = "交付物定义"
            finding = "前端展示界面缺少具体的技术规格要求"
            suggestion = "应明确前端展示的必需功能模块、性能要求（如响应时间）和兼容性要求"
            targetText = "（3）前端展示与标注界面（Web版）"
            matchPattern = "CONTAINS"
        },
        @{
            clauseId = "c5"
            severity = "HIGH"
            category = "付款条款"
            finding = "首付款比例偏低，风险较大"
            suggestion = "建议提高首付款比例至 40-50%，以平衡双方风险"
            targetText = "首付款：合同签订后7个工作日内支付30%"
            matchPattern = "CONTAINS"
        },
        @{
            clauseId = "c10"
            severity = "MEDIUM"
            category = "知识产权"
            finding = "知识产权所有权分配不够平衡"
            suggestion = "建议明确区分通用技术和项目特定技术的所有权归属"
            targetText = "所有项目成果的知识产权归甲方所有"
            matchPattern = "CONTAINS"
        },
        @{
            clauseId = "c15"
            severity = "HIGH"
            category = "违约责任"
            finding = "违约责任条款过于宽泛，缺少具体的量化标准"
            suggestion = "建议明确违约赔偿的计算方式和上限金额"
            targetText = "任一方违反合同约定，须赔偿对方因此造成的全部经济损失"
            matchPattern = "CONTAINS"
        }
    )
    summary = @{
        totalIssues = 5
        highRisk = 3
        mediumRisk = 2
        lowRisk = 0
        recommendation = "该合同在整体结构上较为完整，但在合作范围定义、付款风险管理和违约责任量化等方面仍有改进空间。建议重点关注高风险条款，通过进一步谈判和修改来平衡双方权益。"
    }
} | ConvertTo-Json -Depth 10

Write-Host "测试审查结果已生成"
```

**审查结果包含**：
- 5 个问题（3 个高风险，2 个中风险）
- 每个问题都有 `clauseId` 和 `targetText`
- 混合使用 `EXACT` 和 `CONTAINS` 匹配模式

### 步骤 3: Annotate 阶段 - 导入审查结果

```powershell
# 使用上一步获得的 $parseId 和本步骤的 $reviewJson

$response = Invoke-RestMethod -Uri "http://localhost:8080/chatgpt/import-result-xml?parseResultId=$parseId&anchorStrategy=preferAnchor&cleanupAnchors=false" `
    -Method Post `
    -Form @{
        chatgptResponse = $reviewJson
    } `
    -OutFile "annotated_output.docx"

Write-Host "✅ 批注文档已生成: annotated_output.docx"
```

**预期结果**：
- ✅ 生成 `annotated_output.docx` 文件
- ✅ 文件大小 > 50 KB
- ✅ 可以在 Word 中打开

---

## 🔍 验证批注结果

### 方法 1: 在 Word 中打开文件

```powershell
Start-Process "annotated_output.docx"
```

**检查项目**：
1. ✅ 文件能正常打开
2. ✅ 能看到批注标记（通常是红色框）
3. ✅ 评论中显示审查问题的内容
4. ✅ 批注位置与问题相关的文本相符

### 方法 2: 查看后台日志

在服务启动的终端中查看日志输出。**关键日志包括**：

**Parse 阶段日志**（第一步）：
```
INFO  为ChatGPT生成提示: filename=测试合同_综合测试版.docx, contractType=通用合同, anchors=generate
INFO  【工作流】开始插入锚点到文档中
INFO  【锚点插入】开始插入锚点: 文档段落数=60, 条款数=8
INFO  【文档保存】即将保存文档: 总段落数=60, 总书签数=8
```

**Annotate 阶段日志**（第三步）：
```
INFO  开始处理 XML 格式的合同批注: 问题数=5
INFO  开始查找目标段落：clauseId=c1, anchorId=anc-c1-304286e3
INFO  ? 通过锚点找到目标段落: clauseId=c1
INFO  ? 精确批注插入完成: commentId=X, 前缀=0, 匹配范围=Y-Z
```

---

## 📋 自测试检查清单

- [ ] 编译成功（BUILD SUCCESS）
- [ ] 服务启动成功（Tomcat started on port 8080）
- [ ] Parse 请求返回 parseResultId
- [ ] Parse 日志包含 `【文档保存】` 相关输出
- [ ] Annotate 请求生成 annotated_output.docx 文件
- [ ] 输出文件能在 Word 中打开
- [ ] Word 中能看到批注标记
- [ ] 后台日志中能看到 "通过锚点找到目标段落" 或 "通过文本匹配找到目标段落"
- [ ] 没有异常报错

---

## 🐛 常见问题排查

### Q1: Parse 返回错误
**症状**: `/generate-prompt` 返回异常
**解决**:
```powershell
# 检查文件是否存在
Test-Path "D:\工作\合同审查系统开发\spring boot\Contract_review\测试合同_综合测试版.docx"

# 检查服务是否运行
Invoke-RestMethod "http://localhost:8080/chatgpt/status" -Method Get
```

### Q2: Annotate 无法找到锚点
**症状**: 日志显示 "未找到anchorId对应的书签"
**解决**:
- 确保使用了正确的 `parseResultId`
- 检查 Parse 阶段是否确实生成了锚点（查看日志 `总书签数` 值）
- 查看是否在 Annotate 时指定了 `anchorStrategy=preferAnchor`

### Q3: Word 文件打不开
**症状**: annotated_output.docx 损坏
**解决**:
- 检查文件大小（应该 > 50 KB）
- 查看后台异常日志
- 重新执行工作流

---

## 📊 预期测试结果

### 成功标志

✅ **Parse 阶段成功**：
```
✅ 获得 parseResultId
✅ 条款数 = 8
✅ anchorsEnabled = true
✅ documentWithAnchorsBase64 已返回
```

✅ **Annotate 阶段成功**：
```
✅ 5 个问题已处理
✅ 3 个高风险问题已标注
✅ 2 个中风险问题已标注
✅ 批注文档已生成
```

✅ **最终验证**：
```
✅ Word 文档能打开
✅ 能看到 5 个批注
✅ 批注内容正确
✅ 批注位置准确
```

---

## 🎯 下一步

测试完成后：

1. **收集诊断信息**：
   - 后台日志的关键部分（Parse 和 Annotate 阶段）
   - 特别是 `【文档保存】总书签数` 的值
   - 是否看到 "通过锚点找到" 或 "文本匹配找到"

2. **报告问题**：
   - 如果批注位置不准确
   - 如果无法找到锚点
   - 如果文档生成失败

3. **迭代改进**：
   - 根据测试结果优化算法
   - 改进文本匹配逻辑
   - 增强锚点定位准确性

---

**现在开始测试吧！** 🚀

