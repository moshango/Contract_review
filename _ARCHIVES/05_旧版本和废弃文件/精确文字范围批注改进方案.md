# ç²¾ç¡®æ–‡å­—èŒƒå›´æ‰¹æ³¨æ”¹è¿›æ–¹æ¡ˆ

**é—®é¢˜**: å½“å‰æ‰¹æ³¨æ˜¯æŒ‰æ•´è¡Œï¼ˆRunï¼‰æ’å…¥çš„ï¼Œä¸æ˜¯æŒ‰åŒ¹é…çš„æ–‡å­—èŒƒå›´æ’å…¥

**ç°è±¡**:
```
æ—¥å¿—: æ‰¾åˆ°åŒ¹é…æ–‡å­—ï¼šä½ç½®=3, é•¿åº¦=34, ç´¢å¼•=1/1
ç»“æœ: æ•´ä¸ªRunéƒ½è¢«æ‰¹æ³¨äº†ï¼ˆä½ç½®3-37ï¼Œé•¿åº¦34+3=37ï¼‰
æœŸæœ›: åªæ‰¹æ³¨ä½ç½®3-37çš„è¿™34ä¸ªå­—ç¬¦
```

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### å½“å‰å®ç°çš„æµç¨‹

```
1. PreciseTextAnnotationLocator æ‰¾åˆ°åŒ¹é…èŒƒå›´
   â””â”€ è¿”å›: startRun, endRun, startOffsetInRun, endOffsetInRun
   â””â”€ ä¾‹å¦‚: startRun=Run0, startOffset=3, endRun=Run0, endOffset=37

2. WordXmlCommentProcessor.insertPreciseCommentRange()
   â””â”€ åœ¨ Run å‰æ’å…¥ commentRangeStart
   â””â”€ åœ¨ Run åæ’å…¥ commentRangeEnd
   â””â”€ âŒ ç»“æœ: æ•´ä¸ª Run éƒ½è¢«æ‰¹æ³¨äº†
```

### ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

Word XML çš„æ‰¹æ³¨æ ‡è®°æ˜¯ **æ®µè½çº§åˆ«** çš„ï¼Œä¸èƒ½åœ¨Runå†…éƒ¨ç²¾ç¡®æ’å…¥ã€‚è§£å†³æ–¹æ¡ˆæ˜¯ï¼š
- å½“åŒ¹é…çš„æ–‡å­—åœ¨å•ä¸ªRunå†…éƒ¨æ—¶ï¼Œéœ€è¦**åˆ†å‰²Run**
- å°†Runåˆ†æˆï¼šå‰ç¼€ã€åŒ¹é…éƒ¨åˆ†ã€åç¼€ä¸‰éƒ¨åˆ†
- åªåœ¨åŒ¹é…éƒ¨åˆ†å‰åæ’å…¥æ‰¹æ³¨æ ‡è®°

---

## ğŸ’¡ æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: Runåˆ†å‰²æ³•ï¼ˆæ¨èï¼‰â­

**åŸç†**:
```
åŸRunæ–‡æœ¬: "1. æœ¬åˆåŒæœªå°½äº‹å®œï¼ŒåŒæ–¹å¯ç­¾ç½²è¡¥å……åè®®ï¼Œè¡¥å……åè®®ä¸æœ¬åˆåŒå…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›ã€‚"
          (ä½ç½®0                  3|â†----34ä¸ªå­—ç¬¦---->|37)

åˆ†å‰²å:
  Run1: "1. "                           (ä¿ç•™)
  Run2: "æœ¬åˆåŒæœªå°½äº‹å®œï¼ŒåŒæ–¹å¯ç­¾ç½²è¡¥å……åè®®ï¼Œè¡¥å……åè®®ä¸æœ¬åˆåŒå…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›"  (æ–°Runï¼Œç”¨äºæ‰¹æ³¨)
  Run3: "ã€‚"                           (ä¿ç•™)

æ‰¹æ³¨æ ‡è®°æ”¾åœ¨ Run2 å‰å
```

**ä¼˜ç‚¹**:
- ç²¾ç¡®æ§åˆ¶æ‰¹æ³¨èŒƒå›´
- Wordèƒ½æ­£ç¡®æ˜¾ç¤º
- ç”¨æˆ·å¯ä»¥æ¸…æ™°çœ‹åˆ°æ‰¹æ³¨çš„å…·ä½“ä½ç½®

**ç¼ºç‚¹**:
- éœ€è¦ä¿®æ”¹Runå…ƒç´ ç»“æ„
- ä»£ç å¤æ‚åº¦å¢åŠ 
- éœ€è¦å¤„ç†å¤šä¸ªRunè·¨è¶Šçš„æƒ…å†µ

**å·¥ä½œæµ**:
```java
private void insertPreciseCommentRangeWithRunSplit(
    Element paragraph,
    Element startRun,
    int startOffsetInRun,
    Element endRun,
    int endOffsetInRun,
    int commentId) {

    // 1. å¦‚æœæ˜¯åŒä¸€ä¸ªRunå†…éƒ¨
    if (startRun == endRun) {
        // åˆ†å‰²Runæˆä¸‰éƒ¨åˆ†
        String originalText = extractRunText(startRun);

        // å‰ç¼€: 0 ~ startOffset
        String prefix = originalText.substring(0, startOffsetInRun);

        // åŒ¹é…éƒ¨åˆ†: startOffset ~ endOffset
        String matched = originalText.substring(startOffsetInRun, endOffsetInRun);

        // åç¼€: endOffset ~ æœ«å°¾
        String suffix = originalText.substring(endOffsetInRun);

        // æ¸…ç©ºåŸRun
        startRun.clearContent();

        // å¦‚æœæœ‰å‰ç¼€ï¼Œåˆ›å»ºå‰ç¼€Run
        if (!prefix.isEmpty()) {
            createRunWithText(paragraph, prefix, startRun);
        }

        // åˆ›å»ºæ–°Runç”¨äºæ‰¹æ³¨ï¼ˆåŒ…å«åŒ¹é…éƒ¨åˆ†ï¼‰
        Element newRun = createNewRun(paragraph);
        setRunText(newRun, matched);

        // åœ¨æ–°Runå‰åæ’å…¥æ‰¹æ³¨æ ‡è®°
        insertCommentRangeStart(paragraph, newRun, commentId);
        insertCommentRangeEnd(paragraph, newRun, commentId);

        // å¦‚æœæœ‰åç¼€ï¼Œåˆ›å»ºåç¼€Run
        if (!suffix.isEmpty()) {
            createRunWithText(paragraph, suffix, startRun);
        }
    }
    // 2. å¦‚æœè·¨è¶Šå¤šä¸ªRunï¼Œå¤„ç†æ›´å¤æ‚...
}
```

### æ–¹æ¡ˆ B: æ®µè½çº§åˆ«é€€å›æ³•

**åŸç†**: å½“æ–‡å­—è·¨è¶Šå¤šä¸ªRunï¼Œæˆ–åˆ†å‰²è¿‡äºå¤æ‚æ—¶ï¼Œé€€å›åˆ°æ®µè½çº§åˆ«æ‰¹æ³¨

**ä¼˜ç‚¹**:
- ç®€å•ï¼Œä¸æ”¹åŠ¨Runç»“æ„
- é¿å…å¤æ‚è¾¹ç•Œæƒ…å†µ

**ç¼ºç‚¹**:
- å¤±å»ç²¾ç¡®å®šä½çš„ä¼˜åŠ¿
- æ•´æ®µéƒ½è¢«æ‰¹æ³¨

### æ–¹æ¡ˆ C: æ··åˆæ³•ï¼ˆæœ€å®ç”¨ï¼‰âœ…

ç»“åˆæ–¹æ¡ˆAå’ŒBï¼š
- **æƒ…å†µ1**: å•ä¸ªRunå†…åŒ¹é… â†’ ä½¿ç”¨æ–¹æ¡ˆAï¼ˆåˆ†å‰²Runï¼‰
- **æƒ…å†µ2**: è·¨å¤šä¸ªRunåŒ¹é… â†’ ä½¿ç”¨æ–¹æ¡ˆBï¼ˆæ®µè½çº§åˆ«ï¼‰
- **æƒ…å†µ3**: åŒ¹é…å¤±è´¥ â†’ ä½¿ç”¨æ®µè½çº§åˆ«ï¼ˆå·²æœ‰ï¼‰

---

## ğŸ“‹ å®ç°æ­¥éª¤ï¼ˆæ¨èæŒ‰æ­¤é¡ºåºï¼‰

### ç¬¬1æ­¥: å¢å¼º TextMatchResult ç±»

æ·»åŠ å­—æ®µç”¨äºå­˜å‚¨Runå†…åç§»é‡ï¼š

```java
public class TextMatchResult {
    // ç°æœ‰å­—æ®µ
    private Element startRun;
    private Element endRun;
    private int startPosition;
    private int endPosition;

    // æ–°å¢å­—æ®µ
    private int startOffsetInRun;  // Runå†…èµ·å§‹åç§»
    private int endOffsetInRun;    // Runå†…ç»“æŸåç§»
    private boolean isSingleRun;   // æ˜¯å¦åœ¨å•ä¸ªRunå†…

    // getter/setter...
}
```

### ç¬¬2æ­¥: ä¿®æ”¹ PreciseTextAnnotationLocator

åœ¨ `mapPositionToRuns()` æ–¹æ³•ä¸­è®¡ç®—Runå†…åç§»é‡ï¼š

```java
// ç°æœ‰ä»£ç å·²è®¡ç®—äº† startOffsetInRun å’Œ endOffsetInRun
// åªéœ€æ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼š

if (startRun == endRun) {
    result.setIsSingleRun(true);
} else {
    result.setIsSingleRun(false);
}

logger.debug("æ˜¯å¦å•Runå†…: {}, startOffset={}, endOffset={}",
           result.isSingleRun(), startOffsetInRun, endOffsetInRun);
```

### ç¬¬3æ­¥: ä¿®æ”¹ WordXmlCommentProcessor

æ”¹è¿› `insertPreciseCommentRange()` æ–¹æ³•ï¼š

```java
private void insertPreciseCommentRange(
    Element paragraph,
    TextMatchResult matchResult,
    int commentId) {

    // æƒ…å†µ1: å•ä¸ªRunå†…çš„åŒ¹é… - åˆ†å‰²Run
    if (matchResult.isSingleRun()) {
        insertPreciseCommentRangeInSingleRun(
            paragraph,
            matchResult,
            commentId);
    }
    // æƒ…å†µ2: å¤šä¸ªRunè·¨è¶Š - æ®µè½çº§åˆ«
    else {
        logger.debug("åŒ¹é…è·¨è¶Šå¤šä¸ªRunï¼Œé™çº§åˆ°æ®µè½çº§åˆ«æ‰¹æ³¨");
        insertCommentRangeInDocument(paragraph, commentId);
    }
}
```

### ç¬¬4æ­¥: å®ç° Run åˆ†å‰²é€»è¾‘

```java
private void insertPreciseCommentRangeInSingleRun(
    Element paragraph,
    TextMatchResult matchResult,
    int commentId) {

    Element originalRun = matchResult.getStartRun();
    int startOffset = matchResult.getStartOffsetInRun();
    int endOffset = matchResult.getEndOffsetInRun();

    // æå–åŸRunçš„æ–‡æœ¬å’Œå±æ€§
    String originalText = extractRunText(originalRun);
    String prefix = originalText.substring(0, startOffset);
    String matched = originalText.substring(startOffset, endOffset);
    String suffix = originalText.substring(endOffset);

    // è·å–Runåœ¨æ®µè½ä¸­çš„ä½ç½®
    List<Element> allRuns = paragraph.elements(QName.get("r", W_NS));
    int runIndex = allRuns.indexOf(originalRun);

    // æ¸…ç©ºåŸRun
    originalRun.clearContent();

    // 1. å‰ç¼€Runï¼ˆå¦‚æœæœ‰ï¼‰
    if (!prefix.isEmpty()) {
        Element prefixRun = new org.dom4j.tree.DefaultElement(QName.get("r", W_NS));
        setRunText(prefixRun, prefix);
        paragraph.elements().add(runIndex, prefixRun);
        runIndex++;
    }

    // 2. åŒ¹é…éƒ¨åˆ†Run - è¿™ä¸ªRunä¼šè¢«æ‰¹æ³¨
    Element matchedRun = new org.dom4j.tree.DefaultElement(QName.get("r", W_NS));
    setRunText(matchedRun, matched);

    // åœ¨matchedRunå‰æ’å…¥commentRangeStart
    Element rangeStart = new org.dom4j.tree.DefaultElement(QName.get("commentRangeStart", W_NS));
    rangeStart.addAttribute(QName.get("id", W_NS), String.valueOf(commentId));
    paragraph.elements().add(runIndex, rangeStart);
    runIndex++;

    // æ·»åŠ matchedRun
    paragraph.elements().add(runIndex, matchedRun);
    runIndex++;

    // åœ¨matchedRunåæ’å…¥commentRangeEnd
    Element rangeEnd = new org.dom4j.tree.DefaultElement(QName.get("commentRangeEnd", W_NS));
    rangeEnd.addAttribute(QName.get("id", W_NS), String.valueOf(commentId));
    paragraph.elements().add(runIndex, rangeEnd);
    runIndex++;

    // 3. åç¼€Runï¼ˆå¦‚æœæœ‰ï¼‰
    if (!suffix.isEmpty()) {
        Element suffixRun = new org.dom4j.tree.DefaultElement(QName.get("r", W_NS));
        setRunText(suffixRun, suffix);
        paragraph.elements().add(runIndex, suffixRun);
    }

    logger.debug("Runåˆ†å‰²å®Œæˆï¼šå‰ç¼€={}, åŒ¹é…={}, åç¼€={}",
               prefix.length(), matched.length(), suffix.length());
}
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### æµ‹è¯•ç”¨ä¾‹1: å•Runå†…åŒ¹é…ï¼ˆæœ€å¸¸è§ï¼‰
```
æ®µè½: "1. æœ¬åˆåŒæœªå°½äº‹å®œï¼ŒåŒæ–¹å¯ç­¾ç½²è¡¥å……åè®®ï¼Œè¡¥å……åè®®ä¸æœ¬åˆåŒå…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›ã€‚"
åŒ¹é…: "æœ¬åˆåŒæœªå°½äº‹å®œï¼ŒåŒæ–¹å¯ç­¾ç½²è¡¥å……åè®®ï¼Œè¡¥å……åè®®ä¸æœ¬åˆåŒå…·æœ‰åŒç­‰æ³•å¾‹æ•ˆåŠ›"
é¢„æœŸ: åªæœ‰åŒ¹é…éƒ¨åˆ†è¢«æ‰¹æ³¨ï¼Œä¸åŒ…æ‹¬"1. "å’Œ"ã€‚"
```

### æµ‹è¯•ç”¨ä¾‹2: å¤šRunåŒ¹é…ï¼ˆé™çº§å¤„ç†ï¼‰
```
è·¨è¶Šå¤šä¸ªRun â†’ é™çº§åˆ°æ®µè½çº§åˆ« â†’ æ•´æ®µè¢«æ‰¹æ³¨ï¼ˆå¯æ¥å—ï¼‰
```

### æµ‹è¯•ç”¨ä¾‹3: è¾¹ç•Œæƒ…å†µ
```
- åŒ¹é…ä»Runå¼€å¤´å¼€å§‹
- åŒ¹é…åˆ°Runæœ«å°¾
- åŒ¹é…å°±æ˜¯æ•´ä¸ªRun
```

---

## ğŸ“Š å½±å“èŒƒå›´

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**:
1. `TextMatchResult.java` - æ·»åŠ å­—æ®µï¼ˆå°æ”¹ï¼‰
2. `PreciseTextAnnotationLocator.java` - è®¡ç®—åç§»ï¼ˆå°æ”¹ï¼‰
3. `WordXmlCommentProcessor.java` - æ ¸å¿ƒé€»è¾‘ï¼ˆå¤§æ”¹ï¼‰

**ä¸éœ€è¦ä¿®æ”¹**:
- JSONé…ç½®ï¼ˆannotate_PRECISE_FIXED.jsonï¼‰- ä¸å˜
- PreciseTextAnnotationLocatorçš„åŒ¹é…é€»è¾‘ - ç»§ç»­ä½¿ç”¨

---

## â±ï¸ å®ç°æ—¶é—´ä¼°è®¡

- ç¬¬1æ­¥: 10åˆ†é’Ÿ
- ç¬¬2æ­¥: 15åˆ†é’Ÿ
- ç¬¬3æ­¥: 30åˆ†é’Ÿ
- ç¬¬4æ­¥: 45åˆ†é’Ÿ
- æµ‹è¯•è°ƒè¯•: 30åˆ†é’Ÿ
- **æ€»è®¡: 2-3å°æ—¶**

---

## ğŸ¯ ä¼˜å…ˆçº§

**é«˜ä¼˜å…ˆçº§** - å¦‚æœå¸Œæœ›ç²¾ç¡®å®šä½çœŸæ­£æœ‰æ•ˆ
- å®ç°æ–¹æ¡ˆCï¼ˆæ··åˆæ³•ï¼‰
- è‡³å°‘å¤„ç†å•Runå†…åŒ¹é…çš„æƒ…å†µ

**ä½ä¼˜å…ˆçº§** - å¦‚æœå½“å‰æ®µè½çº§åˆ«æ‰¹æ³¨å·²å¯æ¥å—
- å¯ä¿æŒç°çŠ¶ï¼Œä¸åšæ”¹è¿›

---

## âœ… æ¨èæ–¹æ¡ˆ

**ä½¿ç”¨æ–¹æ¡ˆ Cï¼ˆæ··åˆæ³•ï¼‰**ï¼š
1. âœ… å®ç° Run åˆ†å‰²é€»è¾‘ï¼ˆå¤„ç†å•Runå†…åŒ¹é…ï¼‰
2. âœ… å¤šRunåŒ¹é…æ—¶è‡ªåŠ¨é™çº§
3. âœ… åŒ¹é…å¤±è´¥æ—¶ä¿æŒç°æœ‰é™çº§é€»è¾‘
4. âœ… ç¡®ä¿ç³»ç»Ÿç¨³å®šï¼Œé€æ­¥ä¼˜åŒ–

è¿™æ ·æ—¢èƒ½å®ç°ç²¾ç¡®å®šä½ï¼Œåˆä¸ä¼šå¼•å…¥è¿‡å¤šå¤æ‚æ€§ã€‚

