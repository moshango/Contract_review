# ChatGPT集成与精确文字批注系统 - 完整指南

> **更新时间**: 2025-10-20
> **版本**: v2.0 - 基于精确文字批注系统升级

## 📋 目录

1. [概述](#概述)
2. [关键更新](#关键更新)
3. [工作流程](#工作流程)
4. [使用指南](#使用指南)
5. [ChatGPT Prompt 最佳实践](#chatgpt-prompt-最佳实践)
6. [常见问题](#常见问题)

## 概述

本系统现已集成**精确文字级别的批注功能**与**ChatGPT网页版**，提供了一个完整的合同AI审查解决方案：

1. **上传合同** → 系统解析并生成ChatGPT专用提示
2. **访问ChatGPT** → 复制提示并获得审查结果（包含精确位置信息）
3. **导入结果** → 系统自动生成精确位置的批注文档

## 关键更新

### v2.0 新增功能

#### 1. ✨ 精确文字级别支持

ChatGPT现在可以指定要批注的**精确文字**，而非整个段落：

```json
{
  "issues": [
    {
      "clauseId": "c1",
      "anchorId": "anc-c1-xxxx",
      "severity": "HIGH",
      "finding": "赔偿责任不明确",
      "suggestion": "应明确赔偿的具体范围",

      "targetText": "甲方应在损害事实发生后30天内承担赔偿责任",
      "matchPattern": "EXACT"
    }
  ]
}
```

#### 2. 📊 前端分析

导入ChatGPT结果时，系统会自动：
- 统计有多少条问题包含了 `targetText` 字段
- 验证 `matchPattern` 是否正确设置
- 输出分析结果到浏览器控制台

#### 3. 🎯 后端增强

ChatGPT提示生成已增强以支持：
- 关键短语提取和显示
- 完整的 targetText 填充说明
- 三种匹配模式（EXACT、CONTAINS、REGEX）的详细说明

## 工作流程

### 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 合同审查流程 v2.0                       │
└─────────────────────────────────────────────────────────────┘

    Step 1: 上传合同文件
         │
         ↓
    ┌─────────────────────────────┐
    │ 系统解析合同                 │
    │ • 提取条款结构               │
    │ • 生成锚点ID                 │
    │ • 提取关键短语               │
    └─────────────────────────────┘
         │
         ↓
    ┌─────────────────────────────┐
    │ 生成ChatGPT专用提示          │
    │ • 条款信息                   │
    │ • 关键短语提示               │
    │ • 精确匹配说明               │
    └─────────────────────────────┘
         │
         ↓
    Step 2: 手动操作（用户在ChatGPT）
    • 访问 https://chatgpt.com/
    • 粘贴提示
    • 获得包含targetText的JSON审查结果
         │
         ↓
    Step 3: 导入结果
    ┌─────────────────────────────┐
    │ 系统分析ChatGPT响应          │
    │ • 验证JSON格式               │
    │ • 统计精确批注比例           │
    │ • 验证targetText字段         │
    └─────────────────────────────┘
         │
         ↓
    ┌─────────────────────────────┐
    │ 生成批注文档                 │
    │ • 精确文字定位               │
    │ • 插入Word批注               │
    │ • 自动降级处理               │
    └─────────────────────────────┘
         │
         ↓
    Step 4: 下载带批注的合同

```

## 使用指南

### 步骤1: 准备和上传

1. 访问系统 → 选择 **💬 ChatGPT集成** 标签页
2. 点击 **📁 选择合同文件** 上传 `.docx` 格式的合同
3. 选择合同类型（技术服务、保密协议等）
4. 点击 **🤖 生成ChatGPT提示**

**系统会自动**：
- 解析合同条款
- 生成锚点ID
- 提取关键短语
- 生成专用提示

### 步骤2: ChatGPT审查（手动）

#### 2.1 查看生成的提示

系统会显示：
- 📋 使用步骤说明
- 🤖 完整的ChatGPT提示内容

#### 2.2 复制提示并访问ChatGPT

1. 点击 **📋 复制提示**
2. 点击 **🌐 打开ChatGPT** （或手动访问 https://chatgpt.com/）
3. 在ChatGPT对话框中粘贴提示
4. 等待ChatGPT返回审查结果

**重要**：确保ChatGPT返回的是**JSON格式**的审查结果！

### 步骤3: 导入审查结果

1. 复制ChatGPT返回的完整JSON（包括开头的 ```json 和结尾的 ```）
2. 粘贴到 **📥 ChatGPT审查结果** 文本框
3. **可选**：勾选 "批注完成后清理锚点"（清理文档中的临时标记）
4. 点击 **📥 导入并生成批注文档**

**系统会自动**：
- 清理Markdown代码块标记
- 验证JSON格式
- **分析精确文字批注支持情况** ✨
- 输出分析结果到浏览器控制台（F12查看）
- 生成批注文档
- 下载文件

### 步骤4: 检查结果

1. 检查下载的文件：`contract_ChatGPT审查.docx`
2. 打开Word文件查看批注
3. 验证批注位置的精确性

## ChatGPT Prompt 最佳实践

### 理解生成的提示格式

系统生成的提示包含以下关键部分：

#### 部分1：任务描述
```markdown
# 合同审查任务

你是一名专业的法律顾问，请帮我审查以下合同内容。
```

#### 部分2：合同信息
```markdown
## 合同信息
- **文件名**: contract.docx
- **合同类型**: 技术服务合同
- **条款总数**: 12
```

#### 部分3：合同条款（包含关键短语）
```markdown
### 条款 1 (ID: c1)
**标题**: 合作范围
**内容**: 甲乙双方在以下范围内进行合作...
**锚点ID**: anc-c1-xxxx
**关键短语（用于精确定位批注）**: 甲乙双方在以下范围内 | 进行合作 | 共同承担
```

#### 部分4：输出要求（支持精确匹配）
```json
{
  "issues": [
    {
      "clauseId": "条款ID",
      "anchorId": "锚点ID",
      "severity": "HIGH/MEDIUM/LOW",
      "category": "问题类别",
      "finding": "发现的具体问题",
      "suggestion": "修改建议",
      "targetText": "【重要】发现问题的确切文字（从条款内容中精确复制）",
      "matchPattern": "【建议】EXACT(精确匹配/默认) | CONTAINS(包含匹配) | REGEX(正则表达式)"
    }
  ]
}
```

### 如何让ChatGPT填充 targetText

#### 方法1：精确复制（推荐）

当ChatGPT发现某句话有问题时，让它从条款中**精确复制**这句话到 `targetText`：

```
问题：赔偿责任条款表述模糊
找到的原文：甲方应在损害事实发生后30天内承担赔偿责任
targetText: "甲方应在损害事实发生后30天内承担赔偿责任"
matchPattern: "EXACT"
```

#### 方法2：关键词提取

对于长句子，可以使用关键词组成的短语：

```
原文：甲方需要在收到乙方书面通知后的十个工作日内...
提取关键词：十个工作日内
targetText: "十个工作日内"
matchPattern: "CONTAINS"
```

#### 方法3：正则表达式

对于动态内容，使用正则表达式：

```
原文：合同有效期为2025年1月1日至2026年1月1日
正则：\d{4}年\d{1,2}月\d{1,2}日至\d{4}年\d{1,2}月\d{1,2}日
targetText: "\\d{4}年\\d{1,2}月\\d{1,2}日至\\d{4}年\\d{1,2}月\\d{1,2}日"
matchPattern: "REGEX"
```

### 优化提示的建议

1. **明确目标**：开头写明"请生成包含 targetText 的结果"
2. **示例充分**：提供几个 targetText 的示例
3. **格式严格**：强调必须使用JSON格式
4. **精确要求**：说明 targetText 必须从原文中复制

**增强提示示例**：

```
请审查这份合同。对于每个发现的问题，请：
1. 从合同原文中找到相关的具体文字
2. 将完整的句子或短语复制到 targetText 字段
3. 为 targetText 选择合适的匹配模式（EXACT/CONTAINS/REGEX）

示例：
- 如果问题是"赔偿责任不清晰"，targetText应该是合同中有关赔偿的那句话
- 如果是找到了那句话，matchPattern用EXACT
- 如果只是关键词，matchPattern用CONTAINS
```

## 前端分析功能

### 浏览器控制台输出

导入ChatGPT结果时，系统会在浏览器控制台（F12打开）输出：

```
精确文字批注支持: 8/10 条问题 (80%)
```

这表示：
- 总共 10 条问题
- 8 条包含了有效的 targetText
- 2 条需要降级处理（使用段落级别批注）

### 自动验证

系统会检查：
- ✅ targetText 是否为空
- ✅ matchPattern 是否设置（未设置时默认为EXACT）
- ✅ matchPattern 值是否有效
- ✅ JSON 格式是否正确

## 常见问题

### Q1: ChatGPT返回的不是JSON怎么办？

**A**:
1. 要求ChatGPT重新输出JSON格式
2. 或手动从ChatGPT回复中提取JSON部分
3. 系统支持自动清理 ```json 代码块

示例：如果ChatGPT回复是：
```
好的，以下是审查结果：
```json
{...}
```
```

系统会自动提取中间的JSON部分。

### Q2: targetText 无法精确匹配怎么办？

**A**: 有三个降级方案：

1. **使用CONTAINS匹配**
   ```json
   {
     "targetText": "赔偿责任",
     "matchPattern": "CONTAINS"
   }
   ```

2. **使用REGEX正则匹配**
   ```json
   {
     "targetText": "赔偿.*责任",
     "matchPattern": "REGEX"
   }
   ```

3. **不提供targetText**（系统使用段落级别批注）
   ```json
   {
     "finding": "赔偿责任不清晰"
     // 不包含targetText字段
   }
   ```

### Q3: 同一个词出现多次，如何指定批注哪个？

**A**: 使用 `matchIndex` 字段：

```json
{
  "targetText": "甲方",
  "matchPattern": "CONTAINS",
  "matchIndex": 1  // 第1个"甲方"
}
```

如果有多个问题涉及不同位置的"甲方"：
```json
[
  {
    "finding": "第一处有问题",
    "targetText": "甲方",
    "matchPattern": "CONTAINS",
    "matchIndex": 1
  },
  {
    "finding": "第二处有问题",
    "targetText": "甲方",
    "matchPattern": "CONTAINS",
    "matchIndex": 2
  }
]
```

### Q4: 可以同时使用多个AI服务吗？

**A**: 本版本主要支持ChatGPT网页版。其他AI服务（Claude、OpenAI、豆包）通过 `/auto-review` 接口提供。

两个工作流程是**平行的**：
- **ChatGPT集成** (`/chatgpt/`)：手动提交ChatGPT结果
- **自动化审查** (`/auto-review/`)：自动调用配置的AI服务

### Q5: 批注没有生成在正确的位置？

**A**: 这通常是因为：

1. **targetText拼写错误**
   - 检查原文中的确切文字
   - 注意标点符号、空格

2. **文字在多个地方出现**
   - 使用 `matchIndex` 指定位置
   - 或使用更具体的 targetText

3. **使用了REGEX但正则不匹配**
   - 在线测试你的正则表达式
   - 注意Java正则语法

**调试步骤**：
1. 打开下载的文件查看批注位置
2. 检查浏览器控制台的精确文字批注统计
3. 对比原文和targetText是否一致
4. 调整matchPattern重新导入

### Q6: 如何确保最高的精确度？

**A**: 遵循以下最佳实践：

1. ✅ **使用EXACT模式**：最准确
   ```json
   {
     "targetText": "完整的句子，包括标点",
     "matchPattern": "EXACT"
   }
   ```

2. ✅ **从原文精确复制**：确保文字完全相同
3. ✅ **避免过短的关键词**：容易误匹配
4. ✅ **验证锚点是否正确**：重要的定位基础
5. ✅ **检查文档格式**：确保是标准.docx文件

## 技术细节

### 后端更新（ChatGPTWebReviewServiceImpl）

新增功能：
- 关键短语提取 (`extractKeyPhrases`)
- 精确匹配说明文档
- targetText 和 matchPattern 的提示

### 前端更新（main.js）

新增函数：
- `analyzePreciseAnnotationSupport()` - 分析精确文字支持情况
- 增强的 `importChatGPTResult()` - 验证和分析
- 增强的 `showChatGPTImportResult()` - 显示统计信息

### 编译验证

✅ 所有更新已通过编译验证

## 总结

新版本的ChatGPT集成已完全支持精确文字级别的批注！

**关键优势**：
- 🎯 精确批注定位
- 📊 自动分析和统计
- 🔄 灵活的匹配模式
- ⚡ 自动降级处理
- 💡 完整的使用提示

**立即开始**：
1. 上传合同
2. 复制提示给ChatGPT
3. 导入结果
4. 获得精确批注文档！

---

**需要帮助？** 检查浏览器控制台的分析输出和日志信息。

