# 合同审查系统 - Maven 构建问题解决方案

**问题**: `mvn clean package -DskipTests` 失败，提示文件被占用
```
Failed to delete D:\...\Contract_review-0.0.1-SNAPSHOT.jar:
另一个程序正在使用此文件，进程无法访问。
```

**根本原因**: MINGW64 环境中存在僵尸进程（Zombie Process）- Java 进程无法通过标准 bash/cmd 命令正常终止

---

## 解决方案优先级

### ✅ 方案1: 增量构建（推荐 - 立即可用）

**原理**: 跳过 `clean` 阶段，直接执行 `package` 步骤
**优点**: 无需终止进程，无需 Windows Task Manager 干预
**缺点**: 使用增量编译，可能不会重新编译所有文件

**执行方法**:

```bash
# 1. 进入项目目录
cd /d "D:\工作\合同审查系统开发\spring boot\Contract_review"

# 2. 执行增量构建（不使用 clean）
mvn package -DskipTests

# 3. 验证 JAR 生成
ls -lh target/Contract_review-0.0.1-SNAPSHOT.jar
```

**预期输出**:
```
[INFO] Building jar: D:\...\target\Contract_review-0.0.1-SNAPSHOT.jar
[INFO] BUILD SUCCESS
```

---

### 📋 方案2: 手动清理后构建（需要 Windows Task Manager）

**执行步骤**:

#### Step 1: 打开 Windows 任务管理器

1. 按 `Ctrl + Shift + Esc` 或
2. 右键点击任务栏 → 任务管理器

#### Step 2: 查找并终止 Java 进程

1. 点击 "进程" 标签页
2. 在搜索框中输入 "java"
3. 找到所有 "java.exe" 进程（可能有多个）
4. 一个一个选中后，点击 "结束任务" 按钮

**关键信息**:
- 进程名称: `java.exe`
- 占用端口: 8080, 9999
- 识别方式: 看命令行中是否包含 "Contract_review"

#### Step 3: 验证端口已释放

```bash
netstat -ano | findstr "8080"
```

预期结果: **无输出**（表示端口已释放）

#### Step 4: 执行完整构建

```bash
cd /d "D:\工作\合同审查系统开发\spring boot\Contract_review"

# 现在可以使用 clean
mvn clean package -DskipTests
```

---

### 🔧 方案3: 使用改进的批处理脚本（完全自动化）

**脚本名称**: `完整构建和启动.bat`

**使用方法**: 在项目根目录双击运行

**脚本功能**:
1. 通过 Windows Task Manager API 强制终止所有 Java 进程
2. 等待端口释放
3. 执行 `mvn clean package -DskipTests`
4. 验证 JAR 生成成功
5. 自动启动应用到 8080 端口

---

## 立即采取的行动

### 第1步: 尝试增量构建（60秒解决）

```bash
cd /d "D:\工作\合同审查系统开发\spring boot\Contract_review"
mvn package -DskipTests
echo "✅ 增量构建完成"
```

### 第2步: 如果第1步失败，使用 Windows Task Manager

1. 按 `Ctrl + Shift + Esc` 打开任务管理器
2. 找到并终止所有 `java.exe` 进程
3. 再次运行: `mvn clean package -DskipTests`

### 第3步: 验证构建成功

```bash
# 检查 JAR 是否有效
jar -tf target/Contract_review-0.0.1-SNAPSHOT.jar | head -20

# 检查 Main-Class 是否存在
unzip -p target/Contract_review-0.0.1-SNAPSHOT.jar META-INF/MANIFEST.MF | grep -i main
```

预期输出:
```
Main-Class: org.springframework.boot.loader.launch.JarLauncher
Start-Class: com.example.Contract_review.ContractReviewApplication
```

### 第4步: 启动应用

```bash
java -jar target/Contract_review-0.0.1-SNAPSHOT.jar
```

---

## 诊断信息

### MINGW64 环境已知问题

- **症状**: 通过 `kill -9` 无法终止 Java 进程，该进程变成"僵尸进程"
- **原因**: MINGW64 中 bash 的 shell 实现与 Windows 进程模型的兼容性问题
- **受影响版本**: Git Bash 3.x 系列通常会出现此问题
- **解决方案**: 使用原生 Windows 命令 (`taskkill`) 或 Windows Task Manager

### 运行中的僵尸进程

当前被占用的端口:
- **8080**: PID 25640 (Contract_review-0.0.1-SNAPSHOT.jar)
- 状态: 无法通过标准方式终止

### 为什么 `taskkill /F /IM java.exe` 不起作用

1. PID 25640 对应的 Java 进程已变成"僵尸"状态
2. 进程的父进程已被杀死，但进程本身未被清理
3. 该进程仍然持有文件锁，阻止 Maven 的清理操作
4. Windows Task Manager 可以强制终止该进程（因为它使用不同的 API 调用）

---

## 下一步检查清单

- [ ] 确认已尝试 **增量构建** (`mvn package -DskipTests`)
- [ ] 如果失败，使用 **Windows Task Manager** 终止 Java 进程
- [ ] 验证 **JAR 文件生成**
- [ ] 检查 **MANIFEST.MF** 中的 Main-Class
- [ ] 成功 **启动应用** 到 8080 端口
- [ ] 验证 `/chatgpt/generate-prompt` 端点可用

---

## 参考资源

- **Maven 官方文档**: https://maven.apache.org/guides/index.html
- **Spring Boot 打包指南**: https://spring.io/guides/gs/spring-boot/
- **OOXML 批注格式**: https://learn.microsoft.com/en-us/openspecs/office_standards/ms-docx/
