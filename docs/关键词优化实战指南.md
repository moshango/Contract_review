# 关键词优化实战指南

## 🎯 目标

通过优化 `rules.xlsx` 中的关键词配置，提高规则审查的**命中率**（Recall）和**精确度**（Precision）。

---

## 📊 优化前后对比示例

### 场景 1: 支付条款规则

#### ❌ 优化前（命中率低）

| 字段 | 值 |
|------|-----|
| keywords | `支付方式` |
| regex | (空) |

**问题分析**:
- 只能匹配包含"支付方式"的条款
- 无法匹配"付款方式"、"款项支付"、"支付周期"等同义表述
- 命中率约 **30-40%**

**未命中的真实例子**:
```
条款文本: "甲方应在收货后15天内支付货款"
❌ 不匹配 (没有"支付方式"这个词组)

条款文本: "付款方式为银行转账"
❌ 不匹配 (用的是"付款"而不是"支付")

条款文本: "支付周期为月结"
❌ 不匹配 (有"支付"但没有"方式")
```

#### ✅ 优化后（命中率高）

| 字段 | 值 |
|------|-----|
| keywords | `支付;付款;款项;周期;结算;转账;汇款;支付方式;付款条件;支付周期;付款周期` |
| regex | `(支付\|付款).*天` |

**优化效果**:
- 涵盖所有常见同义词
- 支持灵活的表述方式
- 命中率约 **85-95%**

**现在能匹配的例子**:
```
条款文本: "甲方应在收货后15天内支付货款"
✅ 匹配 (包含"支付"和"周期" → keywords 命中)

条款文本: "付款方式为银行转账"
✅ 匹配 (包含"付款" → keywords 命中)

条款文本: "支付周期为月结"
✅ 匹配 (包含"支付周期" → keywords 命中)

条款文本: "乙方在收票后五天转账付款"
✅ 匹配 (包含"转账"、"付款" → keywords 命中)
```

---

### 场景 2: 违约责任规则

#### ❌ 优化前

| 字段 | 值 |
|------|-----|
| keywords | `违约责任` |
| regex | (空) |

**问题**:
- 词汇过于复合，容易失配
- 不能匹配仅含"违约"的条款

#### ✅ 优化后

| 字段 | 值 |
|------|-----|
| keywords | `违约;毁约;责任;赔偿;违反;不履行;违约金;违约责任;违约条款` |
| regex | `(违约\|毁约\|违反).*(?:责任\|赔偿)` |

**优化原理**:
- 先用 `keywords` 做广泛召回
- 用 `regex` 精筛"违约 + 责任/赔偿"的组合

**匹配能力**:
```
✅ "一方违反本协议" (keywords: 违反)
✅ "甲方毁约应承担赔偿责任" (keywords: 毁约 → regex: (毁约).*赔偿)
✅ "违约方应支付违约金" (keywords: 违约金)
✅ "乙方不履行合同" (keywords: 不履行)
```

---

### 场景 3: 保密条款规则

#### ❌ 优化前

| 字段 | 值 |
|------|-----|
| keywords | `保密条款` |
| regex | (空) |

**失配例子**:
```
❌ "本合同涉及商业秘密的保护" (没有"条款")
❌ "保密期为五年" (关键词是"期限"不是"条款")
❌ "秘密信息应予保密" (没有"保密条款")
```

#### ✅ 优化后

| 字段 | 值 |
|------|-----|
| keywords | `保密;秘密;机密;保密期;保密条款;保密信息;商业秘密;保护;隐私` |
| regex | `保密.*(?:\d+年\|\d+个月\|期限)` |

**匹配能力提升**:
```
✅ "本合同涉及商业秘密" (keywords: 商业秘密)
✅ "保密期为五年" (keywords: 保密期)
✅ "秘密信息应予保密" (keywords: 秘密 + 保密)
✅ "保密期限自合同生效起五年内有效" (keywords: 保密 + regex: 保密.*年)
```

---

## 🔧 如何编辑 rules.xlsx

### 方法 1: 使用 Excel 或 LibreOffice Calc

1. 打开文件:
   ```
   src/main/resources/review-rules/rules.xlsx
   ```

2. 找到需要优化的规则所在行

3. 编辑第 4 列（keywords）:
   ```
   旧: 违约责任
   新: 违约;毁约;责任;赔偿;违反;不履行;违约金;违约责任;违约条款
   ```

4. 编辑第 5 列（regex）：
   ```
   (违约|毁约|违反).*(?:责任|赔偿)
   ```

5. **保存并关闭**

### 方法 2: 保存后立即生效（无需重启）

调用 API 重新加载规则：

```bash
curl -X POST http://localhost:8080/api/review/reload-rules

# 返回例子：
# {
#   "success": true,
#   "message": "规则已重新加载",
#   "ruleCount": 45
# }
```

---

## 📈 关键词优化清单

为了系统地优化规则，使用以下清单：

### 步骤 1: 审视现有规则

```checklist
☐ 查找所有 keywords 列不为空的规则
☐ 识别**复合词汇**（如"违约责任"、"保密条款"）
☐ 识别**表述单一**的规则（只有一个关键词）
```

### 步骤 2: 补充同义词

```checklist
☐ 对于"支付"相关: 添加 付款、款项、结算、转账、汇款
☐ 对于"违约"相关: 添加 毁约、违反、不履行、责任、赔偿
☐ 对于"保密"相关: 添加 秘密、机密、隐私、保护
☐ 对于"知识产权"相关: 添加 专利、著作权、商标、IP
☐ 对于"终止"相关: 添加 解除、中止、终约、解约
```

### 步骤 3: 设计正则表达式

```checklist
☐ 识别需要**条件匹配**的规则（如"支付" + "数字" + "天")
☐ 编写正则表达式测试
☐ 在规则中添加 regex 列数据
```

### 步骤 4: 验证效果

```checklist
☐ 使用测试合同验证规则命中率
☐ 检查是否存在**误匹配**（不应该匹配的被匹配了）
☐ 检查是否存在**漏匹配**（应该匹配的没匹配）
```

---

## 🎓 推荐的优化原则

### 原则 1: 从具体到通用

```
❌ 差: 支付方式
✅ 好: 支付;付款;支付方式;付款方式;支付周期;付款周期
```

### 原则 2: 拆分复合词汇

```
❌ 差: 违约责任;违约条款;违约金
✅ 好: 违约;毁约;责任;条款;金;赔偿
     (这样"违反责任"、"毁约金"也能匹配)
```

### 原则 3: 用正则处理动态内容

```
❌ 差: keywords: 支付30天;支付15天;支付10天
✅ 好: keywords: 支付;期限;天数
      regex: 支付.*\d+.*天
```

### 原则 4: 考虑容易误匹配的词

```
⚠️  小心使用太通用的词汇:
    - "和" (中文很多句子都有，会导致过度匹配)
    - "条" (通常来自"第X条")
    - "应" (几乎所有义务都说"应...")
```

---

## 🧪 测试优化效果

### 测试方法 1: 手动调用规则审查 API

```bash
curl -X POST http://localhost:8080/api/review/analyze \
  -F "file=@test-contract.docx" \
  -F "contractType=采购合同"

# 检查返回的 matchResults 中匹配到的规则数量
```

### 测试方法 2: 查看日志

重启应用后，查看启动日志中的规则加载信息：

```
Successfully loaded 45 rules from src/main/resources/review-rules/rules.xlsx
Loaded rule: id=rule_2, risk=high, keywords=违约;毁约;责任
Loaded rule: id=rule_3, risk=high, keywords=支付;付款;周期;结算
...
```

### 测试方法 3: 前端界面验证

1. 打开 http://localhost:8080/
2. 上传测试合同
3. 点击"规则审查"
4. 查看匹配的规则数量是否增多

---

## 📋 常见关键词库（快速复用）

### 支付相关
```
支付;付款;款项;周期;结算;转账;汇款;支付方式;付款方式;
支付周期;付款周期;支付条件;付款条件;支付时间;付款时间;
结账;结清;清偿;汇兑;电汇
```

### 违约相关
```
违约;毁约;违反;不履行;违约金;违约责任;违约条款;
责任;赔偿;损失;赔偿金;违约方;债务;义务;
承担;承诺;不能;无法;失败;不达;不符
```

### 保密相关
```
保密;秘密;机密;隐私;保护;保密期;保密条款;
商业秘密;保密信息;秘密信息;机密信息;隐私信息;
泄露;公开;披露;保护措施;保密义务;保密责任
```

### 知识产权相关
```
知识产权;专利;著作权;商标;IP;版权;商业秘密;
技术秘密;专有信息;创新;发明;设计;作品;
许可;授权;代理;使用权;所有权;权利;侵权
```

### 终止/解除相关
```
终止;解除;中止;终约;解约;提前;合同期;期限;
有效期;续签;续期;到期;届满;失效;无效;
注销;取消;撤销;申请;通知;声明
```

---

## ⚠️ 常见陷阱

### 陷阱 1: 关键词太通用导致过度匹配

❌ 错误:
```
keywords: 和;或;应;可;应该
```

这会导致几乎所有条款都被匹配到。

✅ 正确:
```
keywords: 合作范围;合作内容;合作方式;技术合作
```

### 陷阱 2: 关键词格式错误

❌ 错误:
```
keywords: 支付, 付款, 周期
(使用逗号分隔)
```

✅ 正确:
```
keywords: 支付;付款;周期
(使用分号分隔)
```

### 陷阱 3: 正则表达式语法错误

❌ 错误:
```
regex: (支付|付款.*天
(括号不匹配)
```

✅ 正确:
```
regex: (支付|付款).*\d+.*天
```

### 陷阱 4: 忽略中英文差异

❌ 易出现:
```
keywords: liability;责任
```

在中英混合的合同中可能导致混淆。

✅ 建议:
```
keywords: 责任;损害赔偿;违约赔偿
```

---

## 📊 优化效果评估指标

| 指标 | 计算方法 | 目标 |
|------|--------|------|
| **命中率 (Recall)** | 实际匹配规则数 / 应该匹配的规则数 | > 80% |
| **精确度 (Precision)** | 正确匹配的规则 / 实际匹配的规则数 | > 90% |
| **F1 Score** | 2 × (Precision × Recall) / (Precision + Recall) | > 0.85 |

---

## 🚀 最佳实践总结

1. **优先优化 keywords**（性能好、维护简单）
2. **用 regex 补充 keywords 无法表达的情况**
3. **定期用实际合同测试规则效果**
4. **建立关键词库，便于复用**
5. **避免过度匹配和模糊匹配**

---

## 📞 技术支持

如果优化后的规则仍然无法匹配，请：

1. 检查规则的 `contract_types` 是否与上传合同类型匹配
2. 查看后台日志是否有规则编译错误
3. 确认关键词是否使用分号 (`;`) 分隔

---

**文档版本**: 1.0
**最后更新**: 2025-10-24
**作者**: Claude Code
