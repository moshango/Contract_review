# 关键词匹配问题修复指南

## 快速修复步骤

### 问题概述
- 用户上传文档包含"违约"关键词，但系统未能匹配
- 根本原因：规则表中的关键词是"违约**责任**"，而文档只有"违约"
- 系统使用 `substring.contains()` 进行匹配，因此"违约"与"违约责任"不匹配

---

## 方案 A：修改规则配置（最推荐 ⭐⭐⭐）

### 操作步骤

#### Step 1: 打开规则文件

```bash
# 使用Excel打开规则文件
src/main/resources/review-rules/rules.xlsx
```

#### Step 2: 定位违约责任规则

- 打开 Sheet1
- 找到第 3 行（第一行是表头，第二行是付款条款）
- 该行的标题应该是"违约责任"

| 行号 | Column A | Column D (Keywords) |
|------|----------|-------------------|
| 1 | contract_types | keywords (表头) |
| 2 | 采购;外包;通用合同 | 付款方式;支付周期;付款条件 |
| **3** | **采购;外包;通用合同** | **违约责任;逾期;赔偿** ← 修改这里 |

#### Step 3: 修改关键词

**原值**：
```
违约责任;逾期;赔偿
```

**新值**：
```
违约;逾期;赔偿
```

**说明**：
- 删除"违约责任"中的"责任"二字，改为仅"违约"
- 这样就能匹配文档中出现的单独"违约"词语
- 保留其他两个关键词"逾期"和"赔偿"不变

#### Step 4: 保存文件

- `Ctrl+S` 或 `Command+S` 保存
- 确保文件格式仍为 .xlsx

#### Step 5: 重新加载规则

方式一：使用 API 端点
```bash
curl -X POST http://localhost:8080/api/review/reload-rules
```

方式二：查看 API 响应
```bash
curl -X POST http://localhost:8080/api/review/reload-rules | jq .
```

预期响应：
```json
{
  "success": true,
  "message": "规则已重新加载",
  "totalRules": 16
}
```

#### Step 6: 验证修复

重新上传相同的合同文档：
```bash
curl -X POST "http://localhost:8080/api/review/analyze?contractType=通用合同" \
  -F "file=@contract.docx"
```

检查返回的 `prompt` 字段中是否包含"【违约责任】"相关的审查要点。

---

## 方案 B：代码层面改进（可选，进阶）

如果要从代码层面优化关键词匹配，可以考虑以下改进：

### 改进 1：支持子词匹配

修改 `ReviewRule.java` 的 `matches()` 方法，支持更灵活的匹配：

```java
public boolean matches(String text) {
    if (text == null || text.trim().isEmpty()) {
        return false;
    }

    this.matchedKeywords = new java.util.ArrayList<>();

    // 方案 1：保留原有的完整词匹配
    String[] keywordList = getKeywordList();
    for (String keyword : keywordList) {
        String trimmedKeyword = keyword.trim();
        if (text.contains(trimmedKeyword)) {
            this.matchedKeywords.add(trimmedKeyword);
        }
    }

    // 方案 2（新增）：如果完整词没有匹配，尝试检查关键词的前缀
    // 例如："违约责任" 的前缀 "违约" 也能匹配
    if (this.matchedKeywords.isEmpty()) {
        for (String keyword : keywordList) {
            String trimmedKeyword = keyword.trim();
            // 检查关键词的每个字都在文本中出现
            boolean allCharsPresent = true;
            for (char c : trimmedKeyword.toCharArray()) {
                if (!text.contains(String.valueOf(c))) {
                    allCharsPresent = false;
                    break;
                }
            }
            if (allCharsPresent) {
                this.matchedKeywords.add(trimmedKeyword + "(前缀匹配)");
            }
        }
    }

    if (!this.matchedKeywords.isEmpty()) {
        return true;
    }

    // 其余逻辑保持不变...
    return false;
}
```

**注意**：这种改进可能导致误匹配，因此**不推荐**在当前系统中使用。

### 改进 2：添加配置文件支持关键词映射

可以创建一个映射文件，支持关键词同义词：

```
src/main/resources/keyword-mapping.properties

# 违约相关
违约责任=违约,逾期责任
违约金=违约,赔偿,罚款

# 付款相关
付款方式=支付方式,付款
付款周期=支付周期,支付期限
```

然后在加载关键词时展开这些映射。

**推荐指数**：⭐⭐（中等）

---

## 对其他关键词的检查建议

完整的规则表关键词检查清单：

| Rule # | 规则名 | 关键词 | 评估 | 建议 |
|--------|--------|--------|------|------|
| 1 | 付款条款 | 付款方式;支付周期;付款条件 | ✅ 较完整 | 可添加"支付方式" |
| **2** | **违约责任** | **违约责任;逾期;赔偿** | ❌ 需改进 | **改为：违约;逾期;赔偿** |
| 3 | 保密条款 | 保密;机密;保密期 | ✅ 可以 | 可添加"保密条款" |
| 4 | 管辖与仲裁 | 管辖;仲裁;司法管辖 | ✅ 可以 | - |
| 5 | 不可抗力 | 不可抗力;力量;天灾 | ⚠️ "力量"过宽 | 考虑修改为"自然灾害;战争" |
| 6 | 价格调整 | 价格调整;价格变动;成本 | ✅ 可以 | - |
| 7 | 发票税务 | 发票;税票;增值税 | ✅ 可以 | - |
| 8 | 验收交付 | 验收;交付;交收 | ✅ 可以 | 可添加"验收标准" |
| 9 | 知识产权 | 知识产权;著作权;专利 | ✅ 较完整 | - |
| 10 | 保险责任 | 保险;责任险 | ✅ 可以 | - |
| 11 | 变更修改 | 变更;修改;补充 | ✅ 可以 | - |
| 12 | 终止解除 | 终止;解除;提前终止 | ✅ 可以 | - |
| 13 | 质量保证 | 质量保证;性能 | ⚠️ 较宽泛 | 改为"质量保证;保修;保证期" |
| 14 | 费用成本 | 费用;成本;报价;价格 | ✅ 较完整 | - |
| 15 | 生效期限 | 生效;签署;有效期 | ✅ 可以 | - |

---

## 修复后的测试清单

修改完成后，按以下清单验证：

```
□ Step 1: 保存 rules.xlsx 文件
□ Step 2: 调用 /api/review/reload-rules 接口
□ Step 3: 收到 success: true 的响应
□ Step 4: 上传包含"违约"关键词的测试合同
□ Step 5: 检查返回的 prompt 中包含"违约责任"规则
□ Step 6: 确认 Prompt 中显示对甲方和乙方的建议
□ Step 7: 验证 matchedKeywords 包含"违约"
```

---

## 相关文件和代码位置

| 文件/类 | 位置 | 关键代码 | 说明 |
|--------|------|---------|------|
| 规则表 | `src/main/resources/review-rules/rules.xlsx` | 第 3 行，Column D | 需修改的文件 |
| 规则加载器 | `ReviewRulesService.java` | `loadRules()` 方法 | 负责加载规则 |
| 规则模型 | `ReviewRule.java` | `matches()` 方法 (行 180-231) | 包含关键词匹配逻辑 |
| 控制器 | `ApiReviewController.java` | `/api/review/analyze` (行 71-238) | 处理文档上传和规则匹配 |
| Prompt 生成器 | `PromptGeneratorNew.java` | `generateFullPrompt()` | 将匹配的规则编入 Prompt |

---

## 常见问题 Q&A

**Q1: 修改了关键词后，规则会立即生效吗？**
A: 不会。需要调用 `/api/review/reload-rules` 接口重新加载规则，或重启应用。

**Q2: 如果我改成"违约"，会不会匹配太多不相关的文本？**
A: 这是一个有效的考虑。系统还有正则表达式作为第二层精筛（`违约.*赔偿|赔偿.*\d+%`），可以进一步过滤。

**Q3: 为什么不修改代码而要修改 Excel？**
A: 因为：
- Excel 更容易修改和维护
- 不需要重新编译和部署
- 支持动态更新，无需重启服务
- 业务人员可以直接管理规则，无需技术人员介入

**Q4: 其他规则的关键词也有这个问题吗？**
A: 可能有。建议逐条检查，并根据实际合同内容调整。

**Q5: 如何知道某个关键词是否合适？**
A: 方法：
1. 收集真实合同样本
2. 检查合同中实际出现的词语
3. 与规则关键词对比
4. 不断迭代优化

---

## 后续改进建议

1. **建立关键词评估流程**
   - 定期从实际合同中提取词频
   - 与规则库关键词对比
   - 动态调整规则配置

2. **添加更多规则**
   - 担保和担保责任
   - 数据隐私与信息安全
   - 合规与法律风险
   - 风险转移与保险

3. **改进关键词匹配算法**
   - 支持正则表达式关键词
   - 支持关键词权重
   - 支持同义词库

4. **建立规则版本管理**
   - 记录规则修改历史
   - 支持规则回滚
   - 追踪规则的有效性

---

## 修复验证示例

### 修复前的现象

上传合同，显示：
```
没有检出包含"违约"的规则
```

### 修复后的现象

上传相同合同，显示：
```json
{
  "matchResults": [
    {
      "clauseId": "c5",
      "heading": "第五条 违约责任",
      "matchedRules": [
        {
          "id": "rule_3",
          "risk": "high",
          "keywords": "违约;逾期;赔偿",
          "checklist": "1. 确认违约金额度\n2. 评估赔偿条件\n3. 检查责任限制"
        }
      ]
    }
  ],
  "prompt": "...【审查要点】...违约...【立场建议】建议甲方明确违约金额度..."
}
```

---

## 总结

| 步骤 | 操作 | 耗时 |
|------|------|------|
| 1 | 打开 rules.xlsx | 1 分钟 |
| 2 | 修改"违约责任"为"违约" | 1 分钟 |
| 3 | 保存文件 | 1 分钟 |
| 4 | 调用 /reload-rules API | 1 分钟 |
| 5 | 测试验证 | 2 分钟 |
| **总计** | | **6 分钟** |

**预期收益**：✅ 系统能够正确匹配文档中"违约"相关的内容

---

**最后更新**：2025-10-23  
**修复状态**：待用户执行  
**优先级**：高（用户反馈）
