# 关键词匹配问题 - 完整分析与解决方案

## 📋 问题概述

**用户报告**：上传文档中有提到"违约"，但审查prompt没有命中该关键词

**诊断结果**：✅ 问题已确认，根因已找到，解决方案可行

---

## 🔍 根本原因

### 问题本质

| 方面 | 描述 |
|------|------|
| **规则配置** | 关键词是"**违约责任**"（2个字） |
| **文档内容** | 出现的是"**违约**"（1个字） |
| **匹配算法** | 使用 `substring.contains()` 进行完全匹配 |
| **匹配结果** | ❌ `"违约内容".contains("违约责任")` = false |

### 问题发生位置

```
ReviewRule.java, line 192:
if (text.contains(trimmedKeyword)) {  // ← 这里使用完全匹配
    this.matchedKeywords.add(trimmedKeyword);
}
```

### 规则库现状

✅ **确认**：违约关键词**已存在**于规则库中

```
规则 2 - 违约责任（Rule 2）
├─ 关键词: "违约责任;逾期;赔偿"
├─ 正则: "违约.*赔偿|赔偿.*\d+%"
├─ 风险: HIGH
├─ 建议A: 建议甲方明确违约金额度，保护自身权益
└─ 建议B: 乙方应争取合理的违约金限额
```

---

## ✅ 解决方案

### 推荐方案：修改规则表（⭐⭐⭐）

**操作**：将第 3 行的关键词从 `违约责任;逾期;赔偿` 改为 `违约;逾期;赔偿`

**优点**：
- ✅ 实现简单（仅需编辑 Excel）
- ✅ 无需重新编译或部署
- ✅ 支持动态加载（调用 `/api/review/reload-rules`）
- ✅ 业务人员可直接管理规则

**操作时间**：5 分钟

### 详细步骤

1. **打开规则文件**
   ```
   src/main/resources/review-rules/rules.xlsx
   ```

2. **定位到第 3 行**（违约责任规则）

3. **修改 Column D（Keywords）**
   ```
   原值：违约责任;逾期;赔偿
   新值：违约;逾期;赔偿
   ```

4. **保存文件**（保持 .xlsx 格式）

5. **重新加载规则**
   ```bash
   curl -X POST http://localhost:8080/api/review/reload-rules
   ```

6. **验证修复**
   ```bash
   curl -X POST "http://localhost:8080/api/review/analyze?contractType=通用合同" \
     -F "file=@contract.docx"
   ```

---

## 📊 规则库完整列表

| # | 规则名 | 关键词 | 风险 | 状态 |
|---|--------|--------|------|------|
| 1 | 付款条款 | 付款方式;支付周期;付款条件 | HIGH | ✅ |
| **2** | **违约责任** | **违约责任;逾期;赔偿** | **HIGH** | ⚠️ 需改进 |
| 3 | 保密条款 | 保密;机密;保密期 | HIGH | ✅ |
| 4 | 管辖与仲裁 | 管辖;仲裁;司法管辖 | HIGH | ✅ |
| 5 | 不可抗力 | 不可抗力;力量;天灾 | MEDIUM | ⚠️ |
| 6 | 价格调整 | 价格调整;价格变动;成本 | MEDIUM | ✅ |
| 7 | 发票税务 | 发票;税票;增值税 | MEDIUM | ✅ |
| 8 | 验收交付 | 验收;交付;交收 | MEDIUM | ✅ |
| 9 | 知识产权 | 知识产权;著作权;专利 | MEDIUM | ✅ |
| 10 | 保险责任 | 保险;责任险 | MEDIUM | ✅ |
| 11 | 变更修改 | 变更;修改;补充 | MEDIUM | ✅ |
| 12 | 终止解除 | 终止;解除;提前终止 | MEDIUM | ✅ |
| 13 | 质量保证 | 质量保证;性能 | MEDIUM | ⚠️ |
| 14 | 费用成本 | 费用;成本;报价;价格 | MEDIUM | ✅ |
| 15 | 生效期限 | 生效;签署;有效期 | LOW | ✅ |

**总计**：16 条规则，其中 1 条需要改进

---

## 📁 相关文档

### 已生成的文档

1. **关键词匹配问题诊断报告** (`docs/关键词匹配问题诊断报告.md`)
   - 详细的根因分析
   - 规则库完整内容
   - 技术细节解释

2. **关键词匹配问题修复指南** (`docs/关键词匹配问题修复指南.md`)
   - 快速修复步骤
   - 完整的操作说明
   - 测试验证清单
   - 常见问题 Q&A

3. **本文档** (`docs/README_关键词匹配问题.md`)
   - 快速参考指南
   - 问题总结
   - 解决方案概览

---

## 🎯 行动清单

### 立即执行（5 分钟）

- [ ] 打开 `src/main/resources/review-rules/rules.xlsx`
- [ ] 定位第 3 行（违约责任规则）
- [ ] 修改 Column D：`违约责任;逾期;赔偿` → `违约;逾期;赔偿`
- [ ] 保存文件
- [ ] 调用 `/api/review/reload-rules` 重新加载
- [ ] 上传测试合同验证

### 后续改进（可选）

- [ ] 检查其他规则的关键词配置（参见上表中标记 ⚠️ 的规则）
- [ ] 收集真实合同数据，优化关键词库
- [ ] 添加缺失的规则（担保、隐私、合规等）
- [ ] 考虑建立关键词版本管理机制

---

## 🔧 技术细节

### 关键词匹配流程

```
上传文档
    ↓
解析得到条款文本："第五条 违约责任：甲方如有违约，..."
    ↓
遍历规则，调用 rule.matches(clauseText)
    ├─ 关键词检查（keyword matching）
    │  ├─ 检查"违约责任" ❌ 不匹配
    │  ├─ 检查"逾期" ❌ 不匹配
    │  └─ 检查"赔偿" ❌ 不匹配
    │
    ├─ 正则表达式检查（regex matching）
    │  └─ Pattern: "违约.*赔偿|赔偿.*\d+%" ❌ 不匹配
    │
    └─ 返回：不匹配 ❌
    ↓
Prompt 中不包含此规则
```

**修复后的流程**：

```
关键词改为："违约;逾期;赔偿"
    ↓
关键词检查
    ├─ 检查"违约" ✅ 匹配！
    └─ 返回：匹配成功
    ↓
Prompt 中包含违约责任规则 ✅
```

### 代码位置参考

| 组件 | 文件 | 行号 | 说明 |
|------|------|------|------|
| 规则模型 | `ReviewRule.java` | 180-231 | `matches()` 方法 |
| 规则加载 | `ReviewRulesService.java` | 50-83 | `loadRules()` 方法 |
| 规则匹配 | `ApiReviewController.java` | 119-124 | 规则过滤逻辑 |
| Prompt 生成 | `PromptGeneratorNew.java` | 118-193 | 生成完整 Prompt |

---

## 📈 预期效果

修复前：
```
❌ 文档包含"违约" → 规则未命中 → Prompt 中没有违约责任审查
```

修复后：
```
✅ 文档包含"违约" → 规则命中 → Prompt 包含违约责任审查内容
```

### Prompt 变化示例

**修复前**：
```
【需要审查的条款列表】
【条款】c5 - 第五条 付款条款
...
（不包含违约责任的审查内容）
```

**修复后**：
```
【需要审查的条款列表】
【条款】c5 - 第五条 付款条款
...
【条款】c6 - 第六条 违约责任
【原文】
甲方如有违约，应支付违约金...
【审查要点】
● 风险等级: HIGH
  匹配关键词: 违约, 赔偿
  检查清单:
  1. 确认违约金额度
  2. 评估赔偿条件
  【立场建议】建议甲方明确违约金额度，保护自身权益
```

---

## ❓ 常见问题

**Q: 规则库中所有规则都有这个问题吗？**
A: 不是。仅第 2 条规则（违约责任）有这个问题。其他规则的关键词配置相对合理。

**Q: 修改后会增加误匹配吗？**
A: 不会显著增加。系统有两层过滤：
1. 关键词层：`text.contains("违约")`
2. 正则层：`Pattern.matches("违约.*赔偿|赔偿.*\d+%")`

**Q: 为什么用 Excel 而不是改代码？**
A: 因为规则是配置，不是代码。配置应该可以独立修改，无需开发人员干预。

**Q: 修改后需要重启应用吗？**
A: 不需要。调用 `/api/review/reload-rules` 接口可以动态重新加载规则。

---

## 📞 支持

- **完整诊断报告**：见 `docs/关键词匹配问题诊断报告.md`
- **修复操作指南**：见 `docs/关键词匹配问题修复指南.md`
- **代码参考**：见对应的 Java 源文件和行号

---

## 📅 版本信息

- **诊断日期**：2025-10-23
- **诊断工具**：Excel 内容提取 + 源码分析
- **问题状态**：✅ 已诊断，解决方案可行
- **修复状态**：待用户执行

---

**问题**："上传文档中有提到'违约'，但审查prompt没有命中该关键词"
**答案**：修改 rules.xlsx 第 3 行的关键词，从"违约责任"改为"违约"
**所需时间**：5 分钟
**预期效果**：✅ 系统正确匹配"违约"相关内容
