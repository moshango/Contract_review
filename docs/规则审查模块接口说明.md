# 规则审查模块接口说明

## 概述

规则审查模块是合同审查系统的核心功能模块，负责：
1. 加载和管理审查规则（来自 `rules.xlsx`）
2. 对合同条款进行规则匹配
3. 生成 LLM 审查 Prompt
4. 提供规则查询和管理接口

---

## 核心概念

### 规则匹配流程

```
合同文件
  ↓
【步骤1】文档解析 → 提取条款及锚点
  ↓
【步骤2】规则加载 → 按合同类型过滤规则
  ↓
【步骤3】规则匹配 → 关键字粗召回 → 正则精筛
  ↓
【步骤4】生成Prompt → 为LLM提供审查指导
  ↓
LLM审查结果（JSON格式）
```

### 关键数据结构

#### ReviewRule（审查规则）

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `id` | String | 规则ID（自动生成） | `rule_1`, `rule_2` |
| `contractTypes` | String | 适用的合同类型（分号分隔） | `采购;外包;NDA` |
| `partyScope` | String | 适用范围 | `Neutral` / `A` / `B` |
| `risk` | String | 风险等级 | `low` / `medium` / `high` / `blocker` |
| `keywords` | String | 关键字列表（分号分隔） | `付款方式;支付周期;付款条件` |
| `regex` | String | 正则表达式（精准匹配） | `支付.*\d+天` |
| `checklist` | String | 检查清单（换行分隔） | `1. 确认付款方式\n2. 明确付款周期` |
| `suggestA` | String | 对甲方的建议 | `建议明确指定...` |
| `suggestB` | String | 对乙方的建议 | `建议要求提高...` |

#### RuleMatchResult（规则匹配结果）

| 字段 | 类型 | 说明 |
|------|------|------|
| `clauseId` | String | 条款ID（如 `c1`, `c2`） |
| `anchorId` | String | 条款级锚点ID（格式：`anc-c{X}-{hash}`） |
| `paragraphAnchors` | List | 段落级锚点列表（每个段落一个anchorId） |
| `clauseHeading` | String | 条款标题 |
| `clauseText` | String | 条款完整文本 |
| `matchedRules` | List<ReviewRule> | 匹配的规则列表 |
| `matchCount` | int | 匹配的规则数量 |
| `highestRisk` | String | 最高风险等级 |

---

## API 接口

### 1. 合同分析接口（核心接口）

**端点:** `POST /api/review/analyze`

**功能:** 上传合同文件，执行规则匹配和 Prompt 生成

#### 请求参数

| 参数名 | 类型 | 必需 | 说明 | 示例 |
|--------|------|------|------|------|
| `file` | File | 是 | 合同文件（.docx / .doc） | - |
| `contractType` | String | 否 | 合同类型 | `采购合同` / `NDA` / `外包合同` |
| `party` | String | 否 | 【新增】审查立场（甲方/乙方/中立） | `A` / `B` / 不指定 |

#### 请求示例

```bash
# 基础请求（使用中立立场）
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@/path/to/contract.docx" \
  -F "contractType=采购合同"

# 【新增】使用甲方立场分析合同
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@/path/to/contract.docx" \
  -F "contractType=采购合同" \
  -F "party=A"

# 【新增】使用乙方立场分析合同
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@/path/to/contract.docx" \
  -F "contractType=采购合同" \
  -F "party=B"
```

#### 响应示例（成功）

```json
{
  "success": true,
  "filename": "采购合同.docx",
  "contractType": "采购合同",
  "userStance": "A",
  "stanceDescription": "甲方",
  "timestamp": 1729682000000,
  "statistics": {
    "totalClauses": 15,
    "matchedClauses": 8,
    "totalRules": 120,
    "applicableRules": 45,
    "totalMatchedRules": 23,
    "highRiskClauses": 3
  },
  "guidance": {
    "statistics": {
      "totalClauses": 15,
      "highRiskCount": 3,
      "totalMatchedRules": 23
    },
    "riskDistribution": {
      "high": 3,
      "medium": 4,
      "low": 1
    },
    "checkpoints": [
      {
        "clauseId": "c1",
        "heading": "第一条 供货范围",
        "riskLevel": "high",
        "checklist": "1. 确认供货范围...\n2. 明确交付标准..."
      }
    ]
  },
  "prompt": "您是一位资深的合同法律顾问。请根据以下信息对合同进行专业审查。\n\n【合同信息】\n合同类型: 采购合同\n需要审查的条款数: 8\n\n【审查规则说明】\n...",
  "matchResults": [
    {
      "clauseId": "c1",
      "anchorId": "anc-c1-4f21",
      "heading": "第一条 供货范围",
      "riskLevel": "high",
      "matchedRuleCount": 3,
      "matchedRules": [
        {
          "id": "rule_1",
          "risk": "high",
          "keywords": "供货范围;交付标准",
          "checklist": "1. 确认供货范围\n2. 明确交付标准"
        }
      ]
    }
  ],
  "parseResultId": "parse_202510231136_abc123",
  "nextStep": "将 prompt 字段的内容复制到 LLM（ChatGPT、Claude等），...",
  "processingTime": "2345ms"
}
```

#### 响应字段说明

| 字段 | 说明 |
|------|------|
| `success` | 是否成功处理 |
| `filename` | 上传的文件名 |
| `contractType` | 合同类型 |
| `statistics` | 统计信息（条款数、匹配数、规则数等） |
| `guidance` | 审查指导（统计信息、风险分布、检查点） |
| `prompt` | **LLM审查Prompt**（复制到ChatGPT/Claude使用） |
| `matchResults` | 匹配结果详情（用于前端展示） |
| `parseResultId` | 解析结果缓存ID（用于后续批注） |
| `nextStep` | 下一步操作指引 |
| `processingTime` | 处理耗时 |

#### 错误响应

```json
{
  "success": false,
  "error": "审查分析失败: 文件格式不支持",
  "filename": "contract.pdf"
}
```

---

### 2. 获取规则列表接口

**端点:** `GET /api/review/rules`

**功能:** 获取所有或特定合同类型的审查规则

#### 请求参数

| 参数名 | 类型 | 必需 | 说明 | 示例 |
|--------|------|------|------|------|
| `contractType` | String | 否 | 合同类型（不填则返回所有） | `采购合同` |

#### 请求示例

```bash
# 获取所有规则
curl "http://localhost:8080/api/review/rules"

# 获取特定类型的规则
curl "http://localhost:8080/api/review/rules?contractType=采购合同"
```

#### 响应示例

```json
{
  "success": true,
  "contractType": "采购合同",
  "totalRules": 45,
  "riskDistribution": {
    "high": 8,
    "medium": 20,
    "low": 15,
    "blocker": 2
  },
  "rules": [
    {
      "id": "rule_1",
      "contractTypes": "采购;外包",
      "partyScope": "Neutral",
      "risk": "high",
      "keywords": "付款方式;支付周期;付款条件",
      "regex": "支付.*\\d+天",
      "checklist": "1. 确认付款方式\n2. 明确付款周期",
      "suggestA": "建议明确指定付款方式...",
      "suggestB": "建议要求提高支付条件..."
    }
  ]
}
```

---

### 3. 重新加载规则接口

**端点:** `POST /api/review/reload-rules`

**功能:** 重新从 `rules.xlsx` 加载规则（支持动态更新）

#### 请求示例

```bash
curl -X POST "http://localhost:8080/api/review/reload-rules"
```

#### 响应示例

```json
{
  "success": true,
  "message": "规则已重新加载",
  "totalRules": 120
}
```

---

### 4. 服务状态接口

**端点:** `GET /api/review/status`

**功能:** 获取规则审查服务的状态信息

#### 请求示例

```bash
curl "http://localhost:8080/api/review/status"
```

#### 响应示例

```json
{
  "service": "API Review Service",
  "version": "1.0",
  "rulesLoaded": true,
  "cachedRuleCount": 120,
  "timestamp": 1729682000000,
  "endpoints": {
    "analyze": "POST /api/review/analyze",
    "rules": "GET /api/review/rules",
    "reloadRules": "POST /api/review/reload-rules",
    "status": "GET /api/review/status"
  }
}
```

---

## 规则配置文件（rules.xlsx）

规则存储在 `src/main/resources/review-rules/rules.xlsx` 文件中。

### 表头说明（第1行）

| 列号 | 列名 | 说明 | 示例 |
|------|------|------|------|
| A | `contract_types` | 适用的合同类型（分号分隔） | `采购;外包;NDA` |
| B | `party_scope` | 适用范围 | `Neutral` / `A` / `B` |
| C | `risk` | 风险等级 | `high` / `medium` / `low` / `blocker` |
| D | `keywords` | 关键字列表（分号分隔） | `付款方式;支付周期` |
| E | `regex` | 正则表达式 | `支付.*\d+天` |
| F | `checklist` | 检查清单（换行分隔） | `1. 确认付款方式...` |
| G | `suggest_A` | 甲方建议 | `建议明确指定...` |
| H | `suggest_B` | 乙方建议 | `建议要求提高...` |

### 规则编写示例

| contract_types | party_scope | risk | keywords | regex | checklist | suggest_A | suggest_B |
|---|---|---|---|---|---|---|---|
| 采购;外包 | Neutral | high | 付款方式;支付周期 | 支付.*\d+天 | 1. 确认付款方式<br>2. 明确付款周期 | 建议在合同中明确约定付款方式和周期 | 建议要求甲方按时支付 |
| NDA | A | medium | 保密期限;保密义务 | 保密.*年 | 1. 检查保密期限<br>2. 确认保密范围 | 建议延长保密期限 | 建议明确保密义务范围 |

---

## 工作流示例

### 场景：审查采购合同

#### 步骤1：上传合同并分析
```bash
curl -X POST "http://localhost:8080/api/review/analyze" \
  -F "file=@采购合同.docx" \
  -F "contractType=采购合同" \
  -o analysis_result.json
```

#### 步骤2：查看响应
```json
{
  "success": true,
  "prompt": "您是一位资深的合同法律顾问...",
  "matchResults": [...],
  "parseResultId": "parse_xxx"
}
```

#### 步骤3：复制 Prompt 到 ChatGPT
```
您是一位资深的合同法律顾问。请根据以下信息对合同进行专业审查。

【合同信息】
合同类型: 采购合同
...

【需要审查的条款列表】
【第一条 供货范围】
...
```

#### 步骤4：获取 ChatGPT 审查结果（JSON格式）
```json
{
  "issues": [
    {
      "clauseId": "c1",
      "anchorId": "anc-c1-p2-8f3a",
      "severity": "HIGH",
      "category": "供货范围",
      "finding": "供货范围不明确",
      "suggestion": "建议明确指定供货范围...",
      "targetText": "甲方应按时供货"
    }
  ]
}
```

#### 步骤5：导入结果并生成批注
```bash
curl -X POST "http://localhost:8080/chatgpt/import-result?parseResultId=parse_xxx" \
  -F "result=@review_result.json" \
  -o annotated_contract.docx
```

---

## 关键特性

### 1. 多级规则匹配
- **关键字匹配**（粗召回）：快速识别相关条款
- **正则匹配**（精筛）：精确定位问题内容
- **多合同类型支持**：不同合同类型应用不同规则

### 2. 双向建议
- **suggestA**：对甲方（合同起草方）的建议
- **suggestB**：对乙方（合同接收方）的建议
- **中立范围**：某些规则对双方都适用

### 3. 锚点精确定位
- **条款级锚点**：格式 `anc-c{X}-{hash}`
- **段落级锚点**：格式 `anc-c{X}-p{Y}-{hash}`
- **自动回填**：系统根据 anchorId 精确定位批注位置

### 4. 规则动态加载
- 支持修改 `rules.xlsx` 后即时重新加载
- 无需重启服务
- 规则变更立即生效

---

## 常见问题

### Q1: 如何添加新的审查规则？

**A:** 编辑 `rules.xlsx` 文件，添加新行，字段说明见上表。然后调用重新加载接口即可。

### Q2: 关键字和正则有什么区别？

**A:**
- **关键字**：简单的文本匹配，不支持复杂模式，性能更好
- **正则**：支持复杂模式匹配（如 `支付.*\d+天`），但性能稍差

优先使用关键字，仅在需要复杂匹配时使用正则。

### Q3: 如何区分 Prompt 中的 anchorId 格式？

**A:** 自动识别：
- 包含 `-pX-` 的为**段落级**（如 `anc-c1-p2-8f3a`）
- 不包含 `-pX-` 的为**条款级**（如 `anc-c1-4f21`）

### Q4: 规则匹配的优先级是什么？

**A:**
1. 优先检查**关键字**（广召回）
2. 如果关键字匹配，直接返回 `true`
3. 只有关键字不匹配时，才检查**正则表达式**

### Q5: 如何自定义 parseResultId 的命名？

**A:** parseResultId 由系统自动生成，格式为 `parse_{timestamp}_{随机串}`。无需手动指定。

---

## 性能考虑

- **规则数量**：支持 100+ 条规则
- **条款数量**：支持 50+ 条条款
- **处理耗时**：通常 1-5 秒（含文件解析、规则匹配、Prompt生成）
- **并发请求**：支持多个并发请求，规则缓存确保性能

---

## 集成建议

### 前端集成步骤

1. **上传合同** → 调用 `/api/review/analyze`
2. **显示分析结果** → 展示 matchResults、statistics、guidance
3. **复制Prompt** → 用户复制 prompt 字段内容
4. **导入LLM结果** → 调用 `/chatgpt/import-result`
5. **下载批注** → 获取带批注的Word文档

### 后端集成点

- `ReviewRulesService`：规则加载和管理
- `ContractParseService`：文档解析
- `PromptGenerator`：Prompt生成
- `ApiReviewController`：REST接口

---

## 相关文档

- [API 接口总体说明](./API接口总体说明.md)
- [批注系统设计](./批注系统设计.md)
- [锚点机制说明](./锚点机制说明.md)
- [项目开发指南](./CLAUDE.md)

### 5. 审查设置接口 - 立场配置

**端点:** `POST /api/review/settings`

**功能:** 设置用户的审查立场（甲方或乙方），在随后的规则匹配中会返回对应的建议

#### 请求参数

| 参数名 | 类型 | 必需 | 说明 | 示例 |
|--------|------|------|------|------|
| `party` | String | 否 | 审查立场（`A` 甲方 / `B` 乙方 / 不指定则为中立） | `A` / `B` |

#### 请求示例

```bash
# 设置为甲方立场
curl -X POST "http://localhost:8080/api/review/settings?party=A"

# 设置为乙方立场
curl -X POST "http://localhost:8080/api/review/settings?party=B"

# 重置为中立立场
curl -X POST "http://localhost:8080/api/review/settings"
```

#### 响应示例

```json
{
  "success": true,
  "currentStance": "A",
  "stanceDescription": "甲方",
  "timestamp": 1729682000000,
  "stanceInfo": {
    "A": "甲方立场 - 将收到对甲方有利的建议",
    "B": "乙方立场 - 将收到对乙方有利的建议",
    "Neutral": "中立立场 - 只显示通用的中立建议"
  },
  "nextStep": "下次调用 /api/review/analyze 时，系统将使用此立场进行规则匹配"
}
```

---

### 6. 获取审查设置接口

**端点:** `GET /api/review/settings`

**功能:** 获取当前的审查立场设置

#### 请求示例

```bash
curl "http://localhost:8080/api/review/settings"
```

#### 响应示例

```json
{
  "success": true,
  "currentStance": "A",
  "stanceDescription": "甲方",
  "timestamp": 1729682000000,
  "availableOptions": {
    "A": "甲方立场",
    "B": "乙方立场",
    "Neutral": "中立立场"
  },
  "info": "可使用 POST /api/review/settings?party=A 或 party=B 来切换立场"
}
```

---

## 立场过滤机制

系统支持基于用户立场的规则过滤：

| 立场 | 代码 | 规则适用范围 |
|------|------|------------|
| **甲方** | `A` | 获得标记为 `A` 或 `Neutral` 的规则，返回 `suggestA` 建议 |
| **乙方** | `B` | 获得标记为 `B` 或 `Neutral` 的规则，返回 `suggestB` 建议 |
| **中立** | 无 | 仅获得标记为 `Neutral` 的规则 |

**工作流程：**

```
用户设置立场 (POST /api/review/settings)
  ↓
用户上传合同分析 (POST /api/review/analyze)
  ↓
系统加载适用的规则 (按 partyScope 过滤)
  ↓
系统返回对应的建议 (suggestA 或 suggestB)
  ↓
LLM 基于立场进行审查
```

---
