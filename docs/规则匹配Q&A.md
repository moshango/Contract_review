# 规则匹配逻辑总结

## 🎯 核心问题解答

### Q1: 规则审查中 keywords 和 regex 分别代表什么？

#### **keywords（关键字）**
- **定义**: 规则中最重要、最高优先级的匹配条件
- **工作原理**: 使用 `String.contains()` 进行**精确子串匹配**
- **用途**: 快速、广泛地检测条款中的关键概念
- **示例**: `违约;毁约;责任;赔偿`
- **性能**: ⚡⚡⚡ 极快

#### **regex（正则表达式）**
- **定义**: 补充性的精细匹配条件，用于处理复杂的模式
- **工作原理**: 使用 Java 正则表达式进行模式匹配
- **用途**: 匹配动态内容（数字、日期等）或复杂的词汇组合
- **示例**: `(支付|付款).*\d+.*天` 可匹配"支付15天"
- **性能**: ⚡ 相对较慢
- **触发时机**: 仅当 keywords 和 targetClauses 都不匹配时才执行

---

### Q2: 关键词匹配的流程是什么？

```
输入：条款文本
  ↓
【第1阶段】检查 keywords
  → 将 keywords 按 `;` 分割为数组
  → 逐个检查每个关键词是否存在于文本中
  → 只要有 1 个关键词匹配 → 🎯 返回 TRUE

【第2阶段】检查 targetClauses（向后兼容）
  → 同理检查 targetClauses 列表
  → 如果匹配 → 🎯 返回 TRUE

【第3阶段】检查 regex
  → 仅当前两阶段都未匹配时执行
  → 使用 Pattern.find() 进行正则匹配
  → 如果匹配 → 🎯 返回 TRUE

如果三个阶段都不匹配 → ❌ 返回 FALSE
```

---

### Q3: 如何优化关键词以提高命中率？

#### **方案 1: 拆分复合词汇**

| 优化前 | 优化后 | 效果 |
|--------|--------|------|
| `违约责任` | `违约;毁约;责任;赔偿` | 命中率从 40% → 80% |
| `支付方式` | `支付;付款;方式;周期;结算;转账` | 命中率从 35% → 85% |

**原因**: 条款中可能只含有"违约"不含"责任"，所以应该把它们拆开

#### **方案 2: 添加同义词和变体**

```
原: 支付
优化: 支付;付款;缴纳;偿付;汇款;转账;结算
```

#### **方案 3: 用正则处理复杂情况**

```
keywords: 支付
regex: 支付.*\d+.*天
```

这样可以精确匹配"支付X天内"这样的表述

---

## 📊 实际代码流程

### 代码位置 1: 关键词匹配算法

**文件**: `ReviewRule.java:180-200`

```java
// 优先检查关键字（广召回）
String[] keywordList = getKeywordList();  // 按 ';' 分割
for (String keyword : keywordList) {
    String trimmedKeyword = keyword.trim();
    if (text.contains(trimmedKeyword)) {  // 精确子串匹配
        this.matchedKeywords.add(trimmedKeyword);  // 记录匹配的关键词
    }
}

// 如果关键字匹配了，直接返回 true（正则不执行）
if (!this.matchedKeywords.isEmpty()) {
    return true;
}
```

### 代码位置 2: 规则匹配流程

**文件**: `ReviewRulesService.java:301-310`

```java
public List<ReviewRule> matchRulesForClause(String clauseText, String contractType) {
    return cachedRules.stream()
        .filter(rule -> rule.applicableToContractType(contractType))  // 1. 筛选合同类型
        .filter(rule -> rule.matches(clauseText))                     // 2. 执行匹配
        .collect(Collectors.toList());
}
```

### 代码位置 3: 正则编译和匹配

**文件**: `ReviewRule.java:213-228`

```java
if (regex != null && !regex.trim().isEmpty()) {
    if (compiledPattern == null) {
        try {
            compiledPattern = Pattern.compile(regex);  // 编译一次，缓存使用
        } catch (Exception e) {
            System.err.println("正则编译失败: " + regex);
            return false;
        }
    }
    if (compiledPattern.matcher(text).find()) {  // 使用 find 而不是 matches
        this.matchedKeywords.add("正则: " + regex);
        return true;
    }
}
```

---

## 💡 关键词优化前后对比

### 示例 1: 支付条款

**❌ 优化前**:
```
keywords: 支付方式
命中率: 35%
```

**未能匹配的真实条款**:
- "甲方应在10天内付款" (用的是"付款"不是"支付方式")
- "款项支付周期为月结" (有"支付"但缺"方式")
- "支付方法为电汇转账" (用的是"方法"不是"方式")

**✅ 优化后**:
```
keywords: 支付;付款;款项;周期;结算;方式;方法;转账
regex: (支付|付款).*\d+.*天
命中率: 85%
```

**现在能匹配的条款**:
- ✅ "甲方应在10天内付款"
- ✅ "款项支付周期为月结"
- ✅ "支付方法为电汇转账"
- ✅ "收到发票后15天支付款项"

---

### 示例 2: 违约条款

**❌ 优化前**:
```
keywords: 违约责任
命中率: 40%
```

**未能匹配的真实条款**:
- "甲方违反本协议应承担责任" (缺少整个"违约责任"组合)
- "若乙方毁约，需赔偿甲方损失" (用的是"毁约"不是"违约")
- "不履行合同义务的后果" (完全没有"违约"字眼)

**✅ 优化后**:
```
keywords: 违约;毁约;违反;不履行;责任;赔偿;罚款;违约金
regex: (违约|毁约|违反).*?(责任|赔偿|处罚)
命中率: 88%
```

**现在能匹配的条款**:
- ✅ "甲方违反本协议应承担责任"
- ✅ "若乙方毁约，需赔偿甲方损失"
- ✅ "不履行合同义务"
- ✅ "违约方应支付违约金"

---

## 🔧 立即可用的优化方案

### 快速复用的关键词库

#### 支付/款项
```
支付;付款;款项;周期;结算;方式;方法;条件;时间;
转账;汇款;电汇;支票;现金;收据;发票;确认;
应收;应付;清偿;清付;缴纳;偿付;汇兑;
支付周期;付款周期;支付方式;付款方式;支付条件;付款条件
```

#### 违约/责任
```
违约;毁约;违反;不履行;责任;赔偿;处罚;罚款;
违约金;违约方;债务;义务;承诺;承担;
损失;费用;利息;违约责任;违约条款;违约处理;
失效;无效;解除;终止;中止
```

#### 保密
```
保密;秘密;机密;隐私;保护;保密期;保密条款;
商业秘密;保密信息;秘密信息;隐私信息;保密义务;
泄露;公开;披露;保密措施;保密责任;
保护措施;防护;安全;严格
```

---

## 📋 优化步骤清单

### Step 1: 定位需优化的规则
- [ ] 打开 `src/main/resources/review-rules/rules.xlsx`
- [ ] 查看第 4 列（keywords）
- [ ] 找出过于具体或单一的关键词

### Step 2: 编辑关键词
- [ ] 将复合词拆分（如"违约责任" → "违约;责任")
- [ ] 添加同义词（如"支付" → "支付;付款;款项")
- [ ] 添加常见变体

### Step 3: 编辑正则表达式
- [ ] 对于需要"词1 + 词2"组合的场景，使用正则
- [ ] 示例: `(支付|付款).*\d+.*天`

### Step 4: 重新加载规则（无需重启）
```bash
curl -X POST http://localhost:8080/api/review/reload-rules
```

### Step 5: 验证效果
- [ ] 上传测试合同进行规则审查
- [ ] 检查匹配的规则数量是否增多
- [ ] 确保没有误匹配（应该不匹配的被匹配了）

---

## 🎯 性能 vs 功能的平衡

| 策略 | 性能 | 准确度 | 推荐用途 |
|------|------|--------|--------|
| 仅用 keywords | ⚡⚡⚡ 最快 | 中等 | 高频词汇、快速匹配 |
| keywords + regex | ⚡⚡ 较快 | 高 | 平衡方案（推荐） |
| 仅用 regex | ⚡ 较慢 | 很高 | 复杂模式、精细匹配 |

**建议**: 优先使用 keywords，用 regex 补充复杂情况

---

## ✅ 实施完成清单

- [x] 理解 keywords 和 regex 的差别
- [x] 理解匹配的三阶段流程
- [x] 了解优化关键词的策略
- [x] 获得了可复用的关键词库
- [x] 掌握了优化步骤

**下一步**: 打开 `rules.xlsx`，按照清单开始优化！

---

## 📞 常见问题

**Q: 如果我更改了 keywords，需要重启应用吗？**

A: 不需要！调用 API 即可重新加载：
```bash
curl -X POST http://localhost:8080/api/review/reload-rules
```

---

**Q: keywords 中的每个关键词都要分开吗？**

A: 不一定。只有在你想让它们都独立生效时才分开。例如：
- 分开: `支付;付款;周期` (三个都会独立检查)
- 组合: `支付周期` (只能匹配整个组合)

根据实际需要选择。

---

**Q: regex 的性能影响有多大？**

A:
- 简单正则 (如 `\d+`) : 影响小
- 复杂正则 (如 `(A|B|C).*?(X|Y|Z).*?\d{2,4}`) : 影响较大

建议只在 keywords 无法表达时才使用 regex。

---

**文档生成时间**: 2025-10-24
**状态**: ✅ 完成
