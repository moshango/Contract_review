# å®¡æŸ¥ç«‹åœºåŠŸèƒ½ - å‰ç«¯é›†æˆæŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·ç«‹åœºåŠŸèƒ½å…è®¸ç”¨æˆ·åœ¨è¿›è¡Œè§„åˆ™å®¡æŸ¥æ—¶é€‰æ‹©è‡ªå·±çš„èº«ä»½ï¼ˆç”²æ–¹/ä¹™æ–¹/ä¸­ç«‹ï¼‰ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©è¿”å›é’ˆå¯¹æ€§çš„å®¡æŸ¥å»ºè®®ã€‚

## UI å®ç°

### 1. HTML UI ç»„ä»¶

**ä½ç½®**: `src/main/resources/static/index.html` ç¬¬ 109-124 è¡Œ

åœ¨"è§„åˆ™å®¡æŸ¥"æ ‡ç­¾é¡µçš„åˆåŒç±»å‹é€‰æ‹©ä¸‹æ–¹æ·»åŠ äº†ç«‹åœºé€‰æ‹©å™¨ï¼š

```html
<div class="form-group">
    <label>å®¡æŸ¥ç«‹åœº: (é€‰æ‹©æ‚¨çš„èº«ä»½ï¼Œè·å¾—é’ˆå¯¹æ€§çš„å®¡æŸ¥å»ºè®®)</label>
    <div style="display: flex; gap: 15px; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
        <label class="radio-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="rule-review-stance" value="Neutral" checked>
            <span><strong>ä¸­ç«‹</strong> (æ˜¾ç¤ºæ‰€æœ‰é€šç”¨è§„åˆ™)</span>
        </label>
        <label class="radio-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="rule-review-stance" value="A">
            <span><strong>ç”²æ–¹</strong> (è·å¾—ç”²æ–¹æœ‰åˆ©çš„å»ºè®®)</span>
        </label>
        <label class="radio-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="rule-review-stance" value="B">
            <span><strong>ä¹™æ–¹</strong> (è·å¾—ä¹™æ–¹æœ‰åˆ©çš„å»ºè®®)</span>
        </label>
    </div>
    <p style="font-size: 12px; color: #666; margin-top: 8px;">
        ğŸ’¡ æç¤ºï¼šä¸åŒç«‹åœºä¼šè¿”å›é’ˆå¯¹æ€§çš„å®¡æŸ¥å»ºè®®ã€‚ç”²æ–¹æ›´å…³æ³¨æ¡æ¬¾å¯¹è‡ªå·±çš„ä¸åˆ©ï¼›ä¹™æ–¹æ›´å…³æ³¨å¦‚ä½•ä¿æŠ¤è‡ªå·±çš„æƒç›Šã€‚
    </p>
</div>
```

**ç‰¹ç‚¹**ï¼š
- ä¸‰ä¸ªå•é€‰æŒ‰é’®ï¼ˆRadio buttonsï¼‰ä¾›ç”¨æˆ·é€‰æ‹©
- é»˜è®¤é€‰ä¸­"ä¸­ç«‹"
- æ¸…æ™°çš„è§†è§‰è®¾è®¡å’Œæè¿°æ–‡å­—
- åŒ…å«ä½¿ç”¨æç¤º

### 2. JavaScript å®ç°

**ä½ç½®**: `src/main/resources/static/js/stance.js`ï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰

#### æ ¸å¿ƒå‡½æ•°

##### a) `getSelectedStance()`
```javascript
function getSelectedStance() {
    const stanceRadios = document.querySelectorAll('input[name="rule-review-stance"]');
    for (const radio of stanceRadios) {
        if (radio.checked) {
            return radio.value;
        }
    }
    return 'Neutral';
}
```

**åŠŸèƒ½**ï¼šè¯»å–ç”¨æˆ·é€‰æ‹©çš„ç«‹åœºå€¼
- è¿”å›å€¼ï¼š`'A'`ï¼ˆç”²æ–¹ï¼‰ã€`'B'`ï¼ˆä¹™æ–¹ï¼‰æˆ– `'Neutral'`ï¼ˆä¸­ç«‹ï¼‰

##### b) `setUserStance(stance)`
```javascript
async function setUserStance(stance) {
    try {
        const url = stance ? `/api/review/settings?party=${stance}` : `/api/review/settings`;
        const response = await fetch(url, {
            method: 'POST'
        });

        if (!response.ok) {
            console.warn('âš ï¸ è®¾ç½®å®¡æŸ¥ç«‹åœºå¤±è´¥:', response.statusText);
            return false;
        }

        const data = await response.json();
        console.log('âœ… å®¡æŸ¥ç«‹åœºå·²è®¾ç½®:', data.stanceDescription);
        return true;
    } catch (error) {
        console.error('è®¾ç½®ç«‹åœºå‡ºé”™:', error);
        return false;
    }
}
```

**åŠŸèƒ½**ï¼šè°ƒç”¨åç«¯ API è®¾ç½®ç”¨æˆ·çš„å®¡æŸ¥ç«‹åœº
- å‚æ•°ï¼š`stance` - ç«‹åœºå€¼ï¼ˆ'A'ã€'B' æˆ– ''ï¼‰
- è¿”å›å€¼ï¼š`true` æˆåŠŸï¼Œ`false` å¤±è´¥

##### c) `getCurrentStance()`
```javascript
async function getCurrentStance() {
    try {
        const response = await fetch(`/api/review/settings`, {
            method: 'GET'
        });

        if (!response.ok) {
            return null;
        }

        const data = await response.json();
        console.log('å½“å‰å®¡æŸ¥ç«‹åœº:', data.stanceDescription);
        return data.currentStance;
    } catch (error) {
        console.error('è·å–ç«‹åœºå‡ºé”™:', error);
        return null;
    }
}
```

**åŠŸèƒ½**ï¼šä»åç«¯è·å–å½“å‰è®¾ç½®çš„ç«‹åœº
- è¿”å›å€¼ï¼šç«‹åœºå€¼æˆ– `null`ï¼ˆå¤±è´¥ï¼‰

##### d) ä¿®æ”¹åçš„ `startRuleReview()` å‡½æ•°

**å…³é”®ä¿®æ”¹**ï¼š
```javascript
// ã€æ–°å¢ã€‘è·å–ç”¨æˆ·é€‰æ‹©çš„ç«‹åœº
const stance = getSelectedStance();

// ã€æ–°å¢ã€‘å…ˆè®¾ç½®ç”¨æˆ·ç«‹åœº
if (stance !== 'Neutral') {
    await setUserStance(stance);
}

// ã€å…³é”®ä¿®æ”¹ã€‘åœ¨URLä¸­æ·»åŠ partyå‚æ•°
const encodedContractType = encodeURIComponent(contractType);
const encodedStance = encodeURIComponent(stance);
const url = `/api/review/analyze?contractType=${encodedContractType}&party=${encodedStance}`;

// ã€æ–°å¢ã€‘æ˜¾ç¤ºç”¨æˆ·çš„å®¡æŸ¥ç«‹åœº
console.log('ğŸ“Š å®¡æŸ¥ç«‹åœº:', data.stanceDescription);
showToast(`âœ… å·²æŒ‰${data.stanceDescription}çš„ç«‹åœºè¿›è¡Œå®¡æŸ¥`, 'success');
```

**å·¥ä½œæµ**ï¼š
1. ç”¨æˆ·é€‰æ‹©ç«‹åœºï¼ˆA/B/ä¸­ç«‹ï¼‰
2. ç‚¹å‡»"å¼€å§‹è§„åˆ™å®¡æŸ¥"æŒ‰é’®
3. å‰ç«¯è°ƒç”¨ `setUserStance()` åœ¨åç«¯å­˜å‚¨ç«‹åœº
4. å‰ç«¯è°ƒç”¨ `/api/review/analyze?party=...` å‘é€åˆ†æè¯·æ±‚
5. åç«¯æ ¹æ®ç«‹åœºè¿‡æ»¤è§„åˆ™å¹¶è¿”å›é’ˆå¯¹æ€§å»ºè®®
6. å‰ç«¯æ˜¾ç¤ºç«‹åœºä¿¡æ¯å’Œå®¡æŸ¥ç»“æœ

## å·¥ä½œåŸç†

### ç”¨æˆ·äº¤äº’æµç¨‹

```
ç”¨æˆ·UIç•Œé¢
   â†“
é€‰æ‹©åˆåŒæ–‡ä»¶
   â†“
é€‰æ‹©åˆåŒç±»å‹ (é‡‡è´­/å¤–åŒ…/NDAç­‰)
   â†“
é€‰æ‹©å®¡æŸ¥ç«‹åœº (ä¸­ç«‹/ç”²æ–¹/ä¹™æ–¹) â† ã€æ–°å¢ã€‘
   â†“
ç‚¹å‡»"å¼€å§‹è§„åˆ™å®¡æŸ¥"
   â†“
å‰ç«¯è°ƒç”¨ setUserStance(stance) â†’ POST /api/review/settings
   â†“
å‰ç«¯è°ƒç”¨ startRuleReview() â†’ POST /api/review/analyze?party=...
   â†“
åç«¯è¿”å›ç«‹åœºç›¸å…³çš„è§„åˆ™å’Œå»ºè®®
   â†“
å‰ç«¯æ˜¾ç¤ºç»“æœï¼ˆå¸¦æœ‰ç”¨æˆ·ç«‹åœºä¿¡æ¯ï¼‰
```

### åç«¯ API è°ƒç”¨

å‰ç«¯ä¸åç«¯äº¤äº’çš„å…³é”® URLï¼š

```bash
# 1. è®¾ç½®ç”¨æˆ·ç«‹åœº
POST /api/review/settings?party=A    # è®¾ç½®ä¸ºç”²æ–¹
POST /api/review/settings?party=B    # è®¾ç½®ä¸ºä¹™æ–¹
POST /api/review/settings            # é‡ç½®ä¸ºä¸­ç«‹

# 2. åˆ†æåˆåŒï¼ˆå¸¦ç«‹åœºå‚æ•°ï¼‰
POST /api/review/analyze?contractType=é‡‡è´­åˆåŒ&party=A
```

## API é›†æˆ

### è¯·æ±‚ç¤ºä¾‹

```javascript
// è·å–ç”¨æˆ·é€‰æ‹©çš„ç«‹åœº
const stance = getSelectedStance(); // è¿”å› 'A', 'B', æˆ– 'Neutral'

// è°ƒç”¨åˆ†æAPI
const formData = new FormData();
formData.append('file', selectedFile);

const response = await fetch(
    `/api/review/analyze?contractType=é‡‡è´­åˆåŒ&party=${stance}`,
    {
        method: 'POST',
        body: formData
    }
);

const data = await response.json();
console.log('ç”¨æˆ·ç«‹åœº:', data.stanceDescription);  // è¾“å‡ºï¼šç”²æ–¹ã€ä¹™æ–¹ æˆ– ä¸­ç«‹
console.log('å®¡æŸ¥å»ºè®®:', data.guidance);            // ç«‹åœºç›¸å…³çš„å®¡æŸ¥å»ºè®®
```

### å“åº”æ ¼å¼

```json
{
    "success": true,
    "filename": "åˆåŒ.docx",
    "contractType": "é‡‡è´­åˆåŒ",
    "userStance": "A",
    "stanceDescription": "ç”²æ–¹",
    "timestamp": 1729682000000,
    "statistics": {
        "totalClauses": 15,
        "matchedClauses": 8,
        "highRiskClauses": 3,
        "totalMatchedRules": 23
    },
    "guidance": {
        "riskDistribution": {
            "high": 3,
            "medium": 4,
            "low": 1
        },
        "checkpoints": [
            {
                "clauseId": "c1",
                "heading": "ç¬¬ä¸€æ¡ ä¾›è´§èŒƒå›´",
                "riskLevel": "high",
                "checklist": "1. ç¡®è®¤ä¾›è´§èŒƒå›´...\\n2. æ˜ç¡®äº¤ä»˜æ ‡å‡†..."
            }
        ]
    },
    "prompt": "æ‚¨æ˜¯ä¸€ä½èµ„æ·±çš„åˆåŒæ³•å¾‹é¡¾é—®ã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯å¯¹åˆåŒè¿›è¡Œä¸“ä¸šå®¡æŸ¥...ï¼ˆé’ˆå¯¹ç”²æ–¹çš„å»ºè®®ï¼‰",
    "matchResults": [
        {
            "clauseId": "c1",
            "anchorId": "anc-c1-4f21",
            "heading": "ç¬¬ä¸€æ¡ ä¾›è´§èŒƒå›´",
            "riskLevel": "high",
            "matchedRuleCount": 3,
            "matchedRules": [...]
        }
    ],
    "parseResultId": "parse_202510231136_abc123"
}
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. ç”²æ–¹å®¡æŸ¥é‡‡è´­åˆåŒ

1. é€‰æ‹©åˆåŒæ–‡ä»¶
2. é€‰æ‹©åˆåŒç±»å‹ä¸º"é‡‡è´­"
3. **é€‰æ‹©ç«‹åœºä¸º"ç”²æ–¹"** â† å…³é”®æ­¥éª¤
4. ç‚¹å‡»"å¼€å§‹è§„åˆ™å®¡æŸ¥"
5. ç³»ç»Ÿè¿”å›é’ˆå¯¹ç”²æ–¹çš„å»ºè®®ï¼ˆå¦‚ï¼šéœ€è¦å…³æ³¨çš„ä¸åˆ©æ¡æ¬¾ã€ä¿æŠ¤è‡ªå·±æƒç›Šçš„å»ºè®®ç­‰ï¼‰

### 2. ä¹™æ–¹å®¡æŸ¥åŒä¸€ä»½åˆåŒ

1. é€‰æ‹©ç›¸åŒçš„åˆåŒæ–‡ä»¶
2. é€‰æ‹©åˆåŒç±»å‹ä¸º"é‡‡è´­"
3. **é€‰æ‹©ç«‹åœºä¸º"ä¹™æ–¹"** â† æ”¹å˜ç«‹åœº
4. ç‚¹å‡»"å¼€å§‹è§„åˆ™å®¡æŸ¥"
5. ç³»ç»Ÿè¿”å›é’ˆå¯¹ä¹™æ–¹çš„å»ºè®®ï¼ˆå¦‚ï¼šå¦‚ä½•äº‰å–åˆç†çš„ä»˜æ¬¾æ¡ä»¶ã€é™ä½è´£ä»»é£é™©ç­‰ï¼‰

## å‰ç«¯åŠŸèƒ½ç‰¹æ€§

### 1. å®æ—¶åé¦ˆ
- ç”¨æˆ·é€‰æ‹©ç«‹åœºåï¼ŒUI æç¤ºä¿¡æ¯ä¼šå®æ—¶æ›´æ–°
- å®¡æŸ¥å®Œæˆåï¼Œç•Œé¢æ˜¾ç¤º"å·²æŒ‰ç”²æ–¹/ä¹™æ–¹/ä¸­ç«‹çš„ç«‹åœºè¿›è¡Œå®¡æŸ¥"

### 2. çŠ¶æ€æŒä¹…åŒ–
- è®¾ç½®çš„ç«‹åœºä¼šåœ¨åç«¯ ThreadLocal ä¸­å­˜å‚¨ï¼ˆå½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
- ç”¨æˆ·å¯éšæ—¶åˆ‡æ¢ç«‹åœºé‡æ–°åˆ†æåŒä¸€ä»½åˆåŒ

### 3. é”™è¯¯å¤„ç†
- å¦‚æœç«‹åœºè®¾ç½®å¤±è´¥ï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè­¦å‘Šä¿¡æ¯
- ä½†åˆ†æä»ä¼šç»§ç»­è¿›è¡Œï¼ˆä½¿ç”¨é»˜è®¤ä¸­ç«‹ç«‹åœºï¼‰

### 4. å…¼å®¹æ€§
- æ”¯æŒæ‰€æœ‰ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safariã€Edgeï¼‰
- ä½¿ç”¨æ ‡å‡† HTML5 Radio Button å’Œ Fetch API

## æ‰©å±•å»ºè®®

### 1. æ·»åŠ æ›´å¤šç«‹åœº
ä¿®æ”¹ `stance.js` ä¸­çš„ `getSelectedStance()` å‡½æ•°å’Œ HTML ä¸­çš„ radio æŒ‰é’®ï¼Œæ”¯æŒæ›´å¤šç«‹åœºï¼ˆå¦‚ C/D/å¤šæ–¹åå•†ç­‰ï¼‰

### 2. ä¿å­˜ç”¨æˆ·åå¥½
åœ¨ localStorage ä¸­ä¿å­˜ç”¨æˆ·çš„é»˜è®¤ç«‹åœºï¼Œä¸‹æ¬¡è®¿é—®æ—¶è‡ªåŠ¨é€‰ä¸­ï¼š

```javascript
function saveStancePreference(stance) {
    localStorage.setItem('defaultStance', stance);
}

function loadStancePreference() {
    const saved = localStorage.getItem('defaultStance');
    if (saved) {
        document.querySelector(`input[name="rule-review-stance"][value="${saved}"]`).checked = true;
    }
}
```

### 3. ç«‹åœºå¯¹æ¯”è§†å›¾
æ·»åŠ åŠŸèƒ½è®©ç”¨æˆ·ä¸€æ¬¡æ€§çœ‹åˆ°ä¸åŒç«‹åœºä¸‹çš„å®¡æŸ¥ç»“æœå¯¹æ¯”

### 4. ç«‹åœºå»ºè®®
åŸºäºç”¨æˆ·èº«ä»½è‡ªåŠ¨æ¨èæœ€åˆé€‚çš„ç«‹åœº

## æ•…éšœæ’é™¤

### é—®é¢˜ï¼šé€‰æ‹©ç«‹åœºåä»ç„¶è¿”å›ä¸­ç«‹å»ºè®®
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
2. ç¡®è®¤ `setUserStance()` å‡½æ•°æˆåŠŸè¿”å› `true`
3. æ£€æŸ¥åç«¯æ˜¯å¦æ­£ç¡®å®ç°äº† `ReviewStanceService`

### é—®é¢˜ï¼šåˆ‡æ¢ç«‹åœºåéœ€è¦é‡æ–°åˆ†æ
**æ­£å¸¸è¡Œä¸º**ï¼š
- è¿™æ˜¯é¢„æœŸçš„ - æ¯ä¸ªç«‹åœºéƒ½éœ€è¦é‡æ–°è¿›è¡Œè§„åˆ™åŒ¹é…å’Œ Prompt ç”Ÿæˆ
- å¦‚æœæƒ³è¦ç¼“å­˜ä¸åŒç«‹åœºçš„ç»“æœï¼Œéœ€è¦åœ¨åç«¯å®ç° Caching å±‚

### é—®é¢˜ï¼šç«‹åœºä¿¡æ¯æœªæ˜¾ç¤ºåœ¨ Prompt ä¸­
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `PromptGenerator` æ˜¯å¦æ­£ç¡®å¤„ç†äº† `stance` ä¿¡æ¯
2. ç¡®è®¤åç«¯è¿”å›çš„ `prompt` å­—æ®µåŒ…å«äº†ç«‹åœºç›¸å…³çš„è¯´æ˜

## æŠ€æœ¯ç»†èŠ‚

### æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `src/main/resources/static/index.html` | HTML | UI ç»„ä»¶ï¼ˆç«‹åœºé€‰æ‹©å™¨ï¼‰ |
| `src/main/resources/static/js/stance.js` | JavaScript | ç«‹åœºé€‰æ‹©é€»è¾‘å’Œ API è°ƒç”¨ |
| `src/main/java/com/example/Contract_review/model/ReviewStance.java` | Java | åç«¯æ¨¡å‹ |
| `src/main/java/com/example/Contract_review/service/ReviewStanceService.java` | Java | åç«¯æœåŠ¡ |
| `src/main/java/com/example/Contract_review/controller/ApiReviewController.java` | Java | åç«¯æ§åˆ¶å™¨ |

### å…³é”®ä¾èµ–

- **å‰ç«¯**: HTML5, Vanilla JavaScript, Fetch API
- **åç«¯**: Spring Boot 3.5.6, Java 17, ThreadLocal

## æ€»ç»“

ç”¨æˆ·ç«‹åœºåŠŸèƒ½å·²æˆåŠŸé›†æˆåˆ°å‰ç«¯ UI ä¸­ï¼š

âœ… **å·²å®Œæˆ**ï¼š
- HTML UI ç»„ä»¶è®¾è®¡å’Œå®ç°
- JavaScript ç«‹åœºé€‰æ‹©é€»è¾‘
- ä¸åç«¯ API é›†æˆ
- å®Œæ•´çš„å·¥ä½œæµå®ç°
- ç”¨æˆ·åé¦ˆå’Œæç¤º

âœ… **åç«¯æ”¯æŒ**ï¼š
- `/api/review/settings` - è®¾ç½®/è·å–ç«‹åœºæ¥å£
- `/api/review/analyze` - æ”¯æŒ `party` å‚æ•°çš„åˆ†ææ¥å£
- `ReviewStance` æ¨¡å‹å’ŒæœåŠ¡
- ç«‹åœºåŸºç¡€çš„è§„åˆ™è¿‡æ»¤

ğŸ¯ **ç”¨æˆ·ä½“éªŒ**ï¼š
- ç®€æ´ç›´è§‚çš„ UI
- å®æ—¶åé¦ˆå’Œæç¤º
- çµæ´»çš„ç«‹åœºåˆ‡æ¢
- é’ˆå¯¹æ€§çš„å®¡æŸ¥å»ºè®®

---

**æ›´æ–°æ—¶é—´**ï¼š2025-10-23
**ç‰ˆæœ¬**ï¼š1.0
