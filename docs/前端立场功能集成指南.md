# 审查立场功能 - 前端集成指南

## 功能概述

用户立场功能允许用户在进行规则审查时选择自己的身份（甲方/乙方/中立），系统会根据用户选择返回针对性的审查建议。

## UI 实现

### 1. HTML UI 组件

**位置**: `src/main/resources/static/index.html` 第 109-124 行

在"规则审查"标签页的合同类型选择下方添加了立场选择器：

```html
<div class="form-group">
    <label>审查立场: (选择您的身份，获得针对性的审查建议)</label>
    <div style="display: flex; gap: 15px; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
        <label class="radio-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="rule-review-stance" value="Neutral" checked>
            <span><strong>中立</strong> (显示所有通用规则)</span>
        </label>
        <label class="radio-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="rule-review-stance" value="A">
            <span><strong>甲方</strong> (获得甲方有利的建议)</span>
        </label>
        <label class="radio-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="rule-review-stance" value="B">
            <span><strong>乙方</strong> (获得乙方有利的建议)</span>
        </label>
    </div>
    <p style="font-size: 12px; color: #666; margin-top: 8px;">
        💡 提示：不同立场会返回针对性的审查建议。甲方更关注条款对自己的不利；乙方更关注如何保护自己的权益。
    </p>
</div>
```

**特点**：
- 三个单选按钮（Radio buttons）供用户选择
- 默认选中"中立"
- 清晰的视觉设计和描述文字
- 包含使用提示

### 2. JavaScript 实现

**位置**: `src/main/resources/static/js/stance.js`（新建文件）

#### 核心函数

##### a) `getSelectedStance()`
```javascript
function getSelectedStance() {
    const stanceRadios = document.querySelectorAll('input[name="rule-review-stance"]');
    for (const radio of stanceRadios) {
        if (radio.checked) {
            return radio.value;
        }
    }
    return 'Neutral';
}
```

**功能**：读取用户选择的立场值
- 返回值：`'A'`（甲方）、`'B'`（乙方）或 `'Neutral'`（中立）

##### b) `setUserStance(stance)`
```javascript
async function setUserStance(stance) {
    try {
        const url = stance ? `/api/review/settings?party=${stance}` : `/api/review/settings`;
        const response = await fetch(url, {
            method: 'POST'
        });

        if (!response.ok) {
            console.warn('⚠️ 设置审查立场失败:', response.statusText);
            return false;
        }

        const data = await response.json();
        console.log('✅ 审查立场已设置:', data.stanceDescription);
        return true;
    } catch (error) {
        console.error('设置立场出错:', error);
        return false;
    }
}
```

**功能**：调用后端 API 设置用户的审查立场
- 参数：`stance` - 立场值（'A'、'B' 或 ''）
- 返回值：`true` 成功，`false` 失败

##### c) `getCurrentStance()`
```javascript
async function getCurrentStance() {
    try {
        const response = await fetch(`/api/review/settings`, {
            method: 'GET'
        });

        if (!response.ok) {
            return null;
        }

        const data = await response.json();
        console.log('当前审查立场:', data.stanceDescription);
        return data.currentStance;
    } catch (error) {
        console.error('获取立场出错:', error);
        return null;
    }
}
```

**功能**：从后端获取当前设置的立场
- 返回值：立场值或 `null`（失败）

##### d) 修改后的 `startRuleReview()` 函数

**关键修改**：
```javascript
// 【新增】获取用户选择的立场
const stance = getSelectedStance();

// 【新增】先设置用户立场
if (stance !== 'Neutral') {
    await setUserStance(stance);
}

// 【关键修改】在URL中添加party参数
const encodedContractType = encodeURIComponent(contractType);
const encodedStance = encodeURIComponent(stance);
const url = `/api/review/analyze?contractType=${encodedContractType}&party=${encodedStance}`;

// 【新增】显示用户的审查立场
console.log('📊 审查立场:', data.stanceDescription);
showToast(`✅ 已按${data.stanceDescription}的立场进行审查`, 'success');
```

**工作流**：
1. 用户选择立场（A/B/中立）
2. 点击"开始规则审查"按钮
3. 前端调用 `setUserStance()` 在后端存储立场
4. 前端调用 `/api/review/analyze?party=...` 发送分析请求
5. 后端根据立场过滤规则并返回针对性建议
6. 前端显示立场信息和审查结果

## 工作原理

### 用户交互流程

```
用户UI界面
   ↓
选择合同文件
   ↓
选择合同类型 (采购/外包/NDA等)
   ↓
选择审查立场 (中立/甲方/乙方) ← 【新增】
   ↓
点击"开始规则审查"
   ↓
前端调用 setUserStance(stance) → POST /api/review/settings
   ↓
前端调用 startRuleReview() → POST /api/review/analyze?party=...
   ↓
后端返回立场相关的规则和建议
   ↓
前端显示结果（带有用户立场信息）
```

### 后端 API 调用

前端与后端交互的关键 URL：

```bash
# 1. 设置用户立场
POST /api/review/settings?party=A    # 设置为甲方
POST /api/review/settings?party=B    # 设置为乙方
POST /api/review/settings            # 重置为中立

# 2. 分析合同（带立场参数）
POST /api/review/analyze?contractType=采购合同&party=A
```

## API 集成

### 请求示例

```javascript
// 获取用户选择的立场
const stance = getSelectedStance(); // 返回 'A', 'B', 或 'Neutral'

// 调用分析API
const formData = new FormData();
formData.append('file', selectedFile);

const response = await fetch(
    `/api/review/analyze?contractType=采购合同&party=${stance}`,
    {
        method: 'POST',
        body: formData
    }
);

const data = await response.json();
console.log('用户立场:', data.stanceDescription);  // 输出：甲方、乙方 或 中立
console.log('审查建议:', data.guidance);            // 立场相关的审查建议
```

### 响应格式

```json
{
    "success": true,
    "filename": "合同.docx",
    "contractType": "采购合同",
    "userStance": "A",
    "stanceDescription": "甲方",
    "timestamp": 1729682000000,
    "statistics": {
        "totalClauses": 15,
        "matchedClauses": 8,
        "highRiskClauses": 3,
        "totalMatchedRules": 23
    },
    "guidance": {
        "riskDistribution": {
            "high": 3,
            "medium": 4,
            "low": 1
        },
        "checkpoints": [
            {
                "clauseId": "c1",
                "heading": "第一条 供货范围",
                "riskLevel": "high",
                "checklist": "1. 确认供货范围...\\n2. 明确交付标准..."
            }
        ]
    },
    "prompt": "您是一位资深的合同法律顾问。请根据以下信息对合同进行专业审查...（针对甲方的建议）",
    "matchResults": [
        {
            "clauseId": "c1",
            "anchorId": "anc-c1-4f21",
            "heading": "第一条 供货范围",
            "riskLevel": "high",
            "matchedRuleCount": 3,
            "matchedRules": [...]
        }
    ],
    "parseResultId": "parse_202510231136_abc123"
}
```

## 使用示例

### 1. 甲方审查采购合同

1. 选择合同文件
2. 选择合同类型为"采购"
3. **选择立场为"甲方"** ← 关键步骤
4. 点击"开始规则审查"
5. 系统返回针对甲方的建议（如：需要关注的不利条款、保护自己权益的建议等）

### 2. 乙方审查同一份合同

1. 选择相同的合同文件
2. 选择合同类型为"采购"
3. **选择立场为"乙方"** ← 改变立场
4. 点击"开始规则审查"
5. 系统返回针对乙方的建议（如：如何争取合理的付款条件、降低责任风险等）

## 前端功能特性

### 1. 实时反馈
- 用户选择立场后，UI 提示信息会实时更新
- 审查完成后，界面显示"已按甲方/乙方/中立的立场进行审查"

### 2. 状态持久化
- 设置的立场会在后端 ThreadLocal 中存储（当前会话有效）
- 用户可随时切换立场重新分析同一份合同

### 3. 错误处理
- 如果立场设置失败，会在控制台输出警告信息
- 但分析仍会继续进行（使用默认中立立场）

### 4. 兼容性
- 支持所有现代浏览器（Chrome、Firefox、Safari、Edge）
- 使用标准 HTML5 Radio Button 和 Fetch API

## 扩展建议

### 1. 添加更多立场
修改 `stance.js` 中的 `getSelectedStance()` 函数和 HTML 中的 radio 按钮，支持更多立场（如 C/D/多方协商等）

### 2. 保存用户偏好
在 localStorage 中保存用户的默认立场，下次访问时自动选中：

```javascript
function saveStancePreference(stance) {
    localStorage.setItem('defaultStance', stance);
}

function loadStancePreference() {
    const saved = localStorage.getItem('defaultStance');
    if (saved) {
        document.querySelector(`input[name="rule-review-stance"][value="${saved}"]`).checked = true;
    }
}
```

### 3. 立场对比视图
添加功能让用户一次性看到不同立场下的审查结果对比

### 4. 立场建议
基于用户身份自动推荐最合适的立场

## 故障排除

### 问题：选择立场后仍然返回中立建议
**解决方案**：
1. 检查浏览器控制台是否有错误信息
2. 确认 `setUserStance()` 函数成功返回 `true`
3. 检查后端是否正确实现了 `ReviewStanceService`

### 问题：切换立场后需要重新分析
**正常行为**：
- 这是预期的 - 每个立场都需要重新进行规则匹配和 Prompt 生成
- 如果想要缓存不同立场的结果，需要在后端实现 Caching 层

### 问题：立场信息未显示在 Prompt 中
**解决方案**：
1. 检查 `PromptGenerator` 是否正确处理了 `stance` 信息
2. 确认后端返回的 `prompt` 字段包含了立场相关的说明

## 技术细节

### 文件清单

| 文件 | 类型 | 说明 |
|------|------|------|
| `src/main/resources/static/index.html` | HTML | UI 组件（立场选择器） |
| `src/main/resources/static/js/stance.js` | JavaScript | 立场选择逻辑和 API 调用 |
| `src/main/java/com/example/Contract_review/model/ReviewStance.java` | Java | 后端模型 |
| `src/main/java/com/example/Contract_review/service/ReviewStanceService.java` | Java | 后端服务 |
| `src/main/java/com/example/Contract_review/controller/ApiReviewController.java` | Java | 后端控制器 |

### 关键依赖

- **前端**: HTML5, Vanilla JavaScript, Fetch API
- **后端**: Spring Boot 3.5.6, Java 17, ThreadLocal

## 总结

用户立场功能已成功集成到前端 UI 中：

✅ **已完成**：
- HTML UI 组件设计和实现
- JavaScript 立场选择逻辑
- 与后端 API 集成
- 完整的工作流实现
- 用户反馈和提示

✅ **后端支持**：
- `/api/review/settings` - 设置/获取立场接口
- `/api/review/analyze` - 支持 `party` 参数的分析接口
- `ReviewStance` 模型和服务
- 立场基础的规则过滤

🎯 **用户体验**：
- 简洁直观的 UI
- 实时反馈和提示
- 灵活的立场切换
- 针对性的审查建议

---

**更新时间**：2025-10-23
**版本**：1.0
