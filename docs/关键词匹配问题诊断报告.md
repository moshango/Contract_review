# 关键词匹配问题诊断报告

## 问题描述

用户报告：上传文档中有提到"违约"，但审查prompt没有命中该关键词

## 诊断结果

### ✅ 关键发现：违约关键词确实存在于规则中

规则表中确认包含以下与违约相关的规则：

| 规则ID | 关键词 | 正则表达式 | 风险等级 | 适用范围 | 建议 |
|--------|--------|----------|---------|---------|------|
| rule_3 | `违约责任;逾期;赔偿` | `违约.*赔偿\|赔偿.*\d+%` | HIGH | Neutral | 甲方：明确违约金额度<br>乙方：合理的违约金限额 |

## 详细的规则库内容

### 完整规则列表（按风险等级）

**HIGH RISK RULES (4 rules):**

1. **Rule 1 - 付款条款**
   - Keywords: `付款方式;支付周期;付款条件`
   - Regex: `支付.*\d+天`
   - Contracts: 采购;外包;通用合同

2. **Rule 2 - 违约责任** ← **用户要找的规则！**
   - Keywords: `违约责任;逾期;赔偿`
   - Regex: `违约.*赔偿|赔偿.*\d+%`
   - Party Scope: Neutral
   - SuggestA: 建议甲方明确违约金额度，保护自身权益
   - SuggestB: 乙方应争取合理的违约金限额

3. **Rule 3 - 保密条款**
   - Keywords: `保密;机密;保密期`
   - Regex: `保密.*\d+年|\d+年.*保密`

4. **Rule 4 - 管辖与仲裁**
   - Keywords: `管辖;仲裁;司法管辖`
   - Regex: `(?:管辖|仲裁).*(?:法院|仲裁委)`

**MEDIUM RISK RULES (6 rules):**
- 不可抗力, 价格调整, 发票, 验收交付, 知识产权, 保险责任, 变更修改, 终止解除, 质量保证, 费用成本等

**LOW RISK RULES (1 rule):**
- 生效与有效期

---

## 问题根因分析

既然 **"违约"** 关键词已经在规则中（Rule 2 - 违约责任），为什么用户上传的文档没有命中？

### 可能的原因：

#### 1. **关键词匹配逻辑（代码层面）** ✅ 已验证

文件：`ReviewRule.java` 第 180-231 行 `matches()` 方法

```java
public boolean matches(String text) {
    // ...省略...
    
    // 检查关键字（广召回）
    String[] keywordList = getKeywordList();  // 使用分号分割
    for (String keyword : keywordList) {
        String trimmedKeyword = keyword.trim();
        if (text.contains(trimmedKeyword)) {  // ← 这里使用 contains() 进行匹配
            this.matchedKeywords.add(trimmedKeyword);
        }
    }
    
    // 如果关键字匹配了，直接返回true
    if (!this.matchedKeywords.isEmpty()) {
        return true;
    }
    
    // 检查正则表达式（如果关键字没有匹配）
    if (regex != null && !regex.trim().isEmpty()) {
        Pattern compiledPattern = Pattern.compile(regex);
        if (compiledPattern.matcher(text).find()) {
            return true;
        }
    }
}
```

**关键细节**：
- 关键词通过分号（`;`）分割，如 `违约责任;逾期;赔偿`
- 分割后的关键词为：`["违约责任", "逾期", "赔偿"]`
- 使用 `text.contains(trimmedKeyword)` 进行匹配
- **这是 substring 完全匹配，NOT 子词匹配**

#### 2. **上传文档的内容**

问题关键：**文档中出现的是"违约"一个词，但规则中配置的是"违约责任"（两个字）**

- 规则关键词：`违约责任;逾期;赔偿`
- 文档内容：`...某处提到"违约"...`
- 匹配结果：❌ 不匹配！因为 `"某处违约内容".contains("违约责任")` 返回 false

---

## 解决方案

### 方案 A：修改规则配置（推荐 ⭐）

修改 rules.xlsx 中的 Rule 2（违约责任规则），将关键词从：
```
违约责任;逾期;赔偿
```

改为：
```
违约;逾期;赔偿
```

这样就能匹配文档中单独出现的"违约"一词。

**优点**：
- 不需要改代码
- 提高了关键词的宽泛性
- 支持更多合同变体

**如何实现**：
1. 打开 `src/main/resources/review-rules/rules.xlsx`
2. 定位到第 3 行（Rule 2 - 违约责任）
3. 修改 D 列（keywords）的值
4. 调用 `/api/review/reload-rules` 接口重新加载规则

### 方案 B：添加专项规则（如需更细致控制）

添加一个新规则专门处理单独的"违约"关键词：

```
契约类型: 通用合同
Party Scope: Neutral
Risk: high
Keywords: 违约
Regex: 违约
Checklist: 1. 确认违约责任和赔偿条件
          2. 检查违约金计算方式
          3. 评估对方的违约救济手段
SuggestA: 建议甲方明确违约金数额，保护自身利益
SuggestB: 乙方应争取合理的违约金额度，避免过高
```

**优点**：
- 更细致的控制
- 可以分别设置不同的检查清单
- 支持多维度的违约相关风险识别

---

## 对规则库完整性的其他建议

基于对 rules.xlsx 的分析，还有以下改进建议：

### 1. 现有规则覆盖范围

已覆盖的风险类别：
- ✅ 付款条款
- ✅ 违约责任
- ✅ 保密条款
- ✅ 管辖与仲裁
- ✅ 不可抗力
- ✅ 价格调整
- ✅ 发票税务
- ✅ 验收交付
- ✅ 知识产权
- ✅ 保险责任
- ✅ 变更修改
- ✅ 终止解除
- ✅ 质量保证
- ✅ 费用成本
- ✅ 生效期限

**总计**：16 条规则

### 2. 缺失的可能需要补充的规则

考虑添加以下规则：
- 担保与担保责任
- 通知与沟通机制
- 保留权与第三方权利
- 风险转移与保险
- 数据隐私与信息安全
- 合规与法律风险

---

## 规则表结构

| 列号 | 列名 | 用途 | 示例 |
|------|------|------|------|
| A | contract_types | 适用合同类型（分号分割） | 采购;外包;通用合同 |
| B | party_scope | 适用范围（A/B/Neutral） | Neutral |
| C | risk | 风险等级 | high / medium / low |
| D | keywords | 关键词（分号分割） | 违约;逾期;赔偿 |
| E | regex | 正则表达式 | 违约.*赔偿\|赔偿.*\d+% |
| F | checklist | 检查清单（\n分割） | 1. 检查违约条款<br>2. 确认赔偿额度 |
| G | suggest_A | 对甲方的建议 | 建议甲方明确违约金额度 |
| H | suggest_B | 对乙方的建议 | 乙方应争取合理的违约金限额 |

---

## 关键词匹配流程图

```
用户上传文档（含"违约"）
    ↓
API /api/review/analyze
    ↓
解析文档 → 得到条款文本
    ↓
加载规则（loadRules）
    ↓
遍历每个条款，对每条规则调用 rule.matches(clauseText)
    ├─ 【问题点】检查关键词：text.contains("违约责任")
    │  关键词是 "违约责任" 但文本只有 "违约" → ❌ 不匹配
    │
    ├─ 检查正则：Pattern.matches("违约.*赔偿|赔偿.*\d+%", text)
    │  如果文本是 "第十条 违约责任：..." → ❌ 不匹配（没有"赔偿"）
    │
    └─ 返回：不匹配
    ↓
Prompt 中不包含此规则 → ❌ 用户报错

---

修正后的流程（方案 A）：
违约 → keywords 改为 "违约;逾期;赔偿" → text.contains("违约") → ✅ 匹配
```

---

## 立即可采取的行动

### 步骤 1：修改规则表

1. 打开 `src/main/resources/review-rules/rules.xlsx`
2. 定位 Rule 2（第 3 行）
3. 修改 Keywords 列：`违约责任;逾期;赔偿` → `违约;逾期;赔偿`
4. 保存文件

### 步骤 2：重新加载规则

```bash
curl -X POST http://localhost:8080/api/review/reload-rules
```

### 步骤 3：重新测试

上传相同文档，应该能在 Prompt 中看到违约责任相关的规则被命中。

---

## 总结

| 项目 | 结论 |
|------|------|
| 违约关键词存在否 | ✅ 是 |
| 规则配置是否正确 | ❌ 需要优化 |
| 代码逻辑是否正确 | ✅ 是（substring 完全匹配） |
| 根本原因 | 关键词颗粒度过粗（违约责任 vs 违约） |
| 推荐解决方案 | 修改规则表中的关键词配置 |
| 修改成本 | 低（仅需编辑 Excel）|
| 验证时间 | 1 分钟（修改+重载） |

---

**诊断日期**: 2025-10-23  
**诊断工具**: Excel 内容提取 + ReviewRule 源码分析  
**状态**: ✅ 根因已确认，解决方案可行
